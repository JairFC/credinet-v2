-- =============================================================================
-- CREDINET v2.0 - RESTAURACI√ìN COMPLETA DE BASE DE DATOS
-- =============================================================================
-- Generado: $(date)
-- 
-- Este archivo contiene TODO lo necesario para recrear la base de datos:
-- 1. Esquema completo (tablas, √≠ndices, constraints)
-- 2. Todas las funciones (40)
-- 3. Todos los triggers (35)
-- 4. Datos de cat√°logos (sin datos de prueba)
-- 5. Per√≠odos de corte generados autom√°ticamente
--
-- USO:
--   psql -U credinet_user -d credinet_db -f 00_restore_complete.sql
-- =============================================================================

-- Configuraci√≥n inicial
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SET check_function_bodies = false;
SET client_min_messages = warning;


-- ============ ESQUEMA ============

--
-- PostgreSQL database dump
--

\restrict 5MXCZGcbiGv8fFN1bGMrTpUjmMnkzcHWHylfFuQIWWI0POuTo6uciP8cgOf6UtI

-- Dumped from database version 15.14
-- Dumped by pg_dump version 15.14

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Name: admin_mark_payment_status(integer, integer, integer, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.admin_mark_payment_status(p_payment_id integer, p_new_status_id integer, p_admin_user_id integer, p_notes text DEFAULT NULL::text) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_old_status_id INTEGER;
BEGIN
    -- Obtener estado actual
    SELECT status_id INTO v_old_status_id
    FROM payments
    WHERE id = p_payment_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Pago % no encontrado', p_payment_id;
    END IF;
    
    -- Actualizar estado del pago
    UPDATE payments
    SET 
        status_id = p_new_status_id,
        marked_by = p_admin_user_id,
        marked_at = CURRENT_TIMESTAMP,
        marking_notes = p_notes,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = p_payment_id;
    
    RAISE NOTICE 'Pago % marcado como estado % por usuario %', p_payment_id, p_new_status_id, p_admin_user_id;
END;
$$;


--
-- Name: apply_debt_payment_v2(integer, numeric, integer, character varying, integer, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.apply_debt_payment_v2(p_associate_profile_id integer, p_payment_amount numeric, p_payment_method_id integer, p_payment_reference character varying, p_registered_by integer, p_notes text DEFAULT NULL::text) RETURNS TABLE(payment_id integer, amount_applied numeric, remaining_debt numeric, applied_items jsonb, credit_released numeric)
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_user_id INTEGER;
    v_remaining_amount DECIMAL(12,2);
    v_debt_record RECORD;
    v_applied_items JSONB := '[]'::jsonb;
    v_item JSONB;
    v_amount_to_apply DECIMAL(12,2);
    v_total_applied DECIMAL(12,2) := 0;
    v_payment_id INTEGER;
    v_credit_before DECIMAL(12,2);
    v_credit_after DECIMAL(12,2);
BEGIN
    -- Validaciones iniciales
    IF p_payment_amount <= 0 THEN
        RAISE EXCEPTION 'El monto del abono debe ser mayor a 0';
    END IF;
    
    -- Obtener user_id y cr√©dito actual
    SELECT ap.user_id, ap.credit_available
    INTO v_user_id, v_credit_before
    FROM associate_profiles ap WHERE ap.id = p_associate_profile_id;
    
    IF v_user_id IS NULL THEN
        RAISE EXCEPTION 'Perfil de asociado % no encontrado', p_associate_profile_id;
    END IF;
    
    v_remaining_amount := p_payment_amount;
    
    -- ‚≠ê APLICAR FIFO: liquidar deudas m√°s antiguas primero desde accumulated_balances
    FOR v_debt_record IN (
        SELECT 
            aab.id,
            aab.accumulated_debt,
            aab.cut_period_id,
            aab.created_at,
            cp.cut_code
        FROM associate_accumulated_balances aab
        JOIN cut_periods cp ON cp.id = aab.cut_period_id
        WHERE aab.user_id = v_user_id
          AND aab.accumulated_debt > 0
        ORDER BY aab.created_at ASC, aab.id ASC  -- ‚≠ê FIFO por fecha
    )
    LOOP
        EXIT WHEN v_remaining_amount <= 0;
        
        IF v_remaining_amount >= v_debt_record.accumulated_debt THEN
            -- Liquidar completamente este item
            v_amount_to_apply := v_debt_record.accumulated_debt;
            
            UPDATE associate_accumulated_balances
            SET 
                accumulated_debt = 0,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = v_debt_record.id;
            
            v_remaining_amount := v_remaining_amount - v_amount_to_apply;
            
            v_item := jsonb_build_object(
                'accumulated_balance_id', v_debt_record.id,
                'cut_period_id', v_debt_record.cut_period_id,
                'period_code', v_debt_record.cut_code,
                'original_debt', v_debt_record.accumulated_debt,
                'amount_applied', v_amount_to_apply,
                'remaining_debt', 0,
                'fully_liquidated', true
            );
        ELSE
            -- Liquidar parcialmente
            v_amount_to_apply := v_remaining_amount;
            
            UPDATE associate_accumulated_balances
            SET 
                accumulated_debt = accumulated_debt - v_remaining_amount,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = v_debt_record.id;
            
            v_item := jsonb_build_object(
                'accumulated_balance_id', v_debt_record.id,
                'cut_period_id', v_debt_record.cut_period_id,
                'period_code', v_debt_record.cut_code,
                'original_debt', v_debt_record.accumulated_debt,
                'amount_applied', v_amount_to_apply,
                'remaining_debt', v_debt_record.accumulated_debt - v_remaining_amount,
                'fully_liquidated', false
            );
            
            v_remaining_amount := 0;
        END IF;
        
        v_applied_items := v_applied_items || v_item;
        v_total_applied := v_total_applied + v_amount_to_apply;
    END LOOP;
    
    -- Si no se aplic√≥ nada (no hab√≠a deuda), advertir
    IF v_total_applied = 0 THEN
        RAISE EXCEPTION 'No se encontr√≥ deuda pendiente para aplicar el abono';
    END IF;
    
    -- Insertar registro de pago
    INSERT INTO associate_debt_payments (
        associate_profile_id,
        payment_amount,
        payment_date,
        payment_method_id,
        payment_reference,
        registered_by,
        applied_breakdown_items,
        notes
    ) VALUES (
        p_associate_profile_id,
        v_total_applied,  -- Solo el monto realmente aplicado
        CURRENT_DATE,
        p_payment_method_id,
        p_payment_reference,
        p_registered_by,
        v_applied_items,
        CASE 
            WHEN v_remaining_amount > 0 THEN 
                COALESCE(p_notes, '') || ' [Sobrante no aplicado: ' || v_remaining_amount || ']'
            ELSE p_notes
        END
    )
    RETURNING id INTO v_payment_id;
    
    -- Sincronizar debt_balance en associate_profiles
    PERFORM sync_associate_debt_balance(p_associate_profile_id);
    
    -- Recalcular cr√©dito disponible (liberar el monto pagado)
    UPDATE associate_profiles
    SET 
        credit_available = credit_available + v_total_applied,
        credit_used = credit_used - v_total_applied,
        credit_last_updated = CURRENT_TIMESTAMP,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = p_associate_profile_id
    RETURNING credit_available INTO v_credit_after;
    
    -- Retornar resultado
    RETURN QUERY SELECT 
        v_payment_id,
        v_total_applied,
        (SELECT COALESCE(SUM(accumulated_debt), 0) FROM associate_accumulated_balances WHERE user_id = v_user_id),
        v_applied_items,
        v_credit_after - v_credit_before;
END;
$$;


--
-- Name: apply_excess_to_debt_fifo(integer, numeric, character varying); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.apply_excess_to_debt_fifo(p_associate_profile_id integer, p_excess_amount numeric, p_payment_reference character varying) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_remaining_amount DECIMAL(12,2);
    v_debt_record RECORD;
BEGIN
    v_remaining_amount := p_excess_amount;
    
    -- Aplicar FIFO: liquidar deudas m√°s antiguas primero
    FOR v_debt_record IN (
        SELECT id, amount
        FROM associate_debt_breakdown
        WHERE associate_profile_id = p_associate_profile_id
          AND is_liquidated = false
        ORDER BY created_at ASC, id ASC  -- ‚≠ê FIFO
    )
    LOOP
        EXIT WHEN v_remaining_amount <= 0;
        
        IF v_remaining_amount >= v_debt_record.amount THEN
            -- Liquidar completamente este item
            UPDATE associate_debt_breakdown
            SET 
                is_liquidated = true,
                liquidated_at = CURRENT_TIMESTAMP,
                liquidation_reference = p_payment_reference,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = v_debt_record.id;
            
            v_remaining_amount := v_remaining_amount - v_debt_record.amount;
            
            RAISE NOTICE 'Deuda % liquidada completamente (monto: %)', 
                         v_debt_record.id, v_debt_record.amount;
        ELSE
            -- Liquidar parcialmente (reducir monto del item)
            UPDATE associate_debt_breakdown
            SET 
                amount = amount - v_remaining_amount,
                updated_at = CURRENT_TIMESTAMP
            WHERE id = v_debt_record.id;
            
            RAISE NOTICE 'Deuda % liquidada parcialmente (abono: %, restante: %)', 
                         v_debt_record.id, v_remaining_amount, v_debt_record.amount - v_remaining_amount;
            
            v_remaining_amount := 0;
        END IF;
    END LOOP;
    
    -- Actualizar debt_balance del asociado
    UPDATE associate_profiles
    SET 
        debt_balance = (
            SELECT COALESCE(SUM(amount), 0)
            FROM associate_debt_breakdown
            WHERE associate_profile_id = p_associate_profile_id
              AND is_liquidated = false
        ),
        updated_at = CURRENT_TIMESTAMP
    WHERE id = p_associate_profile_id;
    
    RAISE NOTICE 'Excedente aplicado: % (sobrante: %)', p_excess_amount - v_remaining_amount, v_remaining_amount;
END;
$$;


--
-- Name: approve_defaulted_client_report(integer, integer, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.approve_defaulted_client_report(p_report_id integer, p_approved_by integer, p_cut_period_id integer) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_associate_profile_id INTEGER;
    v_loan_id INTEGER;
    v_client_user_id INTEGER;
    v_total_debt_amount DECIMAL(12,2);
    v_paid_by_associate_id INTEGER;
BEGIN
    -- Obtener datos del reporte
    SELECT 
        associate_profile_id,
        loan_id,
        client_user_id,
        total_debt_amount
    INTO 
        v_associate_profile_id,
        v_loan_id,
        v_client_user_id,
        v_total_debt_amount
    FROM defaulted_client_reports
    WHERE id = p_report_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Reporte % no encontrado', p_report_id;
    END IF;
    
    -- Obtener ID del estado PAID_BY_ASSOCIATE
    SELECT id INTO v_paid_by_associate_id FROM payment_statuses WHERE name = 'PAID_BY_ASSOCIATE';
    
    -- Actualizar reporte como aprobado
    UPDATE defaulted_client_reports
    SET status = 'APPROVED',
        approved_by = p_approved_by,
        approved_at = CURRENT_TIMESTAMP
    WHERE id = p_report_id;
    
    -- Marcar pagos del pr√©stamo como PAID_BY_ASSOCIATE
    UPDATE payments
    SET status_id = v_paid_by_associate_id,
        updated_at = CURRENT_TIMESTAMP
    WHERE loan_id = v_loan_id
      AND status_id NOT IN (
          SELECT id FROM payment_statuses WHERE name IN ('PAID', 'PAID_BY_ASSOCIATE')
      );
    
    -- Crear registro de deuda en associate_debt_breakdown
    INSERT INTO associate_debt_breakdown (
        associate_profile_id,
        cut_period_id,
        debt_type,
        loan_id,
        client_user_id,
        amount,
        description,
        is_liquidated
    ) VALUES (
        v_associate_profile_id,
        p_cut_period_id,
        'DEFAULTED_CLIENT',
        v_loan_id,
        v_client_user_id,
        v_total_debt_amount,
        'Cliente moroso aprobado - Reporte #' || p_report_id,
        false
    );
    
    -- Actualizar debt_balance del asociado
    UPDATE associate_profiles
    SET debt_balance = debt_balance + v_total_debt_amount
    WHERE id = v_associate_profile_id;
    
    RAISE NOTICE '‚úÖ Reporte % aprobado. Deuda de % agregada a asociado %', 
        p_report_id, v_total_debt_amount, v_associate_profile_id;
END;
$$;


--
-- Name: audit_trigger_function(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.audit_trigger_function() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    IF (TG_OP = 'DELETE') THEN
        INSERT INTO audit_log (table_name, record_id, operation, old_data)
        VALUES (TG_TABLE_NAME, OLD.id, 'DELETE', row_to_json(OLD)::jsonb);
        RETURN OLD;
    ELSIF (TG_OP = 'UPDATE') THEN
        INSERT INTO audit_log (table_name, record_id, operation, old_data, new_data)
        VALUES (TG_TABLE_NAME, NEW.id, 'UPDATE', row_to_json(OLD)::jsonb, row_to_json(NEW)::jsonb);
        RETURN NEW;
    ELSIF (TG_OP = 'INSERT') THEN
        INSERT INTO audit_log (table_name, record_id, operation, new_data)
        VALUES (TG_TABLE_NAME, NEW.id, 'INSERT', row_to_json(NEW)::jsonb);
        RETURN NEW;
    END IF;
    RETURN NULL;
END;
$$;


--
-- Name: auto_generate_statements_at_midnight(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.auto_generate_statements_at_midnight() RETURNS TABLE(period_code character varying, statements_generated integer, total_amount numeric)
    LANGUAGE plpgsql
    AS $_$
DECLARE
    v_current_day INTEGER;
    v_is_cut_day BOOLEAN;
    v_period_id INTEGER;
    v_period_code VARCHAR(20);
    v_count INTEGER;
    v_total NUMERIC(12,2);
BEGIN
    v_current_day := EXTRACT(DAY FROM CURRENT_DATE);
    
    -- Verificar si es d√≠a de corte (8 o 23)
    v_is_cut_day := v_current_day IN (8, 23);
    
    IF NOT v_is_cut_day THEN
        RAISE NOTICE 'Hoy no es d√≠a de corte (d√≠a %, esperado 8 o 23)', v_current_day;
        RETURN;
    END IF;
    
    -- Obtener periodo correspondiente a hoy (d√≠a de impresi√≥n)
    SELECT id, cut_code INTO v_period_id, v_period_code
    FROM cut_periods
    WHERE period_end_date + 1 = CURRENT_DATE;
    
    IF v_period_id IS NULL THEN
        RAISE EXCEPTION 'No se encontr√≥ periodo para hoy: %', CURRENT_DATE;
    END IF;
    
    RAISE NOTICE 'üîÑ Iniciando corte autom√°tico para periodo: %', v_period_code;
    
    -- Generar statements autom√°ticos con estado DRAFT (ID 6)
    INSERT INTO associate_payment_statements (
        cut_period_id,
        user_id,
        statement_number,
        total_payments_count,
        total_amount_collected,
        total_commission_owed,
        commission_rate_applied,
        status_id,
        generated_date,
        due_date
    )
    SELECT 
        v_period_id,
        l.associate_user_id,
        CONCAT(v_period_code, '-A', l.associate_user_id) as statement_number,
        COUNT(p.id) as total_payments,
        SUM(p.expected_amount) as total_amount,
        SUM(p.commission_amount) as total_commission,
        l.commission_rate,
        6,  -- DRAFT
        CURRENT_DATE,
        CURRENT_DATE + INTERVAL '7 days'
    FROM payments p
    JOIN loans l ON p.loan_id = l.id
    WHERE p.cut_period_id = v_period_id
      AND p.status_id = 1  -- PENDING
      AND l.associate_user_id IS NOT NULL
    GROUP BY v_period_id, l.associate_user_id, v_period_code, l.commission_rate
    ON CONFLICT DO NOTHING;
    
    GET DIAGNOSTICS v_count = ROW_COUNT;
    
    -- Calcular total generado
    SELECT COALESCE(SUM(total_amount_collected), 0) INTO v_total
    FROM associate_payment_statements
    WHERE cut_period_id = v_period_id AND status_id = 6;
    
    RAISE NOTICE '‚úÖ Corte autom√°tico completado: % statements en DRAFT, Total: $%',
        v_count, v_total;
    
    -- Retornar resumen
    RETURN QUERY SELECT v_period_code, v_count, v_total;
END;
$_$;


--
-- Name: calculate_first_payment_date(date); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_first_payment_date(p_approval_date date) RETURNS date
    LANGUAGE plpgsql IMMUTABLE STRICT PARALLEL SAFE
    AS $$
DECLARE
    v_approval_day INTEGER;
    v_approval_year INTEGER;
    v_approval_month INTEGER;
    v_first_payment_date DATE;
    v_next_month_date DATE;
    v_last_day_current_month DATE;
BEGIN
    -- Extraer componentes de la fecha
    v_approval_day := EXTRACT(DAY FROM p_approval_date)::INTEGER;
    v_approval_year := EXTRACT(YEAR FROM p_approval_date)::INTEGER;
    v_approval_month := EXTRACT(MONTH FROM p_approval_date)::INTEGER;
    
    -- Pre-calcular fechas comunes
    v_next_month_date := p_approval_date + INTERVAL '1 month';
    v_last_day_current_month := (DATE_TRUNC('month', p_approval_date) + INTERVAL '1 month' - INTERVAL '1 day')::DATE;
    
    -- Aplicar l√≥gica del doble calendario
    v_first_payment_date := CASE
        -- CASO 1: Aprobaci√≥n d√≠as 1-7 ‚Üí Primer pago d√≠a 15 del mes ACTUAL
        WHEN v_approval_day >= 1 AND v_approval_day < 8 THEN
            MAKE_DATE(v_approval_year, v_approval_month, 15)
        
        -- CASO 2: Aprobaci√≥n d√≠as 8-22 ‚Üí Primer pago √öLTIMO d√≠a del mes ACTUAL
        WHEN v_approval_day >= 8 AND v_approval_day < 23 THEN
            v_last_day_current_month
        
        -- CASO 3: Aprobaci√≥n d√≠a 23+ ‚Üí Primer pago d√≠a 15 del mes SIGUIENTE
        WHEN v_approval_day >= 23 THEN
            MAKE_DATE(
                EXTRACT(YEAR FROM v_next_month_date)::INTEGER,
                EXTRACT(MONTH FROM v_next_month_date)::INTEGER,
                15
            )
        
        ELSE NULL
    END;
    
    -- Validaciones
    IF p_approval_date IS NULL THEN
        RAISE EXCEPTION 'La fecha de aprobaci√≥n no puede ser NULL';
    END IF;
    
    IF v_approval_day < 1 OR v_approval_day > 31 THEN
        RAISE EXCEPTION 'D√≠a de aprobaci√≥n inv√°lido: %. Debe estar entre 1 y 31.', v_approval_day;
    END IF;
    
    IF v_first_payment_date < p_approval_date THEN
        RAISE WARNING 'ALERTA: La fecha de primer pago (%) es anterior a la fecha de aprobaci√≥n (%).',
            v_first_payment_date, p_approval_date;
    END IF;
    
    RETURN v_first_payment_date;
    
EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'Error al calcular primera fecha de pago para %: % (%)',
            p_approval_date, SQLERRM, SQLSTATE;
END;
$$;


--
-- Name: calculate_late_fee_for_statement(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_late_fee_for_statement(p_statement_id integer) RETURNS numeric
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
    v_total_payments_count INTEGER;
    v_total_commission_owed DECIMAL(12,2);
    v_late_fee DECIMAL(12,2);
BEGIN
    -- Obtener datos del statement
    SELECT total_payments_count, total_commission_owed
    INTO v_total_payments_count, v_total_commission_owed
    FROM associate_payment_statements
    WHERE id = p_statement_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Statement % no encontrado', p_statement_id;
    END IF;
    
    -- Aplicar regla: Si NO report√≥ ning√∫n pago, mora del 30% sobre comisi√≥n
    IF v_total_payments_count = 0 AND v_total_commission_owed > 0 THEN
        v_late_fee := v_total_commission_owed * 0.30;
        RAISE NOTICE 'Mora del 30%% aplicada: % (comisi√≥n: %)', v_late_fee, v_total_commission_owed;
    ELSE
        v_late_fee := 0.00;
    END IF;
    
    RETURN ROUND(v_late_fee, 2);
END;
$$;


--
-- Name: calculate_loan_payment(numeric, integer, character varying); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_loan_payment(p_amount numeric, p_term_biweeks integer, p_profile_code character varying) RETURNS TABLE(profile_code character varying, profile_name character varying, calculation_method character varying, interest_rate_percent numeric, commission_rate_percent numeric, biweekly_payment numeric, total_payment numeric, total_interest numeric, effective_rate_percent numeric, commission_per_payment numeric, total_commission numeric, associate_payment numeric, associate_total numeric)
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
    v_profile RECORD;
    v_legacy_entry RECORD;
    v_factor DECIMAL(10,6);
    v_total DECIMAL(12,2);
    v_payment DECIMAL(10,2);
    v_commission_per_payment DECIMAL(10,2);
BEGIN
    -- Obtener perfil
    SELECT * INTO v_profile
    FROM rate_profiles
    WHERE code = p_profile_code AND enabled = true;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Perfil de tasa no encontrado o deshabilitado: %', p_profile_code;
    END IF;
    
    -- M√âTODO 1: Table Lookup (perfil legacy)
    IF v_profile.calculation_type = 'table_lookup' THEN
        SELECT * INTO v_legacy_entry
        FROM legacy_payment_table
        WHERE amount = p_amount AND term_biweeks = p_term_biweeks;
        
        IF NOT FOUND THEN
            RAISE EXCEPTION 'Monto % no encontrado en tabla legacy para plazo %Q', p_amount, p_term_biweeks;
        END IF;
        
        v_payment := v_legacy_entry.biweekly_payment;
        v_total := v_legacy_entry.total_payment;
        v_commission_per_payment := COALESCE(v_legacy_entry.commission_per_payment, 0);
        
        RETURN QUERY SELECT
            v_profile.code,
            v_profile.name,
            v_profile.calculation_type,
            v_legacy_entry.biweekly_rate_percent AS interest_rate,
            ROUND(((COALESCE(v_legacy_entry.commission_per_payment, 0) / NULLIF(v_payment, 0)) * 100)::NUMERIC, 3) AS commission_rate,
            v_payment,
            v_total,
            v_legacy_entry.total_interest,
            v_legacy_entry.effective_rate_percent,
            ROUND(v_commission_per_payment, 2),
            ROUND(COALESCE(v_legacy_entry.total_commission, 0), 2),
            ROUND(COALESCE(v_legacy_entry.associate_biweekly_payment, 0), 2),
            ROUND(COALESCE(v_legacy_entry.associate_total_payment, 0), 2);
        
        RETURN;
    END IF;
    
    -- M√âTODO 2: Formula (perfiles standard, custom)
    IF v_profile.calculation_type = 'formula' THEN
        IF v_profile.interest_rate_percent IS NULL THEN
            RAISE EXCEPTION 'Perfil % tipo formula requiere interest_rate_percent configurado', p_profile_code;
        END IF;
        
        IF v_profile.commission_rate_percent IS NULL THEN
            RAISE EXCEPTION 'Perfil % tipo formula requiere commission_rate_percent configurado', p_profile_code;
        END IF;
        
        -- Calcular pago del CLIENTE (inter√©s simple)
        v_factor := 1 + (v_profile.interest_rate_percent / 100) * p_term_biweeks;
        v_total := p_amount * v_factor;
        v_payment := v_total / p_term_biweeks;
        
        -- ‚≠ê CAMBIO CR√çTICO: Comisi√≥n sobre el MONTO, no sobre el pago
        v_commission_per_payment := p_amount * (v_profile.commission_rate_percent / 100);
        
        RETURN QUERY SELECT
            v_profile.code,
            v_profile.name,
            v_profile.calculation_type,
            v_profile.interest_rate_percent,
            v_profile.commission_rate_percent,
            ROUND(v_payment, 2) AS biweekly_payment,
            ROUND(v_total, 2) AS total_payment,
            ROUND(v_total - p_amount, 2) AS total_interest,
            ROUND(((v_total - p_amount) / p_amount * 100)::NUMERIC, 2) AS effective_rate,
            ROUND(v_commission_per_payment, 2),
            ROUND(v_commission_per_payment * p_term_biweeks, 2),
            ROUND(v_payment - v_commission_per_payment, 2),
            ROUND((v_payment - v_commission_per_payment) * p_term_biweeks, 2);
        
        RETURN;
    END IF;
    
    RAISE EXCEPTION 'Tipo de c√°lculo no soportado: %', v_profile.calculation_type;
END;
$$;


--
-- Name: calculate_loan_payment_custom(numeric, integer, numeric, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_loan_payment_custom(p_amount numeric, p_term_biweeks integer, p_interest_rate numeric, p_commission_rate numeric) RETURNS TABLE(profile_code character varying, profile_name character varying, calculation_method character varying, interest_rate_percent numeric, commission_rate_percent numeric, biweekly_payment numeric, total_payment numeric, total_interest numeric, effective_rate_percent numeric, commission_per_payment numeric, total_commission numeric, associate_payment numeric, associate_total numeric)
    LANGUAGE plpgsql IMMUTABLE
    AS $$
DECLARE
    v_factor DECIMAL(10,6);
    v_total DECIMAL(12,2);
    v_payment DECIMAL(10,2);
    v_commission_per_payment DECIMAL(10,2);
BEGIN
    -- Calcular pago del CLIENTE (inter√©s simple)
    v_factor := 1 + (p_interest_rate / 100) * p_term_biweeks;
    v_total := p_amount * v_factor;
    v_payment := v_total / p_term_biweeks;
    
    -- ‚≠ê CAMBIO CR√çTICO: Comisi√≥n sobre el MONTO, no sobre el pago
    v_commission_per_payment := p_amount * (p_commission_rate / 100);
    
    RETURN QUERY SELECT
        'custom'::VARCHAR(50),
        'Personalizado'::VARCHAR(100),
        'formula'::VARCHAR(20),
        p_interest_rate,
        p_commission_rate,
        ROUND(v_payment, 2) AS biweekly_payment,
        ROUND(v_total, 2) AS total_payment,
        ROUND(v_total - p_amount, 2) AS total_interest,
        ROUND(((v_total - p_amount) / p_amount * 100)::NUMERIC, 2) AS effective_rate,
        ROUND(v_commission_per_payment, 2),
        ROUND(v_commission_per_payment * p_term_biweeks, 2),
        ROUND(v_payment - v_commission_per_payment, 2),
        ROUND((v_payment - v_commission_per_payment) * p_term_biweeks, 2);
END;
$$;


--
-- Name: calculate_loan_remaining_balance(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_loan_remaining_balance(p_loan_id integer) RETURNS numeric
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
    v_total_amount DECIMAL(12,2);
    v_total_paid DECIMAL(12,2);
    v_remaining DECIMAL(12,2);
BEGIN
    -- Obtener monto total del pr√©stamo
    SELECT amount INTO v_total_amount
    FROM loans
    WHERE id = p_loan_id;
    
    IF v_total_amount IS NULL THEN
        RAISE EXCEPTION 'Pr√©stamo con ID % no encontrado', p_loan_id;
    END IF;
    
    -- Calcular total pagado
    SELECT COALESCE(SUM(amount_paid), 0) INTO v_total_paid
    FROM payments
    WHERE loan_id = p_loan_id;
    
    v_remaining := v_total_amount - v_total_paid;
    
    -- No permitir saldo negativo
    IF v_remaining < 0 THEN
        v_remaining := 0;
    END IF;
    
    RETURN v_remaining;
END;
$$;


--
-- Name: calculate_payment_preview(timestamp with time zone, integer, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.calculate_payment_preview(p_approval_timestamp timestamp with time zone DEFAULT CURRENT_TIMESTAMP, p_term_biweeks integer DEFAULT 12, p_amount numeric DEFAULT 100000.00) RETURNS TABLE(payment_number integer, payment_due_date date, payment_amount numeric, payment_type text, cut_period_estimated text)
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
    v_approval_date DATE;
    v_approval_day INTEGER;
    v_current_payment_date DATE;
    v_payment_amount DECIMAL(12,2);
    i INTEGER;
BEGIN
    v_approval_date := p_approval_timestamp::DATE;
    v_approval_day := EXTRACT(DAY FROM v_approval_date);
    v_payment_amount := ROUND(p_amount / p_term_biweeks, 2);
    
    -- Calcular primera fecha usando el or√°culo
    v_current_payment_date := calculate_first_payment_date(v_approval_date);
    
    -- Generar preview de todos los pagos
    FOR i IN 1..p_term_biweeks LOOP
        RETURN QUERY SELECT 
            i,
            v_current_payment_date,
            v_payment_amount,
            CASE 
                WHEN EXTRACT(DAY FROM v_current_payment_date) = 15 THEN 'D√çA_15'
                ELSE '√öLTIMO_D√çA'
            END::TEXT,
            CASE 
                WHEN EXTRACT(DAY FROM v_current_payment_date) <= 8 THEN 'CORTE_8_' || EXTRACT(MONTH FROM v_current_payment_date)::TEXT
                ELSE 'CORTE_23_' || EXTRACT(MONTH FROM v_current_payment_date)::TEXT
            END::TEXT;
        
        -- Alternar fechas: d√≠a 15 ‚Üî √∫ltimo d√≠a del mes
        IF EXTRACT(DAY FROM v_current_payment_date) = 15 THEN
            v_current_payment_date := (DATE_TRUNC('month', v_current_payment_date) + INTERVAL '1 month' - INTERVAL '1 day')::DATE;
        ELSE
            v_current_payment_date := MAKE_DATE(
                EXTRACT(YEAR FROM v_current_payment_date + INTERVAL '1 month')::INTEGER,
                EXTRACT(MONTH FROM v_current_payment_date + INTERVAL '1 month')::INTEGER,
                15
            );
        END IF;
    END LOOP;
    
    RETURN;
END;
$$;


--
-- Name: check_associate_credit_available(integer, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.check_associate_credit_available(p_associate_profile_id integer, p_requested_amount numeric) RETURNS boolean
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
    v_credit_available DECIMAL(12,2);
    v_credit_limit DECIMAL(12,2);
    v_credit_used DECIMAL(12,2);
    v_debt_balance DECIMAL(12,2);
BEGIN
    -- Obtener datos del asociado
    SELECT credit_limit, credit_used, debt_balance
    INTO v_credit_limit, v_credit_used, v_debt_balance
    FROM associate_profiles
    WHERE id = p_associate_profile_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Perfil de asociado % no encontrado', p_associate_profile_id;
    END IF;
    
    -- Calcular cr√©dito disponible
    v_credit_available := v_credit_limit - v_credit_used - v_debt_balance;
    
    -- Validar si hay cr√©dito suficiente
    IF v_credit_available >= p_requested_amount THEN
        RETURN TRUE;
    ELSE
        RAISE NOTICE 'Cr√©dito insuficiente. Disponible: %, Solicitado: %', v_credit_available, p_requested_amount;
        RETURN FALSE;
    END IF;
END;
$$;


--
-- Name: close_period_and_accumulate_debt(integer, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.close_period_and_accumulate_debt(p_cut_period_id integer, p_closed_by integer) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_period_start DATE;
    v_period_end DATE;
    v_paid_status_id INTEGER;
    v_paid_not_reported_id INTEGER;
    v_paid_by_associate_id INTEGER;
    v_total_payments_marked INTEGER := 0;
    v_unreported_count INTEGER := 0;
    v_morosos_count INTEGER := 0;
BEGIN
    -- Obtener fechas del per√≠odo
    SELECT period_start_date, period_end_date
    INTO v_period_start, v_period_end
    FROM cut_periods
    WHERE id = p_cut_period_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Per√≠odo de corte % no encontrado', p_cut_period_id;
    END IF;
    
    -- Obtener IDs de estados
    SELECT id INTO v_paid_status_id FROM payment_statuses WHERE name = 'PAID';
    SELECT id INTO v_paid_not_reported_id FROM payment_statuses WHERE name = 'PAID_NOT_REPORTED';
    SELECT id INTO v_paid_by_associate_id FROM payment_statuses WHERE name = 'PAID_BY_ASSOCIATE';
    
    RAISE NOTICE 'üîí Cerrando per√≠odo %: % a %', p_cut_period_id, v_period_start, v_period_end;
    
    -- PASO 1: Marcar pagos reportados como PAID
    WITH updated AS (
        UPDATE payments
        SET status_id = v_paid_status_id,
            updated_at = CURRENT_TIMESTAMP
        WHERE cut_period_id = p_cut_period_id
          AND status_id NOT IN (v_paid_status_id, v_paid_not_reported_id, v_paid_by_associate_id)
          AND amount_paid > 0
        RETURNING id
    )
    SELECT COUNT(*) INTO v_total_payments_marked FROM updated;
    
    RAISE NOTICE '‚úÖ Pagos reportados marcados como PAID: %', v_total_payments_marked;
    
    -- PASO 2: Marcar pagos NO reportados como PAID_NOT_REPORTED
    WITH updated AS (
        UPDATE payments
        SET status_id = v_paid_not_reported_id,
            updated_at = CURRENT_TIMESTAMP
        WHERE cut_period_id = p_cut_period_id
          AND status_id NOT IN (v_paid_status_id, v_paid_not_reported_id, v_paid_by_associate_id)
          AND (amount_paid = 0 OR amount_paid IS NULL)
        RETURNING id
    )
    SELECT COUNT(*) INTO v_unreported_count FROM updated;
    
    RAISE NOTICE '‚ö†Ô∏è  Pagos NO reportados marcados como PAID_NOT_REPORTED: %', v_unreported_count;
    
    -- PASO 3: Marcar clientes morosos como PAID_BY_ASSOCIATE
    -- (Esta l√≥gica se implementar√° cuando se aprueben reportes de morosidad)
    
    -- PASO 4: Actualizar estado del per√≠odo
    UPDATE cut_periods
    SET status_id = (SELECT id FROM cut_period_statuses WHERE name = 'CLOSED'),
        closed_by = p_closed_by,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = p_cut_period_id;
    
    -- PASO 5: Acumular deuda en associate_debt_breakdown
    -- Por cada pago PAID_NOT_REPORTED, crear registro de deuda
    INSERT INTO associate_debt_breakdown (
        associate_profile_id,
        cut_period_id,
        debt_type,
        loan_id,
        client_user_id,
        amount,
        description,
        is_liquidated
    )
    SELECT 
        ap.id,
        p.cut_period_id,
        'UNREPORTED_PAYMENT',
        l.id,
        l.user_id,
        p.amount_paid,
        'Pago no reportado al cierre del per√≠odo',
        false
    FROM payments p
    JOIN loans l ON p.loan_id = l.id
    JOIN associate_profiles ap ON l.associate_user_id = ap.user_id
    WHERE p.cut_period_id = p_cut_period_id
      AND p.status_id = v_paid_not_reported_id;
    
    -- PASO 6: Actualizar debt_balance en associate_profiles
    UPDATE associate_profiles ap
    SET debt_balance = (
        SELECT COALESCE(SUM(amount), 0)
        FROM associate_debt_breakdown adb
        WHERE adb.associate_profile_id = ap.id
          AND adb.is_liquidated = false
    );
    
    RAISE NOTICE '‚úÖ Per√≠odo % cerrado exitosamente', p_cut_period_id;
END;
$$;


--
-- Name: detect_suspicious_payment_changes(integer, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.detect_suspicious_payment_changes(p_days_back integer DEFAULT 7, p_min_changes integer DEFAULT 3) RETURNS TABLE(payment_id integer, loan_id integer, client_name text, total_changes bigint, last_change timestamp with time zone, status_sequence text)
    LANGUAGE plpgsql STABLE
    AS $$
BEGIN
    RETURN QUERY
    SELECT 
        p.id,
        p.loan_id,
        CONCAT(u.first_name, ' ', u.last_name),
        COUNT(psh.id),
        MAX(psh.changed_at),
        STRING_AGG(ps.name, ' ‚Üí ' ORDER BY psh.changed_at)
    FROM payments p
    JOIN payment_status_history psh ON p.id = psh.payment_id
    JOIN payment_statuses ps ON psh.new_status_id = ps.id
    JOIN loans l ON p.loan_id = l.id
    JOIN users u ON l.user_id = u.id
    WHERE psh.changed_at >= CURRENT_TIMESTAMP - (p_days_back || ' days')::INTERVAL
    GROUP BY p.id, p.loan_id, u.first_name, u.last_name
    HAVING COUNT(psh.id) >= p_min_changes
    ORDER BY COUNT(psh.id) DESC, MAX(psh.changed_at) DESC;
END;
$$;


--
-- Name: finalize_statements_manual(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.finalize_statements_manual(p_cut_period_id integer) RETURNS TABLE(finalized_count integer, total_finalized numeric, period_code character varying)
    LANGUAGE plpgsql
    AS $_$
DECLARE
    v_draft_count INTEGER;
    v_updated_count INTEGER;
    v_total NUMERIC(12,2);
    v_period_code VARCHAR(20);
BEGIN
    -- Obtener informaci√≥n del periodo
    SELECT cut_code INTO v_period_code
    FROM cut_periods
    WHERE id = p_cut_period_id;
    
    IF v_period_code IS NULL THEN
        RAISE EXCEPTION 'Periodo con ID % no encontrado', p_cut_period_id;
    END IF;
    
    -- Verificar que existan statements en DRAFT
    SELECT COUNT(*) INTO v_draft_count
    FROM associate_payment_statements
    WHERE cut_period_id = p_cut_period_id
      AND status_id = 6;  -- DRAFT
    
    IF v_draft_count = 0 THEN
        RAISE EXCEPTION 'No hay statements en DRAFT para finalizar en periodo %', v_period_code;
    END IF;
    
    RAISE NOTICE 'üîí Finalizando % statements en periodo %', v_draft_count, v_period_code;
    
    -- Cambiar estado de DRAFT (6) ‚Üí FINALIZED (7)
    UPDATE associate_payment_statements
    SET 
        status_id = 7,  -- FINALIZED
        updated_at = CURRENT_TIMESTAMP
    WHERE cut_period_id = p_cut_period_id
      AND status_id = 6;
    
    GET DIAGNOSTICS v_updated_count = ROW_COUNT;
    
    -- Calcular total finalizado
    SELECT COALESCE(SUM(total_amount_collected), 0) INTO v_total
    FROM associate_payment_statements
    WHERE cut_period_id = p_cut_period_id AND status_id = 7;
    
    RAISE NOTICE '‚úÖ Corte manual completado: % statements FINALIZADOS (bloqueados), Total: $%',
        v_updated_count, v_total;
    
    RAISE NOTICE 'üìß TODO: Enviar notificaciones a asociados';
    
    -- Retornar resumen
    RETURN QUERY SELECT v_updated_count, v_total, v_period_code;
END;
$_$;


--
-- Name: generate_amortization_schedule(numeric, numeric, integer, numeric, date); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_amortization_schedule(p_amount numeric, p_biweekly_payment numeric, p_term_biweeks integer, p_commission_rate numeric, p_start_date date) RETURNS TABLE(periodo integer, fecha_pago date, pago_cliente numeric, interes_cliente numeric, capital_cliente numeric, saldo_pendiente numeric, comision_socio numeric, pago_socio numeric, saldo_asociado numeric)
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
    v_current_date DATE;
    v_balance DECIMAL(12,2);
    v_associate_balance DECIMAL(12,2); -- ‚úÖ NUEVO
    v_total_interest DECIMAL(12,2);
    v_period_interest DECIMAL(10,2);
    v_period_principal DECIMAL(10,2);
    v_commission DECIMAL(10,2);
    v_payment_to_associate DECIMAL(10,2);
    v_is_day_15 BOOLEAN;
BEGIN
    -- Inicializar
    v_balance := p_amount;
    v_total_interest := (p_biweekly_payment * p_term_biweeks) - p_amount;
    v_current_date := p_start_date;
    
    -- Calcular comisi√≥n y pago al asociado (fijos por periodo)
    v_commission := p_amount * (p_commission_rate / 100);
    v_payment_to_associate := p_biweekly_payment - v_commission;
    
    -- Inicializar saldo asociado (Total a pagar por asociado)
    v_associate_balance := v_payment_to_associate * p_term_biweeks;

    -- Generar cronograma completo
    FOR v_period IN 1..p_term_biweeks LOOP
        -- Calcular inter√©s y capital del per√≠odo (distribuci√≥n proporcional)
        v_period_interest := v_total_interest / p_term_biweeks;
        v_period_principal := p_biweekly_payment - v_period_interest;

        -- Actualizar saldo cliente
        v_balance := v_balance - v_period_principal;
        IF v_balance < 0.01 THEN v_balance := 0; END IF;
        
        -- Actualizar saldo asociado
        v_associate_balance := v_associate_balance - v_payment_to_associate;
        IF v_associate_balance < 0.01 THEN v_associate_balance := 0; END IF;

        -- Retornar fila
        RETURN QUERY SELECT
            v_period,
            v_current_date,
            p_biweekly_payment,
            ROUND(v_period_interest, 2),
            ROUND(v_period_principal, 2),
            ROUND(v_balance, 2),
            ROUND(v_commission, 2),
            ROUND(v_payment_to_associate, 2),
            ROUND(v_associate_balance, 2); -- ‚úÖ RETORNAR NUEVO SALDO

        -- Calcular siguiente fecha
        v_is_day_15 := EXTRACT(DAY FROM v_current_date) = 15;

        IF v_is_day_15 THEN
            v_current_date := (DATE_TRUNC('month', v_current_date) + INTERVAL '1 month' - INTERVAL '1 day')::DATE;
        ELSE
            v_current_date := MAKE_DATE(
                EXTRACT(YEAR FROM v_current_date + INTERVAL '1 month')::INTEGER,
                EXTRACT(MONTH FROM v_current_date + INTERVAL '1 month')::INTEGER,
                15
            );
        END IF;
    END LOOP;
END;
$$;


--
-- Name: generate_loan_summary(numeric, integer, numeric, numeric); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_loan_summary(p_amount numeric, p_term_biweeks integer, p_interest_rate numeric, p_commission_rate numeric) RETURNS TABLE(capital numeric, plazo_quincenas integer, tasa_interes_quincenal numeric, tasa_comision numeric, pago_quincenal_cliente numeric, pago_total_cliente numeric, interes_total_cliente numeric, tasa_efectiva_cliente numeric, comision_por_pago numeric, comision_total_socio numeric, pago_quincenal_socio numeric, pago_total_socio numeric)
    LANGUAGE plpgsql IMMUTABLE
    AS $$
DECLARE
    v_factor DECIMAL(10,6);
    v_total_cliente DECIMAL(12,2);
    v_pago_q_cliente DECIMAL(10,2);
    v_interes_cliente DECIMAL(12,2);
    v_comision_por_pago DECIMAL(10,2);
    v_comision_total DECIMAL(12,2);
    v_pago_q_socio DECIMAL(10,2);
BEGIN
    -- Calcular CLIENTE (Inter√©s Simple)
    v_factor := 1 + (p_interest_rate / 100) * p_term_biweeks;
    v_total_cliente := p_amount * v_factor;
    v_pago_q_cliente := v_total_cliente / p_term_biweeks;
    v_interes_cliente := v_total_cliente - p_amount;
    
    -- Calcular SOCIO (Comisi√≥n sobre pago del cliente)
    v_comision_por_pago := v_pago_q_cliente * (p_commission_rate / 100);
    v_comision_total := v_comision_por_pago * p_term_biweeks;
    v_pago_q_socio := v_pago_q_cliente - v_comision_por_pago;
    
    RETURN QUERY SELECT
        p_amount AS capital,
        p_term_biweeks AS plazo_quincenas,
        
        p_interest_rate AS tasa_interes_quincenal,
        p_commission_rate AS tasa_comision,
        
        ROUND(v_pago_q_cliente, 2) AS pago_quincenal_cliente,
        ROUND(v_total_cliente, 2) AS pago_total_cliente,
        ROUND(v_interes_cliente, 2) AS interes_total_cliente,
        ROUND(((v_interes_cliente / p_amount * 100)::NUMERIC), 2) AS tasa_efectiva_cliente,
        
        ROUND(v_comision_por_pago, 2) AS comision_por_pago,
        ROUND(v_comision_total, 2) AS comision_total_socio,
        ROUND(v_pago_q_socio, 2) AS pago_quincenal_socio,
        ROUND(v_pago_q_socio * p_term_biweeks, 2) AS pago_total_socio;
END;
$$;


--
-- Name: generate_payment_schedule(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.generate_payment_schedule() RETURNS trigger
    LANGUAGE plpgsql
    AS $_$
DECLARE
    v_approval_date DATE;
    v_first_payment_date DATE;
    v_approved_status_id INTEGER;
    v_pending_status_id INTEGER;
    v_amortization_row RECORD;
    v_period_id INTEGER;
    v_total_inserted INTEGER := 0;
    v_sum_expected DECIMAL(12,2) := 0;
    v_start_time TIMESTAMP;
    v_end_time TIMESTAMP;
    v_total_associate_payment DECIMAL(12,2);
    v_cumulative_associate_paid DECIMAL(12,2) := 0;
    v_commission_rate_for_function DECIMAL(10,4);
    v_payment_day INTEGER;
    v_target_cut_day INTEGER;
    v_month_name VARCHAR(3);
    v_year_str VARCHAR(4);
    v_target_cut_code VARCHAR(20);
BEGIN
    -- Get status IDs
    SELECT id INTO v_approved_status_id FROM loan_statuses WHERE name = 'APPROVED';
    SELECT id INTO v_pending_status_id FROM payment_statuses WHERE name = 'PENDING';

    IF v_approved_status_id IS NULL THEN
        RAISE EXCEPTION 'CRITICAL: loan_statuses.APPROVED not found';
    END IF;

    IF v_pending_status_id IS NULL THEN
        RAISE EXCEPTION 'CRITICAL: payment_statuses.PENDING not found';
    END IF;

    -- Only execute if loan just got approved
    IF NEW.status_id = v_approved_status_id
       AND (OLD.status_id IS NULL OR OLD.status_id != v_approved_status_id)
    THEN
        v_start_time := CLOCK_TIMESTAMP();

        -- Validations
        IF NEW.approved_at IS NULL THEN
            RAISE EXCEPTION 'CRITICAL: Loan % marked as APPROVED but approved_at is NULL', NEW.id;
        END IF;

        IF NEW.term_biweeks IS NULL OR NEW.term_biweeks <= 0 THEN
            RAISE EXCEPTION 'CRITICAL: Loan % has invalid term_biweeks: %', NEW.id, NEW.term_biweeks;
        END IF;

        IF NEW.biweekly_payment IS NULL THEN
            RAISE EXCEPTION 'CRITICAL: Loan % does not have biweekly_payment calculated', NEW.id;
        END IF;

        v_approval_date := NEW.approved_at::DATE;
        v_first_payment_date := calculate_first_payment_date(v_approval_date);

        -- FIX: Calculate correct commission rate for the function
        IF COALESCE(NEW.commission_per_payment, 0) > 0 AND NEW.amount > 0 THEN
            v_commission_rate_for_function := (NEW.commission_per_payment / NEW.amount) * 100;
        ELSE
            v_commission_rate_for_function := 0;
        END IF;

        RAISE NOTICE 'Generating schedule for loan %: Amount=$%, Term=%, Biweekly=$%, CommPerPmt=$%, Profile=%',
            NEW.id, NEW.amount, NEW.term_biweeks, NEW.biweekly_payment,
            COALESCE(NEW.commission_per_payment, 0), COALESCE(NEW.profile_code, 'N/A');

        -- Calculate total associate payment for this loan
        SELECT SUM(pago_socio) INTO v_total_associate_payment
        FROM generate_amortization_schedule(
            NEW.amount,
            NEW.biweekly_payment,
            NEW.term_biweeks,
            v_commission_rate_for_function,
            v_first_payment_date
        );

        -- Generate complete schedule with breakdown
        FOR v_amortization_row IN
            SELECT
                periodo,
                fecha_pago,
                pago_cliente,
                interes_cliente,
                capital_cliente,
                saldo_pendiente,
                comision_socio,
                pago_socio
            FROM generate_amortization_schedule(
                NEW.amount,
                NEW.biweekly_payment,
                NEW.term_biweeks,
                v_commission_rate_for_function,
                v_first_payment_date
            )
        LOOP
            -- NUEVA L√ìGICA: Asignar per√≠odo basado en d√≠a de vencimiento
            v_payment_day := EXTRACT(DAY FROM v_amortization_row.fecha_pago);
            
            IF v_payment_day = 15 THEN
                v_target_cut_day := 8;
            ELSE
                v_target_cut_day := 23;
            END IF;
            
            -- Construir el cut_code esperado: MonDD-YYYY
            v_month_name := TO_CHAR(v_amortization_row.fecha_pago, 'Mon');
            v_year_str := TO_CHAR(v_amortization_row.fecha_pago, 'YYYY');
            v_target_cut_code := v_month_name || LPAD(v_target_cut_day::text, 2, '0') || '-' || v_year_str;
            
            -- Buscar el per√≠odo de corte por cut_code
            SELECT id INTO v_period_id
            FROM cut_periods
            WHERE cut_code = v_target_cut_code
            LIMIT 1;

            IF v_period_id IS NULL THEN
                RAISE WARNING 'No cut_period found with code %. Inserting with period_id = NULL',
                    v_target_cut_code;
            ELSE
                RAISE NOTICE 'Payment due % -> assigned to period % (%)',
                    v_amortization_row.fecha_pago, v_target_cut_code, v_period_id;
            END IF;

            -- Calculate cumulative associate paid
            v_cumulative_associate_paid := v_cumulative_associate_paid + v_amortization_row.pago_socio;

            -- Insert payment
            INSERT INTO payments (
                loan_id, payment_number, expected_amount, amount_paid,
                interest_amount, principal_amount, commission_amount, associate_payment,
                balance_remaining, associate_balance_remaining,
                payment_date, payment_due_date, is_late, status_id, cut_period_id,
                created_at, updated_at
            ) VALUES (
                NEW.id, v_amortization_row.periodo, v_amortization_row.pago_cliente, 0.00,
                v_amortization_row.interes_cliente, v_amortization_row.capital_cliente,
                v_amortization_row.comision_socio, v_amortization_row.pago_socio,
                v_amortization_row.saldo_pendiente, v_total_associate_payment - v_cumulative_associate_paid,
                v_amortization_row.fecha_pago, v_amortization_row.fecha_pago, false,
                v_pending_status_id, v_period_id, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP
            );

            v_total_inserted := v_total_inserted + 1;
            v_sum_expected := v_sum_expected + v_amortization_row.pago_cliente;
        END LOOP;

        v_end_time := CLOCK_TIMESTAMP();

        IF v_total_inserted != NEW.term_biweeks THEN
            RAISE EXCEPTION 'INCONSISTENCY: Inserted % payments but expected %',
                v_total_inserted, NEW.term_biweeks;
        END IF;

        RAISE NOTICE 'Schedule generated: % payments, Total expected: $%, Time: % ms',
            v_total_inserted, v_sum_expected,
            EXTRACT(MILLISECONDS FROM (v_end_time - v_start_time));

    END IF;

    RETURN NEW;

EXCEPTION
    WHEN OTHERS THEN
        RAISE EXCEPTION 'CRITICAL ERROR generating payment schedule for loan %: % (%). SQLState: %',
            NEW.id, SQLERRM, SQLSTATE, SQLSTATE;
        RETURN NULL;
END;
$_$;


--
-- Name: get_cut_period_for_payment(date); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_cut_period_for_payment(p_payment_date date) RETURNS integer
    LANGUAGE plpgsql IMMUTABLE STRICT
    AS $$
DECLARE
    v_period_id INTEGER;
    v_day INTEGER;
    v_month INTEGER;
    v_year INTEGER;
BEGIN
    v_day := EXTRACT(DAY FROM p_payment_date)::INTEGER;
    v_month := EXTRACT(MONTH FROM p_payment_date)::INTEGER;
    v_year := EXTRACT(YEAR FROM p_payment_date)::INTEGER;
    
    -- Determinar si es d√≠a 15 o √∫ltimo d√≠a del mes
    IF v_day = 15 THEN
        -- Pago d√≠a 15 ‚Üí Buscar periodo que cierra d√≠a 7-8 (aproximado) ANTES del d√≠a 15
        SELECT id INTO v_period_id
        FROM cut_periods
        WHERE EXTRACT(DAY FROM period_end_date) BETWEEN 6 AND 8  -- Cierra ~d√≠a 7
          AND period_end_date < p_payment_date  -- Cierra ANTES del vencimiento
          AND EXTRACT(MONTH FROM period_end_date) = v_month  -- Mismo mes
          AND EXTRACT(YEAR FROM period_end_date) = v_year
        ORDER BY period_end_date DESC
        LIMIT 1;
        
        -- Si no encontr√≥ en el mismo mes, buscar a fin del mes anterior
        IF v_period_id IS NULL THEN
            SELECT id INTO v_period_id
            FROM cut_periods
            WHERE EXTRACT(DAY FROM period_end_date) BETWEEN 6 AND 8
              AND period_end_date < p_payment_date
              AND (
                  (EXTRACT(MONTH FROM period_end_date) = v_month - 1 AND EXTRACT(YEAR FROM period_end_date) = v_year) OR
                  (v_month = 1 AND EXTRACT(MONTH FROM period_end_date) = 12 AND EXTRACT(YEAR FROM period_end_date) = v_year - 1)
              )
            ORDER BY period_end_date DESC
            LIMIT 1;
        END IF;
        
    ELSE
        -- Pago √∫ltimo d√≠a ‚Üí Buscar periodo que cierra d√≠a 22-23 ANTES del √∫ltimo d√≠a
        SELECT id INTO v_period_id
        FROM cut_periods
        WHERE EXTRACT(DAY FROM period_end_date) BETWEEN 21 AND 23  -- Cierra ~d√≠a 22
          AND period_end_date < p_payment_date  -- Cierra ANTES del vencimiento
          AND EXTRACT(MONTH FROM period_end_date) = v_month  -- Mismo mes
          AND EXTRACT(YEAR FROM period_end_date) = v_year
        ORDER BY period_end_date DESC
        LIMIT 1;
    END IF;
    
    -- Si a√∫n no encontr√≥, usar l√≥gica de fallback (contenci√≥n)
    IF v_period_id IS NULL THEN
        RAISE WARNING 'No se encontr√≥ periodo con cierre antes de %. Usando fallback.', p_payment_date;
        SELECT id INTO v_period_id
        FROM cut_periods
        WHERE period_start_date <= p_payment_date
          AND period_end_date >= p_payment_date
        ORDER BY period_start_date DESC
        LIMIT 1;
    END IF;
    
    RETURN v_period_id;
END;
$$;


--
-- Name: get_debt_payment_detail(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_debt_payment_detail(p_debt_payment_id integer) RETURNS TABLE(breakdown_id integer, cut_period_id integer, period_description character varying, original_amount numeric, amount_applied numeric, liquidated boolean, remaining_amount numeric)
    LANGUAGE plpgsql
    AS $$
BEGIN
    RETURN QUERY
    SELECT 
        (item->>'breakdown_id')::INTEGER AS breakdown_id,
        (item->>'cut_period_id')::INTEGER AS cut_period_id,
        COALESCE(
            cp.description,
            'Per√≠odo ' || TO_CHAR(cp.start_date, 'DD/MM/YYYY') || ' - ' || TO_CHAR(cp.end_date, 'DD/MM/YYYY')
        ) AS period_description,
        (item->>'original_amount')::DECIMAL(12,2) AS original_amount,
        (item->>'amount_applied')::DECIMAL(12,2) AS amount_applied,
        (item->>'liquidated')::BOOLEAN AS liquidated,
        COALESCE((item->>'remaining_amount')::DECIMAL(12,2), 0) AS remaining_amount
    FROM associate_debt_payments adp
    CROSS JOIN jsonb_array_elements(adp.applied_breakdown_items) AS item
    LEFT JOIN cut_periods cp ON cp.id = (item->>'cut_period_id')::INTEGER
    WHERE adp.id = p_debt_payment_id;
END;
$$;


--
-- Name: get_payment_history(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.get_payment_history(p_payment_id integer) RETURNS TABLE(change_id integer, old_status character varying, new_status character varying, change_type character varying, changed_by_username character varying, change_reason text, changed_at timestamp with time zone)
    LANGUAGE plpgsql STABLE
    AS $$
BEGIN
    RETURN QUERY
    SELECT 
        psh.id,
        ps_old.name,
        ps_new.name,
        psh.change_type,
        u.username,
        psh.change_reason,
        psh.changed_at
    FROM payment_status_history psh
    LEFT JOIN payment_statuses ps_old ON psh.old_status_id = ps_old.id
    JOIN payment_statuses ps_new ON psh.new_status_id = ps_new.id
    LEFT JOIN users u ON psh.changed_by = u.id
    WHERE psh.payment_id = p_payment_id
    ORDER BY psh.changed_at DESC;
END;
$$;


--
-- Name: handle_loan_approval_status(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.handle_loan_approval_status() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_approved_status_id INTEGER;
    v_rejected_status_id INTEGER;
BEGIN
    -- Obtener IDs de estados APPROVED y REJECTED
    SELECT id INTO v_approved_status_id FROM loan_statuses WHERE name = 'APPROVED';
    SELECT id INTO v_rejected_status_id FROM loan_statuses WHERE name = 'REJECTED';
    
    -- Si cambi√≥ a APPROVED, setear timestamp
    IF NEW.status_id = v_approved_status_id AND (OLD.status_id IS NULL OR OLD.status_id != v_approved_status_id) AND NEW.approved_at IS NULL THEN
        NEW.approved_at = CURRENT_TIMESTAMP;
    END IF;
    
    -- Si cambi√≥ a REJECTED, setear timestamp  
    IF NEW.status_id = v_rejected_status_id AND (OLD.status_id IS NULL OR OLD.status_id != v_rejected_status_id) AND NEW.rejected_at IS NULL THEN
        NEW.rejected_at = CURRENT_TIMESTAMP;
    END IF;
    
    RETURN NEW;
END;
$$;


--
-- Name: log_payment_status_change(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.log_payment_status_change() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_change_type VARCHAR(50);
    v_changed_by INTEGER;
BEGIN
    -- Solo registrar si el status_id cambi√≥
    IF OLD.status_id IS DISTINCT FROM NEW.status_id THEN
        
        -- Determinar tipo de cambio
        IF NEW.marked_by IS NOT NULL THEN
            v_change_type := 'MANUAL_ADMIN';
            v_changed_by := NEW.marked_by;
        ELSE
            v_change_type := 'AUTOMATIC';
            v_changed_by := NULL;
        END IF;
        
        -- Insertar en historial
        INSERT INTO payment_status_history (
            payment_id,
            old_status_id,
            new_status_id,
            change_type,
            changed_by,
            change_reason,
            changed_at
        ) VALUES (
            NEW.id,
            OLD.status_id,
            NEW.status_id,
            v_change_type,
            v_changed_by,
            NEW.marking_notes,
            CURRENT_TIMESTAMP
        );
    END IF;
    
    RETURN NEW;
END;
$$;


--
-- Name: renew_loan(integer, numeric, integer, numeric, numeric, integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.renew_loan(p_original_loan_id integer, p_new_amount numeric, p_new_term_biweeks integer, p_interest_rate numeric, p_commission_rate numeric, p_created_by integer) RETURNS integer
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_client_user_id INTEGER;
    v_associate_user_id INTEGER;
    v_pending_balance DECIMAL(12,2);
    v_new_loan_id INTEGER;
    v_pending_status_id INTEGER;
BEGIN
    -- Obtener datos del pr√©stamo original
    SELECT 
        user_id,
        associate_user_id
    INTO 
        v_client_user_id,
        v_associate_user_id
    FROM loans
    WHERE id = p_original_loan_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Pr√©stamo original % no encontrado', p_original_loan_id;
    END IF;
    
    -- Calcular saldo pendiente
    v_pending_balance := calculate_loan_remaining_balance(p_original_loan_id);
    
    -- Obtener ID del estado PENDING
    SELECT id INTO v_pending_status_id FROM loan_statuses WHERE name = 'PENDING';
    
    -- Crear nuevo pr√©stamo
    INSERT INTO loans (
        user_id,
        associate_user_id,
        amount,
        interest_rate,
        commission_rate,
        term_biweeks,
        status_id,
        notes,
        created_at
    ) VALUES (
        v_client_user_id,
        v_associate_user_id,
        p_new_amount,
        p_interest_rate,
        p_commission_rate,
        p_new_term_biweeks,
        v_pending_status_id,
        'Renovaci√≥n de pr√©stamo #' || p_original_loan_id || '. Saldo pendiente: ' || v_pending_balance,
        CURRENT_TIMESTAMP
    ) RETURNING id INTO v_new_loan_id;
    
    -- Registrar la renovaci√≥n
    INSERT INTO loan_renewals (
        original_loan_id,
        renewed_loan_id,
        renewal_date,
        pending_balance,
        new_amount,
        reason,
        created_by
    ) VALUES (
        p_original_loan_id,
        v_new_loan_id,
        CURRENT_DATE,
        v_pending_balance,
        p_new_amount,
        'Renovaci√≥n est√°ndar',
        p_created_by
    );
    
    RAISE NOTICE '‚úÖ Pr√©stamo % renovado como pr√©stamo %. Saldo pendiente: %, Nuevo monto: %',
        p_original_loan_id, v_new_loan_id, v_pending_balance, p_new_amount;
    
    RETURN v_new_loan_id;
END;
$$;


--
-- Name: report_defaulted_client(integer, integer, integer, numeric, text, character varying); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.report_defaulted_client(p_associate_profile_id integer, p_loan_id integer, p_reported_by integer, p_total_debt_amount numeric, p_evidence_details text, p_evidence_file_path character varying DEFAULT NULL::character varying) RETURNS integer
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_client_user_id INTEGER;
    v_report_id INTEGER;
BEGIN
    -- Obtener ID del cliente desde el pr√©stamo
    SELECT user_id INTO v_client_user_id
    FROM loans
    WHERE id = p_loan_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Pr√©stamo % no encontrado', p_loan_id;
    END IF;
    
    -- Insertar reporte de morosidad
    INSERT INTO defaulted_client_reports (
        associate_profile_id,
        loan_id,
        client_user_id,
        reported_by,
        total_debt_amount,
        evidence_details,
        evidence_file_path,
        status
    ) VALUES (
        p_associate_profile_id,
        p_loan_id,
        v_client_user_id,
        p_reported_by,
        p_total_debt_amount,
        p_evidence_details,
        p_evidence_file_path,
        'PENDING'
    ) RETURNING id INTO v_report_id;
    
    RAISE NOTICE 'üìã Reporte de morosidad creado: ID %, Cliente %, Deuda: %', 
        v_report_id, v_client_user_id, p_total_debt_amount;
    
    RETURN v_report_id;
END;
$$;


--
-- Name: revert_last_payment_change(integer, integer, text); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.revert_last_payment_change(p_payment_id integer, p_admin_user_id integer, p_reason text) RETURNS void
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_last_old_status_id INTEGER;
    v_current_status_id INTEGER;
BEGIN
    -- Obtener estado actual
    SELECT status_id INTO v_current_status_id
    FROM payments
    WHERE id = p_payment_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Pago % no encontrado', p_payment_id;
    END IF;
    
    -- Obtener el estado anterior (√∫ltimo cambio)
    SELECT old_status_id INTO v_last_old_status_id
    FROM payment_status_history
    WHERE payment_id = p_payment_id
    ORDER BY changed_at DESC
    LIMIT 1;
    
    IF v_last_old_status_id IS NULL THEN
        RAISE EXCEPTION 'No hay historial previo para revertir el pago %', p_payment_id;
    END IF;
    
    -- Revertir al estado anterior
    UPDATE payments
    SET 
        status_id = v_last_old_status_id,
        marked_by = p_admin_user_id,
        marked_at = CURRENT_TIMESTAMP,
        marking_notes = 'REVERSI√ìN: ' || p_reason,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = p_payment_id;
    
    RAISE NOTICE 'Pago % revertido de estado % a estado % por usuario %', 
        p_payment_id, v_current_status_id, v_last_old_status_id, p_admin_user_id;
END;
$$;


--
-- Name: simulate_loan(numeric, integer, character varying, date); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.simulate_loan(p_amount numeric, p_term_biweeks integer, p_profile_code character varying, p_approval_date date DEFAULT CURRENT_DATE) RETURNS TABLE(payment_number integer, payment_date date, cut_period_code character varying, client_payment numeric, associate_payment numeric, commission_amount numeric, remaining_balance numeric, associate_remaining_balance numeric)
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
    v_calc RECORD;
    v_current_date DATE;
    v_balance DECIMAL(12,2);
    v_associate_balance DECIMAL(12,2); -- ‚úÖ NUEVO
    v_cut_code VARCHAR(20);
    v_period_capital DECIMAL(12,2);
    v_period_id INTEGER;
    i INTEGER;
BEGIN
    -- Obtener c√°lculos del perfil
    SELECT * INTO v_calc
    FROM calculate_loan_payment(p_amount, p_term_biweeks, p_profile_code);

    IF NOT FOUND THEN
        RAISE EXCEPTION 'Perfil % no encontrado', p_profile_code;
    END IF;

    v_current_date := calculate_first_payment_date(p_approval_date);
    v_balance := p_amount;
    
    -- Inicializar saldo asociado
    v_associate_balance := v_calc.associate_payment * p_term_biweeks;

    v_period_capital := p_amount / p_term_biweeks;

    FOR i IN 1..p_term_biweeks LOOP
        v_period_id := get_cut_period_for_payment(v_current_date);

        IF v_period_id IS NOT NULL THEN
            SELECT cut_code INTO v_cut_code FROM cut_periods WHERE id = v_period_id;
        ELSE
            v_cut_code := EXTRACT(YEAR FROM v_current_date)::TEXT || '-Q' || LPAD(CEIL(EXTRACT(DOY FROM v_current_date) / 15)::TEXT, 2, '0');
        END IF;

        v_balance := v_balance - v_period_capital;
        IF v_balance < 0.01 THEN v_balance := 0; END IF;
        
        -- Actualizar saldo asociado
        v_associate_balance := v_associate_balance - v_calc.associate_payment;
        IF v_associate_balance < 0.01 THEN v_associate_balance := 0; END IF;

        RETURN QUERY SELECT
            i::INTEGER,
            v_current_date::DATE,
            v_cut_code::VARCHAR(20),
            v_calc.biweekly_payment::DECIMAL(10,2),
            v_calc.associate_payment::DECIMAL(10,2),
            v_calc.commission_per_payment::DECIMAL(10,2),
            v_balance::DECIMAL(12,2),
            v_associate_balance::DECIMAL(12,2); -- ‚úÖ RETORNAR

        IF EXTRACT(DAY FROM v_current_date) = 15 THEN
            v_current_date := (DATE_TRUNC('month', v_current_date) + INTERVAL '1 month' - INTERVAL '1 day')::DATE;
        ELSE
            v_current_date := MAKE_DATE(
                EXTRACT(YEAR FROM v_current_date + INTERVAL '1 month')::INTEGER,
                EXTRACT(MONTH FROM v_current_date + INTERVAL '1 month')::INTEGER,
                15
            );
        END IF;
    END LOOP;
END;
$$;


--
-- Name: simulate_loan_complete(numeric, integer, character varying, date); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.simulate_loan_complete(p_amount numeric, p_term_biweeks integer, p_profile_code character varying, p_approval_date date DEFAULT CURRENT_DATE) RETURNS TABLE(section_type character varying, label character varying, value_text character varying, value_numeric numeric, payment_num integer, payment_date date, cut_code character varying, client_pay numeric, associate_pay numeric, commission numeric, balance numeric)
    LANGUAGE plpgsql STABLE
    AS $_$
DECLARE
    v_calc RECORD;
    v_profile RECORD;
BEGIN
    -- Obtener informaci√≥n del perfil y c√°lculos
    SELECT 
        rp.name as profile_name,
        c.*
    INTO v_calc
    FROM calculate_loan_payment(p_amount, p_term_biweeks, p_profile_code) c
    JOIN rate_profiles rp ON rp.code = p_profile_code;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Perfil % no encontrado o deshabilitado', p_profile_code;
    END IF;
    
    -- =========================================================================
    -- SECCI√ìN 1: RESUMEN DEL PR√âSTAMO
    -- =========================================================================
    RETURN QUERY SELECT
        'RESUMEN'::VARCHAR(20),
        'Perfil'::VARCHAR(100),
        v_calc.profile_name::VARCHAR(100),
        NULL::DECIMAL(12,2),
        NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),
        NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);
    
    RETURN QUERY SELECT
        'RESUMEN'::VARCHAR(20), 'Monto Solicitado'::VARCHAR(100),
        ('$' || p_amount::TEXT)::VARCHAR(100), p_amount,
        NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),
        NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);
    
    RETURN QUERY SELECT
        'RESUMEN'::VARCHAR(20), 'Plazo'::VARCHAR(100),
        (p_term_biweeks || ' quincenas')::VARCHAR(100), p_term_biweeks::DECIMAL(12,2),
        NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),
        NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);
    
    RETURN QUERY SELECT
        'RESUMEN'::VARCHAR(20), 'Tasa de Inter√©s'::VARCHAR(100),
        (v_calc.interest_rate_percent || '%')::VARCHAR(100), v_calc.interest_rate_percent,
        NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),
        NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);
    
    RETURN QUERY SELECT
        'RESUMEN'::VARCHAR(20), 'Tasa de Comisi√≥n'::VARCHAR(100),
        (v_calc.commission_rate_percent || '%')::VARCHAR(100), v_calc.commission_rate_percent,
        NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),
        NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);
    
    RETURN QUERY SELECT
        'RESUMEN'::VARCHAR(20), 'Fecha de Aprobaci√≥n'::VARCHAR(100),
        TO_CHAR(p_approval_date, 'DD/MM/YYYY')::VARCHAR(100), NULL::DECIMAL(12,2),
        NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),
        NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);
    
    -- Totales
    RETURN QUERY SELECT
        'TOTALES'::VARCHAR(20), 'Pago Quincenal Cliente'::VARCHAR(100),
        ('$' || v_calc.biweekly_payment::TEXT)::VARCHAR(100), v_calc.biweekly_payment,
        NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),
        NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);
    
    RETURN QUERY SELECT
        'TOTALES'::VARCHAR(20), 'Total a Pagar (Cliente)'::VARCHAR(100),
        ('$' || v_calc.total_payment::TEXT)::VARCHAR(100), v_calc.total_payment,
        NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),
        NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);
    
    RETURN QUERY SELECT
        'TOTALES'::VARCHAR(20), 'Pago Quincenal Asociado'::VARCHAR(100),
        ('$' || v_calc.associate_payment::TEXT)::VARCHAR(100), v_calc.associate_payment,
        NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),
        NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);
    
    RETURN QUERY SELECT
        'TOTALES'::VARCHAR(20), 'Total Asociado ‚Üí CrediCuenta'::VARCHAR(100),
        ('$' || v_calc.associate_total::TEXT)::VARCHAR(100), v_calc.associate_total,
        NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),
        NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);
    
    RETURN QUERY SELECT
        'TOTALES'::VARCHAR(20), 'Comisi√≥n por Pago'::VARCHAR(100),
        ('$' || v_calc.commission_per_payment::TEXT)::VARCHAR(100), v_calc.commission_per_payment,
        NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),
        NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);
    
    RETURN QUERY SELECT
        'TOTALES'::VARCHAR(20), 'Comisi√≥n Total Asociado'::VARCHAR(100),
        ('$' || v_calc.total_commission::TEXT)::VARCHAR(100), v_calc.total_commission,
        NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),
        NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);
    
    -- =========================================================================
    -- SECCI√ìN 2: TABLA DE AMORTIZACI√ìN
    -- =========================================================================
    RETURN QUERY 
    SELECT 
        'AMORTIZACI√ìN'::VARCHAR(20),
        NULL::VARCHAR(100),
        NULL::VARCHAR(100),
        NULL::DECIMAL(12,2),
        s.payment_number,
        s.payment_date,
        s.cut_period_code,
        s.client_payment,
        s.associate_payment,
        s.commission_amount,
        s.remaining_balance
    FROM simulate_loan(p_amount, p_term_biweeks, p_profile_code, p_approval_date) s;
END;
$_$;


--
-- Name: simulate_loan_custom(numeric, integer, numeric, numeric, date); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.simulate_loan_custom(p_amount numeric, p_term_biweeks integer, p_interest_rate numeric, p_commission_rate numeric, p_approval_date date DEFAULT CURRENT_DATE) RETURNS TABLE(payment_number integer, payment_date date, cut_period_code character varying, client_payment numeric, associate_payment numeric, commission_amount numeric, remaining_balance numeric)
    LANGUAGE plpgsql STABLE
    AS $$
DECLARE
    v_calc RECORD;
    v_current_date DATE;
    v_balance DECIMAL(12,2);
    v_cut_code VARCHAR(20);
    v_period_capital DECIMAL(12,2);
    i INTEGER;
BEGIN
    -- Obtener c√°lculos con tasas custom
    SELECT * INTO v_calc
    FROM calculate_loan_payment_custom(p_amount, p_term_biweeks, p_interest_rate, p_commission_rate);
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Error al calcular pr√©stamo custom';
    END IF;
    
    -- Calcular primera fecha de pago usando el or√°culo
    v_current_date := calculate_first_payment_date(p_approval_date);
    v_balance := p_amount;
    
    -- Calcular abono a capital por periodo (inter√©s distribuido uniformemente)
    v_period_capital := p_amount / p_term_biweeks;
    
    -- Generar tabla de amortizaci√≥n
    FOR i IN 1..p_term_biweeks LOOP
        -- ‚≠ê CORRECCI√ìN CR√çTICA: Buscar per√≠odo de corte REAL donde cae el pago
        -- Un pago pertenece al per√≠odo donde payment_date est√° entre start y end
        SELECT cp.cut_code INTO v_cut_code
        FROM cut_periods cp
        WHERE v_current_date >= cp.period_start_date 
          AND v_current_date <= cp.period_end_date
        LIMIT 1;
        
        -- Si no encuentra per√≠odo (ej: simulaci√≥n muy futura), usar c√≥digo gen√©rico
        IF v_cut_code IS NULL THEN
            -- Formato: YYYY-QXX (a√±o-n√∫mero quincenal)
            v_cut_code := EXTRACT(YEAR FROM v_current_date)::TEXT || '-Q' || 
                LPAD(CEIL(EXTRACT(DOY FROM v_current_date) / 15)::TEXT, 2, '0');
        END IF;
        
        -- Calcular saldo restante (disminuye por el abono a capital)
        v_balance := v_balance - v_period_capital;
        IF v_balance < 0.01 THEN
            v_balance := 0;
        END IF;
        
        RETURN QUERY SELECT
            i,
            v_current_date,
            v_cut_code,
            v_calc.biweekly_payment,
            v_calc.associate_payment,
            v_calc.commission_per_payment,
            v_balance;
        
        -- ‚≠ê L√ìGICA DEL CALENDARIO: Alternar entre d√≠a 15 y √∫ltimo d√≠a del mes
        IF EXTRACT(DAY FROM v_current_date) = 15 THEN
            -- Si estamos en d√≠a 15, siguiente pago es el √∫ltimo d√≠a del mes ACTUAL
            v_current_date := (DATE_TRUNC('month', v_current_date) + INTERVAL '1 month' - INTERVAL '1 day')::DATE;
        ELSE
            -- Si estamos en √∫ltimo d√≠a, siguiente pago es el 15 del mes SIGUIENTE
            v_current_date := MAKE_DATE(
                EXTRACT(YEAR FROM v_current_date + INTERVAL '1 month')::INTEGER,
                EXTRACT(MONTH FROM v_current_date + INTERVAL '1 month')::INTEGER,
                15
            );
        END IF;
    END LOOP;
    
    RETURN;
END;
$$;


--
-- Name: sync_associate_debt_balance(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.sync_associate_debt_balance(p_associate_profile_id integer) RETURNS numeric
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_user_id INTEGER;
    v_total_debt DECIMAL(12,2);
BEGIN
    -- Obtener user_id del perfil
    SELECT user_id INTO v_user_id
    FROM associate_profiles WHERE id = p_associate_profile_id;
    
    IF v_user_id IS NULL THEN
        RAISE EXCEPTION 'Associate profile % not found', p_associate_profile_id;
    END IF;
    
    -- Calcular deuda total desde accumulated_balances
    SELECT COALESCE(SUM(accumulated_debt), 0)
    INTO v_total_debt
    FROM associate_accumulated_balances
    WHERE user_id = v_user_id;
    
    -- Actualizar debt_balance en associate_profiles
    UPDATE associate_profiles
    SET 
        debt_balance = v_total_debt,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = p_associate_profile_id;
    
    RETURN v_total_debt;
END;
$$;


--
-- Name: trigger_update_associate_credit_on_level_change(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_update_associate_credit_on_level_change() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_new_credit_limit DECIMAL(12,2);
BEGIN
    IF NEW.level_id != OLD.level_id THEN
        SELECT credit_limit INTO v_new_credit_limit
        FROM associate_levels
        WHERE id = NEW.level_id;
        
        UPDATE associate_profiles
        SET credit_limit = v_new_credit_limit,
            credit_last_updated = CURRENT_TIMESTAMP
        WHERE id = NEW.id;
        
        RAISE NOTICE 'L√≠mite de cr√©dito del asociado % actualizado a %', NEW.id, v_new_credit_limit;
    END IF;
    
    RETURN NEW;
END;
$$;


--
-- Name: trigger_update_associate_credit_on_loan_approval(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_update_associate_credit_on_loan_approval() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_associate_profile_id INTEGER;
    v_approved_status_id INTEGER;
BEGIN
    SELECT id INTO v_approved_status_id FROM loan_statuses WHERE name = 'APPROVED';
    
    IF NEW.status_id = v_approved_status_id AND (OLD.status_id IS NULL OR OLD.status_id != v_approved_status_id) THEN
        IF NEW.associate_user_id IS NOT NULL THEN
            SELECT id INTO v_associate_profile_id
            FROM associate_profiles
            WHERE user_id = NEW.associate_user_id;
            
            IF v_associate_profile_id IS NOT NULL THEN
                UPDATE associate_profiles
                SET credit_used = credit_used + NEW.amount,
                    credit_last_updated = CURRENT_TIMESTAMP
                WHERE id = v_associate_profile_id;
                
                RAISE NOTICE 'Cr√©dito del asociado % actualizado: +%', v_associate_profile_id, NEW.amount;
            END IF;
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$;


--
-- Name: trigger_update_associate_credit_on_payment(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.trigger_update_associate_credit_on_payment() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_associate_user_id INTEGER;
    v_associate_profile_id INTEGER;
    v_amount_diff DECIMAL(12,2);
BEGIN
    IF NEW.amount_paid != OLD.amount_paid THEN
        SELECT associate_user_id INTO v_associate_user_id
        FROM loans
        WHERE id = NEW.loan_id;
        
        IF v_associate_user_id IS NOT NULL THEN
            SELECT id INTO v_associate_profile_id
            FROM associate_profiles
            WHERE user_id = v_associate_user_id;
            
            IF v_associate_profile_id IS NOT NULL THEN
                v_amount_diff := NEW.amount_paid - OLD.amount_paid;
                
                UPDATE associate_profiles
                SET credit_used = GREATEST(credit_used - v_amount_diff, 0),
                    credit_last_updated = CURRENT_TIMESTAMP
                WHERE id = v_associate_profile_id;
                
                RAISE NOTICE 'Cr√©dito del asociado % actualizado por pago: -%', v_associate_profile_id, v_amount_diff;
            END IF;
        END IF;
    END IF;
    
    RETURN NEW;
END;
$$;


--
-- Name: update_legacy_payment_table_timestamp(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_legacy_payment_table_timestamp() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$;


--
-- Name: update_statement_on_payment(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_statement_on_payment() RETURNS trigger
    LANGUAGE plpgsql
    AS $_$
DECLARE
    v_total_paid DECIMAL(12,2);
    v_total_owed DECIMAL(12,2);
    v_remaining DECIMAL(12,2);
    v_new_status_id INTEGER;
    v_associate_profile_id INTEGER;
BEGIN
    -- Calcular total pagado (suma de todos los abonos)
    SELECT COALESCE(SUM(payment_amount), 0)
    INTO v_total_paid
    FROM associate_statement_payments
    WHERE statement_id = NEW.statement_id;

    -- Obtener total adeudado a CrediCuenta (nuevo campo con nombre correcto)
    SELECT
        aps.total_to_credicuenta + aps.late_fee_amount,
        ap.id
    INTO v_total_owed, v_associate_profile_id
    FROM associate_payment_statements aps
    JOIN associate_profiles ap ON aps.user_id = ap.user_id
    WHERE aps.id = NEW.statement_id;

    IF v_total_owed IS NULL THEN
        RAISE EXCEPTION 'Statement % no encontrado', NEW.statement_id;
    END IF;

    v_remaining := v_total_owed - v_total_paid;

    -- Determinar nuevo estado
    IF v_remaining <= 0 THEN
        SELECT id INTO v_new_status_id FROM statement_statuses WHERE name = 'PAID';
    ELSIF v_total_paid > 0 THEN
        SELECT id INTO v_new_status_id FROM statement_statuses WHERE name = 'PARTIAL_PAID';
    END IF;

    -- Actualizar statement
    UPDATE associate_payment_statements
    SET paid_amount = v_total_paid,
        paid_date = CASE WHEN v_remaining <= 0 THEN CURRENT_DATE ELSE paid_date END,
        status_id = COALESCE(v_new_status_id, status_id),
        updated_at = CURRENT_TIMESTAMP
    WHERE id = NEW.statement_id;

    -- Liberar cr√©dito del asociado
    UPDATE associate_profiles
    SET debt_balance = GREATEST(debt_balance - NEW.payment_amount, 0),
        credit_last_updated = CURRENT_TIMESTAMP
    WHERE id = v_associate_profile_id;

    RAISE NOTICE 'üí∞ Statement #% | Pagado: $% | Debe: $% | Restante: $%',
        NEW.statement_id, v_total_paid, v_total_owed, v_remaining;

    RETURN NEW;
END;
$_$;


--
-- Name: update_updated_at_column(); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.update_updated_at_column() RETURNS trigger
    LANGUAGE plpgsql
    AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$;


--
-- Name: validate_loan_calculated_fields(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.validate_loan_calculated_fields(p_loan_id integer) RETURNS TABLE(campo text, valor_actual numeric, valor_esperado numeric, diferencia numeric, es_valido boolean)
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_loan RECORD;
BEGIN
    -- Obtener datos del pr√©stamo
    SELECT 
        amount, term_biweeks, biweekly_payment, total_payment,
        total_interest, commission_per_payment, associate_payment
    INTO v_loan
    FROM loans
    WHERE id = p_loan_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Pr√©stamo % no encontrado', p_loan_id;
    END IF;
    
    -- Validar total_payment = biweekly_payment * term_biweeks
    IF v_loan.total_payment IS NOT NULL AND v_loan.biweekly_payment IS NOT NULL THEN
        RETURN QUERY SELECT 
            'total_payment'::TEXT,
            v_loan.total_payment,
            v_loan.biweekly_payment * v_loan.term_biweeks,
            v_loan.total_payment - (v_loan.biweekly_payment * v_loan.term_biweeks),
            ABS(v_loan.total_payment - (v_loan.biweekly_payment * v_loan.term_biweeks)) < 1.00;
    END IF;
    
    -- Validar total_interest = total_payment - amount
    IF v_loan.total_interest IS NOT NULL AND v_loan.total_payment IS NOT NULL THEN
        RETURN QUERY SELECT 
            'total_interest'::TEXT,
            v_loan.total_interest,
            v_loan.total_payment - v_loan.amount,
            v_loan.total_interest - (v_loan.total_payment - v_loan.amount),
            ABS(v_loan.total_interest - (v_loan.total_payment - v_loan.amount)) < 1.00;
    END IF;
    
    -- Validar associate_payment = biweekly_payment - commission_per_payment
    IF v_loan.associate_payment IS NOT NULL AND v_loan.biweekly_payment IS NOT NULL THEN
        RETURN QUERY SELECT 
            'associate_payment'::TEXT,
            v_loan.associate_payment,
            v_loan.biweekly_payment - COALESCE(v_loan.commission_per_payment, 0),
            v_loan.associate_payment - (v_loan.biweekly_payment - COALESCE(v_loan.commission_per_payment, 0)),
            ABS(v_loan.associate_payment - (v_loan.biweekly_payment - COALESCE(v_loan.commission_per_payment, 0))) < 0.10;
    END IF;
END;
$$;


--
-- Name: validate_loan_payment_schedule(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.validate_loan_payment_schedule(p_loan_id integer) RETURNS TABLE(validacion text, valor numeric, esperado numeric, diferencia numeric, es_valido boolean, detalle text)
    LANGUAGE plpgsql
    AS $_$
DECLARE
    v_loan RECORD;
    v_payment_count INTEGER;
    v_sum_expected DECIMAL;
    v_sum_interest DECIMAL;
    v_sum_principal DECIMAL;
    v_sum_commission DECIMAL;
    v_last_balance DECIMAL;
    v_numbers_ok BOOLEAN;
BEGIN
    -- Obtener datos del pr√©stamo
    SELECT 
        id, amount, term_biweeks, total_payment, total_interest,
        total_commission, biweekly_payment
    INTO v_loan
    FROM loans
    WHERE id = p_loan_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Pr√©stamo % no encontrado', p_loan_id;
    END IF;
    
    -- Contar pagos generados
    SELECT COUNT(*) INTO v_payment_count
    FROM payments
    WHERE loan_id = p_loan_id;
    
    -- Validar: Cantidad de pagos = term_biweeks
    RETURN QUERY SELECT 
        'Cantidad de pagos'::TEXT,
        v_payment_count::DECIMAL,
        v_loan.term_biweeks::DECIMAL,
        (v_payment_count - v_loan.term_biweeks)::DECIMAL,
        v_payment_count = v_loan.term_biweeks,
        format('Se esperaban %s pagos, se encontraron %s', v_loan.term_biweeks, v_payment_count);
    
    -- Validar: payment_number son secuenciales (1, 2, 3, ..., N)
    SELECT COUNT(*) = v_payment_count INTO v_numbers_ok
    FROM (
        SELECT payment_number
        FROM payments
        WHERE loan_id = p_loan_id
        ORDER BY payment_number
    ) t
    WHERE payment_number BETWEEN 1 AND v_payment_count;
    
    RETURN QUERY SELECT 
        'N√∫meros secuenciales'::TEXT,
        CASE WHEN v_numbers_ok THEN 1::DECIMAL ELSE 0::DECIMAL END,
        1::DECIMAL,
        CASE WHEN v_numbers_ok THEN 0::DECIMAL ELSE 1::DECIMAL END,
        v_numbers_ok,
        CASE WHEN v_numbers_ok 
            THEN 'Los n√∫meros de pago son secuenciales (1..N)'
            ELSE 'Los n√∫meros de pago NO son secuenciales'
        END;
    
    -- Calcular sumas
    SELECT 
        COALESCE(SUM(expected_amount), 0),
        COALESCE(SUM(interest_amount), 0),
        COALESCE(SUM(principal_amount), 0),
        COALESCE(SUM(commission_amount), 0)
    INTO v_sum_expected, v_sum_interest, v_sum_principal, v_sum_commission
    FROM payments
    WHERE loan_id = p_loan_id;
    
    -- Validar: SUM(expected_amount) = loans.total_payment
    IF v_loan.total_payment IS NOT NULL THEN
        RETURN QUERY SELECT 
            'SUM(expected) = total_payment'::TEXT,
            v_sum_expected,
            v_loan.total_payment,
            v_sum_expected - v_loan.total_payment,
            ABS(v_sum_expected - v_loan.total_payment) < 1.00,
            format('Suma de pagos esperados: $%s, Total pr√©stamo: $%s', v_sum_expected, v_loan.total_payment);
    END IF;
    
    -- Validar: SUM(interest_amount) = loans.total_interest
    IF v_loan.total_interest IS NOT NULL THEN
        RETURN QUERY SELECT 
            'SUM(interest) = total_interest'::TEXT,
            v_sum_interest,
            v_loan.total_interest,
            v_sum_interest - v_loan.total_interest,
            ABS(v_sum_interest - v_loan.total_interest) < 1.00,
            format('Suma de intereses: $%s, Total inter√©s pr√©stamo: $%s', v_sum_interest, v_loan.total_interest);
    END IF;
    
    -- Validar: SUM(principal_amount) = loans.amount
    RETURN QUERY SELECT 
        'SUM(principal) = amount'::TEXT,
        v_sum_principal,
        v_loan.amount,
        v_sum_principal - v_loan.amount,
        ABS(v_sum_principal - v_loan.amount) < 1.00,
        format('Suma de abonos a capital: $%s, Capital pr√©stamo: $%s', v_sum_principal, v_loan.amount);
    
    -- Validar: SUM(commission_amount) = loans.total_commission
    IF v_loan.total_commission IS NOT NULL THEN
        RETURN QUERY SELECT 
            'SUM(commission) = total_commission'::TEXT,
            v_sum_commission,
            v_loan.total_commission,
            v_sum_commission - v_loan.total_commission,
            ABS(v_sum_commission - v_loan.total_commission) < 1.00,
            format('Suma de comisiones: $%s, Total comisi√≥n pr√©stamo: $%s', v_sum_commission, v_loan.total_commission);
    END IF;
    
    -- Validar: √öltimo pago tiene balance_remaining = 0
    SELECT balance_remaining INTO v_last_balance
    FROM payments
    WHERE loan_id = p_loan_id
    ORDER BY payment_number DESC
    LIMIT 1;
    
    IF v_last_balance IS NOT NULL THEN
        RETURN QUERY SELECT 
            '√öltimo pago balance = 0'::TEXT,
            v_last_balance,
            0::DECIMAL,
            v_last_balance,
            ABS(v_last_balance) < 0.10,
            format('El saldo despu√©s del √∫ltimo pago es: $%s (debe ser $0.00)', v_last_balance);
    END IF;
END;
$_$;


--
-- Name: validate_payment_breakdown(integer); Type: FUNCTION; Schema: public; Owner: -
--

CREATE FUNCTION public.validate_payment_breakdown(p_payment_id integer) RETURNS TABLE(validacion text, valor_actual numeric, valor_esperado numeric, diferencia numeric, es_valido boolean)
    LANGUAGE plpgsql
    AS $$
DECLARE
    v_payment RECORD;
BEGIN
    -- Obtener datos del pago
    SELECT 
        payment_number, expected_amount, interest_amount, principal_amount,
        commission_amount, associate_payment, amount_paid, balance_remaining
    INTO v_payment
    FROM payments
    WHERE id = p_payment_id;
    
    IF NOT FOUND THEN
        RAISE EXCEPTION 'Pago % no encontrado', p_payment_id;
    END IF;
    
    -- Validar expected_amount = interest_amount + principal_amount
    IF v_payment.expected_amount IS NOT NULL AND v_payment.interest_amount IS NOT NULL AND v_payment.principal_amount IS NOT NULL THEN
        RETURN QUERY SELECT 
            'expected = interest + principal'::TEXT,
            v_payment.expected_amount,
            v_payment.interest_amount + v_payment.principal_amount,
            v_payment.expected_amount - (v_payment.interest_amount + v_payment.principal_amount),
            ABS(v_payment.expected_amount - (v_payment.interest_amount + v_payment.principal_amount)) < 0.10;
    END IF;
    
    -- Validar associate_payment = expected_amount - commission_amount
    IF v_payment.associate_payment IS NOT NULL AND v_payment.expected_amount IS NOT NULL AND v_payment.commission_amount IS NOT NULL THEN
        RETURN QUERY SELECT 
            'associate = expected - commission'::TEXT,
            v_payment.associate_payment,
            v_payment.expected_amount - v_payment.commission_amount,
            v_payment.associate_payment - (v_payment.expected_amount - v_payment.commission_amount),
            ABS(v_payment.associate_payment - (v_payment.expected_amount - v_payment.commission_amount)) < 0.10;
    END IF;
    
    -- Validar amount_paid <= expected_amount (permitir sobrepago de hasta 100)
    IF v_payment.amount_paid IS NOT NULL AND v_payment.expected_amount IS NOT NULL THEN
        RETURN QUERY SELECT 
            'paid <= expected'::TEXT,
            v_payment.amount_paid,
            v_payment.expected_amount,
            v_payment.amount_paid - v_payment.expected_amount,
            v_payment.amount_paid <= v_payment.expected_amount + 100.00;
    END IF;
END;
$$;


SET default_tablespace = '';

SET default_table_access_method = heap;

--
-- Name: addresses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.addresses (
    id integer NOT NULL,
    user_id integer NOT NULL,
    street character varying(200) NOT NULL,
    external_number character varying(10) NOT NULL,
    internal_number character varying(10),
    colony character varying(100) NOT NULL,
    municipality character varying(100) NOT NULL,
    state character varying(100) NOT NULL,
    zip_code character varying(10) NOT NULL,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: addresses_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.addresses_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: addresses_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.addresses_id_seq OWNED BY public.addresses.id;


--
-- Name: agreement_items; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.agreement_items (
    id integer NOT NULL,
    agreement_id integer NOT NULL,
    loan_id integer NOT NULL,
    client_user_id integer NOT NULL,
    debt_amount numeric(12,2) NOT NULL,
    debt_type character varying(50) NOT NULL,
    description text,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_agreement_items_debt_positive CHECK ((debt_amount > (0)::numeric)),
    CONSTRAINT check_agreement_items_type_valid CHECK (((debt_type)::text = ANY ((ARRAY['UNREPORTED_PAYMENT'::character varying, 'DEFAULTED_CLIENT'::character varying, 'LATE_FEE'::character varying, 'OTHER'::character varying])::text[])))
);


--
-- Name: agreement_items_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.agreement_items_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: agreement_items_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.agreement_items_id_seq OWNED BY public.agreement_items.id;


--
-- Name: agreement_payments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.agreement_payments (
    id integer NOT NULL,
    agreement_id integer NOT NULL,
    payment_number integer NOT NULL,
    payment_amount numeric(12,2) NOT NULL,
    payment_due_date date NOT NULL,
    payment_date date,
    payment_method_id integer,
    payment_reference character varying(100),
    status character varying(50) DEFAULT 'PENDING'::character varying NOT NULL,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_agreement_payments_amount_positive CHECK ((payment_amount > (0)::numeric)),
    CONSTRAINT check_agreement_payments_status_valid CHECK (((status)::text = ANY ((ARRAY['PENDING'::character varying, 'PAID'::character varying, 'OVERDUE'::character varying, 'CANCELLED'::character varying])::text[])))
);


--
-- Name: agreement_payments_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.agreement_payments_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: agreement_payments_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.agreement_payments_id_seq OWNED BY public.agreement_payments.id;


--
-- Name: agreements; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.agreements (
    id integer NOT NULL,
    associate_profile_id integer NOT NULL,
    agreement_number character varying(50) NOT NULL,
    agreement_date date NOT NULL,
    total_debt_amount numeric(12,2) NOT NULL,
    payment_plan_months integer NOT NULL,
    monthly_payment_amount numeric(12,2) NOT NULL,
    status character varying(50) DEFAULT 'ACTIVE'::character varying NOT NULL,
    start_date date NOT NULL,
    end_date date,
    created_by integer NOT NULL,
    approved_by integer,
    notes text,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_agreements_amounts_positive CHECK (((total_debt_amount > (0)::numeric) AND (monthly_payment_amount > (0)::numeric))),
    CONSTRAINT check_agreements_months_positive CHECK ((payment_plan_months > 0)),
    CONSTRAINT check_agreements_status_valid CHECK (((status)::text = ANY ((ARRAY['ACTIVE'::character varying, 'COMPLETED'::character varying, 'DEFAULTED'::character varying, 'CANCELLED'::character varying])::text[])))
);


--
-- Name: agreements_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.agreements_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: agreements_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.agreements_id_seq OWNED BY public.agreements.id;


--
-- Name: associate_accumulated_balances; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.associate_accumulated_balances (
    id integer NOT NULL,
    user_id integer NOT NULL,
    cut_period_id integer NOT NULL,
    accumulated_debt numeric(12,2) DEFAULT 0.00 NOT NULL,
    debt_details jsonb,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: associate_accumulated_balances_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.associate_accumulated_balances_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: associate_accumulated_balances_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.associate_accumulated_balances_id_seq OWNED BY public.associate_accumulated_balances.id;


--
-- Name: associate_debt_payments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.associate_debt_payments (
    id integer NOT NULL,
    associate_profile_id integer NOT NULL,
    payment_amount numeric(12,2) NOT NULL,
    payment_date date NOT NULL,
    payment_method_id integer NOT NULL,
    payment_reference character varying(100),
    registered_by integer NOT NULL,
    applied_breakdown_items jsonb DEFAULT '[]'::jsonb NOT NULL,
    notes text,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_debt_payments_amount_positive CHECK ((payment_amount > (0)::numeric)),
    CONSTRAINT check_debt_payments_date_logical CHECK ((payment_date <= CURRENT_DATE))
);


--
-- Name: associate_debt_payments_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.associate_debt_payments_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: associate_debt_payments_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.associate_debt_payments_id_seq OWNED BY public.associate_debt_payments.id;


--
-- Name: associate_level_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.associate_level_history (
    id integer NOT NULL,
    associate_profile_id integer NOT NULL,
    old_level_id integer NOT NULL,
    new_level_id integer NOT NULL,
    reason text,
    change_type_id integer NOT NULL,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: associate_level_history_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.associate_level_history_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: associate_level_history_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.associate_level_history_id_seq OWNED BY public.associate_level_history.id;


--
-- Name: associate_levels; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.associate_levels (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    max_loan_amount numeric(12,2) NOT NULL,
    credit_limit numeric(12,2) DEFAULT 0.00,
    description text,
    min_clients integer DEFAULT 0,
    min_collection_rate numeric(5,2) DEFAULT 0.00,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: associate_levels_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.associate_levels_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: associate_levels_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.associate_levels_id_seq OWNED BY public.associate_levels.id;


--
-- Name: associate_payment_statements; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.associate_payment_statements (
    id integer NOT NULL,
    cut_period_id integer NOT NULL,
    user_id integer NOT NULL,
    statement_number character varying(50) NOT NULL,
    total_payments_count integer DEFAULT 0 NOT NULL,
    total_amount_collected numeric(12,2) DEFAULT 0.00 NOT NULL,
    commission_rate_applied numeric(5,2) NOT NULL,
    status_id integer NOT NULL,
    generated_date date NOT NULL,
    sent_date date,
    due_date date NOT NULL,
    paid_date date,
    paid_amount numeric(12,2),
    payment_method_id integer,
    payment_reference character varying(100),
    late_fee_amount numeric(12,2) DEFAULT 0.00 NOT NULL,
    late_fee_applied boolean DEFAULT false NOT NULL,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    total_to_credicuenta numeric(12,2),
    commission_earned numeric(12,2)
);


--
-- Name: associate_payment_statements_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.associate_payment_statements_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: associate_payment_statements_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.associate_payment_statements_id_seq OWNED BY public.associate_payment_statements.id;


--
-- Name: associate_profiles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.associate_profiles (
    id integer NOT NULL,
    user_id integer NOT NULL,
    level_id integer NOT NULL,
    contact_person character varying(150),
    contact_email character varying(150),
    default_commission_rate numeric(5,2) DEFAULT 5.0 NOT NULL,
    active boolean DEFAULT true NOT NULL,
    consecutive_full_credit_periods integer DEFAULT 0 NOT NULL,
    consecutive_on_time_payments integer DEFAULT 0 NOT NULL,
    clients_in_agreement integer DEFAULT 0 NOT NULL,
    last_level_evaluation_date timestamp with time zone,
    credit_used numeric(12,2) DEFAULT 0.00 NOT NULL,
    credit_limit numeric(12,2) DEFAULT 0.00 NOT NULL,
    credit_last_updated timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    debt_balance numeric(12,2) DEFAULT 0.00 NOT NULL,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    credit_available numeric(12,2) GENERATED ALWAYS AS (GREATEST(((credit_limit - credit_used) - debt_balance), (0)::numeric)) STORED,
    CONSTRAINT check_associate_profiles_commission_rate_valid CHECK (((default_commission_rate >= (0)::numeric) AND (default_commission_rate <= (100)::numeric))),
    CONSTRAINT check_associate_profiles_counters_non_negative CHECK (((consecutive_full_credit_periods >= 0) AND (consecutive_on_time_payments >= 0) AND (clients_in_agreement >= 0))),
    CONSTRAINT check_associate_profiles_credit_non_negative CHECK (((credit_used >= (0)::numeric) AND (credit_limit >= (0)::numeric))),
    CONSTRAINT check_associate_profiles_debt_non_negative CHECK ((debt_balance >= (0)::numeric))
);


--
-- Name: associate_profiles_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.associate_profiles_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: associate_profiles_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.associate_profiles_id_seq OWNED BY public.associate_profiles.id;


--
-- Name: associate_statement_payments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.associate_statement_payments (
    id integer NOT NULL,
    statement_id integer NOT NULL,
    payment_amount numeric(12,2) NOT NULL,
    payment_date date NOT NULL,
    payment_method_id integer NOT NULL,
    payment_reference character varying(100),
    registered_by integer NOT NULL,
    notes text,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_statement_payments_amount_positive CHECK ((payment_amount > (0)::numeric)),
    CONSTRAINT check_statement_payments_date_logical CHECK ((payment_date <= CURRENT_DATE))
);


--
-- Name: associate_statement_payments_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.associate_statement_payments_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: associate_statement_payments_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.associate_statement_payments_id_seq OWNED BY public.associate_statement_payments.id;


--
-- Name: audit_log; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.audit_log (
    id integer NOT NULL,
    table_name character varying(100) NOT NULL,
    record_id integer NOT NULL,
    operation character varying(10) NOT NULL,
    old_data jsonb,
    new_data jsonb,
    changed_by integer,
    changed_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    ip_address inet,
    user_agent text,
    CONSTRAINT audit_log_operation_check CHECK (((operation)::text = ANY ((ARRAY['INSERT'::character varying, 'UPDATE'::character varying, 'DELETE'::character varying])::text[])))
);


--
-- Name: audit_log_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.audit_log_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_log_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.audit_log_id_seq OWNED BY public.audit_log.id;


--
-- Name: audit_session_log; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.audit_session_log (
    id integer NOT NULL,
    user_id integer NOT NULL,
    session_token character varying(500) NOT NULL,
    login_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    logout_at timestamp with time zone,
    ip_address inet,
    user_agent text,
    is_active boolean DEFAULT true,
    CONSTRAINT check_session_log_logout_after_login CHECK (((logout_at IS NULL) OR (logout_at >= login_at)))
);


--
-- Name: audit_session_log_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.audit_session_log_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: audit_session_log_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.audit_session_log_id_seq OWNED BY public.audit_session_log.id;


--
-- Name: beneficiaries; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.beneficiaries (
    id integer NOT NULL,
    user_id integer NOT NULL,
    full_name character varying(200) NOT NULL,
    relationship character varying(50) NOT NULL,
    phone_number character varying(20) NOT NULL,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    relationship_id integer
);


--
-- Name: beneficiaries_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.beneficiaries_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: beneficiaries_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.beneficiaries_id_seq OWNED BY public.beneficiaries.id;


--
-- Name: client_documents; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.client_documents (
    id integer NOT NULL,
    user_id integer NOT NULL,
    document_type_id integer NOT NULL,
    file_name character varying(255) NOT NULL,
    original_file_name character varying(255),
    file_path character varying(500) NOT NULL,
    file_size bigint,
    mime_type character varying(100),
    status_id integer NOT NULL,
    upload_date timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    reviewed_by integer,
    reviewed_at timestamp with time zone,
    comments text,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: client_documents_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.client_documents_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: client_documents_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.client_documents_id_seq OWNED BY public.client_documents.id;


--
-- Name: config_types; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.config_types (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    description text,
    validation_regex text,
    example_value text,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: config_types_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.config_types_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: config_types_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.config_types_id_seq OWNED BY public.config_types.id;


--
-- Name: contract_statuses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contract_statuses (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    description text NOT NULL,
    is_active boolean DEFAULT true,
    requires_signature boolean DEFAULT false,
    display_order integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: contract_statuses_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.contract_statuses_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: contract_statuses_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.contract_statuses_id_seq OWNED BY public.contract_statuses.id;


--
-- Name: contracts; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.contracts (
    id integer NOT NULL,
    loan_id integer NOT NULL,
    file_path character varying(500),
    start_date date NOT NULL,
    sign_date date,
    document_number character varying(50) NOT NULL,
    status_id integer NOT NULL,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_contracts_sign_after_start CHECK (((sign_date IS NULL) OR (sign_date >= start_date)))
);


--
-- Name: contracts_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.contracts_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: contracts_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.contracts_id_seq OWNED BY public.contracts.id;


--
-- Name: cut_period_statuses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.cut_period_statuses (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    description text NOT NULL,
    is_terminal boolean DEFAULT false,
    allows_payments boolean DEFAULT true,
    display_order integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: cut_period_statuses_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.cut_period_statuses_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: cut_period_statuses_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.cut_period_statuses_id_seq OWNED BY public.cut_period_statuses.id;


--
-- Name: cut_periods; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.cut_periods (
    id integer NOT NULL,
    cut_number integer NOT NULL,
    period_start_date date NOT NULL,
    period_end_date date NOT NULL,
    status_id integer NOT NULL,
    total_payments_expected numeric(12,2) DEFAULT 0.00 NOT NULL,
    total_payments_received numeric(12,2) DEFAULT 0.00 NOT NULL,
    total_commission numeric(12,2) DEFAULT 0.00 NOT NULL,
    created_by integer NOT NULL,
    closed_by integer,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    cut_code character varying(10),
    CONSTRAINT check_cut_periods_dates_logical CHECK ((period_end_date > period_start_date)),
    CONSTRAINT check_cut_periods_totals_non_negative CHECK (((total_payments_expected >= (0)::numeric) AND (total_payments_received >= (0)::numeric) AND (total_commission >= (0)::numeric)))
);


--
-- Name: cut_periods_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.cut_periods_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: cut_periods_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.cut_periods_id_seq OWNED BY public.cut_periods.id;


--
-- Name: defaulted_client_reports; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.defaulted_client_reports (
    id integer NOT NULL,
    associate_profile_id integer NOT NULL,
    loan_id integer NOT NULL,
    client_user_id integer NOT NULL,
    reported_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    reported_by integer NOT NULL,
    total_debt_amount numeric(12,2) NOT NULL,
    evidence_details text,
    evidence_file_path character varying(500),
    status character varying(50) DEFAULT 'PENDING'::character varying NOT NULL,
    approved_by integer,
    approved_at timestamp with time zone,
    rejection_reason text,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_defaulted_reports_approved_has_user CHECK (((((status)::text = 'APPROVED'::text) AND (approved_by IS NOT NULL) AND (approved_at IS NOT NULL)) OR ((status)::text <> 'APPROVED'::text))),
    CONSTRAINT check_defaulted_reports_debt_positive CHECK ((total_debt_amount > (0)::numeric)),
    CONSTRAINT check_defaulted_reports_status_valid CHECK (((status)::text = ANY ((ARRAY['PENDING'::character varying, 'APPROVED'::character varying, 'REJECTED'::character varying, 'IN_REVIEW'::character varying])::text[])))
);


--
-- Name: defaulted_client_reports_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.defaulted_client_reports_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: defaulted_client_reports_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.defaulted_client_reports_id_seq OWNED BY public.defaulted_client_reports.id;


--
-- Name: document_statuses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.document_statuses (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    description text NOT NULL,
    display_order integer DEFAULT 0,
    color_code character varying(7),
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: document_statuses_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.document_statuses_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: document_statuses_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.document_statuses_id_seq OWNED BY public.document_statuses.id;


--
-- Name: document_types; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.document_types (
    id integer NOT NULL,
    name character varying(100) NOT NULL,
    description text,
    is_required boolean DEFAULT false NOT NULL,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: document_types_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.document_types_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: document_types_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.document_types_id_seq OWNED BY public.document_types.id;


--
-- Name: guarantors; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.guarantors (
    id integer NOT NULL,
    user_id integer NOT NULL,
    full_name character varying(200) NOT NULL,
    first_name character varying(100),
    paternal_last_name character varying(100),
    maternal_last_name character varying(100),
    relationship character varying(50) NOT NULL,
    phone_number character varying(20) NOT NULL,
    curp character varying(18),
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    relationship_id integer,
    CONSTRAINT check_guarantors_curp_length CHECK (((curp IS NULL) OR (length((curp)::text) = 18))),
    CONSTRAINT check_guarantors_phone_format CHECK (((phone_number)::text ~ '^[0-9]{10}$'::text))
);


--
-- Name: guarantors_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.guarantors_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: guarantors_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.guarantors_id_seq OWNED BY public.guarantors.id;


--
-- Name: legacy_payment_table; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.legacy_payment_table (
    id integer NOT NULL,
    amount numeric(12,2) NOT NULL,
    biweekly_payment numeric(10,2) NOT NULL,
    term_biweeks integer DEFAULT 12 NOT NULL,
    total_payment numeric(12,2) GENERATED ALWAYS AS ((biweekly_payment * (term_biweeks)::numeric)) STORED,
    total_interest numeric(12,2) GENERATED ALWAYS AS (((biweekly_payment * (term_biweeks)::numeric) - amount)) STORED,
    effective_rate_percent numeric(5,2) GENERATED ALWAYS AS (round(((((biweekly_payment * (term_biweeks)::numeric) - amount) / amount) * (100)::numeric), 2)) STORED,
    biweekly_rate_percent numeric(5,3) GENERATED ALWAYS AS (round((((((biweekly_payment * (term_biweeks)::numeric) - amount) / amount) / (term_biweeks)::numeric) * (100)::numeric), 3)) STORED,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    created_by integer,
    updated_by integer,
    associate_biweekly_payment numeric(10,2),
    commission_per_payment numeric(10,2) GENERATED ALWAYS AS ((biweekly_payment - COALESCE(associate_biweekly_payment, (0)::numeric))) STORED,
    associate_total_payment numeric(12,2) GENERATED ALWAYS AS ((COALESCE(associate_biweekly_payment, (0)::numeric) * (term_biweeks)::numeric)) STORED,
    total_commission numeric(12,2) GENERATED ALWAYS AS (((biweekly_payment - COALESCE(associate_biweekly_payment, (0)::numeric)) * (term_biweeks)::numeric)) STORED,
    CONSTRAINT check_legacy_amount_positive CHECK ((amount > (0)::numeric)),
    CONSTRAINT check_legacy_payment_positive CHECK ((biweekly_payment > (0)::numeric)),
    CONSTRAINT check_legacy_term_valid CHECK (((term_biweeks >= 1) AND (term_biweeks <= 52)))
);


--
-- Name: legacy_payment_table_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.legacy_payment_table_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: legacy_payment_table_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.legacy_payment_table_id_seq OWNED BY public.legacy_payment_table.id;


--
-- Name: level_change_types; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.level_change_types (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    description text NOT NULL,
    is_automatic boolean DEFAULT false,
    display_order integer DEFAULT 0,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: level_change_types_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.level_change_types_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: level_change_types_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.level_change_types_id_seq OWNED BY public.level_change_types.id;


--
-- Name: loan_renewals; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.loan_renewals (
    id integer NOT NULL,
    original_loan_id integer NOT NULL,
    renewed_loan_id integer NOT NULL,
    renewal_date date NOT NULL,
    pending_balance numeric(12,2) NOT NULL,
    new_amount numeric(12,2) NOT NULL,
    reason text,
    created_by integer NOT NULL,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_loan_renewals_amounts_positive CHECK (((pending_balance >= (0)::numeric) AND (new_amount > (0)::numeric)))
);


--
-- Name: loan_renewals_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.loan_renewals_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: loan_renewals_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.loan_renewals_id_seq OWNED BY public.loan_renewals.id;


--
-- Name: loan_statuses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.loan_statuses (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    description text NOT NULL,
    is_active boolean DEFAULT true,
    display_order integer DEFAULT 0,
    color_code character varying(7),
    icon_name character varying(50),
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: loan_statuses_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.loan_statuses_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: loan_statuses_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.loan_statuses_id_seq OWNED BY public.loan_statuses.id;


--
-- Name: loans; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.loans (
    id integer NOT NULL,
    user_id integer NOT NULL,
    associate_user_id integer,
    amount numeric(12,2) NOT NULL,
    interest_rate numeric(5,2) NOT NULL,
    commission_rate numeric(5,2) DEFAULT 0.0 NOT NULL,
    term_biweeks integer NOT NULL,
    status_id integer NOT NULL,
    contract_id integer,
    approved_at timestamp with time zone,
    approved_by integer,
    rejected_at timestamp with time zone,
    rejected_by integer,
    rejection_reason text,
    notes text,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    profile_code character varying(50),
    biweekly_payment numeric(12,2),
    total_payment numeric(12,2),
    total_interest numeric(12,2),
    total_commission numeric(12,2),
    commission_per_payment numeric(10,2),
    associate_payment numeric(10,2),
    CONSTRAINT check_loans_amount_positive CHECK ((amount > (0)::numeric)),
    CONSTRAINT check_loans_approved_after_created CHECK (((approved_at IS NULL) OR (approved_at >= created_at))),
    CONSTRAINT check_loans_commission_rate_valid CHECK (((commission_rate >= (0)::numeric) AND (commission_rate <= (100)::numeric))),
    CONSTRAINT check_loans_interest_rate_valid CHECK (((interest_rate >= (0)::numeric) AND (interest_rate <= (100)::numeric))),
    CONSTRAINT check_loans_rejected_after_created CHECK (((rejected_at IS NULL) OR (rejected_at >= created_at))),
    CONSTRAINT check_loans_term_biweeks_valid CHECK ((term_biweeks = ANY (ARRAY[3, 6, 9, 12, 15, 18, 21, 24, 30, 36]))),
    CONSTRAINT chk_loans_associate_payment_consistent CHECK (((associate_payment IS NULL) OR (biweekly_payment IS NULL) OR (commission_per_payment IS NULL) OR (abs((associate_payment - (biweekly_payment - commission_per_payment))) < 0.10))),
    CONSTRAINT chk_loans_associate_payment_lte_biweekly CHECK (((associate_payment IS NULL) OR (biweekly_payment IS NULL) OR (associate_payment <= biweekly_payment))),
    CONSTRAINT chk_loans_biweekly_payment_positive CHECK (((biweekly_payment IS NULL) OR (biweekly_payment > (0)::numeric))),
    CONSTRAINT chk_loans_commission_per_payment_non_negative CHECK (((commission_per_payment IS NULL) OR (commission_per_payment >= (0)::numeric))),
    CONSTRAINT chk_loans_total_interest_consistent CHECK (((total_interest IS NULL) OR (total_payment IS NULL) OR (amount IS NULL) OR (abs((total_interest - (total_payment - amount))) < 1.00))),
    CONSTRAINT chk_loans_total_interest_non_negative CHECK (((total_interest IS NULL) OR (total_interest >= (0)::numeric))),
    CONSTRAINT chk_loans_total_payment_consistent CHECK (((total_payment IS NULL) OR (biweekly_payment IS NULL) OR (term_biweeks IS NULL) OR (abs((total_payment - (biweekly_payment * (term_biweeks)::numeric))) < 1.00))),
    CONSTRAINT chk_loans_total_payment_gte_amount CHECK (((total_payment IS NULL) OR (total_payment >= amount)))
);


--
-- Name: loans_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.loans_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: loans_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.loans_id_seq OWNED BY public.loans.id;


--
-- Name: payment_methods; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.payment_methods (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    description text,
    is_active boolean DEFAULT true,
    requires_reference boolean DEFAULT false,
    display_order integer DEFAULT 0,
    icon_name character varying(50),
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: payment_methods_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.payment_methods_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: payment_methods_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.payment_methods_id_seq OWNED BY public.payment_methods.id;


--
-- Name: payment_status_history; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.payment_status_history (
    id integer NOT NULL,
    payment_id integer NOT NULL,
    old_status_id integer,
    new_status_id integer NOT NULL,
    change_type character varying(50) NOT NULL,
    changed_by integer,
    change_reason text,
    ip_address inet,
    user_agent text,
    changed_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_payment_status_history_change_type_valid CHECK (((change_type)::text = ANY ((ARRAY['AUTOMATIC'::character varying, 'MANUAL_ADMIN'::character varying, 'SYSTEM_CLOSURE'::character varying, 'CORRECTION'::character varying, 'TRIGGER'::character varying])::text[]))),
    CONSTRAINT check_payment_status_history_manual_has_user CHECK (((((change_type)::text = ANY ((ARRAY['MANUAL_ADMIN'::character varying, 'CORRECTION'::character varying])::text[])) AND (changed_by IS NOT NULL)) OR ((change_type)::text <> ALL ((ARRAY['MANUAL_ADMIN'::character varying, 'CORRECTION'::character varying])::text[]))))
);


--
-- Name: payment_status_history_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.payment_status_history_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: payment_status_history_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.payment_status_history_id_seq OWNED BY public.payment_status_history.id;


--
-- Name: payment_statuses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.payment_statuses (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    description text NOT NULL,
    is_active boolean DEFAULT true,
    display_order integer DEFAULT 0,
    color_code character varying(7),
    icon_name character varying(50),
    is_real_payment boolean DEFAULT true,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: payment_statuses_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.payment_statuses_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: payment_statuses_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.payment_statuses_id_seq OWNED BY public.payment_statuses.id;


--
-- Name: payments; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.payments (
    id integer NOT NULL,
    loan_id integer NOT NULL,
    amount_paid numeric(12,2) NOT NULL,
    payment_date date NOT NULL,
    payment_due_date date NOT NULL,
    is_late boolean DEFAULT false NOT NULL,
    status_id integer,
    cut_period_id integer,
    marked_by integer,
    marked_at timestamp with time zone,
    marking_notes text,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    payment_number integer,
    expected_amount numeric(12,2),
    interest_amount numeric(10,2),
    principal_amount numeric(10,2),
    commission_amount numeric(10,2),
    associate_payment numeric(10,2),
    balance_remaining numeric(12,2),
    associate_balance_remaining numeric(12,2),
    CONSTRAINT check_payments_amount_paid_non_negative CHECK ((amount_paid >= (0)::numeric)),
    CONSTRAINT check_payments_dates_logical CHECK ((payment_date <= payment_due_date)),
    CONSTRAINT chk_payments_associate_equals_expected_minus_commission CHECK (((associate_payment IS NULL) OR (expected_amount IS NULL) OR (commission_amount IS NULL) OR (abs((associate_payment - (expected_amount - commission_amount))) < 0.10))),
    CONSTRAINT chk_payments_associate_lte_expected CHECK (((associate_payment IS NULL) OR (expected_amount IS NULL) OR (associate_payment <= expected_amount))),
    CONSTRAINT chk_payments_associate_payment_non_negative CHECK (((associate_payment IS NULL) OR (associate_payment >= (0)::numeric))),
    CONSTRAINT chk_payments_balance_non_negative CHECK (((balance_remaining IS NULL) OR (balance_remaining >= (0)::numeric))),
    CONSTRAINT chk_payments_commission_non_negative CHECK (((commission_amount IS NULL) OR (commission_amount >= (0)::numeric))),
    CONSTRAINT chk_payments_expected_amount_positive CHECK (((expected_amount IS NULL) OR (expected_amount > (0)::numeric))),
    CONSTRAINT chk_payments_expected_equals_interest_plus_principal CHECK (((expected_amount IS NULL) OR (interest_amount IS NULL) OR (principal_amount IS NULL) OR (abs((expected_amount - (interest_amount + principal_amount))) < 0.10))),
    CONSTRAINT chk_payments_interest_non_negative CHECK (((interest_amount IS NULL) OR (interest_amount >= (0)::numeric))),
    CONSTRAINT chk_payments_paid_lte_expected CHECK (((expected_amount IS NULL) OR (amount_paid <= (expected_amount + 100.00)))),
    CONSTRAINT chk_payments_payment_number_positive CHECK (((payment_number IS NULL) OR (payment_number > 0))),
    CONSTRAINT chk_payments_principal_non_negative CHECK (((principal_amount IS NULL) OR (principal_amount >= (0)::numeric)))
);


--
-- Name: payments_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.payments_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: payments_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.payments_id_seq OWNED BY public.payments.id;


--
-- Name: rate_profile_reference_table; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.rate_profile_reference_table (
    id integer NOT NULL,
    profile_code character varying(50) NOT NULL,
    amount numeric(12,2) NOT NULL,
    term_biweeks integer NOT NULL,
    biweekly_payment numeric(10,2) NOT NULL,
    total_payment numeric(12,2) NOT NULL,
    commission_per_payment numeric(10,2) NOT NULL,
    total_commission numeric(12,2) NOT NULL,
    associate_payment numeric(10,2) NOT NULL,
    associate_total numeric(12,2) NOT NULL,
    interest_rate_percent numeric(5,3),
    commission_rate_percent numeric(5,3),
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: rate_profile_reference_table_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.rate_profile_reference_table_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: rate_profile_reference_table_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.rate_profile_reference_table_id_seq OWNED BY public.rate_profile_reference_table.id;


--
-- Name: rate_profiles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.rate_profiles (
    id integer NOT NULL,
    code character varying(50) NOT NULL,
    name character varying(100) NOT NULL,
    description text,
    calculation_type character varying(20) NOT NULL,
    interest_rate_percent numeric(5,3),
    enabled boolean DEFAULT true,
    is_recommended boolean DEFAULT false,
    display_order integer DEFAULT 0,
    min_amount numeric(12,2),
    max_amount numeric(12,2),
    valid_terms integer[],
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    created_by integer,
    updated_by integer,
    commission_rate_percent numeric(5,3),
    CONSTRAINT rate_profiles_calculation_type_check CHECK (((calculation_type)::text = ANY ((ARRAY['table_lookup'::character varying, 'formula'::character varying])::text[])))
);


--
-- Name: rate_profiles_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.rate_profiles_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: rate_profiles_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.rate_profiles_id_seq OWNED BY public.rate_profiles.id;


--
-- Name: relationships; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.relationships (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    description text,
    active boolean DEFAULT true NOT NULL,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: relationships_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.relationships_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: relationships_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.relationships_id_seq OWNED BY public.relationships.id;


--
-- Name: roles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.roles (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    description text,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: roles_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.roles_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: roles_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.roles_id_seq OWNED BY public.roles.id;


--
-- Name: statement_statuses; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.statement_statuses (
    id integer NOT NULL,
    name character varying(50) NOT NULL,
    description text NOT NULL,
    is_paid boolean DEFAULT false,
    display_order integer DEFAULT 0,
    color_code character varying(7),
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: statement_statuses_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.statement_statuses_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: statement_statuses_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.statement_statuses_id_seq OWNED BY public.statement_statuses.id;


--
-- Name: system_configurations; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.system_configurations (
    id integer NOT NULL,
    config_key character varying(100) NOT NULL,
    config_value text NOT NULL,
    description text,
    config_type_id integer NOT NULL,
    updated_by integer NOT NULL,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: system_configurations_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.system_configurations_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: system_configurations_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.system_configurations_id_seq OWNED BY public.system_configurations.id;


--
-- Name: user_roles; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.user_roles (
    user_id integer NOT NULL,
    role_id integer NOT NULL,
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP
);


--
-- Name: users; Type: TABLE; Schema: public; Owner: -
--

CREATE TABLE public.users (
    id integer NOT NULL,
    username character varying(50) NOT NULL,
    password_hash character varying(255) NOT NULL,
    first_name character varying(100) NOT NULL,
    last_name character varying(100) NOT NULL,
    email character varying(150),
    phone_number character varying(20) NOT NULL,
    birth_date date,
    curp character varying(18),
    profile_picture_url character varying(500),
    created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
    active boolean DEFAULT true NOT NULL,
    CONSTRAINT check_users_curp_length CHECK (((curp IS NULL) OR (length((curp)::text) = 18))),
    CONSTRAINT check_users_phone_format CHECK (((phone_number)::text ~ '^[0-9]{10}$'::text))
);


--
-- Name: users_id_seq; Type: SEQUENCE; Schema: public; Owner: -
--

CREATE SEQUENCE public.users_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


--
-- Name: users_id_seq; Type: SEQUENCE OWNED BY; Schema: public; Owner: -
--

ALTER SEQUENCE public.users_id_seq OWNED BY public.users.id;


--
-- Name: v_associate_all_payments; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_associate_all_payments AS
 SELECT asp.id,
    'SALDO_ACTUAL'::text AS payment_type,
    ap.id AS associate_profile_id,
    concat(u.first_name, ' ', u.last_name) AS associate_name,
    asp.payment_amount,
    asp.payment_date,
    pm.name AS payment_method,
    asp.payment_reference,
    aps.cut_period_id,
    cp.period_start_date AS period_start,
    cp.period_end_date AS period_end,
    asp.notes,
    asp.created_at
   FROM (((((public.associate_statement_payments asp
     JOIN public.associate_payment_statements aps ON ((aps.id = asp.statement_id)))
     JOIN public.users u ON ((u.id = aps.user_id)))
     JOIN public.associate_profiles ap ON ((ap.user_id = u.id)))
     JOIN public.payment_methods pm ON ((pm.id = asp.payment_method_id)))
     LEFT JOIN public.cut_periods cp ON ((cp.id = aps.cut_period_id)))
UNION ALL
 SELECT adp.id,
    'DEUDA_ACUMULADA'::text AS payment_type,
    adp.associate_profile_id,
    concat(u.first_name, ' ', u.last_name) AS associate_name,
    adp.payment_amount,
    adp.payment_date,
    pm.name AS payment_method,
    adp.payment_reference,
    NULL::integer AS cut_period_id,
    NULL::date AS period_start,
    NULL::date AS period_end,
    adp.notes,
    adp.created_at
   FROM (((public.associate_debt_payments adp
     JOIN public.associate_profiles ap ON ((ap.id = adp.associate_profile_id)))
     JOIN public.users u ON ((u.id = ap.user_id)))
     JOIN public.payment_methods pm ON ((pm.id = adp.payment_method_id)))
  ORDER BY 6 DESC, 13 DESC;


--
-- Name: v_associate_credit_complete; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_associate_credit_complete AS
 SELECT ap.id AS associate_profile_id,
    u.id AS user_id,
    concat(u.first_name, ' ', u.last_name) AS associate_name,
    u.email,
    u.phone_number,
    al.name AS level,
    ap.credit_limit,
    ap.credit_used,
    ap.credit_available,
    ap.debt_balance,
    (ap.credit_available - ap.debt_balance) AS real_available_credit,
    round((((ap.credit_used)::numeric / NULLIF(ap.credit_limit, (0)::numeric)) * (100)::numeric), 2) AS usage_percentage,
    round((((ap.debt_balance)::numeric / NULLIF(ap.credit_limit, (0)::numeric)) * (100)::numeric), 2) AS debt_percentage,
    round((((ap.credit_available - ap.debt_balance) / NULLIF(ap.credit_limit, (0)::numeric)) * (100)::numeric), 2) AS real_available_percentage,
        CASE
            WHEN ((ap.credit_available - ap.debt_balance) <= (0)::numeric) THEN 'SIN_CREDITO'::text
            WHEN ((ap.credit_available - ap.debt_balance) < (ap.credit_limit * 0.25)) THEN 'CRITICO'::text
            WHEN ((ap.credit_available - ap.debt_balance) < (ap.credit_limit * 0.50)) THEN 'MEDIO'::text
            ELSE 'ALTO'::text
        END AS credit_health_status,
        CASE
            WHEN (ap.debt_balance = (0)::numeric) THEN 'SIN_DEUDA'::text
            WHEN (ap.debt_balance < (ap.credit_limit * 0.10)) THEN 'DEUDA_BAJA'::text
            WHEN (ap.debt_balance < (ap.credit_limit * 0.25)) THEN 'DEUDA_MEDIA'::text
            ELSE 'DEUDA_ALTA'::text
        END AS debt_status,
    ap.consecutive_full_credit_periods,
    ap.consecutive_on_time_payments,
    ap.clients_in_agreement,
    ap.active,
    ap.credit_last_updated,
    ap.last_level_evaluation_date
   FROM ((public.associate_profiles ap
     JOIN public.users u ON ((ap.user_id = u.id)))
     JOIN public.associate_levels al ON ((ap.level_id = al.id)))
  ORDER BY (ap.credit_available - ap.debt_balance) DESC;


--
-- Name: v_associate_credit_summary; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_associate_credit_summary AS
 SELECT ap.id AS associate_profile_id,
    u.id AS user_id,
    concat(u.first_name, ' ', u.last_name) AS associate_name,
    u.email,
    al.name AS associate_level,
    ap.credit_limit,
    ap.credit_used,
    ap.debt_balance,
    ap.credit_available,
    ap.credit_last_updated,
        CASE
            WHEN (ap.credit_available <= (0)::numeric) THEN 'SIN_CREDITO'::text
            WHEN (ap.credit_available < (ap.credit_limit * 0.25)) THEN 'CRITICO'::text
            WHEN (ap.credit_available < (ap.credit_limit * 0.50)) THEN 'MEDIO'::text
            ELSE 'ALTO'::text
        END AS credit_status,
    round((((ap.credit_used)::numeric / NULLIF(ap.credit_limit, (0)::numeric)) * (100)::numeric), 2) AS credit_usage_percentage,
    ap.active AS is_active
   FROM ((public.associate_profiles ap
     JOIN public.users u ON ((ap.user_id = u.id)))
     JOIN public.associate_levels al ON ((ap.level_id = al.id)))
  ORDER BY ap.credit_available DESC;


--
-- Name: v_associate_late_fees; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_associate_late_fees AS
 SELECT aps.id AS statement_id,
    aps.statement_number,
    concat(u.first_name, ' ', u.last_name) AS associate_name,
    cp.cut_number,
    cp.period_start_date,
    cp.period_end_date,
    aps.total_payments_count,
    aps.total_amount_collected,
    aps.total_to_credicuenta,
    aps.commission_earned,
    aps.late_fee_amount,
    aps.late_fee_applied,
    ss.name AS statement_status,
        CASE
            WHEN aps.late_fee_applied THEN 'MORA APLICADA'::text
            WHEN ((aps.total_payments_count = 0) AND (aps.total_to_credicuenta > (0)::numeric)) THEN 'SUJETO A MORA'::text
            ELSE 'SIN MORA'::text
        END AS late_fee_status,
    round(((aps.late_fee_amount / NULLIF(aps.total_to_credicuenta, (0)::numeric)) * (100)::numeric), 2) AS late_fee_percentage,
    aps.generated_date,
    aps.due_date,
    aps.paid_date
   FROM (((public.associate_payment_statements aps
     JOIN public.users u ON ((aps.user_id = u.id)))
     JOIN public.cut_periods cp ON ((aps.cut_period_id = cp.id)))
     JOIN public.statement_statuses ss ON ((aps.status_id = ss.id)))
  WHERE ((aps.late_fee_amount > (0)::numeric) OR ((aps.total_payments_count = 0) AND (aps.total_to_credicuenta > (0)::numeric)))
  ORDER BY aps.generated_date DESC, aps.late_fee_amount DESC;


--
-- Name: v_associate_real_debt_summary; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_associate_real_debt_summary AS
 SELECT ap.id AS associate_profile_id,
    ap.user_id,
    concat(u.first_name, ' ', u.last_name) AS associate_name,
    COALESCE(debt_agg.total_accumulated_debt, (0)::numeric) AS total_debt,
    COALESCE(debt_agg.periods_with_debt, (0)::bigint) AS periods_with_debt,
    debt_agg.oldest_debt_date,
    debt_agg.newest_debt_date,
    ap.debt_balance AS profile_debt_balance,
    ap.credit_limit,
    ap.credit_available,
    ap.credit_used,
    COALESCE(payments_agg.total_paid_to_debt, (0)::numeric) AS total_paid_to_debt,
    COALESCE(payments_agg.total_payments_count, (0)::bigint) AS total_payments_count,
    payments_agg.last_payment_date
   FROM (((public.associate_profiles ap
     JOIN public.users u ON ((u.id = ap.user_id)))
     LEFT JOIN ( SELECT associate_accumulated_balances.user_id,
            sum(associate_accumulated_balances.accumulated_debt) AS total_accumulated_debt,
            count(*) AS periods_with_debt,
            min(associate_accumulated_balances.created_at) AS oldest_debt_date,
            max(associate_accumulated_balances.created_at) AS newest_debt_date
           FROM public.associate_accumulated_balances
          WHERE (associate_accumulated_balances.accumulated_debt > (0)::numeric)
          GROUP BY associate_accumulated_balances.user_id) debt_agg ON ((debt_agg.user_id = ap.user_id)))
     LEFT JOIN ( SELECT associate_debt_payments.associate_profile_id,
            sum(associate_debt_payments.payment_amount) AS total_paid_to_debt,
            count(*) AS total_payments_count,
            max(associate_debt_payments.payment_date) AS last_payment_date
           FROM public.associate_debt_payments
          GROUP BY associate_debt_payments.associate_profile_id) payments_agg ON ((payments_agg.associate_profile_id = ap.id)));


--
-- Name: v_cut_periods_readable; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_cut_periods_readable AS
 SELECT cut_periods.id,
    cut_periods.cut_code,
    cut_periods.period_start_date,
    cut_periods.period_end_date,
    ((cut_periods.period_end_date - cut_periods.period_start_date) + 1) AS days_in_period,
    to_char((cut_periods.period_start_date)::timestamp with time zone, 'DD-Mon-YYYY'::text) AS start_formatted,
    to_char((cut_periods.period_end_date)::timestamp with time zone, 'DD-Mon-YYYY'::text) AS end_formatted,
        CASE
            WHEN (EXTRACT(day FROM cut_periods.period_start_date) = (8)::numeric) THEN 'Primera Quincena'::text
            WHEN (EXTRACT(day FROM cut_periods.period_start_date) = (23)::numeric) THEN 'Segunda Quincena'::text
            ELSE 'Irregular'::text
        END AS period_type,
    cut_periods.status_id,
    cut_periods.total_payments_expected,
    cut_periods.total_payments_received,
    cut_periods.total_commission
   FROM public.cut_periods;


--
-- Name: v_loans_summary; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_loans_summary AS
 SELECT l.id,
    l.user_id,
    u.username,
    l.amount AS capital,
    l.term_biweeks AS plazo_quincenas,
    l.profile_code,
    rp.name AS profile_name,
    l.biweekly_payment AS pago_quincenal,
    l.total_payment AS pago_total,
    l.total_interest AS interes_total,
    l.commission_per_payment AS comision_por_pago,
    l.associate_payment AS pago_al_asociado,
    l.total_commission AS comision_total,
    ls.name AS estado,
    l.created_at AS fecha_creacion,
    l.approved_at AS fecha_aprobacion,
        CASE
            WHEN (l.amount > (0)::numeric) THEN round(((l.total_interest / l.amount) * (100)::numeric), 2)
            ELSE NULL::numeric
        END AS tasa_interes_efectiva_pct,
        CASE
            WHEN (l.biweekly_payment > (0)::numeric) THEN round(((l.commission_per_payment / l.biweekly_payment) * (100)::numeric), 2)
            ELSE NULL::numeric
        END AS comision_pct
   FROM (((public.loans l
     LEFT JOIN public.users u ON ((l.user_id = u.id)))
     LEFT JOIN public.rate_profiles rp ON (((l.profile_code)::text = (rp.code)::text)))
     LEFT JOIN public.loan_statuses ls ON ((l.status_id = ls.id)))
  WHERE (l.biweekly_payment IS NOT NULL);


--
-- Name: v_payment_changes_summary; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_payment_changes_summary AS
 SELECT date(psh.changed_at) AS change_date,
    psh.change_type,
    count(*) AS total_changes,
    count(DISTINCT psh.payment_id) AS unique_payments,
    count(DISTINCT psh.changed_by) AS unique_users,
    string_agg(DISTINCT (ps_new.name)::text, ', '::text) AS status_changes_to,
    min(psh.changed_at) AS first_change,
    max(psh.changed_at) AS last_change
   FROM (public.payment_status_history psh
     JOIN public.payment_statuses ps_new ON ((psh.new_status_id = ps_new.id)))
  GROUP BY (date(psh.changed_at)), psh.change_type
  ORDER BY (date(psh.changed_at)) DESC, (count(*)) DESC;


--
-- Name: v_payments_absorbed_by_associate; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_payments_absorbed_by_associate AS
 SELECT concat(ua.first_name, ' ', ua.last_name) AS associate_name,
    ap.id AS associate_profile_id,
    count(p.id) AS total_payments_absorbed,
    sum(p.amount_paid) AS total_amount_absorbed,
    ps.name AS payment_status,
    cp.cut_number,
    cp.period_start_date,
    cp.period_end_date,
    string_agg(DISTINCT concat(uc.first_name, ' ', uc.last_name), ', '::text) AS affected_clients
   FROM ((((((public.payments p
     JOIN public.payment_statuses ps ON ((p.status_id = ps.id)))
     JOIN public.loans l ON ((p.loan_id = l.id)))
     JOIN public.users uc ON ((l.user_id = uc.id)))
     JOIN public.users ua ON ((l.associate_user_id = ua.id)))
     JOIN public.associate_profiles ap ON ((ua.id = ap.user_id)))
     LEFT JOIN public.cut_periods cp ON ((p.cut_period_id = cp.id)))
  WHERE ((ps.is_real_payment = false) AND ((ps.name)::text = ANY ((ARRAY['PAID_BY_ASSOCIATE'::character varying, 'PAID_NOT_REPORTED'::character varying])::text[])))
  GROUP BY ua.first_name, ua.last_name, ap.id, ps.name, cp.cut_number, cp.period_start_date, cp.period_end_date
  ORDER BY (sum(p.amount_paid)) DESC;


--
-- Name: v_payments_by_status_detailed; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_payments_by_status_detailed AS
 SELECT p.id AS payment_id,
    p.loan_id,
    concat(u.first_name, ' ', u.last_name) AS client_name,
    l.amount AS loan_amount,
    p.amount_paid,
    p.payment_date,
    p.payment_due_date,
    p.is_late,
    ps.name AS payment_status,
    ps.is_real_payment,
        CASE
            WHEN ps.is_real_payment THEN 'REAL üíµ'::text
            ELSE 'FICTICIO ‚ö†Ô∏è'::text
        END AS payment_type,
    concat(um.first_name, ' ', um.last_name) AS marked_by_name,
    p.marked_at,
    p.marking_notes,
    cp.cut_number,
    cp.period_start_date,
    cp.period_end_date,
    concat(ua.first_name, ' ', ua.last_name) AS associate_name,
    p.created_at,
    p.updated_at
   FROM ((((((public.payments p
     JOIN public.loans l ON ((p.loan_id = l.id)))
     JOIN public.users u ON ((l.user_id = u.id)))
     JOIN public.payment_statuses ps ON ((p.status_id = ps.id)))
     LEFT JOIN public.users um ON ((p.marked_by = um.id)))
     LEFT JOIN public.cut_periods cp ON ((p.cut_period_id = cp.id)))
     LEFT JOIN public.users ua ON ((l.associate_user_id = ua.id)))
  ORDER BY p.payment_due_date DESC, p.id DESC;


--
-- Name: v_payments_multiple_changes; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_payments_multiple_changes AS
 SELECT p.id AS payment_id,
    p.loan_id,
    concat(u.first_name, ' ', u.last_name) AS client_name,
    count(psh.id) AS total_changes,
    string_agg(concat(ps.name, ' (', to_char(psh.changed_at, 'YYYY-MM-DD HH24:MI'::text), ')'), ' ‚Üí '::text ORDER BY psh.changed_at) AS status_timeline,
    min(psh.changed_at) AS first_change,
    max(psh.changed_at) AS last_change,
    (EXTRACT(epoch FROM (max(psh.changed_at) - min(psh.changed_at))) / (3600)::numeric) AS hours_between_first_last,
    count(
        CASE
            WHEN ((psh.change_type)::text = 'MANUAL_ADMIN'::text) THEN 1
            ELSE NULL::integer
        END) AS manual_changes_count,
        CASE
            WHEN (count(psh.id) >= 5) THEN 'CR√çTICO'::text
            WHEN (count(psh.id) >= 3) THEN 'ALERTA'::text
            ELSE 'NORMAL'::text
        END AS review_priority
   FROM ((((public.payments p
     JOIN public.payment_status_history psh ON ((p.id = psh.payment_id)))
     JOIN public.payment_statuses ps ON ((psh.new_status_id = ps.id)))
     JOIN public.loans l ON ((p.loan_id = l.id)))
     JOIN public.users u ON ((l.user_id = u.id)))
  GROUP BY p.id, p.loan_id, u.first_name, u.last_name
 HAVING (count(psh.id) >= 3)
  ORDER BY (count(psh.id)) DESC, (max(psh.changed_at)) DESC;


--
-- Name: v_payments_summary; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_payments_summary AS
 SELECT p.id,
    p.loan_id,
    l.user_id,
    u.username,
    p.payment_number,
    p.payment_due_date AS fecha_vencimiento,
    p.expected_amount AS monto_esperado,
    p.amount_paid AS monto_pagado,
    p.interest_amount AS interes,
    p.principal_amount AS capital,
    p.commission_amount AS comision,
    p.associate_payment AS pago_asociado,
    p.balance_remaining AS saldo_pendiente,
    ps.name AS estado_pago,
    cp.period_start_date AS periodo_inicio,
    cp.period_end_date AS periodo_fin,
    p.is_late AS esta_atrasado,
        CASE
            WHEN (p.expected_amount > (0)::numeric) THEN round(((p.amount_paid / p.expected_amount) * (100)::numeric), 2)
            ELSE (0)::numeric
        END AS porcentaje_pagado,
        CASE
            WHEN (p.amount_paid >= p.expected_amount) THEN 'PAGADO COMPLETO'::text
            WHEN (p.amount_paid > (0)::numeric) THEN 'PAGO PARCIAL'::text
            ELSE 'SIN PAGAR'::text
        END AS estado_pago_detalle,
    (p.expected_amount - p.amount_paid) AS saldo_pago
   FROM ((((public.payments p
     JOIN public.loans l ON ((p.loan_id = l.id)))
     LEFT JOIN public.users u ON ((l.user_id = u.id)))
     LEFT JOIN public.payment_statuses ps ON ((p.status_id = ps.id)))
     LEFT JOIN public.cut_periods cp ON ((p.cut_period_id = cp.id)))
  WHERE (p.expected_amount IS NOT NULL)
  ORDER BY l.id, p.payment_number;


--
-- Name: v_period_closure_summary; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_period_closure_summary AS
 SELECT cp.id AS cut_period_id,
    cp.cut_number,
    cp.period_start_date,
    cp.period_end_date,
    cps.name AS period_status,
    count(p.id) AS total_payments,
    count(
        CASE
            WHEN ((ps.name)::text = 'PAID'::text) THEN 1
            ELSE NULL::integer
        END) AS payments_paid,
    count(
        CASE
            WHEN ((ps.name)::text = 'PAID_NOT_REPORTED'::text) THEN 1
            ELSE NULL::integer
        END) AS payments_not_reported,
    count(
        CASE
            WHEN ((ps.name)::text = 'PAID_BY_ASSOCIATE'::text) THEN 1
            ELSE NULL::integer
        END) AS payments_by_associate,
    count(
        CASE
            WHEN ((ps.name)::text = ANY ((ARRAY['PENDING'::character varying, 'DUE_TODAY'::character varying, 'OVERDUE'::character varying])::text[])) THEN 1
            ELSE NULL::integer
        END) AS payments_pending,
    COALESCE(sum(
        CASE
            WHEN ((ps.name)::text = 'PAID'::text) THEN p.amount_paid
            ELSE (0)::numeric
        END), (0)::numeric) AS total_collected,
    cp.total_payments_expected,
    cp.total_commission,
    concat(u.first_name, ' ', u.last_name) AS closed_by_name,
    cp.updated_at AS last_updated
   FROM ((((public.cut_periods cp
     JOIN public.cut_period_statuses cps ON ((cp.status_id = cps.id)))
     LEFT JOIN public.payments p ON ((cp.id = p.cut_period_id)))
     LEFT JOIN public.payment_statuses ps ON ((p.status_id = ps.id)))
     LEFT JOIN public.users u ON ((cp.closed_by = u.id)))
  GROUP BY cp.id, cp.cut_number, cp.period_start_date, cp.period_end_date, cps.name, cp.total_payments_expected, cp.total_commission, u.first_name, u.last_name, cp.updated_at
  ORDER BY cp.period_start_date DESC;


--
-- Name: v_rate_reference_12q; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_rate_reference_12q AS
 SELECT rate_profile_reference_table.profile_code AS "Perfil",
    rate_profile_reference_table.amount AS "Importe",
    rate_profile_reference_table.biweekly_payment AS "Pago Cliente",
    rate_profile_reference_table.total_payment AS "Total Cliente",
    rate_profile_reference_table.commission_per_payment AS "Comisi√≥n",
    rate_profile_reference_table.total_commission AS "Comisi√≥n Total",
    rate_profile_reference_table.associate_payment AS "Pago Asociado",
    rate_profile_reference_table.associate_total AS "Total Asociado"
   FROM public.rate_profile_reference_table
  WHERE (rate_profile_reference_table.term_biweeks = 12)
  ORDER BY rate_profile_reference_table.profile_code, rate_profile_reference_table.amount;


--
-- Name: v_recent_payment_changes; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_recent_payment_changes AS
 SELECT psh.id AS change_id,
    psh.payment_id,
    p.loan_id,
    concat(u.first_name, ' ', u.last_name) AS client_name,
    ps_old.name AS old_status,
    ps_new.name AS new_status,
    psh.change_type,
    concat(uc.first_name, ' ', uc.last_name) AS changed_by_name,
    psh.change_reason,
    psh.changed_at,
    (EXTRACT(epoch FROM (CURRENT_TIMESTAMP - psh.changed_at)) / (3600)::numeric) AS hours_ago
   FROM ((((((public.payment_status_history psh
     JOIN public.payments p ON ((psh.payment_id = p.id)))
     JOIN public.loans l ON ((p.loan_id = l.id)))
     JOIN public.users u ON ((l.user_id = u.id)))
     LEFT JOIN public.payment_statuses ps_old ON ((psh.old_status_id = ps_old.id)))
     JOIN public.payment_statuses ps_new ON ((psh.new_status_id = ps_new.id)))
     LEFT JOIN public.users uc ON ((psh.changed_by = uc.id)))
  WHERE (psh.changed_at >= (CURRENT_TIMESTAMP - '24:00:00'::interval))
  ORDER BY psh.changed_at DESC;


--
-- Name: v_statement_payment_history; Type: VIEW; Schema: public; Owner: -
--

CREATE VIEW public.v_statement_payment_history AS
 SELECT asp.id AS payment_id,
    asp.statement_id,
    aps.statement_number,
    concat(u_assoc.first_name, ' ', u_assoc.last_name) AS associate_name,
    cp.cut_number,
    cp.period_start_date,
    cp.period_end_date,
    asp.payment_amount,
    asp.payment_date,
    pm.name AS payment_method,
    asp.payment_reference,
    asp.notes,
    aps.total_to_credicuenta,
    aps.commission_earned,
    aps.late_fee_amount,
    (aps.total_to_credicuenta + aps.late_fee_amount) AS total_owed,
    aps.paid_amount AS total_paid_to_date,
    ((aps.total_to_credicuenta + aps.late_fee_amount) - aps.paid_amount) AS remaining_balance,
    ss.name AS statement_status,
    concat(u_reg.first_name, ' ', u_reg.last_name) AS registered_by_name,
    asp.created_at AS payment_registered_at
   FROM ((((((public.associate_statement_payments asp
     JOIN public.associate_payment_statements aps ON ((asp.statement_id = aps.id)))
     JOIN public.users u_assoc ON ((aps.user_id = u_assoc.id)))
     JOIN public.cut_periods cp ON ((aps.cut_period_id = cp.id)))
     JOIN public.payment_methods pm ON ((asp.payment_method_id = pm.id)))
     JOIN public.statement_statuses ss ON ((aps.status_id = ss.id)))
     JOIN public.users u_reg ON ((asp.registered_by = u_reg.id)))
  ORDER BY asp.payment_date DESC, asp.id DESC;


--
-- Name: addresses id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.addresses ALTER COLUMN id SET DEFAULT nextval('public.addresses_id_seq'::regclass);


--
-- Name: agreement_items id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreement_items ALTER COLUMN id SET DEFAULT nextval('public.agreement_items_id_seq'::regclass);


--
-- Name: agreement_payments id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreement_payments ALTER COLUMN id SET DEFAULT nextval('public.agreement_payments_id_seq'::regclass);


--
-- Name: agreements id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreements ALTER COLUMN id SET DEFAULT nextval('public.agreements_id_seq'::regclass);


--
-- Name: associate_accumulated_balances id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_accumulated_balances ALTER COLUMN id SET DEFAULT nextval('public.associate_accumulated_balances_id_seq'::regclass);


--
-- Name: associate_debt_payments id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_debt_payments ALTER COLUMN id SET DEFAULT nextval('public.associate_debt_payments_id_seq'::regclass);


--
-- Name: associate_level_history id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_level_history ALTER COLUMN id SET DEFAULT nextval('public.associate_level_history_id_seq'::regclass);


--
-- Name: associate_levels id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_levels ALTER COLUMN id SET DEFAULT nextval('public.associate_levels_id_seq'::regclass);


--
-- Name: associate_payment_statements id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_payment_statements ALTER COLUMN id SET DEFAULT nextval('public.associate_payment_statements_id_seq'::regclass);


--
-- Name: associate_profiles id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_profiles ALTER COLUMN id SET DEFAULT nextval('public.associate_profiles_id_seq'::regclass);


--
-- Name: associate_statement_payments id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_statement_payments ALTER COLUMN id SET DEFAULT nextval('public.associate_statement_payments_id_seq'::regclass);


--
-- Name: audit_log id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_log ALTER COLUMN id SET DEFAULT nextval('public.audit_log_id_seq'::regclass);


--
-- Name: audit_session_log id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_session_log ALTER COLUMN id SET DEFAULT nextval('public.audit_session_log_id_seq'::regclass);


--
-- Name: beneficiaries id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.beneficiaries ALTER COLUMN id SET DEFAULT nextval('public.beneficiaries_id_seq'::regclass);


--
-- Name: client_documents id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.client_documents ALTER COLUMN id SET DEFAULT nextval('public.client_documents_id_seq'::regclass);


--
-- Name: config_types id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.config_types ALTER COLUMN id SET DEFAULT nextval('public.config_types_id_seq'::regclass);


--
-- Name: contract_statuses id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contract_statuses ALTER COLUMN id SET DEFAULT nextval('public.contract_statuses_id_seq'::regclass);


--
-- Name: contracts id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contracts ALTER COLUMN id SET DEFAULT nextval('public.contracts_id_seq'::regclass);


--
-- Name: cut_period_statuses id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cut_period_statuses ALTER COLUMN id SET DEFAULT nextval('public.cut_period_statuses_id_seq'::regclass);


--
-- Name: cut_periods id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cut_periods ALTER COLUMN id SET DEFAULT nextval('public.cut_periods_id_seq'::regclass);


--
-- Name: defaulted_client_reports id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.defaulted_client_reports ALTER COLUMN id SET DEFAULT nextval('public.defaulted_client_reports_id_seq'::regclass);


--
-- Name: document_statuses id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.document_statuses ALTER COLUMN id SET DEFAULT nextval('public.document_statuses_id_seq'::regclass);


--
-- Name: document_types id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.document_types ALTER COLUMN id SET DEFAULT nextval('public.document_types_id_seq'::regclass);


--
-- Name: guarantors id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.guarantors ALTER COLUMN id SET DEFAULT nextval('public.guarantors_id_seq'::regclass);


--
-- Name: legacy_payment_table id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.legacy_payment_table ALTER COLUMN id SET DEFAULT nextval('public.legacy_payment_table_id_seq'::regclass);


--
-- Name: level_change_types id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.level_change_types ALTER COLUMN id SET DEFAULT nextval('public.level_change_types_id_seq'::regclass);


--
-- Name: loan_renewals id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loan_renewals ALTER COLUMN id SET DEFAULT nextval('public.loan_renewals_id_seq'::regclass);


--
-- Name: loan_statuses id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loan_statuses ALTER COLUMN id SET DEFAULT nextval('public.loan_statuses_id_seq'::regclass);


--
-- Name: loans id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loans ALTER COLUMN id SET DEFAULT nextval('public.loans_id_seq'::regclass);


--
-- Name: payment_methods id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_methods ALTER COLUMN id SET DEFAULT nextval('public.payment_methods_id_seq'::regclass);


--
-- Name: payment_status_history id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_status_history ALTER COLUMN id SET DEFAULT nextval('public.payment_status_history_id_seq'::regclass);


--
-- Name: payment_statuses id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_statuses ALTER COLUMN id SET DEFAULT nextval('public.payment_statuses_id_seq'::regclass);


--
-- Name: payments id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payments ALTER COLUMN id SET DEFAULT nextval('public.payments_id_seq'::regclass);


--
-- Name: rate_profile_reference_table id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.rate_profile_reference_table ALTER COLUMN id SET DEFAULT nextval('public.rate_profile_reference_table_id_seq'::regclass);


--
-- Name: rate_profiles id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.rate_profiles ALTER COLUMN id SET DEFAULT nextval('public.rate_profiles_id_seq'::regclass);


--
-- Name: relationships id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.relationships ALTER COLUMN id SET DEFAULT nextval('public.relationships_id_seq'::regclass);


--
-- Name: roles id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roles ALTER COLUMN id SET DEFAULT nextval('public.roles_id_seq'::regclass);


--
-- Name: statement_statuses id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.statement_statuses ALTER COLUMN id SET DEFAULT nextval('public.statement_statuses_id_seq'::regclass);


--
-- Name: system_configurations id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.system_configurations ALTER COLUMN id SET DEFAULT nextval('public.system_configurations_id_seq'::regclass);


--
-- Name: users id; Type: DEFAULT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users ALTER COLUMN id SET DEFAULT nextval('public.users_id_seq'::regclass);


--
-- Name: addresses addresses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.addresses
    ADD CONSTRAINT addresses_pkey PRIMARY KEY (id);


--
-- Name: addresses addresses_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.addresses
    ADD CONSTRAINT addresses_user_id_key UNIQUE (user_id);


--
-- Name: agreement_items agreement_items_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreement_items
    ADD CONSTRAINT agreement_items_pkey PRIMARY KEY (id);


--
-- Name: agreement_payments agreement_payments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreement_payments
    ADD CONSTRAINT agreement_payments_pkey PRIMARY KEY (id);


--
-- Name: agreements agreements_agreement_number_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreements
    ADD CONSTRAINT agreements_agreement_number_key UNIQUE (agreement_number);


--
-- Name: agreements agreements_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreements
    ADD CONSTRAINT agreements_pkey PRIMARY KEY (id);


--
-- Name: associate_accumulated_balances associate_accumulated_balances_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_accumulated_balances
    ADD CONSTRAINT associate_accumulated_balances_pkey PRIMARY KEY (id);


--
-- Name: associate_accumulated_balances associate_accumulated_balances_user_id_cut_period_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_accumulated_balances
    ADD CONSTRAINT associate_accumulated_balances_user_id_cut_period_id_key UNIQUE (user_id, cut_period_id);


--
-- Name: associate_debt_payments associate_debt_payments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_debt_payments
    ADD CONSTRAINT associate_debt_payments_pkey PRIMARY KEY (id);


--
-- Name: associate_level_history associate_level_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_level_history
    ADD CONSTRAINT associate_level_history_pkey PRIMARY KEY (id);


--
-- Name: associate_levels associate_levels_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_levels
    ADD CONSTRAINT associate_levels_name_key UNIQUE (name);


--
-- Name: associate_levels associate_levels_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_levels
    ADD CONSTRAINT associate_levels_pkey PRIMARY KEY (id);


--
-- Name: associate_payment_statements associate_payment_statements_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_payment_statements
    ADD CONSTRAINT associate_payment_statements_pkey PRIMARY KEY (id);


--
-- Name: associate_profiles associate_profiles_contact_email_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_profiles
    ADD CONSTRAINT associate_profiles_contact_email_key UNIQUE (contact_email);


--
-- Name: associate_profiles associate_profiles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_profiles
    ADD CONSTRAINT associate_profiles_pkey PRIMARY KEY (id);


--
-- Name: associate_profiles associate_profiles_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_profiles
    ADD CONSTRAINT associate_profiles_user_id_key UNIQUE (user_id);


--
-- Name: associate_statement_payments associate_statement_payments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_statement_payments
    ADD CONSTRAINT associate_statement_payments_pkey PRIMARY KEY (id);


--
-- Name: audit_log audit_log_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_log
    ADD CONSTRAINT audit_log_pkey PRIMARY KEY (id);


--
-- Name: audit_session_log audit_session_log_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_session_log
    ADD CONSTRAINT audit_session_log_pkey PRIMARY KEY (id);


--
-- Name: beneficiaries beneficiaries_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.beneficiaries
    ADD CONSTRAINT beneficiaries_pkey PRIMARY KEY (id);


--
-- Name: beneficiaries beneficiaries_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.beneficiaries
    ADD CONSTRAINT beneficiaries_user_id_key UNIQUE (user_id);


--
-- Name: client_documents client_documents_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.client_documents
    ADD CONSTRAINT client_documents_pkey PRIMARY KEY (id);


--
-- Name: config_types config_types_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.config_types
    ADD CONSTRAINT config_types_name_key UNIQUE (name);


--
-- Name: config_types config_types_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.config_types
    ADD CONSTRAINT config_types_pkey PRIMARY KEY (id);


--
-- Name: contract_statuses contract_statuses_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contract_statuses
    ADD CONSTRAINT contract_statuses_name_key UNIQUE (name);


--
-- Name: contract_statuses contract_statuses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contract_statuses
    ADD CONSTRAINT contract_statuses_pkey PRIMARY KEY (id);


--
-- Name: contracts contracts_document_number_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contracts
    ADD CONSTRAINT contracts_document_number_key UNIQUE (document_number);


--
-- Name: contracts contracts_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contracts
    ADD CONSTRAINT contracts_pkey PRIMARY KEY (id);


--
-- Name: cut_period_statuses cut_period_statuses_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cut_period_statuses
    ADD CONSTRAINT cut_period_statuses_name_key UNIQUE (name);


--
-- Name: cut_period_statuses cut_period_statuses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cut_period_statuses
    ADD CONSTRAINT cut_period_statuses_pkey PRIMARY KEY (id);


--
-- Name: cut_periods cut_periods_cut_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cut_periods
    ADD CONSTRAINT cut_periods_cut_code_key UNIQUE (cut_code);


--
-- Name: cut_periods cut_periods_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cut_periods
    ADD CONSTRAINT cut_periods_pkey PRIMARY KEY (id);


--
-- Name: defaulted_client_reports defaulted_client_reports_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.defaulted_client_reports
    ADD CONSTRAINT defaulted_client_reports_pkey PRIMARY KEY (id);


--
-- Name: document_statuses document_statuses_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.document_statuses
    ADD CONSTRAINT document_statuses_name_key UNIQUE (name);


--
-- Name: document_statuses document_statuses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.document_statuses
    ADD CONSTRAINT document_statuses_pkey PRIMARY KEY (id);


--
-- Name: document_types document_types_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.document_types
    ADD CONSTRAINT document_types_name_key UNIQUE (name);


--
-- Name: document_types document_types_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.document_types
    ADD CONSTRAINT document_types_pkey PRIMARY KEY (id);


--
-- Name: guarantors guarantors_curp_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.guarantors
    ADD CONSTRAINT guarantors_curp_key UNIQUE (curp);


--
-- Name: guarantors guarantors_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.guarantors
    ADD CONSTRAINT guarantors_pkey PRIMARY KEY (id);


--
-- Name: guarantors guarantors_user_id_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.guarantors
    ADD CONSTRAINT guarantors_user_id_key UNIQUE (user_id);


--
-- Name: legacy_payment_table legacy_payment_table_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.legacy_payment_table
    ADD CONSTRAINT legacy_payment_table_pkey PRIMARY KEY (id);


--
-- Name: level_change_types level_change_types_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.level_change_types
    ADD CONSTRAINT level_change_types_name_key UNIQUE (name);


--
-- Name: level_change_types level_change_types_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.level_change_types
    ADD CONSTRAINT level_change_types_pkey PRIMARY KEY (id);


--
-- Name: loan_renewals loan_renewals_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loan_renewals
    ADD CONSTRAINT loan_renewals_pkey PRIMARY KEY (id);


--
-- Name: loan_statuses loan_statuses_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loan_statuses
    ADD CONSTRAINT loan_statuses_name_key UNIQUE (name);


--
-- Name: loan_statuses loan_statuses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loan_statuses
    ADD CONSTRAINT loan_statuses_pkey PRIMARY KEY (id);


--
-- Name: loans loans_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loans
    ADD CONSTRAINT loans_pkey PRIMARY KEY (id);


--
-- Name: payment_methods payment_methods_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_methods
    ADD CONSTRAINT payment_methods_name_key UNIQUE (name);


--
-- Name: payment_methods payment_methods_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_methods
    ADD CONSTRAINT payment_methods_pkey PRIMARY KEY (id);


--
-- Name: payment_status_history payment_status_history_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_status_history
    ADD CONSTRAINT payment_status_history_pkey PRIMARY KEY (id);


--
-- Name: payment_statuses payment_statuses_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_statuses
    ADD CONSTRAINT payment_statuses_name_key UNIQUE (name);


--
-- Name: payment_statuses payment_statuses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_statuses
    ADD CONSTRAINT payment_statuses_pkey PRIMARY KEY (id);


--
-- Name: payments payments_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payments
    ADD CONSTRAINT payments_pkey PRIMARY KEY (id);


--
-- Name: rate_profile_reference_table rate_profile_reference_table_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.rate_profile_reference_table
    ADD CONSTRAINT rate_profile_reference_table_pkey PRIMARY KEY (id);


--
-- Name: rate_profiles rate_profiles_code_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.rate_profiles
    ADD CONSTRAINT rate_profiles_code_key UNIQUE (code);


--
-- Name: rate_profiles rate_profiles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.rate_profiles
    ADD CONSTRAINT rate_profiles_pkey PRIMARY KEY (id);


--
-- Name: relationships relationships_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.relationships
    ADD CONSTRAINT relationships_name_key UNIQUE (name);


--
-- Name: relationships relationships_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.relationships
    ADD CONSTRAINT relationships_pkey PRIMARY KEY (id);


--
-- Name: roles roles_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roles
    ADD CONSTRAINT roles_name_key UNIQUE (name);


--
-- Name: roles roles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.roles
    ADD CONSTRAINT roles_pkey PRIMARY KEY (id);


--
-- Name: statement_statuses statement_statuses_name_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.statement_statuses
    ADD CONSTRAINT statement_statuses_name_key UNIQUE (name);


--
-- Name: statement_statuses statement_statuses_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.statement_statuses
    ADD CONSTRAINT statement_statuses_pkey PRIMARY KEY (id);


--
-- Name: system_configurations system_configurations_config_key_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.system_configurations
    ADD CONSTRAINT system_configurations_config_key_key UNIQUE (config_key);


--
-- Name: system_configurations system_configurations_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.system_configurations
    ADD CONSTRAINT system_configurations_pkey PRIMARY KEY (id);


--
-- Name: legacy_payment_table uq_legacy_amount_term; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.legacy_payment_table
    ADD CONSTRAINT uq_legacy_amount_term UNIQUE (amount, term_biweeks);


--
-- Name: rate_profile_reference_table uq_profile_amount_term; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.rate_profile_reference_table
    ADD CONSTRAINT uq_profile_amount_term UNIQUE (profile_code, amount, term_biweeks);


--
-- Name: user_roles user_roles_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_roles
    ADD CONSTRAINT user_roles_pkey PRIMARY KEY (user_id, role_id);


--
-- Name: users users_curp_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_curp_key UNIQUE (curp);


--
-- Name: users users_email_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_email_key UNIQUE (email);


--
-- Name: users users_phone_number_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_phone_number_key UNIQUE (phone_number);


--
-- Name: users users_pkey; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_pkey PRIMARY KEY (id);


--
-- Name: users users_username_key; Type: CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.users
    ADD CONSTRAINT users_username_key UNIQUE (username);


--
-- Name: idx_agreement_items_agreement_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_agreement_items_agreement_id ON public.agreement_items USING btree (agreement_id);


--
-- Name: idx_agreement_items_loan_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_agreement_items_loan_id ON public.agreement_items USING btree (loan_id);


--
-- Name: idx_agreement_payments_agreement_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_agreement_payments_agreement_id ON public.agreement_payments USING btree (agreement_id);


--
-- Name: idx_agreement_payments_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_agreement_payments_status ON public.agreement_payments USING btree (status);


--
-- Name: idx_agreements_associate_profile_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_agreements_associate_profile_id ON public.agreements USING btree (associate_profile_id);


--
-- Name: idx_agreements_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_agreements_status ON public.agreements USING btree (status);


--
-- Name: idx_associate_profiles_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_associate_profiles_active ON public.associate_profiles USING btree (active);


--
-- Name: idx_associate_profiles_credit_used; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_associate_profiles_credit_used ON public.associate_profiles USING btree (credit_used);


--
-- Name: idx_associate_profiles_level_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_associate_profiles_level_id ON public.associate_profiles USING btree (level_id);


--
-- Name: idx_associate_profiles_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_associate_profiles_user_id ON public.associate_profiles USING btree (user_id);


--
-- Name: idx_audit_log_changed_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_log_changed_at ON public.audit_log USING btree (changed_at);


--
-- Name: idx_audit_log_changed_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_log_changed_by ON public.audit_log USING btree (changed_by);


--
-- Name: idx_audit_log_operation; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_log_operation ON public.audit_log USING btree (operation);


--
-- Name: idx_audit_log_table_record; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_audit_log_table_record ON public.audit_log USING btree (table_name, record_id);


--
-- Name: idx_beneficiaries_relationship_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_beneficiaries_relationship_id ON public.beneficiaries USING btree (relationship_id);


--
-- Name: idx_client_documents_status_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_client_documents_status_id ON public.client_documents USING btree (status_id);


--
-- Name: idx_client_documents_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_client_documents_user_id ON public.client_documents USING btree (user_id);


--
-- Name: idx_config_types_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_config_types_name ON public.config_types USING btree (name);


--
-- Name: idx_contract_statuses_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contract_statuses_name ON public.contract_statuses USING btree (name);


--
-- Name: idx_contracts_document_number; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contracts_document_number ON public.contracts USING btree (document_number);


--
-- Name: idx_contracts_loan_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_contracts_loan_id ON public.contracts USING btree (loan_id);


--
-- Name: idx_cut_period_statuses_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_cut_period_statuses_name ON public.cut_period_statuses USING btree (name);


--
-- Name: idx_cut_periods_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_cut_periods_active ON public.cut_periods USING btree (status_id) WHERE (status_id = ANY (ARRAY[1, 2]));


--
-- Name: idx_cut_periods_cut_code; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_cut_periods_cut_code ON public.cut_periods USING btree (cut_code);


--
-- Name: idx_cut_periods_dates; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_cut_periods_dates ON public.cut_periods USING btree (period_start_date, period_end_date);


--
-- Name: idx_cut_periods_status_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_cut_periods_status_id ON public.cut_periods USING btree (status_id);


--
-- Name: idx_debt_payments_applied_items; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_debt_payments_applied_items ON public.associate_debt_payments USING gin (applied_breakdown_items);


--
-- Name: idx_debt_payments_associate_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_debt_payments_associate_date ON public.associate_debt_payments USING btree (associate_profile_id, payment_date DESC);


--
-- Name: idx_debt_payments_associate_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_debt_payments_associate_id ON public.associate_debt_payments USING btree (associate_profile_id);


--
-- Name: idx_debt_payments_method; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_debt_payments_method ON public.associate_debt_payments USING btree (payment_method_id);


--
-- Name: idx_debt_payments_payment_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_debt_payments_payment_date ON public.associate_debt_payments USING btree (payment_date);


--
-- Name: idx_debt_payments_registered_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_debt_payments_registered_by ON public.associate_debt_payments USING btree (registered_by);


--
-- Name: idx_defaulted_reports_associate_profile_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_defaulted_reports_associate_profile_id ON public.defaulted_client_reports USING btree (associate_profile_id);


--
-- Name: idx_defaulted_reports_client_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_defaulted_reports_client_user_id ON public.defaulted_client_reports USING btree (client_user_id);


--
-- Name: idx_defaulted_reports_loan_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_defaulted_reports_loan_id ON public.defaulted_client_reports USING btree (loan_id);


--
-- Name: idx_defaulted_reports_reported_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_defaulted_reports_reported_at ON public.defaulted_client_reports USING btree (reported_at DESC);


--
-- Name: idx_defaulted_reports_status; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_defaulted_reports_status ON public.defaulted_client_reports USING btree (status);


--
-- Name: idx_document_statuses_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_document_statuses_name ON public.document_statuses USING btree (name);


--
-- Name: idx_guarantors_relationship_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_guarantors_relationship_id ON public.guarantors USING btree (relationship_id);


--
-- Name: idx_legacy_amount; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_legacy_amount ON public.legacy_payment_table USING btree (amount);


--
-- Name: idx_legacy_amount_term_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_legacy_amount_term_unique ON public.legacy_payment_table USING btree (amount, term_biweeks);


--
-- Name: idx_legacy_term; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_legacy_term ON public.legacy_payment_table USING btree (term_biweeks);


--
-- Name: idx_level_change_types_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_level_change_types_name ON public.level_change_types USING btree (name);


--
-- Name: idx_loan_renewals_original_loan_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_loan_renewals_original_loan_id ON public.loan_renewals USING btree (original_loan_id);


--
-- Name: idx_loan_renewals_renewed_loan_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_loan_renewals_renewed_loan_id ON public.loan_renewals USING btree (renewed_loan_id);


--
-- Name: idx_loan_statuses_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_loan_statuses_active ON public.loan_statuses USING btree (is_active);


--
-- Name: idx_loan_statuses_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_loan_statuses_name ON public.loan_statuses USING btree (name);


--
-- Name: idx_loans_approved_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_loans_approved_at ON public.loans USING btree (approved_at) WHERE (approved_at IS NOT NULL);


--
-- Name: idx_loans_associate_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_loans_associate_user_id ON public.loans USING btree (associate_user_id);


--
-- Name: idx_loans_biweekly_payment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_loans_biweekly_payment ON public.loans USING btree (biweekly_payment) WHERE (biweekly_payment IS NOT NULL);


--
-- Name: idx_loans_profile_code_biweekly; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_loans_profile_code_biweekly ON public.loans USING btree (profile_code, biweekly_payment) WHERE ((profile_code IS NOT NULL) AND (biweekly_payment IS NOT NULL));


--
-- Name: idx_loans_status_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_loans_status_id ON public.loans USING btree (status_id);


--
-- Name: idx_loans_status_id_approved_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_loans_status_id_approved_at ON public.loans USING btree (status_id, approved_at);


--
-- Name: idx_loans_total_payment; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_loans_total_payment ON public.loans USING btree (total_payment) WHERE (total_payment IS NOT NULL);


--
-- Name: idx_loans_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_loans_user_id ON public.loans USING btree (user_id);


--
-- Name: idx_payment_methods_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_methods_name ON public.payment_methods USING btree (name);


--
-- Name: idx_payment_status_history_change_type; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_status_history_change_type ON public.payment_status_history USING btree (change_type);


--
-- Name: idx_payment_status_history_changed_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_status_history_changed_at ON public.payment_status_history USING btree (changed_at DESC);


--
-- Name: idx_payment_status_history_changed_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_status_history_changed_by ON public.payment_status_history USING btree (changed_by);


--
-- Name: idx_payment_status_history_new_status_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_status_history_new_status_id ON public.payment_status_history USING btree (new_status_id);


--
-- Name: idx_payment_status_history_payment_changed_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_status_history_payment_changed_at ON public.payment_status_history USING btree (payment_id, changed_at DESC);


--
-- Name: idx_payment_status_history_payment_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_status_history_payment_id ON public.payment_status_history USING btree (payment_id);


--
-- Name: idx_payment_statuses_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_statuses_active ON public.payment_statuses USING btree (is_active);


--
-- Name: idx_payment_statuses_is_real; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_statuses_is_real ON public.payment_statuses USING btree (is_real_payment);


--
-- Name: idx_payment_statuses_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payment_statuses_name ON public.payment_statuses USING btree (name);


--
-- Name: idx_payments_balance_remaining; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_balance_remaining ON public.payments USING btree (balance_remaining) WHERE (balance_remaining IS NOT NULL);


--
-- Name: idx_payments_cut_period_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_cut_period_id ON public.payments USING btree (cut_period_id);


--
-- Name: idx_payments_due_date_status_expected; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_due_date_status_expected ON public.payments USING btree (payment_due_date, status_id, expected_amount) WHERE (expected_amount IS NOT NULL);


--
-- Name: idx_payments_expected_amount; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_expected_amount ON public.payments USING btree (expected_amount) WHERE (expected_amount IS NOT NULL);


--
-- Name: idx_payments_is_late; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_is_late ON public.payments USING btree (is_late);


--
-- Name: idx_payments_late_loan; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_late_loan ON public.payments USING btree (loan_id, is_late, payment_due_date);


--
-- Name: idx_payments_loan_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_loan_id ON public.payments USING btree (loan_id);


--
-- Name: idx_payments_loan_number_unique; Type: INDEX; Schema: public; Owner: -
--

CREATE UNIQUE INDEX idx_payments_loan_number_unique ON public.payments USING btree (loan_id, payment_number) WHERE (payment_number IS NOT NULL);


--
-- Name: idx_payments_payment_due_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_payment_due_date ON public.payments USING btree (payment_due_date);


--
-- Name: idx_payments_payment_number; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_payment_number ON public.payments USING btree (payment_number) WHERE (payment_number IS NOT NULL);


--
-- Name: idx_payments_status_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_payments_status_id ON public.payments USING btree (status_id);


--
-- Name: idx_rate_profiles_code; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_rate_profiles_code ON public.rate_profiles USING btree (code);


--
-- Name: idx_rate_profiles_display; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_rate_profiles_display ON public.rate_profiles USING btree (display_order);


--
-- Name: idx_rate_profiles_enabled; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_rate_profiles_enabled ON public.rate_profiles USING btree (enabled) WHERE (enabled = true);


--
-- Name: idx_session_log_is_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_session_log_is_active ON public.audit_session_log USING btree (is_active);


--
-- Name: idx_session_log_login_at; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_session_log_login_at ON public.audit_session_log USING btree (login_at DESC);


--
-- Name: idx_session_log_user_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_session_log_user_id ON public.audit_session_log USING btree (user_id);


--
-- Name: idx_statement_payments_method; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_statement_payments_method ON public.associate_statement_payments USING btree (payment_method_id);


--
-- Name: idx_statement_payments_payment_date; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_statement_payments_payment_date ON public.associate_statement_payments USING btree (payment_date);


--
-- Name: idx_statement_payments_registered_by; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_statement_payments_registered_by ON public.associate_statement_payments USING btree (registered_by);


--
-- Name: idx_statement_payments_statement_amount; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_statement_payments_statement_amount ON public.associate_statement_payments USING btree (statement_id, payment_amount);


--
-- Name: idx_statement_payments_statement_id; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_statement_payments_statement_id ON public.associate_statement_payments USING btree (statement_id);


--
-- Name: idx_statement_statuses_name; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_statement_statuses_name ON public.statement_statuses USING btree (name);


--
-- Name: idx_users_active; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_active ON public.users USING btree (active);


--
-- Name: idx_users_email_lower; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_email_lower ON public.users USING btree (lower((email)::text));


--
-- Name: idx_users_username_lower; Type: INDEX; Schema: public; Owner: -
--

CREATE INDEX idx_users_username_lower ON public.users USING btree (lower((username)::text));


--
-- Name: contracts audit_contracts_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER audit_contracts_trigger AFTER INSERT OR DELETE OR UPDATE ON public.contracts FOR EACH ROW EXECUTE FUNCTION public.audit_trigger_function();


--
-- Name: cut_periods audit_cut_periods_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER audit_cut_periods_trigger AFTER INSERT OR DELETE OR UPDATE ON public.cut_periods FOR EACH ROW EXECUTE FUNCTION public.audit_trigger_function();


--
-- Name: loans audit_loans_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER audit_loans_trigger AFTER INSERT OR DELETE OR UPDATE ON public.loans FOR EACH ROW EXECUTE FUNCTION public.audit_trigger_function();


--
-- Name: payments audit_payments_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER audit_payments_trigger AFTER INSERT OR DELETE OR UPDATE ON public.payments FOR EACH ROW EXECUTE FUNCTION public.audit_trigger_function();


--
-- Name: users audit_users_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER audit_users_trigger AFTER INSERT OR DELETE OR UPDATE ON public.users FOR EACH ROW EXECUTE FUNCTION public.audit_trigger_function();


--
-- Name: loans handle_loan_approval_trigger; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER handle_loan_approval_trigger BEFORE UPDATE ON public.loans FOR EACH ROW EXECUTE FUNCTION public.handle_loan_approval_status();


--
-- Name: loans trigger_generate_payment_schedule; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_generate_payment_schedule AFTER UPDATE OF status_id ON public.loans FOR EACH ROW EXECUTE FUNCTION public.generate_payment_schedule();


--
-- Name: legacy_payment_table trigger_legacy_payment_table_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_legacy_payment_table_updated_at BEFORE UPDATE ON public.legacy_payment_table FOR EACH ROW EXECUTE FUNCTION public.update_legacy_payment_table_timestamp();


--
-- Name: payments trigger_log_payment_status_change; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_log_payment_status_change AFTER UPDATE OF status_id ON public.payments FOR EACH ROW EXECUTE FUNCTION public.log_payment_status_change();


--
-- Name: associate_profiles trigger_update_associate_credit_on_level_change; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_associate_credit_on_level_change AFTER UPDATE OF level_id ON public.associate_profiles FOR EACH ROW EXECUTE FUNCTION public.trigger_update_associate_credit_on_level_change();


--
-- Name: loans trigger_update_associate_credit_on_loan_approval; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_associate_credit_on_loan_approval AFTER UPDATE OF status_id ON public.loans FOR EACH ROW EXECUTE FUNCTION public.trigger_update_associate_credit_on_loan_approval();


--
-- Name: payments trigger_update_associate_credit_on_payment; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_associate_credit_on_payment AFTER UPDATE OF amount_paid ON public.payments FOR EACH ROW EXECUTE FUNCTION public.trigger_update_associate_credit_on_payment();


--
-- Name: associate_statement_payments trigger_update_statement_on_payment; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER trigger_update_statement_on_payment AFTER INSERT ON public.associate_statement_payments FOR EACH ROW EXECUTE FUNCTION public.update_statement_on_payment();


--
-- Name: addresses update_addresses_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_addresses_updated_at BEFORE UPDATE ON public.addresses FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: associate_debt_payments update_associate_debt_payments_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_associate_debt_payments_updated_at BEFORE UPDATE ON public.associate_debt_payments FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: associate_payment_statements update_associate_payment_statements_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_associate_payment_statements_updated_at BEFORE UPDATE ON public.associate_payment_statements FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: associate_profiles update_associate_profiles_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_associate_profiles_updated_at BEFORE UPDATE ON public.associate_profiles FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: associate_statement_payments update_associate_statement_payments_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_associate_statement_payments_updated_at BEFORE UPDATE ON public.associate_statement_payments FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: beneficiaries update_beneficiaries_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_beneficiaries_updated_at BEFORE UPDATE ON public.beneficiaries FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: client_documents update_client_documents_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_client_documents_updated_at BEFORE UPDATE ON public.client_documents FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: config_types update_config_types_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_config_types_updated_at BEFORE UPDATE ON public.config_types FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: contract_statuses update_contract_statuses_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_contract_statuses_updated_at BEFORE UPDATE ON public.contract_statuses FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: contracts update_contracts_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_contracts_updated_at BEFORE UPDATE ON public.contracts FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: cut_period_statuses update_cut_period_statuses_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_cut_period_statuses_updated_at BEFORE UPDATE ON public.cut_period_statuses FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: cut_periods update_cut_periods_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_cut_periods_updated_at BEFORE UPDATE ON public.cut_periods FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: document_statuses update_document_statuses_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_document_statuses_updated_at BEFORE UPDATE ON public.document_statuses FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: guarantors update_guarantors_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_guarantors_updated_at BEFORE UPDATE ON public.guarantors FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: level_change_types update_level_change_types_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_level_change_types_updated_at BEFORE UPDATE ON public.level_change_types FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: loan_statuses update_loan_statuses_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_loan_statuses_updated_at BEFORE UPDATE ON public.loan_statuses FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: loans update_loans_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_loans_updated_at BEFORE UPDATE ON public.loans FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: payment_methods update_payment_methods_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_payment_methods_updated_at BEFORE UPDATE ON public.payment_methods FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: payments update_payments_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_payments_updated_at BEFORE UPDATE ON public.payments FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: statement_statuses update_statement_statuses_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_statement_statuses_updated_at BEFORE UPDATE ON public.statement_statuses FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: system_configurations update_system_configurations_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_system_configurations_updated_at BEFORE UPDATE ON public.system_configurations FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: users update_users_updated_at; Type: TRIGGER; Schema: public; Owner: -
--

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON public.users FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();


--
-- Name: addresses addresses_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.addresses
    ADD CONSTRAINT addresses_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- Name: agreement_items agreement_items_agreement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreement_items
    ADD CONSTRAINT agreement_items_agreement_id_fkey FOREIGN KEY (agreement_id) REFERENCES public.agreements(id) ON DELETE CASCADE;


--
-- Name: agreement_items agreement_items_client_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreement_items
    ADD CONSTRAINT agreement_items_client_user_id_fkey FOREIGN KEY (client_user_id) REFERENCES public.users(id);


--
-- Name: agreement_items agreement_items_loan_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreement_items
    ADD CONSTRAINT agreement_items_loan_id_fkey FOREIGN KEY (loan_id) REFERENCES public.loans(id);


--
-- Name: agreement_payments agreement_payments_agreement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreement_payments
    ADD CONSTRAINT agreement_payments_agreement_id_fkey FOREIGN KEY (agreement_id) REFERENCES public.agreements(id) ON DELETE CASCADE;


--
-- Name: agreement_payments agreement_payments_payment_method_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreement_payments
    ADD CONSTRAINT agreement_payments_payment_method_id_fkey FOREIGN KEY (payment_method_id) REFERENCES public.payment_methods(id);


--
-- Name: agreements agreements_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreements
    ADD CONSTRAINT agreements_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.users(id);


--
-- Name: agreements agreements_associate_profile_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreements
    ADD CONSTRAINT agreements_associate_profile_id_fkey FOREIGN KEY (associate_profile_id) REFERENCES public.associate_profiles(id) ON DELETE CASCADE;


--
-- Name: agreements agreements_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.agreements
    ADD CONSTRAINT agreements_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id);


--
-- Name: associate_accumulated_balances associate_accumulated_balances_cut_period_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_accumulated_balances
    ADD CONSTRAINT associate_accumulated_balances_cut_period_id_fkey FOREIGN KEY (cut_period_id) REFERENCES public.cut_periods(id);


--
-- Name: associate_accumulated_balances associate_accumulated_balances_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_accumulated_balances
    ADD CONSTRAINT associate_accumulated_balances_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id);


--
-- Name: associate_debt_payments associate_debt_payments_associate_profile_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_debt_payments
    ADD CONSTRAINT associate_debt_payments_associate_profile_id_fkey FOREIGN KEY (associate_profile_id) REFERENCES public.associate_profiles(id) ON DELETE CASCADE;


--
-- Name: associate_debt_payments associate_debt_payments_payment_method_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_debt_payments
    ADD CONSTRAINT associate_debt_payments_payment_method_id_fkey FOREIGN KEY (payment_method_id) REFERENCES public.payment_methods(id);


--
-- Name: associate_debt_payments associate_debt_payments_registered_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_debt_payments
    ADD CONSTRAINT associate_debt_payments_registered_by_fkey FOREIGN KEY (registered_by) REFERENCES public.users(id);


--
-- Name: associate_level_history associate_level_history_associate_profile_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_level_history
    ADD CONSTRAINT associate_level_history_associate_profile_id_fkey FOREIGN KEY (associate_profile_id) REFERENCES public.associate_profiles(id) ON DELETE CASCADE;


--
-- Name: associate_level_history associate_level_history_change_type_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_level_history
    ADD CONSTRAINT associate_level_history_change_type_id_fkey FOREIGN KEY (change_type_id) REFERENCES public.level_change_types(id);


--
-- Name: associate_level_history associate_level_history_new_level_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_level_history
    ADD CONSTRAINT associate_level_history_new_level_id_fkey FOREIGN KEY (new_level_id) REFERENCES public.associate_levels(id);


--
-- Name: associate_level_history associate_level_history_old_level_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_level_history
    ADD CONSTRAINT associate_level_history_old_level_id_fkey FOREIGN KEY (old_level_id) REFERENCES public.associate_levels(id);


--
-- Name: associate_payment_statements associate_payment_statements_cut_period_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_payment_statements
    ADD CONSTRAINT associate_payment_statements_cut_period_id_fkey FOREIGN KEY (cut_period_id) REFERENCES public.cut_periods(id);


--
-- Name: associate_payment_statements associate_payment_statements_payment_method_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_payment_statements
    ADD CONSTRAINT associate_payment_statements_payment_method_id_fkey FOREIGN KEY (payment_method_id) REFERENCES public.payment_methods(id);


--
-- Name: associate_payment_statements associate_payment_statements_status_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_payment_statements
    ADD CONSTRAINT associate_payment_statements_status_id_fkey FOREIGN KEY (status_id) REFERENCES public.statement_statuses(id);


--
-- Name: associate_payment_statements associate_payment_statements_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_payment_statements
    ADD CONSTRAINT associate_payment_statements_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id);


--
-- Name: associate_profiles associate_profiles_level_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_profiles
    ADD CONSTRAINT associate_profiles_level_id_fkey FOREIGN KEY (level_id) REFERENCES public.associate_levels(id);


--
-- Name: associate_profiles associate_profiles_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_profiles
    ADD CONSTRAINT associate_profiles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- Name: associate_statement_payments associate_statement_payments_payment_method_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_statement_payments
    ADD CONSTRAINT associate_statement_payments_payment_method_id_fkey FOREIGN KEY (payment_method_id) REFERENCES public.payment_methods(id);


--
-- Name: associate_statement_payments associate_statement_payments_registered_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_statement_payments
    ADD CONSTRAINT associate_statement_payments_registered_by_fkey FOREIGN KEY (registered_by) REFERENCES public.users(id);


--
-- Name: associate_statement_payments associate_statement_payments_statement_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.associate_statement_payments
    ADD CONSTRAINT associate_statement_payments_statement_id_fkey FOREIGN KEY (statement_id) REFERENCES public.associate_payment_statements(id) ON DELETE CASCADE;


--
-- Name: audit_log audit_log_changed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_log
    ADD CONSTRAINT audit_log_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.users(id);


--
-- Name: audit_session_log audit_session_log_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.audit_session_log
    ADD CONSTRAINT audit_session_log_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- Name: beneficiaries beneficiaries_relationship_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.beneficiaries
    ADD CONSTRAINT beneficiaries_relationship_id_fkey FOREIGN KEY (relationship_id) REFERENCES public.relationships(id);


--
-- Name: beneficiaries beneficiaries_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.beneficiaries
    ADD CONSTRAINT beneficiaries_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- Name: client_documents client_documents_document_type_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.client_documents
    ADD CONSTRAINT client_documents_document_type_id_fkey FOREIGN KEY (document_type_id) REFERENCES public.document_types(id);


--
-- Name: client_documents client_documents_reviewed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.client_documents
    ADD CONSTRAINT client_documents_reviewed_by_fkey FOREIGN KEY (reviewed_by) REFERENCES public.users(id);


--
-- Name: client_documents client_documents_status_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.client_documents
    ADD CONSTRAINT client_documents_status_id_fkey FOREIGN KEY (status_id) REFERENCES public.document_statuses(id);


--
-- Name: client_documents client_documents_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.client_documents
    ADD CONSTRAINT client_documents_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- Name: contracts contracts_loan_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contracts
    ADD CONSTRAINT contracts_loan_id_fkey FOREIGN KEY (loan_id) REFERENCES public.loans(id) ON DELETE CASCADE;


--
-- Name: contracts contracts_status_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.contracts
    ADD CONSTRAINT contracts_status_id_fkey FOREIGN KEY (status_id) REFERENCES public.contract_statuses(id);


--
-- Name: cut_periods cut_periods_closed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cut_periods
    ADD CONSTRAINT cut_periods_closed_by_fkey FOREIGN KEY (closed_by) REFERENCES public.users(id);


--
-- Name: cut_periods cut_periods_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cut_periods
    ADD CONSTRAINT cut_periods_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id);


--
-- Name: cut_periods cut_periods_status_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.cut_periods
    ADD CONSTRAINT cut_periods_status_id_fkey FOREIGN KEY (status_id) REFERENCES public.cut_period_statuses(id);


--
-- Name: defaulted_client_reports defaulted_client_reports_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.defaulted_client_reports
    ADD CONSTRAINT defaulted_client_reports_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.users(id);


--
-- Name: defaulted_client_reports defaulted_client_reports_associate_profile_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.defaulted_client_reports
    ADD CONSTRAINT defaulted_client_reports_associate_profile_id_fkey FOREIGN KEY (associate_profile_id) REFERENCES public.associate_profiles(id) ON DELETE CASCADE;


--
-- Name: defaulted_client_reports defaulted_client_reports_client_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.defaulted_client_reports
    ADD CONSTRAINT defaulted_client_reports_client_user_id_fkey FOREIGN KEY (client_user_id) REFERENCES public.users(id);


--
-- Name: defaulted_client_reports defaulted_client_reports_loan_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.defaulted_client_reports
    ADD CONSTRAINT defaulted_client_reports_loan_id_fkey FOREIGN KEY (loan_id) REFERENCES public.loans(id);


--
-- Name: defaulted_client_reports defaulted_client_reports_reported_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.defaulted_client_reports
    ADD CONSTRAINT defaulted_client_reports_reported_by_fkey FOREIGN KEY (reported_by) REFERENCES public.users(id);


--
-- Name: loans fk_loans_contract_id; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loans
    ADD CONSTRAINT fk_loans_contract_id FOREIGN KEY (contract_id) REFERENCES public.contracts(id);


--
-- Name: loans fk_loans_profile_code; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loans
    ADD CONSTRAINT fk_loans_profile_code FOREIGN KEY (profile_code) REFERENCES public.rate_profiles(code) ON DELETE SET NULL;


--
-- Name: guarantors guarantors_relationship_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.guarantors
    ADD CONSTRAINT guarantors_relationship_id_fkey FOREIGN KEY (relationship_id) REFERENCES public.relationships(id);


--
-- Name: guarantors guarantors_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.guarantors
    ADD CONSTRAINT guarantors_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- Name: legacy_payment_table legacy_payment_table_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.legacy_payment_table
    ADD CONSTRAINT legacy_payment_table_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id);


--
-- Name: legacy_payment_table legacy_payment_table_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.legacy_payment_table
    ADD CONSTRAINT legacy_payment_table_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.users(id);


--
-- Name: loan_renewals loan_renewals_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loan_renewals
    ADD CONSTRAINT loan_renewals_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id);


--
-- Name: loan_renewals loan_renewals_original_loan_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loan_renewals
    ADD CONSTRAINT loan_renewals_original_loan_id_fkey FOREIGN KEY (original_loan_id) REFERENCES public.loans(id);


--
-- Name: loan_renewals loan_renewals_renewed_loan_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loan_renewals
    ADD CONSTRAINT loan_renewals_renewed_loan_id_fkey FOREIGN KEY (renewed_loan_id) REFERENCES public.loans(id);


--
-- Name: loans loans_approved_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loans
    ADD CONSTRAINT loans_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.users(id);


--
-- Name: loans loans_associate_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loans
    ADD CONSTRAINT loans_associate_user_id_fkey FOREIGN KEY (associate_user_id) REFERENCES public.users(id);


--
-- Name: loans loans_rejected_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loans
    ADD CONSTRAINT loans_rejected_by_fkey FOREIGN KEY (rejected_by) REFERENCES public.users(id);


--
-- Name: loans loans_status_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loans
    ADD CONSTRAINT loans_status_id_fkey FOREIGN KEY (status_id) REFERENCES public.loan_statuses(id);


--
-- Name: loans loans_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.loans
    ADD CONSTRAINT loans_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- Name: payment_status_history payment_status_history_changed_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_status_history
    ADD CONSTRAINT payment_status_history_changed_by_fkey FOREIGN KEY (changed_by) REFERENCES public.users(id);


--
-- Name: payment_status_history payment_status_history_new_status_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_status_history
    ADD CONSTRAINT payment_status_history_new_status_id_fkey FOREIGN KEY (new_status_id) REFERENCES public.payment_statuses(id);


--
-- Name: payment_status_history payment_status_history_old_status_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_status_history
    ADD CONSTRAINT payment_status_history_old_status_id_fkey FOREIGN KEY (old_status_id) REFERENCES public.payment_statuses(id);


--
-- Name: payment_status_history payment_status_history_payment_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payment_status_history
    ADD CONSTRAINT payment_status_history_payment_id_fkey FOREIGN KEY (payment_id) REFERENCES public.payments(id) ON DELETE CASCADE;


--
-- Name: payments payments_cut_period_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payments
    ADD CONSTRAINT payments_cut_period_id_fkey FOREIGN KEY (cut_period_id) REFERENCES public.cut_periods(id);


--
-- Name: payments payments_loan_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payments
    ADD CONSTRAINT payments_loan_id_fkey FOREIGN KEY (loan_id) REFERENCES public.loans(id) ON DELETE CASCADE;


--
-- Name: payments payments_marked_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payments
    ADD CONSTRAINT payments_marked_by_fkey FOREIGN KEY (marked_by) REFERENCES public.users(id);


--
-- Name: payments payments_status_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.payments
    ADD CONSTRAINT payments_status_id_fkey FOREIGN KEY (status_id) REFERENCES public.payment_statuses(id);


--
-- Name: rate_profiles rate_profiles_created_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.rate_profiles
    ADD CONSTRAINT rate_profiles_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id);


--
-- Name: rate_profiles rate_profiles_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.rate_profiles
    ADD CONSTRAINT rate_profiles_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.users(id);


--
-- Name: system_configurations system_configurations_config_type_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.system_configurations
    ADD CONSTRAINT system_configurations_config_type_id_fkey FOREIGN KEY (config_type_id) REFERENCES public.config_types(id);


--
-- Name: system_configurations system_configurations_updated_by_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.system_configurations
    ADD CONSTRAINT system_configurations_updated_by_fkey FOREIGN KEY (updated_by) REFERENCES public.users(id);


--
-- Name: user_roles user_roles_role_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_roles
    ADD CONSTRAINT user_roles_role_id_fkey FOREIGN KEY (role_id) REFERENCES public.roles(id) ON DELETE CASCADE;


--
-- Name: user_roles user_roles_user_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -
--

ALTER TABLE ONLY public.user_roles
    ADD CONSTRAINT user_roles_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id) ON DELETE CASCADE;


--
-- PostgreSQL database dump complete
--

\unrestrict 5MXCZGcbiGv8fFN1bGMrTpUjmMnkzcHWHylfFuQIWWI0POuTo6uciP8cgOf6UtI


-- ============ FUNCIONES ============

 CREATE OR REPLACE FUNCTION public.admin_mark_payment_status(p_payment_id integer, p_new_status_id integer, p_admin_user_id integer, p_notes text DEFAULT NULL::text)                                                                                                                                                                                                                                       +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                                                              +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_old_status_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                               +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener estado actual                                                                                                                                                                                                                                                                                                                                                                               +
     SELECT status_id INTO v_old_status_id                                                                                                                                                                                                                                                                                                                                                                  +
     FROM payments                                                                                                                                                                                                                                                                                                                                                                                          +
     WHERE id = p_payment_id;                                                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Pago % no encontrado', p_payment_id;                                                                                                                                                                                                                                                                                                                                              +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Actualizar estado del pago                                                                                                                                                                                                                                                                                                                                                                          +
     UPDATE payments                                                                                                                                                                                                                                                                                                                                                                                        +
     SET                                                                                                                                                                                                                                                                                                                                                                                                    +
         status_id = p_new_status_id,                                                                                                                                                                                                                                                                                                                                                                       +
         marked_by = p_admin_user_id,                                                                                                                                                                                                                                                                                                                                                                       +
         marked_at = CURRENT_TIMESTAMP,                                                                                                                                                                                                                                                                                                                                                                     +
         marking_notes = p_notes,                                                                                                                                                                                                                                                                                                                                                                           +
         updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                     +
     WHERE id = p_payment_id;                                                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE 'Pago % marcado como estado % por usuario %', p_payment_id, p_new_status_id, p_admin_user_id;                                                                                                                                                                                                                                                                                             +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.apply_debt_payment_v2(p_associate_profile_id integer, p_payment_amount numeric, p_payment_method_id integer, p_payment_reference character varying, p_registered_by integer, p_notes text DEFAULT NULL::text)                                                                                                                                                            +
  RETURNS TABLE(payment_id integer, amount_applied numeric, remaining_debt numeric, applied_items jsonb, credit_released numeric)                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_user_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                                     +
     v_remaining_amount DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                      +
     v_debt_record RECORD;                                                                                                                                                                                                                                                                                                                                                                                  +
     v_applied_items JSONB := '[]'::jsonb;                                                                                                                                                                                                                                                                                                                                                                  +
     v_item JSONB;                                                                                                                                                                                                                                                                                                                                                                                          +
     v_amount_to_apply DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                       +
     v_total_applied DECIMAL(12,2) := 0;                                                                                                                                                                                                                                                                                                                                                                    +
     v_payment_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                                  +
     v_credit_before DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                         +
     v_credit_after DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                          +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Validaciones iniciales                                                                                                                                                                                                                                                                                                                                                                              +
     IF p_payment_amount <= 0 THEN                                                                                                                                                                                                                                                                                                                                                                          +
         RAISE EXCEPTION 'El monto del abono debe ser mayor a 0';                                                                                                                                                                                                                                                                                                                                           +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Obtener user_id y cr√©dito actual                                                                                                                                                                                                                                                                                                                                                                    +
     SELECT ap.user_id, ap.credit_available                                                                                                                                                                                                                                                                                                                                                                 +
     INTO v_user_id, v_credit_before                                                                                                                                                                                                                                                                                                                                                                        +
     FROM associate_profiles ap WHERE ap.id = p_associate_profile_id;                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_user_id IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                              +
         RAISE EXCEPTION 'Perfil de asociado % no encontrado', p_associate_profile_id;                                                                                                                                                                                                                                                                                                                      +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     v_remaining_amount := p_payment_amount;                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- ‚≠ê APLICAR FIFO: liquidar deudas m√°s antiguas primero desde accumulated_balances                                                                                                                                                                                                                                                                                                                    +
     FOR v_debt_record IN (                                                                                                                                                                                                                                                                                                                                                                                 +
         SELECT                                                                                                                                                                                                                                                                                                                                                                                             +
             aab.id,                                                                                                                                                                                                                                                                                                                                                                                        +
             aab.accumulated_debt,                                                                                                                                                                                                                                                                                                                                                                          +
             aab.cut_period_id,                                                                                                                                                                                                                                                                                                                                                                             +
             aab.created_at,                                                                                                                                                                                                                                                                                                                                                                                +
             cp.cut_code                                                                                                                                                                                                                                                                                                                                                                                    +
         FROM associate_accumulated_balances aab                                                                                                                                                                                                                                                                                                                                                            +
         JOIN cut_periods cp ON cp.id = aab.cut_period_id                                                                                                                                                                                                                                                                                                                                                   +
         WHERE aab.user_id = v_user_id                                                                                                                                                                                                                                                                                                                                                                      +
           AND aab.accumulated_debt > 0                                                                                                                                                                                                                                                                                                                                                                     +
         ORDER BY aab.created_at ASC, aab.id ASC  -- ‚≠ê FIFO por fecha                                                                                                                                                                                                                                                                                                                                      +
     )                                                                                                                                                                                                                                                                                                                                                                                                      +
     LOOP                                                                                                                                                                                                                                                                                                                                                                                                   +
         EXIT WHEN v_remaining_amount <= 0;                                                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         IF v_remaining_amount >= v_debt_record.accumulated_debt THEN                                                                                                                                                                                                                                                                                                                                       +
             -- Liquidar completamente este item                                                                                                                                                                                                                                                                                                                                                            +
             v_amount_to_apply := v_debt_record.accumulated_debt;                                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             UPDATE associate_accumulated_balances                                                                                                                                                                                                                                                                                                                                                          +
             SET                                                                                                                                                                                                                                                                                                                                                                                            +
                 accumulated_debt = 0,                                                                                                                                                                                                                                                                                                                                                                      +
                 updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                             +
             WHERE id = v_debt_record.id;                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             v_remaining_amount := v_remaining_amount - v_amount_to_apply;                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             v_item := jsonb_build_object(                                                                                                                                                                                                                                                                                                                                                                  +
                 'accumulated_balance_id', v_debt_record.id,                                                                                                                                                                                                                                                                                                                                                +
                 'cut_period_id', v_debt_record.cut_period_id,                                                                                                                                                                                                                                                                                                                                              +
                 'period_code', v_debt_record.cut_code,                                                                                                                                                                                                                                                                                                                                                     +
                 'original_debt', v_debt_record.accumulated_debt,                                                                                                                                                                                                                                                                                                                                           +
                 'amount_applied', v_amount_to_apply,                                                                                                                                                                                                                                                                                                                                                       +
                 'remaining_debt', 0,                                                                                                                                                                                                                                                                                                                                                                       +
                 'fully_liquidated', true                                                                                                                                                                                                                                                                                                                                                                   +
             );                                                                                                                                                                                                                                                                                                                                                                                             +
         ELSE                                                                                                                                                                                                                                                                                                                                                                                               +
             -- Liquidar parcialmente                                                                                                                                                                                                                                                                                                                                                                       +
             v_amount_to_apply := v_remaining_amount;                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             UPDATE associate_accumulated_balances                                                                                                                                                                                                                                                                                                                                                          +
             SET                                                                                                                                                                                                                                                                                                                                                                                            +
                 accumulated_debt = accumulated_debt - v_remaining_amount,                                                                                                                                                                                                                                                                                                                                  +
                 updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                             +
             WHERE id = v_debt_record.id;                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             v_item := jsonb_build_object(                                                                                                                                                                                                                                                                                                                                                                  +
                 'accumulated_balance_id', v_debt_record.id,                                                                                                                                                                                                                                                                                                                                                +
                 'cut_period_id', v_debt_record.cut_period_id,                                                                                                                                                                                                                                                                                                                                              +
                 'period_code', v_debt_record.cut_code,                                                                                                                                                                                                                                                                                                                                                     +
                 'original_debt', v_debt_record.accumulated_debt,                                                                                                                                                                                                                                                                                                                                           +
                 'amount_applied', v_amount_to_apply,                                                                                                                                                                                                                                                                                                                                                       +
                 'remaining_debt', v_debt_record.accumulated_debt - v_remaining_amount,                                                                                                                                                                                                                                                                                                                     +
                 'fully_liquidated', false                                                                                                                                                                                                                                                                                                                                                                  +
             );                                                                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             v_remaining_amount := 0;                                                                                                                                                                                                                                                                                                                                                                       +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         v_applied_items := v_applied_items || v_item;                                                                                                                                                                                                                                                                                                                                                      +
         v_total_applied := v_total_applied + v_amount_to_apply;                                                                                                                                                                                                                                                                                                                                            +
     END LOOP;                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Si no se aplic√≥ nada (no hab√≠a deuda), advertir                                                                                                                                                                                                                                                                                                                                                     +
     IF v_total_applied = 0 THEN                                                                                                                                                                                                                                                                                                                                                                            +
         RAISE EXCEPTION 'No se encontr√≥ deuda pendiente para aplicar el abono';                                                                                                                                                                                                                                                                                                                            +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Insertar registro de pago                                                                                                                                                                                                                                                                                                                                                                           +
     INSERT INTO associate_debt_payments (                                                                                                                                                                                                                                                                                                                                                                  +
         associate_profile_id,                                                                                                                                                                                                                                                                                                                                                                              +
         payment_amount,                                                                                                                                                                                                                                                                                                                                                                                    +
         payment_date,                                                                                                                                                                                                                                                                                                                                                                                      +
         payment_method_id,                                                                                                                                                                                                                                                                                                                                                                                 +
         payment_reference,                                                                                                                                                                                                                                                                                                                                                                                 +
         registered_by,                                                                                                                                                                                                                                                                                                                                                                                     +
         applied_breakdown_items,                                                                                                                                                                                                                                                                                                                                                                           +
         notes                                                                                                                                                                                                                                                                                                                                                                                              +
     ) VALUES (                                                                                                                                                                                                                                                                                                                                                                                             +
         p_associate_profile_id,                                                                                                                                                                                                                                                                                                                                                                            +
         v_total_applied,  -- Solo el monto realmente aplicado                                                                                                                                                                                                                                                                                                                                              +
         CURRENT_DATE,                                                                                                                                                                                                                                                                                                                                                                                      +
         p_payment_method_id,                                                                                                                                                                                                                                                                                                                                                                               +
         p_payment_reference,                                                                                                                                                                                                                                                                                                                                                                               +
         p_registered_by,                                                                                                                                                                                                                                                                                                                                                                                   +
         v_applied_items,                                                                                                                                                                                                                                                                                                                                                                                   +
         CASE                                                                                                                                                                                                                                                                                                                                                                                               +
             WHEN v_remaining_amount > 0 THEN                                                                                                                                                                                                                                                                                                                                                               +
                 COALESCE(p_notes, '') || ' [Sobrante no aplicado: ' || v_remaining_amount || ']'                                                                                                                                                                                                                                                                                                           +
             ELSE p_notes                                                                                                                                                                                                                                                                                                                                                                                   +
         END                                                                                                                                                                                                                                                                                                                                                                                                +
     )                                                                                                                                                                                                                                                                                                                                                                                                      +
     RETURNING id INTO v_payment_id;                                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Sincronizar debt_balance en associate_profiles                                                                                                                                                                                                                                                                                                                                                      +
     PERFORM sync_associate_debt_balance(p_associate_profile_id);                                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Recalcular cr√©dito disponible (liberar el monto pagado)                                                                                                                                                                                                                                                                                                                                             +
     UPDATE associate_profiles                                                                                                                                                                                                                                                                                                                                                                              +
     SET                                                                                                                                                                                                                                                                                                                                                                                                    +
         credit_available = credit_available + v_total_applied,                                                                                                                                                                                                                                                                                                                                             +
         credit_used = credit_used - v_total_applied,                                                                                                                                                                                                                                                                                                                                                       +
         credit_last_updated = CURRENT_TIMESTAMP,                                                                                                                                                                                                                                                                                                                                                           +
         updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                     +
     WHERE id = p_associate_profile_id                                                                                                                                                                                                                                                                                                                                                                      +
     RETURNING credit_available INTO v_credit_after;                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Retornar resultado                                                                                                                                                                                                                                                                                                                                                                                  +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         v_payment_id,                                                                                                                                                                                                                                                                                                                                                                                      +
         v_total_applied,                                                                                                                                                                                                                                                                                                                                                                                   +
         (SELECT COALESCE(SUM(accumulated_debt), 0) FROM associate_accumulated_balances WHERE user_id = v_user_id),                                                                                                                                                                                                                                                                                         +
         v_applied_items,                                                                                                                                                                                                                                                                                                                                                                                   +
         v_credit_after - v_credit_before;                                                                                                                                                                                                                                                                                                                                                                  +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.apply_excess_to_debt_fifo(p_associate_profile_id integer, p_excess_amount numeric, p_payment_reference character varying)                                                                                                                                                                                                                                                +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                                                              +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_remaining_amount DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                      +
     v_debt_record RECORD;                                                                                                                                                                                                                                                                                                                                                                                  +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     v_remaining_amount := p_excess_amount;                                                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Aplicar FIFO: liquidar deudas m√°s antiguas primero                                                                                                                                                                                                                                                                                                                                                  +
     FOR v_debt_record IN (                                                                                                                                                                                                                                                                                                                                                                                 +
         SELECT id, amount                                                                                                                                                                                                                                                                                                                                                                                  +
         FROM associate_debt_breakdown                                                                                                                                                                                                                                                                                                                                                                      +
         WHERE associate_profile_id = p_associate_profile_id                                                                                                                                                                                                                                                                                                                                                +
           AND is_liquidated = false                                                                                                                                                                                                                                                                                                                                                                        +
         ORDER BY created_at ASC, id ASC  -- ‚≠ê FIFO                                                                                                                                                                                                                                                                                                                                                        +
     )                                                                                                                                                                                                                                                                                                                                                                                                      +
     LOOP                                                                                                                                                                                                                                                                                                                                                                                                   +
         EXIT WHEN v_remaining_amount <= 0;                                                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         IF v_remaining_amount >= v_debt_record.amount THEN                                                                                                                                                                                                                                                                                                                                                 +
             -- Liquidar completamente este item                                                                                                                                                                                                                                                                                                                                                            +
             UPDATE associate_debt_breakdown                                                                                                                                                                                                                                                                                                                                                                +
             SET                                                                                                                                                                                                                                                                                                                                                                                            +
                 is_liquidated = true,                                                                                                                                                                                                                                                                                                                                                                      +
                 liquidated_at = CURRENT_TIMESTAMP,                                                                                                                                                                                                                                                                                                                                                         +
                 liquidation_reference = p_payment_reference,                                                                                                                                                                                                                                                                                                                                               +
                 updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                             +
             WHERE id = v_debt_record.id;                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             v_remaining_amount := v_remaining_amount - v_debt_record.amount;                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             RAISE NOTICE 'Deuda % liquidada completamente (monto: %)',                                                                                                                                                                                                                                                                                                                                     +
                          v_debt_record.id, v_debt_record.amount;                                                                                                                                                                                                                                                                                                                                           +
         ELSE                                                                                                                                                                                                                                                                                                                                                                                               +
             -- Liquidar parcialmente (reducir monto del item)                                                                                                                                                                                                                                                                                                                                              +
             UPDATE associate_debt_breakdown                                                                                                                                                                                                                                                                                                                                                                +
             SET                                                                                                                                                                                                                                                                                                                                                                                            +
                 amount = amount - v_remaining_amount,                                                                                                                                                                                                                                                                                                                                                      +
                 updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                             +
             WHERE id = v_debt_record.id;                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             RAISE NOTICE 'Deuda % liquidada parcialmente (abono: %, restante: %)',                                                                                                                                                                                                                                                                                                                         +
                          v_debt_record.id, v_remaining_amount, v_debt_record.amount - v_remaining_amount;                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             v_remaining_amount := 0;                                                                                                                                                                                                                                                                                                                                                                       +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
     END LOOP;                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Actualizar debt_balance del asociado                                                                                                                                                                                                                                                                                                                                                                +
     UPDATE associate_profiles                                                                                                                                                                                                                                                                                                                                                                              +
     SET                                                                                                                                                                                                                                                                                                                                                                                                    +
         debt_balance = (                                                                                                                                                                                                                                                                                                                                                                                   +
             SELECT COALESCE(SUM(amount), 0)                                                                                                                                                                                                                                                                                                                                                                +
             FROM associate_debt_breakdown                                                                                                                                                                                                                                                                                                                                                                  +
             WHERE associate_profile_id = p_associate_profile_id                                                                                                                                                                                                                                                                                                                                            +
               AND is_liquidated = false                                                                                                                                                                                                                                                                                                                                                                    +
         ),                                                                                                                                                                                                                                                                                                                                                                                                 +
         updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                     +
     WHERE id = p_associate_profile_id;                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE 'Excedente aplicado: % (sobrante: %)', p_excess_amount - v_remaining_amount, v_remaining_amount;                                                                                                                                                                                                                                                                                          +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.approve_defaulted_client_report(p_report_id integer, p_approved_by integer, p_cut_period_id integer)                                                                                                                                                                                                                                                                     +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                                                              +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_associate_profile_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                        +
     v_loan_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                                     +
     v_client_user_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                              +
     v_total_debt_amount DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                     +
     v_paid_by_associate_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                        +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener datos del reporte                                                                                                                                                                                                                                                                                                                                                                           +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         associate_profile_id,                                                                                                                                                                                                                                                                                                                                                                              +
         loan_id,                                                                                                                                                                                                                                                                                                                                                                                           +
         client_user_id,                                                                                                                                                                                                                                                                                                                                                                                    +
         total_debt_amount                                                                                                                                                                                                                                                                                                                                                                                  +
     INTO                                                                                                                                                                                                                                                                                                                                                                                                   +
         v_associate_profile_id,                                                                                                                                                                                                                                                                                                                                                                            +
         v_loan_id,                                                                                                                                                                                                                                                                                                                                                                                         +
         v_client_user_id,                                                                                                                                                                                                                                                                                                                                                                                  +
         v_total_debt_amount                                                                                                                                                                                                                                                                                                                                                                                +
     FROM defaulted_client_reports                                                                                                                                                                                                                                                                                                                                                                          +
     WHERE id = p_report_id;                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Reporte % no encontrado', p_report_id;                                                                                                                                                                                                                                                                                                                                            +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Obtener ID del estado PAID_BY_ASSOCIATE                                                                                                                                                                                                                                                                                                                                                             +
     SELECT id INTO v_paid_by_associate_id FROM payment_statuses WHERE name = 'PAID_BY_ASSOCIATE';                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Actualizar reporte como aprobado                                                                                                                                                                                                                                                                                                                                                                    +
     UPDATE defaulted_client_reports                                                                                                                                                                                                                                                                                                                                                                        +
     SET status = 'APPROVED',                                                                                                                                                                                                                                                                                                                                                                               +
         approved_by = p_approved_by,                                                                                                                                                                                                                                                                                                                                                                       +
         approved_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                    +
     WHERE id = p_report_id;                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Marcar pagos del pr√©stamo como PAID_BY_ASSOCIATE                                                                                                                                                                                                                                                                                                                                                    +
     UPDATE payments                                                                                                                                                                                                                                                                                                                                                                                        +
     SET status_id = v_paid_by_associate_id,                                                                                                                                                                                                                                                                                                                                                                +
         updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                     +
     WHERE loan_id = v_loan_id                                                                                                                                                                                                                                                                                                                                                                              +
       AND status_id NOT IN (                                                                                                                                                                                                                                                                                                                                                                               +
           SELECT id FROM payment_statuses WHERE name IN ('PAID', 'PAID_BY_ASSOCIATE')                                                                                                                                                                                                                                                                                                                      +
       );                                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Crear registro de deuda en associate_debt_breakdown                                                                                                                                                                                                                                                                                                                                                 +
     INSERT INTO associate_debt_breakdown (                                                                                                                                                                                                                                                                                                                                                                 +
         associate_profile_id,                                                                                                                                                                                                                                                                                                                                                                              +
         cut_period_id,                                                                                                                                                                                                                                                                                                                                                                                     +
         debt_type,                                                                                                                                                                                                                                                                                                                                                                                         +
         loan_id,                                                                                                                                                                                                                                                                                                                                                                                           +
         client_user_id,                                                                                                                                                                                                                                                                                                                                                                                    +
         amount,                                                                                                                                                                                                                                                                                                                                                                                            +
         description,                                                                                                                                                                                                                                                                                                                                                                                       +
         is_liquidated                                                                                                                                                                                                                                                                                                                                                                                      +
     ) VALUES (                                                                                                                                                                                                                                                                                                                                                                                             +
         v_associate_profile_id,                                                                                                                                                                                                                                                                                                                                                                            +
         p_cut_period_id,                                                                                                                                                                                                                                                                                                                                                                                   +
         'DEFAULTED_CLIENT',                                                                                                                                                                                                                                                                                                                                                                                +
         v_loan_id,                                                                                                                                                                                                                                                                                                                                                                                         +
         v_client_user_id,                                                                                                                                                                                                                                                                                                                                                                                  +
         v_total_debt_amount,                                                                                                                                                                                                                                                                                                                                                                               +
         'Cliente moroso aprobado - Reporte #' || p_report_id,                                                                                                                                                                                                                                                                                                                                              +
         false                                                                                                                                                                                                                                                                                                                                                                                              +
     );                                                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Actualizar debt_balance del asociado                                                                                                                                                                                                                                                                                                                                                                +
     UPDATE associate_profiles                                                                                                                                                                                                                                                                                                                                                                              +
     SET debt_balance = debt_balance + v_total_debt_amount                                                                                                                                                                                                                                                                                                                                                  +
     WHERE id = v_associate_profile_id;                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE '‚úÖ Reporte % aprobado. Deuda de % agregada a asociado %',                                                                                                                                                                                                                                                                                                                                +
         p_report_id, v_total_debt_amount, v_associate_profile_id;                                                                                                                                                                                                                                                                                                                                          +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.audit_trigger_function()                                                                                                                                                                                                                                                                                                                                                 +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     IF (TG_OP = 'DELETE') THEN                                                                                                                                                                                                                                                                                                                                                                             +
         INSERT INTO audit_log (table_name, record_id, operation, old_data)                                                                                                                                                                                                                                                                                                                                 +
         VALUES (TG_TABLE_NAME, OLD.id, 'DELETE', row_to_json(OLD)::jsonb);                                                                                                                                                                                                                                                                                                                                 +
         RETURN OLD;                                                                                                                                                                                                                                                                                                                                                                                        +
     ELSIF (TG_OP = 'UPDATE') THEN                                                                                                                                                                                                                                                                                                                                                                          +
         INSERT INTO audit_log (table_name, record_id, operation, old_data, new_data)                                                                                                                                                                                                                                                                                                                       +
         VALUES (TG_TABLE_NAME, NEW.id, 'UPDATE', row_to_json(OLD)::jsonb, row_to_json(NEW)::jsonb);                                                                                                                                                                                                                                                                                                        +
         RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                        +
     ELSIF (TG_OP = 'INSERT') THEN                                                                                                                                                                                                                                                                                                                                                                          +
         INSERT INTO audit_log (table_name, record_id, operation, new_data)                                                                                                                                                                                                                                                                                                                                 +
         VALUES (TG_TABLE_NAME, NEW.id, 'INSERT', row_to_json(NEW)::jsonb);                                                                                                                                                                                                                                                                                                                                 +
         RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                        +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
     RETURN NULL;                                                                                                                                                                                                                                                                                                                                                                                           +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.auto_generate_statements_at_midnight()                                                                                                                                                                                                                                                                                                                                   +
  RETURNS TABLE(period_code character varying, statements_generated integer, total_amount numeric)                                                                                                                                                                                                                                                                                                          +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_current_day INTEGER;                                                                                                                                                                                                                                                                                                                                                                                 +
     v_is_cut_day BOOLEAN;                                                                                                                                                                                                                                                                                                                                                                                  +
     v_period_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                                   +
     v_period_code VARCHAR(20);                                                                                                                                                                                                                                                                                                                                                                             +
     v_count INTEGER;                                                                                                                                                                                                                                                                                                                                                                                       +
     v_total NUMERIC(12,2);                                                                                                                                                                                                                                                                                                                                                                                 +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     v_current_day := EXTRACT(DAY FROM CURRENT_DATE);                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Verificar si es d√≠a de corte (8 o 23)                                                                                                                                                                                                                                                                                                                                                               +
     v_is_cut_day := v_current_day IN (8, 23);                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT v_is_cut_day THEN                                                                                                                                                                                                                                                                                                                                                                               +
         RAISE NOTICE 'Hoy no es d√≠a de corte (d√≠a %, esperado 8 o 23)', v_current_day;                                                                                                                                                                                                                                                                                                                     +
         RETURN;                                                                                                                                                                                                                                                                                                                                                                                            +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Obtener periodo correspondiente a hoy (d√≠a de impresi√≥n)                                                                                                                                                                                                                                                                                                                                            +
     SELECT id, cut_code INTO v_period_id, v_period_code                                                                                                                                                                                                                                                                                                                                                    +
     FROM cut_periods                                                                                                                                                                                                                                                                                                                                                                                       +
     WHERE period_end_date + 1 = CURRENT_DATE;                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_period_id IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                            +
         RAISE EXCEPTION 'No se encontr√≥ periodo para hoy: %', CURRENT_DATE;                                                                                                                                                                                                                                                                                                                                +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE 'üîÑ Iniciando corte autom√°tico para periodo: %', v_period_code;                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Generar statements autom√°ticos con estado DRAFT (ID 6)                                                                                                                                                                                                                                                                                                                                              +
     INSERT INTO associate_payment_statements (                                                                                                                                                                                                                                                                                                                                                             +
         cut_period_id,                                                                                                                                                                                                                                                                                                                                                                                     +
         user_id,                                                                                                                                                                                                                                                                                                                                                                                           +
         statement_number,                                                                                                                                                                                                                                                                                                                                                                                  +
         total_payments_count,                                                                                                                                                                                                                                                                                                                                                                              +
         total_amount_collected,                                                                                                                                                                                                                                                                                                                                                                            +
         total_commission_owed,                                                                                                                                                                                                                                                                                                                                                                             +
         commission_rate_applied,                                                                                                                                                                                                                                                                                                                                                                           +
         status_id,                                                                                                                                                                                                                                                                                                                                                                                         +
         generated_date,                                                                                                                                                                                                                                                                                                                                                                                    +
         due_date                                                                                                                                                                                                                                                                                                                                                                                           +
     )                                                                                                                                                                                                                                                                                                                                                                                                      +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         v_period_id,                                                                                                                                                                                                                                                                                                                                                                                       +
         l.associate_user_id,                                                                                                                                                                                                                                                                                                                                                                               +
         CONCAT(v_period_code, '-A', l.associate_user_id) as statement_number,                                                                                                                                                                                                                                                                                                                              +
         COUNT(p.id) as total_payments,                                                                                                                                                                                                                                                                                                                                                                     +
         SUM(p.expected_amount) as total_amount,                                                                                                                                                                                                                                                                                                                                                            +
         SUM(p.commission_amount) as total_commission,                                                                                                                                                                                                                                                                                                                                                      +
         l.commission_rate,                                                                                                                                                                                                                                                                                                                                                                                 +
         6,  -- DRAFT                                                                                                                                                                                                                                                                                                                                                                                       +
         CURRENT_DATE,                                                                                                                                                                                                                                                                                                                                                                                      +
         CURRENT_DATE + INTERVAL '7 days'                                                                                                                                                                                                                                                                                                                                                                   +
     FROM payments p                                                                                                                                                                                                                                                                                                                                                                                        +
     JOIN loans l ON p.loan_id = l.id                                                                                                                                                                                                                                                                                                                                                                       +
     WHERE p.cut_period_id = v_period_id                                                                                                                                                                                                                                                                                                                                                                    +
       AND p.status_id = 1  -- PENDING                                                                                                                                                                                                                                                                                                                                                                      +
       AND l.associate_user_id IS NOT NULL                                                                                                                                                                                                                                                                                                                                                                  +
     GROUP BY v_period_id, l.associate_user_id, v_period_code, l.commission_rate                                                                                                                                                                                                                                                                                                                            +
     ON CONFLICT DO NOTHING;                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     GET DIAGNOSTICS v_count = ROW_COUNT;                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Calcular total generado                                                                                                                                                                                                                                                                                                                                                                             +
     SELECT COALESCE(SUM(total_amount_collected), 0) INTO v_total                                                                                                                                                                                                                                                                                                                                           +
     FROM associate_payment_statements                                                                                                                                                                                                                                                                                                                                                                      +
     WHERE cut_period_id = v_period_id AND status_id = 6;                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE '‚úÖ Corte autom√°tico completado: % statements en DRAFT, Total: $%',                                                                                                                                                                                                                                                                                                                       +
         v_count, v_total;                                                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Retornar resumen                                                                                                                                                                                                                                                                                                                                                                                    +
     RETURN QUERY SELECT v_period_code, v_count, v_total;                                                                                                                                                                                                                                                                                                                                                   +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.calculate_first_payment_date(p_approval_date date)                                                                                                                                                                                                                                                                                                                       +
  RETURNS date                                                                                                                                                                                                                                                                                                                                                                                              +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                                                            +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_approval_day INTEGER;                                                                                                                                                                                                                                                                                                                                                                                +
     v_approval_year INTEGER;                                                                                                                                                                                                                                                                                                                                                                               +
     v_approval_month INTEGER;                                                                                                                                                                                                                                                                                                                                                                              +
     v_first_payment_date DATE;                                                                                                                                                                                                                                                                                                                                                                             +
     v_next_month_date DATE;                                                                                                                                                                                                                                                                                                                                                                                +
     v_last_day_current_month DATE;                                                                                                                                                                                                                                                                                                                                                                         +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Extraer componentes de la fecha                                                                                                                                                                                                                                                                                                                                                                     +
     v_approval_day := EXTRACT(DAY FROM p_approval_date)::INTEGER;                                                                                                                                                                                                                                                                                                                                          +
     v_approval_year := EXTRACT(YEAR FROM p_approval_date)::INTEGER;                                                                                                                                                                                                                                                                                                                                        +
     v_approval_month := EXTRACT(MONTH FROM p_approval_date)::INTEGER;                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Pre-calcular fechas comunes                                                                                                                                                                                                                                                                                                                                                                         +
     v_next_month_date := p_approval_date + INTERVAL '1 month';                                                                                                                                                                                                                                                                                                                                             +
     v_last_day_current_month := (DATE_TRUNC('month', p_approval_date) + INTERVAL '1 month' - INTERVAL '1 day')::DATE;                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Aplicar l√≥gica del doble calendario                                                                                                                                                                                                                                                                                                                                                                 +
     v_first_payment_date := CASE                                                                                                                                                                                                                                                                                                                                                                           +
         -- CASO 1: Aprobaci√≥n d√≠as 1-7 ‚Üí Primer pago d√≠a 15 del mes ACTUAL                                                                                                                                                                                                                                                                                                                                 +
         WHEN v_approval_day >= 1 AND v_approval_day < 8 THEN                                                                                                                                                                                                                                                                                                                                               +
             MAKE_DATE(v_approval_year, v_approval_month, 15)                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- CASO 2: Aprobaci√≥n d√≠as 8-22 ‚Üí Primer pago √öLTIMO d√≠a del mes ACTUAL                                                                                                                                                                                                                                                                                                                            +
         WHEN v_approval_day >= 8 AND v_approval_day < 23 THEN                                                                                                                                                                                                                                                                                                                                              +
             v_last_day_current_month                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- CASO 3: Aprobaci√≥n d√≠a 23+ ‚Üí Primer pago d√≠a 15 del mes SIGUIENTE                                                                                                                                                                                                                                                                                                                               +
         WHEN v_approval_day >= 23 THEN                                                                                                                                                                                                                                                                                                                                                                     +
             MAKE_DATE(                                                                                                                                                                                                                                                                                                                                                                                     +
                 EXTRACT(YEAR FROM v_next_month_date)::INTEGER,                                                                                                                                                                                                                                                                                                                                             +
                 EXTRACT(MONTH FROM v_next_month_date)::INTEGER,                                                                                                                                                                                                                                                                                                                                            +
                 15                                                                                                                                                                                                                                                                                                                                                                                         +
             )                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         ELSE NULL                                                                                                                                                                                                                                                                                                                                                                                          +
     END;                                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validaciones                                                                                                                                                                                                                                                                                                                                                                                        +
     IF p_approval_date IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                        +
         RAISE EXCEPTION 'La fecha de aprobaci√≥n no puede ser NULL';                                                                                                                                                                                                                                                                                                                                        +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_approval_day < 1 OR v_approval_day > 31 THEN                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'D√≠a de aprobaci√≥n inv√°lido: %. Debe estar entre 1 y 31.', v_approval_day;                                                                                                                                                                                                                                                                                                         +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_first_payment_date < p_approval_date THEN                                                                                                                                                                                                                                                                                                                                                         +
         RAISE WARNING 'ALERTA: La fecha de primer pago (%) es anterior a la fecha de aprobaci√≥n (%).',                                                                                                                                                                                                                                                                                                     +
             v_first_payment_date, p_approval_date;                                                                                                                                                                                                                                                                                                                                                         +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN v_first_payment_date;                                                                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                            +
 EXCEPTION                                                                                                                                                                                                                                                                                                                                                                                                  +
     WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                                                                       +
         RAISE EXCEPTION 'Error al calcular primera fecha de pago para %: % (%)',                                                                                                                                                                                                                                                                                                                           +
             p_approval_date, SQLERRM, SQLSTATE;                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.calculate_late_fee_for_statement(p_statement_id integer)                                                                                                                                                                                                                                                                                                                 +
  RETURNS numeric                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  STABLE                                                                                                                                                                                                                                                                                                                                                                                                    +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_total_payments_count INTEGER;                                                                                                                                                                                                                                                                                                                                                                        +
     v_total_commission_owed DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                 +
     v_late_fee DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                              +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener datos del statement                                                                                                                                                                                                                                                                                                                                                                         +
     SELECT total_payments_count, total_commission_owed                                                                                                                                                                                                                                                                                                                                                     +
     INTO v_total_payments_count, v_total_commission_owed                                                                                                                                                                                                                                                                                                                                                   +
     FROM associate_payment_statements                                                                                                                                                                                                                                                                                                                                                                      +
     WHERE id = p_statement_id;                                                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Statement % no encontrado', p_statement_id;                                                                                                                                                                                                                                                                                                                                       +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Aplicar regla: Si NO report√≥ ning√∫n pago, mora del 30% sobre comisi√≥n                                                                                                                                                                                                                                                                                                                               +
     IF v_total_payments_count = 0 AND v_total_commission_owed > 0 THEN                                                                                                                                                                                                                                                                                                                                     +
         v_late_fee := v_total_commission_owed * 0.30;                                                                                                                                                                                                                                                                                                                                                      +
         RAISE NOTICE 'Mora del 30%% aplicada: % (comisi√≥n: %)', v_late_fee, v_total_commission_owed;                                                                                                                                                                                                                                                                                                       +
     ELSE                                                                                                                                                                                                                                                                                                                                                                                                   +
         v_late_fee := 0.00;                                                                                                                                                                                                                                                                                                                                                                                +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN ROUND(v_late_fee, 2);                                                                                                                                                                                                                                                                                                                                                                           +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.calculate_loan_payment(p_amount numeric, p_term_biweeks integer, p_profile_code character varying)                                                                                                                                                                                                                                                                       +
  RETURNS TABLE(profile_code character varying, profile_name character varying, calculation_method character varying, interest_rate_percent numeric, commission_rate_percent numeric, biweekly_payment numeric, total_payment numeric, total_interest numeric, effective_rate_percent numeric, commission_per_payment numeric, total_commission numeric, associate_payment numeric, associate_total numeric)+
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  STABLE                                                                                                                                                                                                                                                                                                                                                                                                    +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_profile RECORD;                                                                                                                                                                                                                                                                                                                                                                                      +
     v_legacy_entry RECORD;                                                                                                                                                                                                                                                                                                                                                                                 +
     v_factor DECIMAL(10,6);                                                                                                                                                                                                                                                                                                                                                                                +
     v_total DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                                 +
     v_payment DECIMAL(10,2);                                                                                                                                                                                                                                                                                                                                                                               +
     v_commission_per_payment DECIMAL(10,2);                                                                                                                                                                                                                                                                                                                                                                +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener perfil                                                                                                                                                                                                                                                                                                                                                                                      +
     SELECT * INTO v_profile                                                                                                                                                                                                                                                                                                                                                                                +
     FROM rate_profiles                                                                                                                                                                                                                                                                                                                                                                                     +
     WHERE code = p_profile_code AND enabled = true;                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Perfil de tasa no encontrado o deshabilitado: %', p_profile_code;                                                                                                                                                                                                                                                                                                                 +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- M√âTODO 1: Table Lookup (perfil legacy)                                                                                                                                                                                                                                                                                                                                                              +
     IF v_profile.calculation_type = 'table_lookup' THEN                                                                                                                                                                                                                                                                                                                                                    +
         SELECT * INTO v_legacy_entry                                                                                                                                                                                                                                                                                                                                                                       +
         FROM legacy_payment_table                                                                                                                                                                                                                                                                                                                                                                          +
         WHERE amount = p_amount AND term_biweeks = p_term_biweeks;                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                  +
             RAISE EXCEPTION 'Monto % no encontrado en tabla legacy para plazo %Q', p_amount, p_term_biweeks;                                                                                                                                                                                                                                                                                               +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         v_payment := v_legacy_entry.biweekly_payment;                                                                                                                                                                                                                                                                                                                                                      +
         v_total := v_legacy_entry.total_payment;                                                                                                                                                                                                                                                                                                                                                           +
         v_commission_per_payment := COALESCE(v_legacy_entry.commission_per_payment, 0);                                                                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             v_profile.code,                                                                                                                                                                                                                                                                                                                                                                                +
             v_profile.name,                                                                                                                                                                                                                                                                                                                                                                                +
             v_profile.calculation_type,                                                                                                                                                                                                                                                                                                                                                                    +
             v_legacy_entry.biweekly_rate_percent AS interest_rate,                                                                                                                                                                                                                                                                                                                                         +
             ROUND(((COALESCE(v_legacy_entry.commission_per_payment, 0) / NULLIF(v_payment, 0)) * 100)::NUMERIC, 3) AS commission_rate,                                                                                                                                                                                                                                                                     +
             v_payment,                                                                                                                                                                                                                                                                                                                                                                                     +
             v_total,                                                                                                                                                                                                                                                                                                                                                                                       +
             v_legacy_entry.total_interest,                                                                                                                                                                                                                                                                                                                                                                 +
             v_legacy_entry.effective_rate_percent,                                                                                                                                                                                                                                                                                                                                                         +
             ROUND(v_commission_per_payment, 2),                                                                                                                                                                                                                                                                                                                                                            +
             ROUND(COALESCE(v_legacy_entry.total_commission, 0), 2),                                                                                                                                                                                                                                                                                                                                        +
             ROUND(COALESCE(v_legacy_entry.associate_biweekly_payment, 0), 2),                                                                                                                                                                                                                                                                                                                              +
             ROUND(COALESCE(v_legacy_entry.associate_total_payment, 0), 2);                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         RETURN;                                                                                                                                                                                                                                                                                                                                                                                            +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- M√âTODO 2: Formula (perfiles standard, custom)                                                                                                                                                                                                                                                                                                                                                       +
     IF v_profile.calculation_type = 'formula' THEN                                                                                                                                                                                                                                                                                                                                                         +
         IF v_profile.interest_rate_percent IS NULL THEN                                                                                                                                                                                                                                                                                                                                                    +
             RAISE EXCEPTION 'Perfil % tipo formula requiere interest_rate_percent configurado', p_profile_code;                                                                                                                                                                                                                                                                                            +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         IF v_profile.commission_rate_percent IS NULL THEN                                                                                                                                                                                                                                                                                                                                                  +
             RAISE EXCEPTION 'Perfil % tipo formula requiere commission_rate_percent configurado', p_profile_code;                                                                                                                                                                                                                                                                                          +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- Calcular pago del CLIENTE (inter√©s simple)                                                                                                                                                                                                                                                                                                                                                      +
         v_factor := 1 + (v_profile.interest_rate_percent / 100) * p_term_biweeks;                                                                                                                                                                                                                                                                                                                          +
         v_total := p_amount * v_factor;                                                                                                                                                                                                                                                                                                                                                                    +
         v_payment := v_total / p_term_biweeks;                                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- ‚≠ê CAMBIO CR√çTICO: Comisi√≥n sobre el MONTO, no sobre el pago                                                                                                                                                                                                                                                                                                                                    +
         v_commission_per_payment := p_amount * (v_profile.commission_rate_percent / 100);                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             v_profile.code,                                                                                                                                                                                                                                                                                                                                                                                +
             v_profile.name,                                                                                                                                                                                                                                                                                                                                                                                +
             v_profile.calculation_type,                                                                                                                                                                                                                                                                                                                                                                    +
             v_profile.interest_rate_percent,                                                                                                                                                                                                                                                                                                                                                               +
             v_profile.commission_rate_percent,                                                                                                                                                                                                                                                                                                                                                             +
             ROUND(v_payment, 2) AS biweekly_payment,                                                                                                                                                                                                                                                                                                                                                       +
             ROUND(v_total, 2) AS total_payment,                                                                                                                                                                                                                                                                                                                                                            +
             ROUND(v_total - p_amount, 2) AS total_interest,                                                                                                                                                                                                                                                                                                                                                +
             ROUND(((v_total - p_amount) / p_amount * 100)::NUMERIC, 2) AS effective_rate,                                                                                                                                                                                                                                                                                                                  +
             ROUND(v_commission_per_payment, 2),                                                                                                                                                                                                                                                                                                                                                            +
             ROUND(v_commission_per_payment * p_term_biweeks, 2),                                                                                                                                                                                                                                                                                                                                           +
             ROUND(v_payment - v_commission_per_payment, 2),                                                                                                                                                                                                                                                                                                                                                +
             ROUND((v_payment - v_commission_per_payment) * p_term_biweeks, 2);                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         RETURN;                                                                                                                                                                                                                                                                                                                                                                                            +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE EXCEPTION 'Tipo de c√°lculo no soportado: %', v_profile.calculation_type;                                                                                                                                                                                                                                                                                                                         +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.calculate_loan_payment_custom(p_amount numeric, p_term_biweeks integer, p_interest_rate numeric, p_commission_rate numeric)                                                                                                                                                                                                                                              +
  RETURNS TABLE(profile_code character varying, profile_name character varying, calculation_method character varying, interest_rate_percent numeric, commission_rate_percent numeric, biweekly_payment numeric, total_payment numeric, total_interest numeric, effective_rate_percent numeric, commission_per_payment numeric, total_commission numeric, associate_payment numeric, associate_total numeric)+
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  IMMUTABLE                                                                                                                                                                                                                                                                                                                                                                                                 +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_factor DECIMAL(10,6);                                                                                                                                                                                                                                                                                                                                                                                +
     v_total DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                                 +
     v_payment DECIMAL(10,2);                                                                                                                                                                                                                                                                                                                                                                               +
     v_commission_per_payment DECIMAL(10,2);                                                                                                                                                                                                                                                                                                                                                                +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Calcular pago del CLIENTE (inter√©s simple)                                                                                                                                                                                                                                                                                                                                                          +
     v_factor := 1 + (p_interest_rate / 100) * p_term_biweeks;                                                                                                                                                                                                                                                                                                                                              +
     v_total := p_amount * v_factor;                                                                                                                                                                                                                                                                                                                                                                        +
     v_payment := v_total / p_term_biweeks;                                                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- ‚≠ê CAMBIO CR√çTICO: Comisi√≥n sobre el MONTO, no sobre el pago                                                                                                                                                                                                                                                                                                                                        +
     v_commission_per_payment := p_amount * (p_commission_rate / 100);                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'custom'::VARCHAR(50),                                                                                                                                                                                                                                                                                                                                                                             +
         'Personalizado'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                                                     +
         'formula'::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                                            +
         p_interest_rate,                                                                                                                                                                                                                                                                                                                                                                                   +
         p_commission_rate,                                                                                                                                                                                                                                                                                                                                                                                 +
         ROUND(v_payment, 2) AS biweekly_payment,                                                                                                                                                                                                                                                                                                                                                           +
         ROUND(v_total, 2) AS total_payment,                                                                                                                                                                                                                                                                                                                                                                +
         ROUND(v_total - p_amount, 2) AS total_interest,                                                                                                                                                                                                                                                                                                                                                    +
         ROUND(((v_total - p_amount) / p_amount * 100)::NUMERIC, 2) AS effective_rate,                                                                                                                                                                                                                                                                                                                      +
         ROUND(v_commission_per_payment, 2),                                                                                                                                                                                                                                                                                                                                                                +
         ROUND(v_commission_per_payment * p_term_biweeks, 2),                                                                                                                                                                                                                                                                                                                                               +
         ROUND(v_payment - v_commission_per_payment, 2),                                                                                                                                                                                                                                                                                                                                                    +
         ROUND((v_payment - v_commission_per_payment) * p_term_biweeks, 2);                                                                                                                                                                                                                                                                                                                                 +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.calculate_loan_remaining_balance(p_loan_id integer)                                                                                                                                                                                                                                                                                                                      +
  RETURNS numeric                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  STABLE                                                                                                                                                                                                                                                                                                                                                                                                    +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_total_amount DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                          +
     v_total_paid DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                            +
     v_remaining DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                             +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener monto total del pr√©stamo                                                                                                                                                                                                                                                                                                                                                                    +
     SELECT amount INTO v_total_amount                                                                                                                                                                                                                                                                                                                                                                      +
     FROM loans                                                                                                                                                                                                                                                                                                                                                                                             +
     WHERE id = p_loan_id;                                                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_total_amount IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                         +
         RAISE EXCEPTION 'Pr√©stamo con ID % no encontrado', p_loan_id;                                                                                                                                                                                                                                                                                                                                      +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Calcular total pagado                                                                                                                                                                                                                                                                                                                                                                               +
     SELECT COALESCE(SUM(amount_paid), 0) INTO v_total_paid                                                                                                                                                                                                                                                                                                                                                 +
     FROM payments                                                                                                                                                                                                                                                                                                                                                                                          +
     WHERE loan_id = p_loan_id;                                                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     v_remaining := v_total_amount - v_total_paid;                                                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- No permitir saldo negativo                                                                                                                                                                                                                                                                                                                                                                          +
     IF v_remaining < 0 THEN                                                                                                                                                                                                                                                                                                                                                                                +
         v_remaining := 0;                                                                                                                                                                                                                                                                                                                                                                                  +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN v_remaining;                                                                                                                                                                                                                                                                                                                                                                                    +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.calculate_payment_preview(p_approval_timestamp timestamp with time zone DEFAULT CURRENT_TIMESTAMP, p_term_biweeks integer DEFAULT 12, p_amount numeric DEFAULT 100000.00)                                                                                                                                                                                                +
  RETURNS TABLE(payment_number integer, payment_due_date date, payment_amount numeric, payment_type text, cut_period_estimated text)                                                                                                                                                                                                                                                                        +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  STABLE                                                                                                                                                                                                                                                                                                                                                                                                    +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_approval_date DATE;                                                                                                                                                                                                                                                                                                                                                                                  +
     v_approval_day INTEGER;                                                                                                                                                                                                                                                                                                                                                                                +
     v_current_payment_date DATE;                                                                                                                                                                                                                                                                                                                                                                           +
     v_payment_amount DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                        +
     i INTEGER;                                                                                                                                                                                                                                                                                                                                                                                             +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     v_approval_date := p_approval_timestamp::DATE;                                                                                                                                                                                                                                                                                                                                                         +
     v_approval_day := EXTRACT(DAY FROM v_approval_date);                                                                                                                                                                                                                                                                                                                                                   +
     v_payment_amount := ROUND(p_amount / p_term_biweeks, 2);                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Calcular primera fecha usando el or√°culo                                                                                                                                                                                                                                                                                                                                                            +
     v_current_payment_date := calculate_first_payment_date(v_approval_date);                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Generar preview de todos los pagos                                                                                                                                                                                                                                                                                                                                                                  +
     FOR i IN 1..p_term_biweeks LOOP                                                                                                                                                                                                                                                                                                                                                                        +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             i,                                                                                                                                                                                                                                                                                                                                                                                             +
             v_current_payment_date,                                                                                                                                                                                                                                                                                                                                                                        +
             v_payment_amount,                                                                                                                                                                                                                                                                                                                                                                              +
             CASE                                                                                                                                                                                                                                                                                                                                                                                           +
                 WHEN EXTRACT(DAY FROM v_current_payment_date) = 15 THEN 'D√çA_15'                                                                                                                                                                                                                                                                                                                           +
                 ELSE '√öLTIMO_D√çA'                                                                                                                                                                                                                                                                                                                                                                          +
             END::TEXT,                                                                                                                                                                                                                                                                                                                                                                                     +
             CASE                                                                                                                                                                                                                                                                                                                                                                                           +
                 WHEN EXTRACT(DAY FROM v_current_payment_date) <= 8 THEN 'CORTE_8_' || EXTRACT(MONTH FROM v_current_payment_date)::TEXT                                                                                                                                                                                                                                                                     +
                 ELSE 'CORTE_23_' || EXTRACT(MONTH FROM v_current_payment_date)::TEXT                                                                                                                                                                                                                                                                                                                       +
             END::TEXT;                                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- Alternar fechas: d√≠a 15 ‚Üî √∫ltimo d√≠a del mes                                                                                                                                                                                                                                                                                                                                                    +
         IF EXTRACT(DAY FROM v_current_payment_date) = 15 THEN                                                                                                                                                                                                                                                                                                                                              +
             v_current_payment_date := (DATE_TRUNC('month', v_current_payment_date) + INTERVAL '1 month' - INTERVAL '1 day')::DATE;                                                                                                                                                                                                                                                                         +
         ELSE                                                                                                                                                                                                                                                                                                                                                                                               +
             v_current_payment_date := MAKE_DATE(                                                                                                                                                                                                                                                                                                                                                           +
                 EXTRACT(YEAR FROM v_current_payment_date + INTERVAL '1 month')::INTEGER,                                                                                                                                                                                                                                                                                                                   +
                 EXTRACT(MONTH FROM v_current_payment_date + INTERVAL '1 month')::INTEGER,                                                                                                                                                                                                                                                                                                                  +
                 15                                                                                                                                                                                                                                                                                                                                                                                         +
             );                                                                                                                                                                                                                                                                                                                                                                                             +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
     END LOOP;                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN;                                                                                                                                                                                                                                                                                                                                                                                                +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.check_associate_credit_available(p_associate_profile_id integer, p_requested_amount numeric)                                                                                                                                                                                                                                                                             +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  STABLE                                                                                                                                                                                                                                                                                                                                                                                                    +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_credit_available DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                      +
     v_credit_limit DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                          +
     v_credit_used DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                           +
     v_debt_balance DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                          +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener datos del asociado                                                                                                                                                                                                                                                                                                                                                                          +
     SELECT credit_limit, credit_used, debt_balance                                                                                                                                                                                                                                                                                                                                                         +
     INTO v_credit_limit, v_credit_used, v_debt_balance                                                                                                                                                                                                                                                                                                                                                     +
     FROM associate_profiles                                                                                                                                                                                                                                                                                                                                                                                +
     WHERE id = p_associate_profile_id;                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Perfil de asociado % no encontrado', p_associate_profile_id;                                                                                                                                                                                                                                                                                                                      +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Calcular cr√©dito disponible                                                                                                                                                                                                                                                                                                                                                                         +
     v_credit_available := v_credit_limit - v_credit_used - v_debt_balance;                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar si hay cr√©dito suficiente                                                                                                                                                                                                                                                                                                                                                                   +
     IF v_credit_available >= p_requested_amount THEN                                                                                                                                                                                                                                                                                                                                                       +
         RETURN TRUE;                                                                                                                                                                                                                                                                                                                                                                                       +
     ELSE                                                                                                                                                                                                                                                                                                                                                                                                   +
         RAISE NOTICE 'Cr√©dito insuficiente. Disponible: %, Solicitado: %', v_credit_available, p_requested_amount;                                                                                                                                                                                                                                                                                         +
         RETURN FALSE;                                                                                                                                                                                                                                                                                                                                                                                      +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.close_period_and_accumulate_debt(p_cut_period_id integer, p_closed_by integer)                                                                                                                                                                                                                                                                                           +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                                                              +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_period_start DATE;                                                                                                                                                                                                                                                                                                                                                                                   +
     v_period_end DATE;                                                                                                                                                                                                                                                                                                                                                                                     +
     v_paid_status_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                              +
     v_paid_not_reported_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                        +
     v_paid_by_associate_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                        +
     v_total_payments_marked INTEGER := 0;                                                                                                                                                                                                                                                                                                                                                                  +
     v_unreported_count INTEGER := 0;                                                                                                                                                                                                                                                                                                                                                                       +
     v_morosos_count INTEGER := 0;                                                                                                                                                                                                                                                                                                                                                                          +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener fechas del per√≠odo                                                                                                                                                                                                                                                                                                                                                                          +
     SELECT period_start_date, period_end_date                                                                                                                                                                                                                                                                                                                                                              +
     INTO v_period_start, v_period_end                                                                                                                                                                                                                                                                                                                                                                      +
     FROM cut_periods                                                                                                                                                                                                                                                                                                                                                                                       +
     WHERE id = p_cut_period_id;                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Per√≠odo de corte % no encontrado', p_cut_period_id;                                                                                                                                                                                                                                                                                                                               +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Obtener IDs de estados                                                                                                                                                                                                                                                                                                                                                                              +
     SELECT id INTO v_paid_status_id FROM payment_statuses WHERE name = 'PAID';                                                                                                                                                                                                                                                                                                                             +
     SELECT id INTO v_paid_not_reported_id FROM payment_statuses WHERE name = 'PAID_NOT_REPORTED';                                                                                                                                                                                                                                                                                                          +
     SELECT id INTO v_paid_by_associate_id FROM payment_statuses WHERE name = 'PAID_BY_ASSOCIATE';                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE 'üîí Cerrando per√≠odo %: % a %', p_cut_period_id, v_period_start, v_period_end;                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- PASO 1: Marcar pagos reportados como PAID                                                                                                                                                                                                                                                                                                                                                           +
     WITH updated AS (                                                                                                                                                                                                                                                                                                                                                                                      +
         UPDATE payments                                                                                                                                                                                                                                                                                                                                                                                    +
         SET status_id = v_paid_status_id,                                                                                                                                                                                                                                                                                                                                                                  +
             updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                 +
         WHERE cut_period_id = p_cut_period_id                                                                                                                                                                                                                                                                                                                                                              +
           AND status_id NOT IN (v_paid_status_id, v_paid_not_reported_id, v_paid_by_associate_id)                                                                                                                                                                                                                                                                                                          +
           AND amount_paid > 0                                                                                                                                                                                                                                                                                                                                                                              +
         RETURNING id                                                                                                                                                                                                                                                                                                                                                                                       +
     )                                                                                                                                                                                                                                                                                                                                                                                                      +
     SELECT COUNT(*) INTO v_total_payments_marked FROM updated;                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE '‚úÖ Pagos reportados marcados como PAID: %', v_total_payments_marked;                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- PASO 2: Marcar pagos NO reportados como PAID_NOT_REPORTED                                                                                                                                                                                                                                                                                                                                           +
     WITH updated AS (                                                                                                                                                                                                                                                                                                                                                                                      +
         UPDATE payments                                                                                                                                                                                                                                                                                                                                                                                    +
         SET status_id = v_paid_not_reported_id,                                                                                                                                                                                                                                                                                                                                                            +
             updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                 +
         WHERE cut_period_id = p_cut_period_id                                                                                                                                                                                                                                                                                                                                                              +
           AND status_id NOT IN (v_paid_status_id, v_paid_not_reported_id, v_paid_by_associate_id)                                                                                                                                                                                                                                                                                                          +
           AND (amount_paid = 0 OR amount_paid IS NULL)                                                                                                                                                                                                                                                                                                                                                     +
         RETURNING id                                                                                                                                                                                                                                                                                                                                                                                       +
     )                                                                                                                                                                                                                                                                                                                                                                                                      +
     SELECT COUNT(*) INTO v_unreported_count FROM updated;                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE '‚ö†Ô∏è  Pagos NO reportados marcados como PAID_NOT_REPORTED: %', v_unreported_count;                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- PASO 3: Marcar clientes morosos como PAID_BY_ASSOCIATE                                                                                                                                                                                                                                                                                                                                              +
     -- (Esta l√≥gica se implementar√° cuando se aprueben reportes de morosidad)                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- PASO 4: Actualizar estado del per√≠odo                                                                                                                                                                                                                                                                                                                                                               +
     UPDATE cut_periods                                                                                                                                                                                                                                                                                                                                                                                     +
     SET status_id = (SELECT id FROM cut_period_statuses WHERE name = 'CLOSED'),                                                                                                                                                                                                                                                                                                                            +
         closed_by = p_closed_by,                                                                                                                                                                                                                                                                                                                                                                           +
         updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                     +
     WHERE id = p_cut_period_id;                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- PASO 5: Acumular deuda en associate_debt_breakdown                                                                                                                                                                                                                                                                                                                                                  +
     -- Por cada pago PAID_NOT_REPORTED, crear registro de deuda                                                                                                                                                                                                                                                                                                                                            +
     INSERT INTO associate_debt_breakdown (                                                                                                                                                                                                                                                                                                                                                                 +
         associate_profile_id,                                                                                                                                                                                                                                                                                                                                                                              +
         cut_period_id,                                                                                                                                                                                                                                                                                                                                                                                     +
         debt_type,                                                                                                                                                                                                                                                                                                                                                                                         +
         loan_id,                                                                                                                                                                                                                                                                                                                                                                                           +
         client_user_id,                                                                                                                                                                                                                                                                                                                                                                                    +
         amount,                                                                                                                                                                                                                                                                                                                                                                                            +
         description,                                                                                                                                                                                                                                                                                                                                                                                       +
         is_liquidated                                                                                                                                                                                                                                                                                                                                                                                      +
     )                                                                                                                                                                                                                                                                                                                                                                                                      +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         ap.id,                                                                                                                                                                                                                                                                                                                                                                                             +
         p.cut_period_id,                                                                                                                                                                                                                                                                                                                                                                                   +
         'UNREPORTED_PAYMENT',                                                                                                                                                                                                                                                                                                                                                                              +
         l.id,                                                                                                                                                                                                                                                                                                                                                                                              +
         l.user_id,                                                                                                                                                                                                                                                                                                                                                                                         +
         p.amount_paid,                                                                                                                                                                                                                                                                                                                                                                                     +
         'Pago no reportado al cierre del per√≠odo',                                                                                                                                                                                                                                                                                                                                                         +
         false                                                                                                                                                                                                                                                                                                                                                                                              +
     FROM payments p                                                                                                                                                                                                                                                                                                                                                                                        +
     JOIN loans l ON p.loan_id = l.id                                                                                                                                                                                                                                                                                                                                                                       +
     JOIN associate_profiles ap ON l.associate_user_id = ap.user_id                                                                                                                                                                                                                                                                                                                                         +
     WHERE p.cut_period_id = p_cut_period_id                                                                                                                                                                                                                                                                                                                                                                +
       AND p.status_id = v_paid_not_reported_id;                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- PASO 6: Actualizar debt_balance en associate_profiles                                                                                                                                                                                                                                                                                                                                               +
     UPDATE associate_profiles ap                                                                                                                                                                                                                                                                                                                                                                           +
     SET debt_balance = (                                                                                                                                                                                                                                                                                                                                                                                   +
         SELECT COALESCE(SUM(amount), 0)                                                                                                                                                                                                                                                                                                                                                                    +
         FROM associate_debt_breakdown adb                                                                                                                                                                                                                                                                                                                                                                  +
         WHERE adb.associate_profile_id = ap.id                                                                                                                                                                                                                                                                                                                                                             +
           AND adb.is_liquidated = false                                                                                                                                                                                                                                                                                                                                                                    +
     );                                                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE '‚úÖ Per√≠odo % cerrado exitosamente', p_cut_period_id;                                                                                                                                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.detect_suspicious_payment_changes(p_days_back integer DEFAULT 7, p_min_changes integer DEFAULT 3)                                                                                                                                                                                                                                                                        +
  RETURNS TABLE(payment_id integer, loan_id integer, client_name text, total_changes bigint, last_change timestamp with time zone, status_sequence text)                                                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  STABLE                                                                                                                                                                                                                                                                                                                                                                                                    +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                           +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         p.id,                                                                                                                                                                                                                                                                                                                                                                                              +
         p.loan_id,                                                                                                                                                                                                                                                                                                                                                                                         +
         CONCAT(u.first_name, ' ', u.last_name),                                                                                                                                                                                                                                                                                                                                                            +
         COUNT(psh.id),                                                                                                                                                                                                                                                                                                                                                                                     +
         MAX(psh.changed_at),                                                                                                                                                                                                                                                                                                                                                                               +
         STRING_AGG(ps.name, ' ‚Üí ' ORDER BY psh.changed_at)                                                                                                                                                                                                                                                                                                                                                 +
     FROM payments p                                                                                                                                                                                                                                                                                                                                                                                        +
     JOIN payment_status_history psh ON p.id = psh.payment_id                                                                                                                                                                                                                                                                                                                                               +
     JOIN payment_statuses ps ON psh.new_status_id = ps.id                                                                                                                                                                                                                                                                                                                                                  +
     JOIN loans l ON p.loan_id = l.id                                                                                                                                                                                                                                                                                                                                                                       +
     JOIN users u ON l.user_id = u.id                                                                                                                                                                                                                                                                                                                                                                       +
     WHERE psh.changed_at >= CURRENT_TIMESTAMP - (p_days_back || ' days')::INTERVAL                                                                                                                                                                                                                                                                                                                         +
     GROUP BY p.id, p.loan_id, u.first_name, u.last_name                                                                                                                                                                                                                                                                                                                                                    +
     HAVING COUNT(psh.id) >= p_min_changes                                                                                                                                                                                                                                                                                                                                                                  +
     ORDER BY COUNT(psh.id) DESC, MAX(psh.changed_at) DESC;                                                                                                                                                                                                                                                                                                                                                 +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.finalize_statements_manual(p_cut_period_id integer)                                                                                                                                                                                                                                                                                                                      +
  RETURNS TABLE(finalized_count integer, total_finalized numeric, period_code character varying)                                                                                                                                                                                                                                                                                                            +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_draft_count INTEGER;                                                                                                                                                                                                                                                                                                                                                                                 +
     v_updated_count INTEGER;                                                                                                                                                                                                                                                                                                                                                                               +
     v_total NUMERIC(12,2);                                                                                                                                                                                                                                                                                                                                                                                 +
     v_period_code VARCHAR(20);                                                                                                                                                                                                                                                                                                                                                                             +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener informaci√≥n del periodo                                                                                                                                                                                                                                                                                                                                                                     +
     SELECT cut_code INTO v_period_code                                                                                                                                                                                                                                                                                                                                                                     +
     FROM cut_periods                                                                                                                                                                                                                                                                                                                                                                                       +
     WHERE id = p_cut_period_id;                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_period_code IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                          +
         RAISE EXCEPTION 'Periodo con ID % no encontrado', p_cut_period_id;                                                                                                                                                                                                                                                                                                                                 +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Verificar que existan statements en DRAFT                                                                                                                                                                                                                                                                                                                                                           +
     SELECT COUNT(*) INTO v_draft_count                                                                                                                                                                                                                                                                                                                                                                     +
     FROM associate_payment_statements                                                                                                                                                                                                                                                                                                                                                                      +
     WHERE cut_period_id = p_cut_period_id                                                                                                                                                                                                                                                                                                                                                                  +
       AND status_id = 6;  -- DRAFT                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_draft_count = 0 THEN                                                                                                                                                                                                                                                                                                                                                                              +
         RAISE EXCEPTION 'No hay statements en DRAFT para finalizar en periodo %', v_period_code;                                                                                                                                                                                                                                                                                                           +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE 'üîí Finalizando % statements en periodo %', v_draft_count, v_period_code;                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Cambiar estado de DRAFT (6) ‚Üí FINALIZED (7)                                                                                                                                                                                                                                                                                                                                                         +
     UPDATE associate_payment_statements                                                                                                                                                                                                                                                                                                                                                                    +
     SET                                                                                                                                                                                                                                                                                                                                                                                                    +
         status_id = 7,  -- FINALIZED                                                                                                                                                                                                                                                                                                                                                                       +
         updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                     +
     WHERE cut_period_id = p_cut_period_id                                                                                                                                                                                                                                                                                                                                                                  +
       AND status_id = 6;                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     GET DIAGNOSTICS v_updated_count = ROW_COUNT;                                                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Calcular total finalizado                                                                                                                                                                                                                                                                                                                                                                           +
     SELECT COALESCE(SUM(total_amount_collected), 0) INTO v_total                                                                                                                                                                                                                                                                                                                                           +
     FROM associate_payment_statements                                                                                                                                                                                                                                                                                                                                                                      +
     WHERE cut_period_id = p_cut_period_id AND status_id = 7;                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE '‚úÖ Corte manual completado: % statements FINALIZADOS (bloqueados), Total: $%',                                                                                                                                                                                                                                                                                                           +
         v_updated_count, v_total;                                                                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE 'üìß TODO: Enviar notificaciones a asociados';                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Retornar resumen                                                                                                                                                                                                                                                                                                                                                                                    +
     RETURN QUERY SELECT v_updated_count, v_total, v_period_code;                                                                                                                                                                                                                                                                                                                                           +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.generate_amortization_schedule(p_amount numeric, p_biweekly_payment numeric, p_term_biweeks integer, p_commission_rate numeric, p_start_date date)                                                                                                                                                                                                                       +
  RETURNS TABLE(periodo integer, fecha_pago date, pago_cliente numeric, interes_cliente numeric, capital_cliente numeric, saldo_pendiente numeric, comision_socio numeric, pago_socio numeric, saldo_asociado numeric)                                                                                                                                                                                      +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  STABLE                                                                                                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                                                            +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                                                                  +
     v_current_date DATE;\r                                                                                                                                                                                                                                                                                                                                                                                 +
     v_balance DECIMAL(12,2);\r                                                                                                                                                                                                                                                                                                                                                                             +
     v_associate_balance DECIMAL(12,2); -- ‚úÖ NUEVO\r                                                                                                                                                                                                                                                                                                                                                       +
     v_total_interest DECIMAL(12,2);\r                                                                                                                                                                                                                                                                                                                                                                      +
     v_period_interest DECIMAL(10,2);\r                                                                                                                                                                                                                                                                                                                                                                     +
     v_period_principal DECIMAL(10,2);\r                                                                                                                                                                                                                                                                                                                                                                    +
     v_commission DECIMAL(10,2);\r                                                                                                                                                                                                                                                                                                                                                                          +
     v_payment_to_associate DECIMAL(10,2);\r                                                                                                                                                                                                                                                                                                                                                                +
     v_is_day_15 BOOLEAN;\r                                                                                                                                                                                                                                                                                                                                                                                 +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                                                                    +
     -- Inicializar\r                                                                                                                                                                                                                                                                                                                                                                                       +
     v_balance := p_amount;\r                                                                                                                                                                                                                                                                                                                                                                               +
     v_total_interest := (p_biweekly_payment * p_term_biweeks) - p_amount;\r                                                                                                                                                                                                                                                                                                                                +
     v_current_date := p_start_date;\r                                                                                                                                                                                                                                                                                                                                                                      +
     \r                                                                                                                                                                                                                                                                                                                                                                                                     +
     -- Calcular comisi√≥n y pago al asociado (fijos por periodo)\r                                                                                                                                                                                                                                                                                                                                          +
     v_commission := p_amount * (p_commission_rate / 100);\r                                                                                                                                                                                                                                                                                                                                                +
     v_payment_to_associate := p_biweekly_payment - v_commission;\r                                                                                                                                                                                                                                                                                                                                         +
     \r                                                                                                                                                                                                                                                                                                                                                                                                     +
     -- Inicializar saldo asociado (Total a pagar por asociado)\r                                                                                                                                                                                                                                                                                                                                           +
     v_associate_balance := v_payment_to_associate * p_term_biweeks;\r                                                                                                                                                                                                                                                                                                                                      +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
     -- Generar cronograma completo\r                                                                                                                                                                                                                                                                                                                                                                       +
     FOR v_period IN 1..p_term_biweeks LOOP\r                                                                                                                                                                                                                                                                                                                                                               +
         -- Calcular inter√©s y capital del per√≠odo (distribuci√≥n proporcional)\r                                                                                                                                                                                                                                                                                                                            +
         v_period_interest := v_total_interest / p_term_biweeks;\r                                                                                                                                                                                                                                                                                                                                          +
         v_period_principal := p_biweekly_payment - v_period_interest;\r                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
         -- Actualizar saldo cliente\r                                                                                                                                                                                                                                                                                                                                                                      +
         v_balance := v_balance - v_period_principal;\r                                                                                                                                                                                                                                                                                                                                                     +
         IF v_balance < 0.01 THEN v_balance := 0; END IF;\r                                                                                                                                                                                                                                                                                                                                                 +
         \r                                                                                                                                                                                                                                                                                                                                                                                                 +
         -- Actualizar saldo asociado\r                                                                                                                                                                                                                                                                                                                                                                     +
         v_associate_balance := v_associate_balance - v_payment_to_associate;\r                                                                                                                                                                                                                                                                                                                             +
         IF v_associate_balance < 0.01 THEN v_associate_balance := 0; END IF;\r                                                                                                                                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
         -- Retornar fila\r                                                                                                                                                                                                                                                                                                                                                                                 +
         RETURN QUERY SELECT\r                                                                                                                                                                                                                                                                                                                                                                              +
             v_period,\r                                                                                                                                                                                                                                                                                                                                                                                    +
             v_current_date,\r                                                                                                                                                                                                                                                                                                                                                                              +
             p_biweekly_payment,\r                                                                                                                                                                                                                                                                                                                                                                          +
             ROUND(v_period_interest, 2),\r                                                                                                                                                                                                                                                                                                                                                                 +
             ROUND(v_period_principal, 2),\r                                                                                                                                                                                                                                                                                                                                                                +
             ROUND(v_balance, 2),\r                                                                                                                                                                                                                                                                                                                                                                         +
             ROUND(v_commission, 2),\r                                                                                                                                                                                                                                                                                                                                                                      +
             ROUND(v_payment_to_associate, 2),\r                                                                                                                                                                                                                                                                                                                                                            +
             ROUND(v_associate_balance, 2); -- ‚úÖ RETORNAR NUEVO SALDO\r                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
         -- Calcular siguiente fecha\r                                                                                                                                                                                                                                                                                                                                                                      +
         v_is_day_15 := EXTRACT(DAY FROM v_current_date) = 15;\r                                                                                                                                                                                                                                                                                                                                            +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
         IF v_is_day_15 THEN\r                                                                                                                                                                                                                                                                                                                                                                              +
             v_current_date := (DATE_TRUNC('month', v_current_date) + INTERVAL '1 month' - INTERVAL '1 day')::DATE;\r                                                                                                                                                                                                                                                                                       +
         ELSE\r                                                                                                                                                                                                                                                                                                                                                                                             +
             v_current_date := MAKE_DATE(\r                                                                                                                                                                                                                                                                                                                                                                 +
                 EXTRACT(YEAR FROM v_current_date + INTERVAL '1 month')::INTEGER,\r                                                                                                                                                                                                                                                                                                                         +
                 EXTRACT(MONTH FROM v_current_date + INTERVAL '1 month')::INTEGER,\r                                                                                                                                                                                                                                                                                                                        +
                 15\r                                                                                                                                                                                                                                                                                                                                                                                       +
             );\r                                                                                                                                                                                                                                                                                                                                                                                           +
         END IF;\r                                                                                                                                                                                                                                                                                                                                                                                          +
     END LOOP;\r                                                                                                                                                                                                                                                                                                                                                                                            +
 END;\r                                                                                                                                                                                                                                                                                                                                                                                                     +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.generate_loan_summary(p_amount numeric, p_term_biweeks integer, p_interest_rate numeric, p_commission_rate numeric)                                                                                                                                                                                                                                                      +
  RETURNS TABLE(capital numeric, plazo_quincenas integer, tasa_interes_quincenal numeric, tasa_comision numeric, pago_quincenal_cliente numeric, pago_total_cliente numeric, interes_total_cliente numeric, tasa_efectiva_cliente numeric, comision_por_pago numeric, comision_total_socio numeric, pago_quincenal_socio numeric, pago_total_socio numeric)                                                 +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  IMMUTABLE                                                                                                                                                                                                                                                                                                                                                                                                 +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_factor DECIMAL(10,6);                                                                                                                                                                                                                                                                                                                                                                                +
     v_total_cliente DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                         +
     v_pago_q_cliente DECIMAL(10,2);                                                                                                                                                                                                                                                                                                                                                                        +
     v_interes_cliente DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                       +
     v_comision_por_pago DECIMAL(10,2);                                                                                                                                                                                                                                                                                                                                                                     +
     v_comision_total DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                        +
     v_pago_q_socio DECIMAL(10,2);                                                                                                                                                                                                                                                                                                                                                                          +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Calcular CLIENTE (Inter√©s Simple)                                                                                                                                                                                                                                                                                                                                                                   +
     v_factor := 1 + (p_interest_rate / 100) * p_term_biweeks;                                                                                                                                                                                                                                                                                                                                              +
     v_total_cliente := p_amount * v_factor;                                                                                                                                                                                                                                                                                                                                                                +
     v_pago_q_cliente := v_total_cliente / p_term_biweeks;                                                                                                                                                                                                                                                                                                                                                  +
     v_interes_cliente := v_total_cliente - p_amount;                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Calcular SOCIO (Comisi√≥n sobre pago del cliente)                                                                                                                                                                                                                                                                                                                                                    +
     v_comision_por_pago := v_pago_q_cliente * (p_commission_rate / 100);                                                                                                                                                                                                                                                                                                                                   +
     v_comision_total := v_comision_por_pago * p_term_biweeks;                                                                                                                                                                                                                                                                                                                                              +
     v_pago_q_socio := v_pago_q_cliente - v_comision_por_pago;                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         p_amount AS capital,                                                                                                                                                                                                                                                                                                                                                                               +
         p_term_biweeks AS plazo_quincenas,                                                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         p_interest_rate AS tasa_interes_quincenal,                                                                                                                                                                                                                                                                                                                                                         +
         p_commission_rate AS tasa_comision,                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         ROUND(v_pago_q_cliente, 2) AS pago_quincenal_cliente,                                                                                                                                                                                                                                                                                                                                              +
         ROUND(v_total_cliente, 2) AS pago_total_cliente,                                                                                                                                                                                                                                                                                                                                                   +
         ROUND(v_interes_cliente, 2) AS interes_total_cliente,                                                                                                                                                                                                                                                                                                                                              +
         ROUND(((v_interes_cliente / p_amount * 100)::NUMERIC), 2) AS tasa_efectiva_cliente,                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         ROUND(v_comision_por_pago, 2) AS comision_por_pago,                                                                                                                                                                                                                                                                                                                                                +
         ROUND(v_comision_total, 2) AS comision_total_socio,                                                                                                                                                                                                                                                                                                                                                +
         ROUND(v_pago_q_socio, 2) AS pago_quincenal_socio,                                                                                                                                                                                                                                                                                                                                                  +
         ROUND(v_pago_q_socio * p_term_biweeks, 2) AS pago_total_socio;                                                                                                                                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.generate_payment_schedule()                                                                                                                                                                                                                                                                                                                                              +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_approval_date DATE;                                                                                                                                                                                                                                                                                                                                                                                  +
     v_first_payment_date DATE;                                                                                                                                                                                                                                                                                                                                                                             +
     v_approved_status_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                          +
     v_pending_status_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                           +
     v_amortization_row RECORD;                                                                                                                                                                                                                                                                                                                                                                             +
     v_period_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                                   +
     v_total_inserted INTEGER := 0;                                                                                                                                                                                                                                                                                                                                                                         +
     v_sum_expected DECIMAL(12,2) := 0;                                                                                                                                                                                                                                                                                                                                                                     +
     v_start_time TIMESTAMP;                                                                                                                                                                                                                                                                                                                                                                                +
     v_end_time TIMESTAMP;                                                                                                                                                                                                                                                                                                                                                                                  +
     v_total_associate_payment DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                               +
     v_cumulative_associate_paid DECIMAL(12,2) := 0;                                                                                                                                                                                                                                                                                                                                                        +
     v_commission_rate_for_function DECIMAL(10,4);                                                                                                                                                                                                                                                                                                                                                          +
     v_payment_day INTEGER;                                                                                                                                                                                                                                                                                                                                                                                 +
     v_target_cut_day INTEGER;                                                                                                                                                                                                                                                                                                                                                                              +
     v_month_name VARCHAR(3);                                                                                                                                                                                                                                                                                                                                                                               +
     v_year_str VARCHAR(4);                                                                                                                                                                                                                                                                                                                                                                                 +
     v_target_cut_code VARCHAR(20);                                                                                                                                                                                                                                                                                                                                                                         +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Get status IDs                                                                                                                                                                                                                                                                                                                                                                                      +
     SELECT id INTO v_approved_status_id FROM loan_statuses WHERE name = 'APPROVED';                                                                                                                                                                                                                                                                                                                        +
     SELECT id INTO v_pending_status_id FROM payment_statuses WHERE name = 'PENDING';                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_approved_status_id IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                   +
         RAISE EXCEPTION 'CRITICAL: loan_statuses.APPROVED not found';                                                                                                                                                                                                                                                                                                                                      +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_pending_status_id IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                    +
         RAISE EXCEPTION 'CRITICAL: payment_statuses.PENDING not found';                                                                                                                                                                                                                                                                                                                                    +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Only execute if loan just got approved                                                                                                                                                                                                                                                                                                                                                              +
     IF NEW.status_id = v_approved_status_id                                                                                                                                                                                                                                                                                                                                                                +
        AND (OLD.status_id IS NULL OR OLD.status_id != v_approved_status_id)                                                                                                                                                                                                                                                                                                                                +
     THEN                                                                                                                                                                                                                                                                                                                                                                                                   +
         v_start_time := CLOCK_TIMESTAMP();                                                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- Validations                                                                                                                                                                                                                                                                                                                                                                                     +
         IF NEW.approved_at IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                    +
             RAISE EXCEPTION 'CRITICAL: Loan % marked as APPROVED but approved_at is NULL', NEW.id;                                                                                                                                                                                                                                                                                                         +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         IF NEW.term_biweeks IS NULL OR NEW.term_biweeks <= 0 THEN                                                                                                                                                                                                                                                                                                                                          +
             RAISE EXCEPTION 'CRITICAL: Loan % has invalid term_biweeks: %', NEW.id, NEW.term_biweeks;                                                                                                                                                                                                                                                                                                      +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         IF NEW.biweekly_payment IS NULL THEN                                                                                                                                                                                                                                                                                                                                                               +
             RAISE EXCEPTION 'CRITICAL: Loan % does not have biweekly_payment calculated', NEW.id;                                                                                                                                                                                                                                                                                                          +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         v_approval_date := NEW.approved_at::DATE;                                                                                                                                                                                                                                                                                                                                                          +
         v_first_payment_date := calculate_first_payment_date(v_approval_date);                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- FIX: Calculate correct commission rate for the function                                                                                                                                                                                                                                                                                                                                         +
         IF COALESCE(NEW.commission_per_payment, 0) > 0 AND NEW.amount > 0 THEN                                                                                                                                                                                                                                                                                                                             +
             v_commission_rate_for_function := (NEW.commission_per_payment / NEW.amount) * 100;                                                                                                                                                                                                                                                                                                             +
         ELSE                                                                                                                                                                                                                                                                                                                                                                                               +
             v_commission_rate_for_function := 0;                                                                                                                                                                                                                                                                                                                                                           +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         RAISE NOTICE 'Generating schedule for loan %: Amount=$%, Term=%, Biweekly=$%, CommPerPmt=$%, Profile=%',                                                                                                                                                                                                                                                                                           +
             NEW.id, NEW.amount, NEW.term_biweeks, NEW.biweekly_payment,                                                                                                                                                                                                                                                                                                                                    +
             COALESCE(NEW.commission_per_payment, 0), COALESCE(NEW.profile_code, 'N/A');                                                                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- Calculate total associate payment for this loan                                                                                                                                                                                                                                                                                                                                                 +
         SELECT SUM(pago_socio) INTO v_total_associate_payment                                                                                                                                                                                                                                                                                                                                              +
         FROM generate_amortization_schedule(                                                                                                                                                                                                                                                                                                                                                               +
             NEW.amount,                                                                                                                                                                                                                                                                                                                                                                                    +
             NEW.biweekly_payment,                                                                                                                                                                                                                                                                                                                                                                          +
             NEW.term_biweeks,                                                                                                                                                                                                                                                                                                                                                                              +
             v_commission_rate_for_function,                                                                                                                                                                                                                                                                                                                                                                +
             v_first_payment_date                                                                                                                                                                                                                                                                                                                                                                           +
         );                                                                                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- Generate complete schedule with breakdown                                                                                                                                                                                                                                                                                                                                                       +
         FOR v_amortization_row IN                                                                                                                                                                                                                                                                                                                                                                          +
             SELECT                                                                                                                                                                                                                                                                                                                                                                                         +
                 periodo,                                                                                                                                                                                                                                                                                                                                                                                   +
                 fecha_pago,                                                                                                                                                                                                                                                                                                                                                                                +
                 pago_cliente,                                                                                                                                                                                                                                                                                                                                                                              +
                 interes_cliente,                                                                                                                                                                                                                                                                                                                                                                           +
                 capital_cliente,                                                                                                                                                                                                                                                                                                                                                                           +
                 saldo_pendiente,                                                                                                                                                                                                                                                                                                                                                                           +
                 comision_socio,                                                                                                                                                                                                                                                                                                                                                                            +
                 pago_socio                                                                                                                                                                                                                                                                                                                                                                                 +
             FROM generate_amortization_schedule(                                                                                                                                                                                                                                                                                                                                                           +
                 NEW.amount,                                                                                                                                                                                                                                                                                                                                                                                +
                 NEW.biweekly_payment,                                                                                                                                                                                                                                                                                                                                                                      +
                 NEW.term_biweeks,                                                                                                                                                                                                                                                                                                                                                                          +
                 v_commission_rate_for_function,                                                                                                                                                                                                                                                                                                                                                            +
                 v_first_payment_date                                                                                                                                                                                                                                                                                                                                                                       +
             )                                                                                                                                                                                                                                                                                                                                                                                              +
         LOOP                                                                                                                                                                                                                                                                                                                                                                                               +
             -- NUEVA L√ìGICA: Asignar per√≠odo basado en d√≠a de vencimiento                                                                                                                                                                                                                                                                                                                                  +
             v_payment_day := EXTRACT(DAY FROM v_amortization_row.fecha_pago);                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             IF v_payment_day = 15 THEN                                                                                                                                                                                                                                                                                                                                                                     +
                 v_target_cut_day := 8;                                                                                                                                                                                                                                                                                                                                                                     +
             ELSE                                                                                                                                                                                                                                                                                                                                                                                           +
                 v_target_cut_day := 23;                                                                                                                                                                                                                                                                                                                                                                    +
             END IF;                                                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             -- Construir el cut_code esperado: MonDD-YYYY                                                                                                                                                                                                                                                                                                                                                  +
             v_month_name := TO_CHAR(v_amortization_row.fecha_pago, 'Mon');                                                                                                                                                                                                                                                                                                                                 +
             v_year_str := TO_CHAR(v_amortization_row.fecha_pago, 'YYYY');                                                                                                                                                                                                                                                                                                                                  +
             v_target_cut_code := v_month_name || LPAD(v_target_cut_day::text, 2, '0') || '-' || v_year_str;                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             -- Buscar el per√≠odo de corte por cut_code                                                                                                                                                                                                                                                                                                                                                     +
             SELECT id INTO v_period_id                                                                                                                                                                                                                                                                                                                                                                     +
             FROM cut_periods                                                                                                                                                                                                                                                                                                                                                                               +
             WHERE cut_code = v_target_cut_code                                                                                                                                                                                                                                                                                                                                                             +
             LIMIT 1;                                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             IF v_period_id IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                    +
                 RAISE WARNING 'No cut_period found with code %. Inserting with period_id = NULL',                                                                                                                                                                                                                                                                                                          +
                     v_target_cut_code;                                                                                                                                                                                                                                                                                                                                                                     +
             ELSE                                                                                                                                                                                                                                                                                                                                                                                           +
                 RAISE NOTICE 'Payment due % -> assigned to period % (%)',                                                                                                                                                                                                                                                                                                                                  +
                     v_amortization_row.fecha_pago, v_target_cut_code, v_period_id;                                                                                                                                                                                                                                                                                                                         +
             END IF;                                                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             -- Calculate cumulative associate paid                                                                                                                                                                                                                                                                                                                                                         +
             v_cumulative_associate_paid := v_cumulative_associate_paid + v_amortization_row.pago_socio;                                                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             -- Insert payment                                                                                                                                                                                                                                                                                                                                                                              +
             INSERT INTO payments (                                                                                                                                                                                                                                                                                                                                                                         +
                 loan_id, payment_number, expected_amount, amount_paid,                                                                                                                                                                                                                                                                                                                                     +
                 interest_amount, principal_amount, commission_amount, associate_payment,                                                                                                                                                                                                                                                                                                                   +
                 balance_remaining, associate_balance_remaining,                                                                                                                                                                                                                                                                                                                                            +
                 payment_date, payment_due_date, is_late, status_id, cut_period_id,                                                                                                                                                                                                                                                                                                                         +
                 created_at, updated_at                                                                                                                                                                                                                                                                                                                                                                     +
             ) VALUES (                                                                                                                                                                                                                                                                                                                                                                                     +
                 NEW.id, v_amortization_row.periodo, v_amortization_row.pago_cliente, 0.00,                                                                                                                                                                                                                                                                                                                 +
                 v_amortization_row.interes_cliente, v_amortization_row.capital_cliente,                                                                                                                                                                                                                                                                                                                    +
                 v_amortization_row.comision_socio, v_amortization_row.pago_socio,                                                                                                                                                                                                                                                                                                                          +
                 v_amortization_row.saldo_pendiente, v_total_associate_payment - v_cumulative_associate_paid,                                                                                                                                                                                                                                                                                               +
                 v_amortization_row.fecha_pago, v_amortization_row.fecha_pago, false,                                                                                                                                                                                                                                                                                                                       +
                 v_pending_status_id, v_period_id, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                     +
             );                                                                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             v_total_inserted := v_total_inserted + 1;                                                                                                                                                                                                                                                                                                                                                      +
             v_sum_expected := v_sum_expected + v_amortization_row.pago_cliente;                                                                                                                                                                                                                                                                                                                            +
         END LOOP;                                                                                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         v_end_time := CLOCK_TIMESTAMP();                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         IF v_total_inserted != NEW.term_biweeks THEN                                                                                                                                                                                                                                                                                                                                                       +
             RAISE EXCEPTION 'INCONSISTENCY: Inserted % payments but expected %',                                                                                                                                                                                                                                                                                                                           +
                 v_total_inserted, NEW.term_biweeks;                                                                                                                                                                                                                                                                                                                                                        +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         RAISE NOTICE 'Schedule generated: % payments, Total expected: $%, Time: % ms',                                                                                                                                                                                                                                                                                                                     +
             v_total_inserted, v_sum_expected,                                                                                                                                                                                                                                                                                                                                                              +
             EXTRACT(MILLISECONDS FROM (v_end_time - v_start_time));                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
 EXCEPTION                                                                                                                                                                                                                                                                                                                                                                                                  +
     WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                                                                       +
         RAISE EXCEPTION 'CRITICAL ERROR generating payment schedule for loan %: % (%). SQLState: %',                                                                                                                                                                                                                                                                                                       +
             NEW.id, SQLERRM, SQLSTATE, SQLSTATE;                                                                                                                                                                                                                                                                                                                                                           +
         RETURN NULL;                                                                                                                                                                                                                                                                                                                                                                                       +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.get_cut_period_for_payment(p_payment_date date)                                                                                                                                                                                                                                                                                                                          +
  RETURNS integer                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  IMMUTABLE STRICT                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_period_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                                   +
     v_day INTEGER;                                                                                                                                                                                                                                                                                                                                                                                         +
     v_month INTEGER;                                                                                                                                                                                                                                                                                                                                                                                       +
     v_year INTEGER;                                                                                                                                                                                                                                                                                                                                                                                        +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     v_day := EXTRACT(DAY FROM p_payment_date)::INTEGER;                                                                                                                                                                                                                                                                                                                                                    +
     v_month := EXTRACT(MONTH FROM p_payment_date)::INTEGER;                                                                                                                                                                                                                                                                                                                                                +
     v_year := EXTRACT(YEAR FROM p_payment_date)::INTEGER;                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Determinar si es d√≠a 15 o √∫ltimo d√≠a del mes                                                                                                                                                                                                                                                                                                                                                        +
     IF v_day = 15 THEN                                                                                                                                                                                                                                                                                                                                                                                     +
         -- Pago d√≠a 15 ‚Üí Buscar periodo que cierra d√≠a 7-8 (aproximado) ANTES del d√≠a 15                                                                                                                                                                                                                                                                                                                   +
         SELECT id INTO v_period_id                                                                                                                                                                                                                                                                                                                                                                         +
         FROM cut_periods                                                                                                                                                                                                                                                                                                                                                                                   +
         WHERE EXTRACT(DAY FROM period_end_date) BETWEEN 6 AND 8  -- Cierra ~d√≠a 7                                                                                                                                                                                                                                                                                                                          +
           AND period_end_date < p_payment_date  -- Cierra ANTES del vencimiento                                                                                                                                                                                                                                                                                                                            +
           AND EXTRACT(MONTH FROM period_end_date) = v_month  -- Mismo mes                                                                                                                                                                                                                                                                                                                                  +
           AND EXTRACT(YEAR FROM period_end_date) = v_year                                                                                                                                                                                                                                                                                                                                                  +
         ORDER BY period_end_date DESC                                                                                                                                                                                                                                                                                                                                                                      +
         LIMIT 1;                                                                                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- Si no encontr√≥ en el mismo mes, buscar a fin del mes anterior                                                                                                                                                                                                                                                                                                                                   +
         IF v_period_id IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                        +
             SELECT id INTO v_period_id                                                                                                                                                                                                                                                                                                                                                                     +
             FROM cut_periods                                                                                                                                                                                                                                                                                                                                                                               +
             WHERE EXTRACT(DAY FROM period_end_date) BETWEEN 6 AND 8                                                                                                                                                                                                                                                                                                                                        +
               AND period_end_date < p_payment_date                                                                                                                                                                                                                                                                                                                                                         +
               AND (                                                                                                                                                                                                                                                                                                                                                                                        +
                   (EXTRACT(MONTH FROM period_end_date) = v_month - 1 AND EXTRACT(YEAR FROM period_end_date) = v_year) OR                                                                                                                                                                                                                                                                                   +
                   (v_month = 1 AND EXTRACT(MONTH FROM period_end_date) = 12 AND EXTRACT(YEAR FROM period_end_date) = v_year - 1)                                                                                                                                                                                                                                                                           +
               )                                                                                                                                                                                                                                                                                                                                                                                            +
             ORDER BY period_end_date DESC                                                                                                                                                                                                                                                                                                                                                                  +
             LIMIT 1;                                                                                                                                                                                                                                                                                                                                                                                       +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     ELSE                                                                                                                                                                                                                                                                                                                                                                                                   +
         -- Pago √∫ltimo d√≠a ‚Üí Buscar periodo que cierra d√≠a 22-23 ANTES del √∫ltimo d√≠a                                                                                                                                                                                                                                                                                                                      +
         SELECT id INTO v_period_id                                                                                                                                                                                                                                                                                                                                                                         +
         FROM cut_periods                                                                                                                                                                                                                                                                                                                                                                                   +
         WHERE EXTRACT(DAY FROM period_end_date) BETWEEN 21 AND 23  -- Cierra ~d√≠a 22                                                                                                                                                                                                                                                                                                                       +
           AND period_end_date < p_payment_date  -- Cierra ANTES del vencimiento                                                                                                                                                                                                                                                                                                                            +
           AND EXTRACT(MONTH FROM period_end_date) = v_month  -- Mismo mes                                                                                                                                                                                                                                                                                                                                  +
           AND EXTRACT(YEAR FROM period_end_date) = v_year                                                                                                                                                                                                                                                                                                                                                  +
         ORDER BY period_end_date DESC                                                                                                                                                                                                                                                                                                                                                                      +
         LIMIT 1;                                                                                                                                                                                                                                                                                                                                                                                           +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Si a√∫n no encontr√≥, usar l√≥gica de fallback (contenci√≥n)                                                                                                                                                                                                                                                                                                                                            +
     IF v_period_id IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                            +
         RAISE WARNING 'No se encontr√≥ periodo con cierre antes de %. Usando fallback.', p_payment_date;                                                                                                                                                                                                                                                                                                    +
         SELECT id INTO v_period_id                                                                                                                                                                                                                                                                                                                                                                         +
         FROM cut_periods                                                                                                                                                                                                                                                                                                                                                                                   +
         WHERE period_start_date <= p_payment_date                                                                                                                                                                                                                                                                                                                                                          +
           AND period_end_date >= p_payment_date                                                                                                                                                                                                                                                                                                                                                            +
         ORDER BY period_start_date DESC                                                                                                                                                                                                                                                                                                                                                                    +
         LIMIT 1;                                                                                                                                                                                                                                                                                                                                                                                           +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN v_period_id;                                                                                                                                                                                                                                                                                                                                                                                    +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.get_debt_payment_detail(p_debt_payment_id integer)                                                                                                                                                                                                                                                                                                                       +
  RETURNS TABLE(breakdown_id integer, cut_period_id integer, period_description character varying, original_amount numeric, amount_applied numeric, liquidated boolean, remaining_amount numeric)                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                           +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         (item->>'breakdown_id')::INTEGER AS breakdown_id,                                                                                                                                                                                                                                                                                                                                                  +
         (item->>'cut_period_id')::INTEGER AS cut_period_id,                                                                                                                                                                                                                                                                                                                                                +
         COALESCE(                                                                                                                                                                                                                                                                                                                                                                                          +
             cp.description,                                                                                                                                                                                                                                                                                                                                                                                +
             'Per√≠odo ' || TO_CHAR(cp.start_date, 'DD/MM/YYYY') || ' - ' || TO_CHAR(cp.end_date, 'DD/MM/YYYY')                                                                                                                                                                                                                                                                                              +
         ) AS period_description,                                                                                                                                                                                                                                                                                                                                                                           +
         (item->>'original_amount')::DECIMAL(12,2) AS original_amount,                                                                                                                                                                                                                                                                                                                                      +
         (item->>'amount_applied')::DECIMAL(12,2) AS amount_applied,                                                                                                                                                                                                                                                                                                                                        +
         (item->>'liquidated')::BOOLEAN AS liquidated,                                                                                                                                                                                                                                                                                                                                                      +
         COALESCE((item->>'remaining_amount')::DECIMAL(12,2), 0) AS remaining_amount                                                                                                                                                                                                                                                                                                                        +
     FROM associate_debt_payments adp                                                                                                                                                                                                                                                                                                                                                                       +
     CROSS JOIN jsonb_array_elements(adp.applied_breakdown_items) AS item                                                                                                                                                                                                                                                                                                                                   +
     LEFT JOIN cut_periods cp ON cp.id = (item->>'cut_period_id')::INTEGER                                                                                                                                                                                                                                                                                                                                  +
     WHERE adp.id = p_debt_payment_id;                                                                                                                                                                                                                                                                                                                                                                      +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.get_payment_history(p_payment_id integer)                                                                                                                                                                                                                                                                                                                                +
  RETURNS TABLE(change_id integer, old_status character varying, new_status character varying, change_type character varying, changed_by_username character varying, change_reason text, changed_at timestamp with time zone)                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  STABLE                                                                                                                                                                                                                                                                                                                                                                                                    +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                           +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         psh.id,                                                                                                                                                                                                                                                                                                                                                                                            +
         ps_old.name,                                                                                                                                                                                                                                                                                                                                                                                       +
         ps_new.name,                                                                                                                                                                                                                                                                                                                                                                                       +
         psh.change_type,                                                                                                                                                                                                                                                                                                                                                                                   +
         u.username,                                                                                                                                                                                                                                                                                                                                                                                        +
         psh.change_reason,                                                                                                                                                                                                                                                                                                                                                                                 +
         psh.changed_at                                                                                                                                                                                                                                                                                                                                                                                     +
     FROM payment_status_history psh                                                                                                                                                                                                                                                                                                                                                                        +
     LEFT JOIN payment_statuses ps_old ON psh.old_status_id = ps_old.id                                                                                                                                                                                                                                                                                                                                     +
     JOIN payment_statuses ps_new ON psh.new_status_id = ps_new.id                                                                                                                                                                                                                                                                                                                                          +
     LEFT JOIN users u ON psh.changed_by = u.id                                                                                                                                                                                                                                                                                                                                                             +
     WHERE psh.payment_id = p_payment_id                                                                                                                                                                                                                                                                                                                                                                    +
     ORDER BY psh.changed_at DESC;                                                                                                                                                                                                                                                                                                                                                                          +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.handle_loan_approval_status()                                                                                                                                                                                                                                                                                                                                            +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_approved_status_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                          +
     v_rejected_status_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                          +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener IDs de estados APPROVED y REJECTED                                                                                                                                                                                                                                                                                                                                                          +
     SELECT id INTO v_approved_status_id FROM loan_statuses WHERE name = 'APPROVED';                                                                                                                                                                                                                                                                                                                        +
     SELECT id INTO v_rejected_status_id FROM loan_statuses WHERE name = 'REJECTED';                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Si cambi√≥ a APPROVED, setear timestamp                                                                                                                                                                                                                                                                                                                                                              +
     IF NEW.status_id = v_approved_status_id AND (OLD.status_id IS NULL OR OLD.status_id != v_approved_status_id) AND NEW.approved_at IS NULL THEN                                                                                                                                                                                                                                                          +
         NEW.approved_at = CURRENT_TIMESTAMP;                                                                                                                                                                                                                                                                                                                                                               +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Si cambi√≥ a REJECTED, setear timestamp                                                                                                                                                                                                                                                                                                                                                              +
     IF NEW.status_id = v_rejected_status_id AND (OLD.status_id IS NULL OR OLD.status_id != v_rejected_status_id) AND NEW.rejected_at IS NULL THEN                                                                                                                                                                                                                                                          +
         NEW.rejected_at = CURRENT_TIMESTAMP;                                                                                                                                                                                                                                                                                                                                                               +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.log_payment_status_change()                                                                                                                                                                                                                                                                                                                                              +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_change_type VARCHAR(50);                                                                                                                                                                                                                                                                                                                                                                             +
     v_changed_by INTEGER;                                                                                                                                                                                                                                                                                                                                                                                  +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Solo registrar si el status_id cambi√≥                                                                                                                                                                                                                                                                                                                                                               +
     IF OLD.status_id IS DISTINCT FROM NEW.status_id THEN                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- Determinar tipo de cambio                                                                                                                                                                                                                                                                                                                                                                       +
         IF NEW.marked_by IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                                  +
             v_change_type := 'MANUAL_ADMIN';                                                                                                                                                                                                                                                                                                                                                               +
             v_changed_by := NEW.marked_by;                                                                                                                                                                                                                                                                                                                                                                 +
         ELSE                                                                                                                                                                                                                                                                                                                                                                                               +
             v_change_type := 'AUTOMATIC';                                                                                                                                                                                                                                                                                                                                                                  +
             v_changed_by := NULL;                                                                                                                                                                                                                                                                                                                                                                          +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- Insertar en historial                                                                                                                                                                                                                                                                                                                                                                           +
         INSERT INTO payment_status_history (                                                                                                                                                                                                                                                                                                                                                               +
             payment_id,                                                                                                                                                                                                                                                                                                                                                                                    +
             old_status_id,                                                                                                                                                                                                                                                                                                                                                                                 +
             new_status_id,                                                                                                                                                                                                                                                                                                                                                                                 +
             change_type,                                                                                                                                                                                                                                                                                                                                                                                   +
             changed_by,                                                                                                                                                                                                                                                                                                                                                                                    +
             change_reason,                                                                                                                                                                                                                                                                                                                                                                                 +
             changed_at                                                                                                                                                                                                                                                                                                                                                                                     +
         ) VALUES (                                                                                                                                                                                                                                                                                                                                                                                         +
             NEW.id,                                                                                                                                                                                                                                                                                                                                                                                        +
             OLD.status_id,                                                                                                                                                                                                                                                                                                                                                                                 +
             NEW.status_id,                                                                                                                                                                                                                                                                                                                                                                                 +
             v_change_type,                                                                                                                                                                                                                                                                                                                                                                                 +
             v_changed_by,                                                                                                                                                                                                                                                                                                                                                                                  +
             NEW.marking_notes,                                                                                                                                                                                                                                                                                                                                                                             +
             CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                              +
         );                                                                                                                                                                                                                                                                                                                                                                                                 +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.renew_loan(p_original_loan_id integer, p_new_amount numeric, p_new_term_biweeks integer, p_interest_rate numeric, p_commission_rate numeric, p_created_by integer)                                                                                                                                                                                                       +
  RETURNS integer                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_client_user_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                              +
     v_associate_user_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                           +
     v_pending_balance DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                       +
     v_new_loan_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                                 +
     v_pending_status_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                           +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener datos del pr√©stamo original                                                                                                                                                                                                                                                                                                                                                                 +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         user_id,                                                                                                                                                                                                                                                                                                                                                                                           +
         associate_user_id                                                                                                                                                                                                                                                                                                                                                                                  +
     INTO                                                                                                                                                                                                                                                                                                                                                                                                   +
         v_client_user_id,                                                                                                                                                                                                                                                                                                                                                                                  +
         v_associate_user_id                                                                                                                                                                                                                                                                                                                                                                                +
     FROM loans                                                                                                                                                                                                                                                                                                                                                                                             +
     WHERE id = p_original_loan_id;                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Pr√©stamo original % no encontrado', p_original_loan_id;                                                                                                                                                                                                                                                                                                                           +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Calcular saldo pendiente                                                                                                                                                                                                                                                                                                                                                                            +
     v_pending_balance := calculate_loan_remaining_balance(p_original_loan_id);                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Obtener ID del estado PENDING                                                                                                                                                                                                                                                                                                                                                                       +
     SELECT id INTO v_pending_status_id FROM loan_statuses WHERE name = 'PENDING';                                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Crear nuevo pr√©stamo                                                                                                                                                                                                                                                                                                                                                                                +
     INSERT INTO loans (                                                                                                                                                                                                                                                                                                                                                                                    +
         user_id,                                                                                                                                                                                                                                                                                                                                                                                           +
         associate_user_id,                                                                                                                                                                                                                                                                                                                                                                                 +
         amount,                                                                                                                                                                                                                                                                                                                                                                                            +
         interest_rate,                                                                                                                                                                                                                                                                                                                                                                                     +
         commission_rate,                                                                                                                                                                                                                                                                                                                                                                                   +
         term_biweeks,                                                                                                                                                                                                                                                                                                                                                                                      +
         status_id,                                                                                                                                                                                                                                                                                                                                                                                         +
         notes,                                                                                                                                                                                                                                                                                                                                                                                             +
         created_at                                                                                                                                                                                                                                                                                                                                                                                         +
     ) VALUES (                                                                                                                                                                                                                                                                                                                                                                                             +
         v_client_user_id,                                                                                                                                                                                                                                                                                                                                                                                  +
         v_associate_user_id,                                                                                                                                                                                                                                                                                                                                                                               +
         p_new_amount,                                                                                                                                                                                                                                                                                                                                                                                      +
         p_interest_rate,                                                                                                                                                                                                                                                                                                                                                                                   +
         p_commission_rate,                                                                                                                                                                                                                                                                                                                                                                                 +
         p_new_term_biweeks,                                                                                                                                                                                                                                                                                                                                                                                +
         v_pending_status_id,                                                                                                                                                                                                                                                                                                                                                                               +
         'Renovaci√≥n de pr√©stamo #' || p_original_loan_id || '. Saldo pendiente: ' || v_pending_balance,                                                                                                                                                                                                                                                                                                    +
         CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                                  +
     ) RETURNING id INTO v_new_loan_id;                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Registrar la renovaci√≥n                                                                                                                                                                                                                                                                                                                                                                             +
     INSERT INTO loan_renewals (                                                                                                                                                                                                                                                                                                                                                                            +
         original_loan_id,                                                                                                                                                                                                                                                                                                                                                                                  +
         renewed_loan_id,                                                                                                                                                                                                                                                                                                                                                                                   +
         renewal_date,                                                                                                                                                                                                                                                                                                                                                                                      +
         pending_balance,                                                                                                                                                                                                                                                                                                                                                                                   +
         new_amount,                                                                                                                                                                                                                                                                                                                                                                                        +
         reason,                                                                                                                                                                                                                                                                                                                                                                                            +
         created_by                                                                                                                                                                                                                                                                                                                                                                                         +
     ) VALUES (                                                                                                                                                                                                                                                                                                                                                                                             +
         p_original_loan_id,                                                                                                                                                                                                                                                                                                                                                                                +
         v_new_loan_id,                                                                                                                                                                                                                                                                                                                                                                                     +
         CURRENT_DATE,                                                                                                                                                                                                                                                                                                                                                                                      +
         v_pending_balance,                                                                                                                                                                                                                                                                                                                                                                                 +
         p_new_amount,                                                                                                                                                                                                                                                                                                                                                                                      +
         'Renovaci√≥n est√°ndar',                                                                                                                                                                                                                                                                                                                                                                             +
         p_created_by                                                                                                                                                                                                                                                                                                                                                                                       +
     );                                                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE '‚úÖ Pr√©stamo % renovado como pr√©stamo %. Saldo pendiente: %, Nuevo monto: %',                                                                                                                                                                                                                                                                                                             +
         p_original_loan_id, v_new_loan_id, v_pending_balance, p_new_amount;                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN v_new_loan_id;                                                                                                                                                                                                                                                                                                                                                                                  +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.report_defaulted_client(p_associate_profile_id integer, p_loan_id integer, p_reported_by integer, p_total_debt_amount numeric, p_evidence_details text, p_evidence_file_path character varying DEFAULT NULL::character varying)                                                                                                                                          +
  RETURNS integer                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_client_user_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                              +
     v_report_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                                   +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener ID del cliente desde el pr√©stamo                                                                                                                                                                                                                                                                                                                                                            +
     SELECT user_id INTO v_client_user_id                                                                                                                                                                                                                                                                                                                                                                   +
     FROM loans                                                                                                                                                                                                                                                                                                                                                                                             +
     WHERE id = p_loan_id;                                                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Pr√©stamo % no encontrado', p_loan_id;                                                                                                                                                                                                                                                                                                                                             +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Insertar reporte de morosidad                                                                                                                                                                                                                                                                                                                                                                       +
     INSERT INTO defaulted_client_reports (                                                                                                                                                                                                                                                                                                                                                                 +
         associate_profile_id,                                                                                                                                                                                                                                                                                                                                                                              +
         loan_id,                                                                                                                                                                                                                                                                                                                                                                                           +
         client_user_id,                                                                                                                                                                                                                                                                                                                                                                                    +
         reported_by,                                                                                                                                                                                                                                                                                                                                                                                       +
         total_debt_amount,                                                                                                                                                                                                                                                                                                                                                                                 +
         evidence_details,                                                                                                                                                                                                                                                                                                                                                                                  +
         evidence_file_path,                                                                                                                                                                                                                                                                                                                                                                                +
         status                                                                                                                                                                                                                                                                                                                                                                                             +
     ) VALUES (                                                                                                                                                                                                                                                                                                                                                                                             +
         p_associate_profile_id,                                                                                                                                                                                                                                                                                                                                                                            +
         p_loan_id,                                                                                                                                                                                                                                                                                                                                                                                         +
         v_client_user_id,                                                                                                                                                                                                                                                                                                                                                                                  +
         p_reported_by,                                                                                                                                                                                                                                                                                                                                                                                     +
         p_total_debt_amount,                                                                                                                                                                                                                                                                                                                                                                               +
         p_evidence_details,                                                                                                                                                                                                                                                                                                                                                                                +
         p_evidence_file_path,                                                                                                                                                                                                                                                                                                                                                                              +
         'PENDING'                                                                                                                                                                                                                                                                                                                                                                                          +
     ) RETURNING id INTO v_report_id;                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE 'üìã Reporte de morosidad creado: ID %, Cliente %, Deuda: %',                                                                                                                                                                                                                                                                                                                              +
         v_report_id, v_client_user_id, p_total_debt_amount;                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN v_report_id;                                                                                                                                                                                                                                                                                                                                                                                    +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.revert_last_payment_change(p_payment_id integer, p_admin_user_id integer, p_reason text)                                                                                                                                                                                                                                                                                 +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                                                              +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_last_old_status_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                          +
     v_current_status_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                           +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener estado actual                                                                                                                                                                                                                                                                                                                                                                               +
     SELECT status_id INTO v_current_status_id                                                                                                                                                                                                                                                                                                                                                              +
     FROM payments                                                                                                                                                                                                                                                                                                                                                                                          +
     WHERE id = p_payment_id;                                                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Pago % no encontrado', p_payment_id;                                                                                                                                                                                                                                                                                                                                              +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Obtener el estado anterior (√∫ltimo cambio)                                                                                                                                                                                                                                                                                                                                                          +
     SELECT old_status_id INTO v_last_old_status_id                                                                                                                                                                                                                                                                                                                                                         +
     FROM payment_status_history                                                                                                                                                                                                                                                                                                                                                                            +
     WHERE payment_id = p_payment_id                                                                                                                                                                                                                                                                                                                                                                        +
     ORDER BY changed_at DESC                                                                                                                                                                                                                                                                                                                                                                               +
     LIMIT 1;                                                                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_last_old_status_id IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                   +
         RAISE EXCEPTION 'No hay historial previo para revertir el pago %', p_payment_id;                                                                                                                                                                                                                                                                                                                   +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Revertir al estado anterior                                                                                                                                                                                                                                                                                                                                                                         +
     UPDATE payments                                                                                                                                                                                                                                                                                                                                                                                        +
     SET                                                                                                                                                                                                                                                                                                                                                                                                    +
         status_id = v_last_old_status_id,                                                                                                                                                                                                                                                                                                                                                                  +
         marked_by = p_admin_user_id,                                                                                                                                                                                                                                                                                                                                                                       +
         marked_at = CURRENT_TIMESTAMP,                                                                                                                                                                                                                                                                                                                                                                     +
         marking_notes = 'REVERSI√ìN: ' || p_reason,                                                                                                                                                                                                                                                                                                                                                         +
         updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                     +
     WHERE id = p_payment_id;                                                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE 'Pago % revertido de estado % a estado % por usuario %',                                                                                                                                                                                                                                                                                                                                  +
         p_payment_id, v_current_status_id, v_last_old_status_id, p_admin_user_id;                                                                                                                                                                                                                                                                                                                          +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.simulate_loan(p_amount numeric, p_term_biweeks integer, p_profile_code character varying, p_approval_date date DEFAULT CURRENT_DATE)                                                                                                                                                                                                                                     +
  RETURNS TABLE(payment_number integer, payment_date date, cut_period_code character varying, client_payment numeric, associate_payment numeric, commission_amount numeric, remaining_balance numeric, associate_remaining_balance numeric)                                                                                                                                                                 +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  STABLE                                                                                                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                                                            +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                                                                  +
     v_calc RECORD;\r                                                                                                                                                                                                                                                                                                                                                                                       +
     v_current_date DATE;\r                                                                                                                                                                                                                                                                                                                                                                                 +
     v_balance DECIMAL(12,2);\r                                                                                                                                                                                                                                                                                                                                                                             +
     v_associate_balance DECIMAL(12,2); -- ‚úÖ NUEVO\r                                                                                                                                                                                                                                                                                                                                                       +
     v_cut_code VARCHAR(20);\r                                                                                                                                                                                                                                                                                                                                                                              +
     v_period_capital DECIMAL(12,2);\r                                                                                                                                                                                                                                                                                                                                                                      +
     v_period_id INTEGER;\r                                                                                                                                                                                                                                                                                                                                                                                 +
     i INTEGER;\r                                                                                                                                                                                                                                                                                                                                                                                           +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                                                                    +
     -- Obtener c√°lculos del perfil\r                                                                                                                                                                                                                                                                                                                                                                       +
     SELECT * INTO v_calc\r                                                                                                                                                                                                                                                                                                                                                                                 +
     FROM calculate_loan_payment(p_amount, p_term_biweeks, p_profile_code);\r                                                                                                                                                                                                                                                                                                                               +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
     IF NOT FOUND THEN\r                                                                                                                                                                                                                                                                                                                                                                                    +
         RAISE EXCEPTION 'Perfil % no encontrado', p_profile_code;\r                                                                                                                                                                                                                                                                                                                                        +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                                                              +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
     v_current_date := calculate_first_payment_date(p_approval_date);\r                                                                                                                                                                                                                                                                                                                                     +
     v_balance := p_amount;\r                                                                                                                                                                                                                                                                                                                                                                               +
     \r                                                                                                                                                                                                                                                                                                                                                                                                     +
     -- Inicializar saldo asociado\r                                                                                                                                                                                                                                                                                                                                                                        +
     v_associate_balance := v_calc.associate_payment * p_term_biweeks;\r                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
     v_period_capital := p_amount / p_term_biweeks;\r                                                                                                                                                                                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
     FOR i IN 1..p_term_biweeks LOOP\r                                                                                                                                                                                                                                                                                                                                                                      +
         v_period_id := get_cut_period_for_payment(v_current_date);\r                                                                                                                                                                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
         IF v_period_id IS NOT NULL THEN\r                                                                                                                                                                                                                                                                                                                                                                  +
             SELECT cut_code INTO v_cut_code FROM cut_periods WHERE id = v_period_id;\r                                                                                                                                                                                                                                                                                                                     +
         ELSE\r                                                                                                                                                                                                                                                                                                                                                                                             +
             v_cut_code := EXTRACT(YEAR FROM v_current_date)::TEXT || '-Q' || LPAD(CEIL(EXTRACT(DOY FROM v_current_date) / 15)::TEXT, 2, '0');\r                                                                                                                                                                                                                                                            +
         END IF;\r                                                                                                                                                                                                                                                                                                                                                                                          +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
         v_balance := v_balance - v_period_capital;\r                                                                                                                                                                                                                                                                                                                                                       +
         IF v_balance < 0.01 THEN v_balance := 0; END IF;\r                                                                                                                                                                                                                                                                                                                                                 +
         \r                                                                                                                                                                                                                                                                                                                                                                                                 +
         -- Actualizar saldo asociado\r                                                                                                                                                                                                                                                                                                                                                                     +
         v_associate_balance := v_associate_balance - v_calc.associate_payment;\r                                                                                                                                                                                                                                                                                                                           +
         IF v_associate_balance < 0.01 THEN v_associate_balance := 0; END IF;\r                                                                                                                                                                                                                                                                                                                             +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
         RETURN QUERY SELECT\r                                                                                                                                                                                                                                                                                                                                                                              +
             i::INTEGER,\r                                                                                                                                                                                                                                                                                                                                                                                  +
             v_current_date::DATE,\r                                                                                                                                                                                                                                                                                                                                                                        +
             v_cut_code::VARCHAR(20),\r                                                                                                                                                                                                                                                                                                                                                                     +
             v_calc.biweekly_payment::DECIMAL(10,2),\r                                                                                                                                                                                                                                                                                                                                                      +
             v_calc.associate_payment::DECIMAL(10,2),\r                                                                                                                                                                                                                                                                                                                                                     +
             v_calc.commission_per_payment::DECIMAL(10,2),\r                                                                                                                                                                                                                                                                                                                                                +
             v_balance::DECIMAL(12,2),\r                                                                                                                                                                                                                                                                                                                                                                    +
             v_associate_balance::DECIMAL(12,2); -- ‚úÖ RETORNAR\r                                                                                                                                                                                                                                                                                                                                           +
 \r                                                                                                                                                                                                                                                                                                                                                                                                         +
         IF EXTRACT(DAY FROM v_current_date) = 15 THEN\r                                                                                                                                                                                                                                                                                                                                                    +
             v_current_date := (DATE_TRUNC('month', v_current_date) + INTERVAL '1 month' - INTERVAL '1 day')::DATE;\r                                                                                                                                                                                                                                                                                       +
         ELSE\r                                                                                                                                                                                                                                                                                                                                                                                             +
             v_current_date := MAKE_DATE(\r                                                                                                                                                                                                                                                                                                                                                                 +
                 EXTRACT(YEAR FROM v_current_date + INTERVAL '1 month')::INTEGER,\r                                                                                                                                                                                                                                                                                                                         +
                 EXTRACT(MONTH FROM v_current_date + INTERVAL '1 month')::INTEGER,\r                                                                                                                                                                                                                                                                                                                        +
                 15\r                                                                                                                                                                                                                                                                                                                                                                                       +
             );\r                                                                                                                                                                                                                                                                                                                                                                                           +
         END IF;\r                                                                                                                                                                                                                                                                                                                                                                                          +
     END LOOP;\r                                                                                                                                                                                                                                                                                                                                                                                            +
 END;\r                                                                                                                                                                                                                                                                                                                                                                                                     +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.simulate_loan_complete(p_amount numeric, p_term_biweeks integer, p_profile_code character varying, p_approval_date date DEFAULT CURRENT_DATE)                                                                                                                                                                                                                            +
  RETURNS TABLE(section_type character varying, label character varying, value_text character varying, value_numeric numeric, payment_num integer, payment_date date, cut_code character varying, client_pay numeric, associate_pay numeric, commission numeric, balance numeric)                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  STABLE                                                                                                                                                                                                                                                                                                                                                                                                    +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_calc RECORD;                                                                                                                                                                                                                                                                                                                                                                                         +
     v_profile RECORD;                                                                                                                                                                                                                                                                                                                                                                                      +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener informaci√≥n del perfil y c√°lculos                                                                                                                                                                                                                                                                                                                                                           +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         rp.name as profile_name,                                                                                                                                                                                                                                                                                                                                                                           +
         c.*                                                                                                                                                                                                                                                                                                                                                                                                +
     INTO v_calc                                                                                                                                                                                                                                                                                                                                                                                            +
     FROM calculate_loan_payment(p_amount, p_term_biweeks, p_profile_code) c                                                                                                                                                                                                                                                                                                                                +
     JOIN rate_profiles rp ON rp.code = p_profile_code;                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Perfil % no encontrado o deshabilitado', p_profile_code;                                                                                                                                                                                                                                                                                                                          +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- =========================================================================                                                                                                                                                                                                                                                                                                                           +
     -- SECCI√ìN 1: RESUMEN DEL PR√âSTAMO                                                                                                                                                                                                                                                                                                                                                                     +
     -- =========================================================================                                                                                                                                                                                                                                                                                                                           +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'RESUMEN'::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                                            +
         'Perfil'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                                                            +
         v_calc.profile_name::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                                                 +
         NULL::DECIMAL(12,2),                                                                                                                                                                                                                                                                                                                                                                               +
         NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                      +
         NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'RESUMEN'::VARCHAR(20), 'Monto Solicitado'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                          +
         ('$' || p_amount::TEXT)::VARCHAR(100), p_amount,                                                                                                                                                                                                                                                                                                                                                   +
         NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                      +
         NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'RESUMEN'::VARCHAR(20), 'Plazo'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                                     +
         (p_term_biweeks || ' quincenas')::VARCHAR(100), p_term_biweeks::DECIMAL(12,2),                                                                                                                                                                                                                                                                                                                     +
         NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                      +
         NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'RESUMEN'::VARCHAR(20), 'Tasa de Inter√©s'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                           +
         (v_calc.interest_rate_percent || '%')::VARCHAR(100), v_calc.interest_rate_percent,                                                                                                                                                                                                                                                                                                                 +
         NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                      +
         NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'RESUMEN'::VARCHAR(20), 'Tasa de Comisi√≥n'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                          +
         (v_calc.commission_rate_percent || '%')::VARCHAR(100), v_calc.commission_rate_percent,                                                                                                                                                                                                                                                                                                             +
         NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                      +
         NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'RESUMEN'::VARCHAR(20), 'Fecha de Aprobaci√≥n'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                       +
         TO_CHAR(p_approval_date, 'DD/MM/YYYY')::VARCHAR(100), NULL::DECIMAL(12,2),                                                                                                                                                                                                                                                                                                                         +
         NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                      +
         NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Totales                                                                                                                                                                                                                                                                                                                                                                                             +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'TOTALES'::VARCHAR(20), 'Pago Quincenal Cliente'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                    +
         ('$' || v_calc.biweekly_payment::TEXT)::VARCHAR(100), v_calc.biweekly_payment,                                                                                                                                                                                                                                                                                                                     +
         NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                      +
         NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'TOTALES'::VARCHAR(20), 'Total a Pagar (Cliente)'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                   +
         ('$' || v_calc.total_payment::TEXT)::VARCHAR(100), v_calc.total_payment,                                                                                                                                                                                                                                                                                                                           +
         NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                      +
         NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'TOTALES'::VARCHAR(20), 'Pago Quincenal Asociado'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                   +
         ('$' || v_calc.associate_payment::TEXT)::VARCHAR(100), v_calc.associate_payment,                                                                                                                                                                                                                                                                                                                   +
         NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                      +
         NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'TOTALES'::VARCHAR(20), 'Total Asociado ‚Üí CrediCuenta'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                              +
         ('$' || v_calc.associate_total::TEXT)::VARCHAR(100), v_calc.associate_total,                                                                                                                                                                                                                                                                                                                       +
         NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                      +
         NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'TOTALES'::VARCHAR(20), 'Comisi√≥n por Pago'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                         +
         ('$' || v_calc.commission_per_payment::TEXT)::VARCHAR(100), v_calc.commission_per_payment,                                                                                                                                                                                                                                                                                                         +
         NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                      +
         NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'TOTALES'::VARCHAR(20), 'Comisi√≥n Total Asociado'::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                   +
         ('$' || v_calc.total_commission::TEXT)::VARCHAR(100), v_calc.total_commission,                                                                                                                                                                                                                                                                                                                     +
         NULL::INTEGER, NULL::DATE, NULL::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                      +
         NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(10,2), NULL::DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- =========================================================================                                                                                                                                                                                                                                                                                                                           +
     -- SECCI√ìN 2: TABLA DE AMORTIZACI√ìN                                                                                                                                                                                                                                                                                                                                                                    +
     -- =========================================================================                                                                                                                                                                                                                                                                                                                           +
     RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                           +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         'AMORTIZACI√ìN'::VARCHAR(20),                                                                                                                                                                                                                                                                                                                                                                       +
         NULL::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                                                                +
         NULL::VARCHAR(100),                                                                                                                                                                                                                                                                                                                                                                                +
         NULL::DECIMAL(12,2),                                                                                                                                                                                                                                                                                                                                                                               +
         s.payment_number,                                                                                                                                                                                                                                                                                                                                                                                  +
         s.payment_date,                                                                                                                                                                                                                                                                                                                                                                                    +
         s.cut_period_code,                                                                                                                                                                                                                                                                                                                                                                                 +
         s.client_payment,                                                                                                                                                                                                                                                                                                                                                                                  +
         s.associate_payment,                                                                                                                                                                                                                                                                                                                                                                               +
         s.commission_amount,                                                                                                                                                                                                                                                                                                                                                                               +
         s.remaining_balance                                                                                                                                                                                                                                                                                                                                                                                +
     FROM simulate_loan(p_amount, p_term_biweeks, p_profile_code, p_approval_date) s;                                                                                                                                                                                                                                                                                                                       +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.simulate_loan_custom(p_amount numeric, p_term_biweeks integer, p_interest_rate numeric, p_commission_rate numeric, p_approval_date date DEFAULT CURRENT_DATE)                                                                                                                                                                                                            +
  RETURNS TABLE(payment_number integer, payment_date date, cut_period_code character varying, client_payment numeric, associate_payment numeric, commission_amount numeric, remaining_balance numeric)                                                                                                                                                                                                      +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
  STABLE                                                                                                                                                                                                                                                                                                                                                                                                    +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_calc RECORD;                                                                                                                                                                                                                                                                                                                                                                                         +
     v_current_date DATE;                                                                                                                                                                                                                                                                                                                                                                                   +
     v_balance DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                               +
     v_cut_code VARCHAR(20);                                                                                                                                                                                                                                                                                                                                                                                +
     v_period_capital DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                        +
     i INTEGER;                                                                                                                                                                                                                                                                                                                                                                                             +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener c√°lculos con tasas custom                                                                                                                                                                                                                                                                                                                                                                   +
     SELECT * INTO v_calc                                                                                                                                                                                                                                                                                                                                                                                   +
     FROM calculate_loan_payment_custom(p_amount, p_term_biweeks, p_interest_rate, p_commission_rate);                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Error al calcular pr√©stamo custom';                                                                                                                                                                                                                                                                                                                                               +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Calcular primera fecha de pago usando el or√°culo                                                                                                                                                                                                                                                                                                                                                    +
     v_current_date := calculate_first_payment_date(p_approval_date);                                                                                                                                                                                                                                                                                                                                       +
     v_balance := p_amount;                                                                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Calcular abono a capital por periodo (inter√©s distribuido uniformemente)                                                                                                                                                                                                                                                                                                                            +
     v_period_capital := p_amount / p_term_biweeks;                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Generar tabla de amortizaci√≥n                                                                                                                                                                                                                                                                                                                                                                       +
     FOR i IN 1..p_term_biweeks LOOP                                                                                                                                                                                                                                                                                                                                                                        +
         -- ‚≠ê CORRECCI√ìN CR√çTICA: Buscar per√≠odo de corte REAL donde cae el pago                                                                                                                                                                                                                                                                                                                           +
         -- Un pago pertenece al per√≠odo donde payment_date est√° entre start y end                                                                                                                                                                                                                                                                                                                          +
         SELECT cp.cut_code INTO v_cut_code                                                                                                                                                                                                                                                                                                                                                                 +
         FROM cut_periods cp                                                                                                                                                                                                                                                                                                                                                                                +
         WHERE v_current_date >= cp.period_start_date                                                                                                                                                                                                                                                                                                                                                       +
           AND v_current_date <= cp.period_end_date                                                                                                                                                                                                                                                                                                                                                         +
         LIMIT 1;                                                                                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- Si no encuentra per√≠odo (ej: simulaci√≥n muy futura), usar c√≥digo gen√©rico                                                                                                                                                                                                                                                                                                                       +
         IF v_cut_code IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                         +
             -- Formato: YYYY-QXX (a√±o-n√∫mero quincenal)                                                                                                                                                                                                                                                                                                                                                    +
             v_cut_code := EXTRACT(YEAR FROM v_current_date)::TEXT || '-Q' ||                                                                                                                                                                                                                                                                                                                               +
                 LPAD(CEIL(EXTRACT(DOY FROM v_current_date) / 15)::TEXT, 2, '0');                                                                                                                                                                                                                                                                                                                           +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- Calcular saldo restante (disminuye por el abono a capital)                                                                                                                                                                                                                                                                                                                                      +
         v_balance := v_balance - v_period_capital;                                                                                                                                                                                                                                                                                                                                                         +
         IF v_balance < 0.01 THEN                                                                                                                                                                                                                                                                                                                                                                           +
             v_balance := 0;                                                                                                                                                                                                                                                                                                                                                                                +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             i,                                                                                                                                                                                                                                                                                                                                                                                             +
             v_current_date,                                                                                                                                                                                                                                                                                                                                                                                +
             v_cut_code,                                                                                                                                                                                                                                                                                                                                                                                    +
             v_calc.biweekly_payment,                                                                                                                                                                                                                                                                                                                                                                       +
             v_calc.associate_payment,                                                                                                                                                                                                                                                                                                                                                                      +
             v_calc.commission_per_payment,                                                                                                                                                                                                                                                                                                                                                                 +
             v_balance;                                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         -- ‚≠ê L√ìGICA DEL CALENDARIO: Alternar entre d√≠a 15 y √∫ltimo d√≠a del mes                                                                                                                                                                                                                                                                                                                            +
         IF EXTRACT(DAY FROM v_current_date) = 15 THEN                                                                                                                                                                                                                                                                                                                                                      +
             -- Si estamos en d√≠a 15, siguiente pago es el √∫ltimo d√≠a del mes ACTUAL                                                                                                                                                                                                                                                                                                                        +
             v_current_date := (DATE_TRUNC('month', v_current_date) + INTERVAL '1 month' - INTERVAL '1 day')::DATE;                                                                                                                                                                                                                                                                                         +
         ELSE                                                                                                                                                                                                                                                                                                                                                                                               +
             -- Si estamos en √∫ltimo d√≠a, siguiente pago es el 15 del mes SIGUIENTE                                                                                                                                                                                                                                                                                                                         +
             v_current_date := MAKE_DATE(                                                                                                                                                                                                                                                                                                                                                                   +
                 EXTRACT(YEAR FROM v_current_date + INTERVAL '1 month')::INTEGER,                                                                                                                                                                                                                                                                                                                           +
                 EXTRACT(MONTH FROM v_current_date + INTERVAL '1 month')::INTEGER,                                                                                                                                                                                                                                                                                                                          +
                 15                                                                                                                                                                                                                                                                                                                                                                                         +
             );                                                                                                                                                                                                                                                                                                                                                                                             +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
     END LOOP;                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN;                                                                                                                                                                                                                                                                                                                                                                                                +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.sync_associate_debt_balance(p_associate_profile_id integer)                                                                                                                                                                                                                                                                                                              +
  RETURNS numeric                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_user_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                                     +
     v_total_debt DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                            +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener user_id del perfil                                                                                                                                                                                                                                                                                                                                                                          +
     SELECT user_id INTO v_user_id                                                                                                                                                                                                                                                                                                                                                                          +
     FROM associate_profiles WHERE id = p_associate_profile_id;                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_user_id IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                              +
         RAISE EXCEPTION 'Associate profile % not found', p_associate_profile_id;                                                                                                                                                                                                                                                                                                                           +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Calcular deuda total desde accumulated_balances                                                                                                                                                                                                                                                                                                                                                     +
     SELECT COALESCE(SUM(accumulated_debt), 0)                                                                                                                                                                                                                                                                                                                                                              +
     INTO v_total_debt                                                                                                                                                                                                                                                                                                                                                                                      +
     FROM associate_accumulated_balances                                                                                                                                                                                                                                                                                                                                                                    +
     WHERE user_id = v_user_id;                                                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Actualizar debt_balance en associate_profiles                                                                                                                                                                                                                                                                                                                                                       +
     UPDATE associate_profiles                                                                                                                                                                                                                                                                                                                                                                              +
     SET                                                                                                                                                                                                                                                                                                                                                                                                    +
         debt_balance = v_total_debt,                                                                                                                                                                                                                                                                                                                                                                       +
         updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                     +
     WHERE id = p_associate_profile_id;                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN v_total_debt;                                                                                                                                                                                                                                                                                                                                                                                   +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.trigger_update_associate_credit_on_level_change()                                                                                                                                                                                                                                                                                                                        +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_new_credit_limit DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                      +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     IF NEW.level_id != OLD.level_id THEN                                                                                                                                                                                                                                                                                                                                                                   +
         SELECT credit_limit INTO v_new_credit_limit                                                                                                                                                                                                                                                                                                                                                        +
         FROM associate_levels                                                                                                                                                                                                                                                                                                                                                                              +
         WHERE id = NEW.level_id;                                                                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         UPDATE associate_profiles                                                                                                                                                                                                                                                                                                                                                                          +
         SET credit_limit = v_new_credit_limit,                                                                                                                                                                                                                                                                                                                                                             +
             credit_last_updated = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                        +
         WHERE id = NEW.id;                                                                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         RAISE NOTICE 'L√≠mite de cr√©dito del asociado % actualizado a %', NEW.id, v_new_credit_limit;                                                                                                                                                                                                                                                                                                       +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.trigger_update_associate_credit_on_loan_approval()                                                                                                                                                                                                                                                                                                                       +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_associate_profile_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                        +
     v_approved_status_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                          +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     SELECT id INTO v_approved_status_id FROM loan_statuses WHERE name = 'APPROVED';                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NEW.status_id = v_approved_status_id AND (OLD.status_id IS NULL OR OLD.status_id != v_approved_status_id) THEN                                                                                                                                                                                                                                                                                      +
         IF NEW.associate_user_id IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                          +
             SELECT id INTO v_associate_profile_id                                                                                                                                                                                                                                                                                                                                                          +
             FROM associate_profiles                                                                                                                                                                                                                                                                                                                                                                        +
             WHERE user_id = NEW.associate_user_id;                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             IF v_associate_profile_id IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                     +
                 UPDATE associate_profiles                                                                                                                                                                                                                                                                                                                                                                  +
                 SET credit_used = credit_used + NEW.amount,                                                                                                                                                                                                                                                                                                                                                +
                     credit_last_updated = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                +
                 WHERE id = v_associate_profile_id;                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                            +
                 RAISE NOTICE 'Cr√©dito del asociado % actualizado: +%', v_associate_profile_id, NEW.amount;                                                                                                                                                                                                                                                                                                 +
             END IF;                                                                                                                                                                                                                                                                                                                                                                                        +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.trigger_update_associate_credit_on_payment()                                                                                                                                                                                                                                                                                                                             +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_associate_user_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                           +
     v_associate_profile_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                        +
     v_amount_diff DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                           +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     IF NEW.amount_paid != OLD.amount_paid THEN                                                                                                                                                                                                                                                                                                                                                             +
         SELECT associate_user_id INTO v_associate_user_id                                                                                                                                                                                                                                                                                                                                                  +
         FROM loans                                                                                                                                                                                                                                                                                                                                                                                         +
         WHERE id = NEW.loan_id;                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
         IF v_associate_user_id IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                            +
             SELECT id INTO v_associate_profile_id                                                                                                                                                                                                                                                                                                                                                          +
             FROM associate_profiles                                                                                                                                                                                                                                                                                                                                                                        +
             WHERE user_id = v_associate_user_id;                                                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                            +
             IF v_associate_profile_id IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                     +
                 v_amount_diff := NEW.amount_paid - OLD.amount_paid;                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                            +
                 UPDATE associate_profiles                                                                                                                                                                                                                                                                                                                                                                  +
                 SET credit_used = GREATEST(credit_used - v_amount_diff, 0),                                                                                                                                                                                                                                                                                                                                +
                     credit_last_updated = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                +
                 WHERE id = v_associate_profile_id;                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                            +
                 RAISE NOTICE 'Cr√©dito del asociado % actualizado por pago: -%', v_associate_profile_id, v_amount_diff;                                                                                                                                                                                                                                                                                     +
             END IF;                                                                                                                                                                                                                                                                                                                                                                                        +
         END IF;                                                                                                                                                                                                                                                                                                                                                                                            +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.update_legacy_payment_table_timestamp()                                                                                                                                                                                                                                                                                                                                  +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     NEW.updated_at = CURRENT_TIMESTAMP;                                                                                                                                                                                                                                                                                                                                                                    +
     RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.update_statement_on_payment()                                                                                                                                                                                                                                                                                                                                            +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_total_paid DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                            +
     v_total_owed DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                            +
     v_remaining DECIMAL(12,2);                                                                                                                                                                                                                                                                                                                                                                             +
     v_new_status_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                               +
     v_associate_profile_id INTEGER;                                                                                                                                                                                                                                                                                                                                                                        +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Calcular total pagado (suma de todos los abonos)                                                                                                                                                                                                                                                                                                                                                    +
     SELECT COALESCE(SUM(payment_amount), 0)                                                                                                                                                                                                                                                                                                                                                                +
     INTO v_total_paid                                                                                                                                                                                                                                                                                                                                                                                      +
     FROM associate_statement_payments                                                                                                                                                                                                                                                                                                                                                                      +
     WHERE statement_id = NEW.statement_id;                                                                                                                                                                                                                                                                                                                                                                 +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Obtener total adeudado a CrediCuenta (nuevo campo con nombre correcto)                                                                                                                                                                                                                                                                                                                              +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         aps.total_to_credicuenta + aps.late_fee_amount,                                                                                                                                                                                                                                                                                                                                                    +
         ap.id                                                                                                                                                                                                                                                                                                                                                                                              +
     INTO v_total_owed, v_associate_profile_id                                                                                                                                                                                                                                                                                                                                                              +
     FROM associate_payment_statements aps                                                                                                                                                                                                                                                                                                                                                                  +
     JOIN associate_profiles ap ON aps.user_id = ap.user_id                                                                                                                                                                                                                                                                                                                                                 +
     WHERE aps.id = NEW.statement_id;                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_total_owed IS NULL THEN                                                                                                                                                                                                                                                                                                                                                                           +
         RAISE EXCEPTION 'Statement % no encontrado', NEW.statement_id;                                                                                                                                                                                                                                                                                                                                     +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     v_remaining := v_total_owed - v_total_paid;                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Determinar nuevo estado                                                                                                                                                                                                                                                                                                                                                                             +
     IF v_remaining <= 0 THEN                                                                                                                                                                                                                                                                                                                                                                               +
         SELECT id INTO v_new_status_id FROM statement_statuses WHERE name = 'PAID';                                                                                                                                                                                                                                                                                                                        +
     ELSIF v_total_paid > 0 THEN                                                                                                                                                                                                                                                                                                                                                                            +
         SELECT id INTO v_new_status_id FROM statement_statuses WHERE name = 'PARTIAL_PAID';                                                                                                                                                                                                                                                                                                                +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Actualizar statement                                                                                                                                                                                                                                                                                                                                                                                +
     UPDATE associate_payment_statements                                                                                                                                                                                                                                                                                                                                                                    +
     SET paid_amount = v_total_paid,                                                                                                                                                                                                                                                                                                                                                                        +
         paid_date = CASE WHEN v_remaining <= 0 THEN CURRENT_DATE ELSE paid_date END,                                                                                                                                                                                                                                                                                                                       +
         status_id = COALESCE(v_new_status_id, status_id),                                                                                                                                                                                                                                                                                                                                                  +
         updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                                     +
     WHERE id = NEW.statement_id;                                                                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Liberar cr√©dito del asociado                                                                                                                                                                                                                                                                                                                                                                        +
     UPDATE associate_profiles                                                                                                                                                                                                                                                                                                                                                                              +
     SET debt_balance = GREATEST(debt_balance - NEW.payment_amount, 0),                                                                                                                                                                                                                                                                                                                                     +
         credit_last_updated = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                                            +
     WHERE id = v_associate_profile_id;                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE NOTICE 'üí∞ Statement #% | Pagado: $% | Debe: $% | Restante: $%',                                                                                                                                                                                                                                                                                                                                 +
         NEW.statement_id, v_total_paid, v_total_owed, v_remaining;                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.update_updated_at_column()                                                                                                                                                                                                                                                                                                                                               +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                           +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     NEW.updated_at = CURRENT_TIMESTAMP;                                                                                                                                                                                                                                                                                                                                                                    +
     RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.validate_loan_calculated_fields(p_loan_id integer)                                                                                                                                                                                                                                                                                                                       +
  RETURNS TABLE(campo text, valor_actual numeric, valor_esperado numeric, diferencia numeric, es_valido boolean)                                                                                                                                                                                                                                                                                            +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_loan RECORD;                                                                                                                                                                                                                                                                                                                                                                                         +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener datos del pr√©stamo                                                                                                                                                                                                                                                                                                                                                                          +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         amount, term_biweeks, biweekly_payment, total_payment,                                                                                                                                                                                                                                                                                                                                             +
         total_interest, commission_per_payment, associate_payment                                                                                                                                                                                                                                                                                                                                          +
     INTO v_loan                                                                                                                                                                                                                                                                                                                                                                                            +
     FROM loans                                                                                                                                                                                                                                                                                                                                                                                             +
     WHERE id = p_loan_id;                                                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Pr√©stamo % no encontrado', p_loan_id;                                                                                                                                                                                                                                                                                                                                             +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar total_payment = biweekly_payment * term_biweeks                                                                                                                                                                                                                                                                                                                                             +
     IF v_loan.total_payment IS NOT NULL AND v_loan.biweekly_payment IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                       +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             'total_payment'::TEXT,                                                                                                                                                                                                                                                                                                                                                                         +
             v_loan.total_payment,                                                                                                                                                                                                                                                                                                                                                                          +
             v_loan.biweekly_payment * v_loan.term_biweeks,                                                                                                                                                                                                                                                                                                                                                 +
             v_loan.total_payment - (v_loan.biweekly_payment * v_loan.term_biweeks),                                                                                                                                                                                                                                                                                                                        +
             ABS(v_loan.total_payment - (v_loan.biweekly_payment * v_loan.term_biweeks)) < 1.00;                                                                                                                                                                                                                                                                                                            +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar total_interest = total_payment - amount                                                                                                                                                                                                                                                                                                                                                     +
     IF v_loan.total_interest IS NOT NULL AND v_loan.total_payment IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                         +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             'total_interest'::TEXT,                                                                                                                                                                                                                                                                                                                                                                        +
             v_loan.total_interest,                                                                                                                                                                                                                                                                                                                                                                         +
             v_loan.total_payment - v_loan.amount,                                                                                                                                                                                                                                                                                                                                                          +
             v_loan.total_interest - (v_loan.total_payment - v_loan.amount),                                                                                                                                                                                                                                                                                                                                +
             ABS(v_loan.total_interest - (v_loan.total_payment - v_loan.amount)) < 1.00;                                                                                                                                                                                                                                                                                                                    +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar associate_payment = biweekly_payment - commission_per_payment                                                                                                                                                                                                                                                                                                                               +
     IF v_loan.associate_payment IS NOT NULL AND v_loan.biweekly_payment IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                   +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             'associate_payment'::TEXT,                                                                                                                                                                                                                                                                                                                                                                     +
             v_loan.associate_payment,                                                                                                                                                                                                                                                                                                                                                                      +
             v_loan.biweekly_payment - COALESCE(v_loan.commission_per_payment, 0),                                                                                                                                                                                                                                                                                                                          +
             v_loan.associate_payment - (v_loan.biweekly_payment - COALESCE(v_loan.commission_per_payment, 0)),                                                                                                                                                                                                                                                                                             +
             ABS(v_loan.associate_payment - (v_loan.biweekly_payment - COALESCE(v_loan.commission_per_payment, 0))) < 0.10;                                                                                                                                                                                                                                                                                 +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.validate_loan_payment_schedule(p_loan_id integer)                                                                                                                                                                                                                                                                                                                        +
  RETURNS TABLE(validacion text, valor numeric, esperado numeric, diferencia numeric, es_valido boolean, detalle text)                                                                                                                                                                                                                                                                                      +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_loan RECORD;                                                                                                                                                                                                                                                                                                                                                                                         +
     v_payment_count INTEGER;                                                                                                                                                                                                                                                                                                                                                                               +
     v_sum_expected DECIMAL;                                                                                                                                                                                                                                                                                                                                                                                +
     v_sum_interest DECIMAL;                                                                                                                                                                                                                                                                                                                                                                                +
     v_sum_principal DECIMAL;                                                                                                                                                                                                                                                                                                                                                                               +
     v_sum_commission DECIMAL;                                                                                                                                                                                                                                                                                                                                                                              +
     v_last_balance DECIMAL;                                                                                                                                                                                                                                                                                                                                                                                +
     v_numbers_ok BOOLEAN;                                                                                                                                                                                                                                                                                                                                                                                  +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener datos del pr√©stamo                                                                                                                                                                                                                                                                                                                                                                          +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         id, amount, term_biweeks, total_payment, total_interest,                                                                                                                                                                                                                                                                                                                                           +
         total_commission, biweekly_payment                                                                                                                                                                                                                                                                                                                                                                 +
     INTO v_loan                                                                                                                                                                                                                                                                                                                                                                                            +
     FROM loans                                                                                                                                                                                                                                                                                                                                                                                             +
     WHERE id = p_loan_id;                                                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Pr√©stamo % no encontrado', p_loan_id;                                                                                                                                                                                                                                                                                                                                             +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Contar pagos generados                                                                                                                                                                                                                                                                                                                                                                              +
     SELECT COUNT(*) INTO v_payment_count                                                                                                                                                                                                                                                                                                                                                                   +
     FROM payments                                                                                                                                                                                                                                                                                                                                                                                          +
     WHERE loan_id = p_loan_id;                                                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar: Cantidad de pagos = term_biweeks                                                                                                                                                                                                                                                                                                                                                           +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'Cantidad de pagos'::TEXT,                                                                                                                                                                                                                                                                                                                                                                         +
         v_payment_count::DECIMAL,                                                                                                                                                                                                                                                                                                                                                                          +
         v_loan.term_biweeks::DECIMAL,                                                                                                                                                                                                                                                                                                                                                                      +
         (v_payment_count - v_loan.term_biweeks)::DECIMAL,                                                                                                                                                                                                                                                                                                                                                  +
         v_payment_count = v_loan.term_biweeks,                                                                                                                                                                                                                                                                                                                                                             +
         format('Se esperaban %s pagos, se encontraron %s', v_loan.term_biweeks, v_payment_count);                                                                                                                                                                                                                                                                                                          +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar: payment_number son secuenciales (1, 2, 3, ..., N)                                                                                                                                                                                                                                                                                                                                          +
     SELECT COUNT(*) = v_payment_count INTO v_numbers_ok                                                                                                                                                                                                                                                                                                                                                    +
     FROM (                                                                                                                                                                                                                                                                                                                                                                                                 +
         SELECT payment_number                                                                                                                                                                                                                                                                                                                                                                              +
         FROM payments                                                                                                                                                                                                                                                                                                                                                                                      +
         WHERE loan_id = p_loan_id                                                                                                                                                                                                                                                                                                                                                                          +
         ORDER BY payment_number                                                                                                                                                                                                                                                                                                                                                                            +
     ) t                                                                                                                                                                                                                                                                                                                                                                                                    +
     WHERE payment_number BETWEEN 1 AND v_payment_count;                                                                                                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'N√∫meros secuenciales'::TEXT,                                                                                                                                                                                                                                                                                                                                                                      +
         CASE WHEN v_numbers_ok THEN 1::DECIMAL ELSE 0::DECIMAL END,                                                                                                                                                                                                                                                                                                                                        +
         1::DECIMAL,                                                                                                                                                                                                                                                                                                                                                                                        +
         CASE WHEN v_numbers_ok THEN 0::DECIMAL ELSE 1::DECIMAL END,                                                                                                                                                                                                                                                                                                                                        +
         v_numbers_ok,                                                                                                                                                                                                                                                                                                                                                                                      +
         CASE WHEN v_numbers_ok                                                                                                                                                                                                                                                                                                                                                                             +
             THEN 'Los n√∫meros de pago son secuenciales (1..N)'                                                                                                                                                                                                                                                                                                                                             +
             ELSE 'Los n√∫meros de pago NO son secuenciales'                                                                                                                                                                                                                                                                                                                                                 +
         END;                                                                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Calcular sumas                                                                                                                                                                                                                                                                                                                                                                                      +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         COALESCE(SUM(expected_amount), 0),                                                                                                                                                                                                                                                                                                                                                                 +
         COALESCE(SUM(interest_amount), 0),                                                                                                                                                                                                                                                                                                                                                                 +
         COALESCE(SUM(principal_amount), 0),                                                                                                                                                                                                                                                                                                                                                                +
         COALESCE(SUM(commission_amount), 0)                                                                                                                                                                                                                                                                                                                                                                +
     INTO v_sum_expected, v_sum_interest, v_sum_principal, v_sum_commission                                                                                                                                                                                                                                                                                                                                 +
     FROM payments                                                                                                                                                                                                                                                                                                                                                                                          +
     WHERE loan_id = p_loan_id;                                                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar: SUM(expected_amount) = loans.total_payment                                                                                                                                                                                                                                                                                                                                                 +
     IF v_loan.total_payment IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                               +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             'SUM(expected) = total_payment'::TEXT,                                                                                                                                                                                                                                                                                                                                                         +
             v_sum_expected,                                                                                                                                                                                                                                                                                                                                                                                +
             v_loan.total_payment,                                                                                                                                                                                                                                                                                                                                                                          +
             v_sum_expected - v_loan.total_payment,                                                                                                                                                                                                                                                                                                                                                         +
             ABS(v_sum_expected - v_loan.total_payment) < 1.00,                                                                                                                                                                                                                                                                                                                                             +
             format('Suma de pagos esperados: $%s, Total pr√©stamo: $%s', v_sum_expected, v_loan.total_payment);                                                                                                                                                                                                                                                                                             +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar: SUM(interest_amount) = loans.total_interest                                                                                                                                                                                                                                                                                                                                                +
     IF v_loan.total_interest IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                              +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             'SUM(interest) = total_interest'::TEXT,                                                                                                                                                                                                                                                                                                                                                        +
             v_sum_interest,                                                                                                                                                                                                                                                                                                                                                                                +
             v_loan.total_interest,                                                                                                                                                                                                                                                                                                                                                                         +
             v_sum_interest - v_loan.total_interest,                                                                                                                                                                                                                                                                                                                                                        +
             ABS(v_sum_interest - v_loan.total_interest) < 1.00,                                                                                                                                                                                                                                                                                                                                            +
             format('Suma de intereses: $%s, Total inter√©s pr√©stamo: $%s', v_sum_interest, v_loan.total_interest);                                                                                                                                                                                                                                                                                          +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar: SUM(principal_amount) = loans.amount                                                                                                                                                                                                                                                                                                                                                       +
     RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                    +
         'SUM(principal) = amount'::TEXT,                                                                                                                                                                                                                                                                                                                                                                   +
         v_sum_principal,                                                                                                                                                                                                                                                                                                                                                                                   +
         v_loan.amount,                                                                                                                                                                                                                                                                                                                                                                                     +
         v_sum_principal - v_loan.amount,                                                                                                                                                                                                                                                                                                                                                                   +
         ABS(v_sum_principal - v_loan.amount) < 1.00,                                                                                                                                                                                                                                                                                                                                                       +
         format('Suma de abonos a capital: $%s, Capital pr√©stamo: $%s', v_sum_principal, v_loan.amount);                                                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar: SUM(commission_amount) = loans.total_commission                                                                                                                                                                                                                                                                                                                                            +
     IF v_loan.total_commission IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                            +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             'SUM(commission) = total_commission'::TEXT,                                                                                                                                                                                                                                                                                                                                                    +
             v_sum_commission,                                                                                                                                                                                                                                                                                                                                                                              +
             v_loan.total_commission,                                                                                                                                                                                                                                                                                                                                                                       +
             v_sum_commission - v_loan.total_commission,                                                                                                                                                                                                                                                                                                                                                    +
             ABS(v_sum_commission - v_loan.total_commission) < 1.00,                                                                                                                                                                                                                                                                                                                                        +
             format('Suma de comisiones: $%s, Total comisi√≥n pr√©stamo: $%s', v_sum_commission, v_loan.total_commission);                                                                                                                                                                                                                                                                                    +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar: √öltimo pago tiene balance_remaining = 0                                                                                                                                                                                                                                                                                                                                                    +
     SELECT balance_remaining INTO v_last_balance                                                                                                                                                                                                                                                                                                                                                           +
     FROM payments                                                                                                                                                                                                                                                                                                                                                                                          +
     WHERE loan_id = p_loan_id                                                                                                                                                                                                                                                                                                                                                                              +
     ORDER BY payment_number DESC                                                                                                                                                                                                                                                                                                                                                                           +
     LIMIT 1;                                                                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF v_last_balance IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                                     +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             '√öltimo pago balance = 0'::TEXT,                                                                                                                                                                                                                                                                                                                                                               +
             v_last_balance,                                                                                                                                                                                                                                                                                                                                                                                +
             0::DECIMAL,                                                                                                                                                                                                                                                                                                                                                                                    +
             v_last_balance,                                                                                                                                                                                                                                                                                                                                                                                +
             ABS(v_last_balance) < 0.10,                                                                                                                                                                                                                                                                                                                                                                    +
             format('El saldo despu√©s del √∫ltimo pago es: $%s (debe ser $0.00)', v_last_balance);                                                                                                                                                                                                                                                                                                           +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 
 CREATE OR REPLACE FUNCTION public.validate_payment_breakdown(p_payment_id integer)                                                                                                                                                                                                                                                                                                                         +
  RETURNS TABLE(validacion text, valor_actual numeric, valor_esperado numeric, diferencia numeric, es_valido boolean)                                                                                                                                                                                                                                                                                       +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                          +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                              +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_payment RECORD;                                                                                                                                                                                                                                                                                                                                                                                      +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                      +
     -- Obtener datos del pago                                                                                                                                                                                                                                                                                                                                                                              +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                 +
         payment_number, expected_amount, interest_amount, principal_amount,                                                                                                                                                                                                                                                                                                                                +
         commission_amount, associate_payment, amount_paid, balance_remaining                                                                                                                                                                                                                                                                                                                               +
     INTO v_payment                                                                                                                                                                                                                                                                                                                                                                                         +
     FROM payments                                                                                                                                                                                                                                                                                                                                                                                          +
     WHERE id = p_payment_id;                                                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF NOT FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                      +
         RAISE EXCEPTION 'Pago % no encontrado', p_payment_id;                                                                                                                                                                                                                                                                                                                                              +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar expected_amount = interest_amount + principal_amount                                                                                                                                                                                                                                                                                                                                        +
     IF v_payment.expected_amount IS NOT NULL AND v_payment.interest_amount IS NOT NULL AND v_payment.principal_amount IS NOT NULL THEN                                                                                                                                                                                                                                                                     +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             'expected = interest + principal'::TEXT,                                                                                                                                                                                                                                                                                                                                                       +
             v_payment.expected_amount,                                                                                                                                                                                                                                                                                                                                                                     +
             v_payment.interest_amount + v_payment.principal_amount,                                                                                                                                                                                                                                                                                                                                        +
             v_payment.expected_amount - (v_payment.interest_amount + v_payment.principal_amount),                                                                                                                                                                                                                                                                                                          +
             ABS(v_payment.expected_amount - (v_payment.interest_amount + v_payment.principal_amount)) < 0.10;                                                                                                                                                                                                                                                                                              +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar associate_payment = expected_amount - commission_amount                                                                                                                                                                                                                                                                                                                                     +
     IF v_payment.associate_payment IS NOT NULL AND v_payment.expected_amount IS NOT NULL AND v_payment.commission_amount IS NOT NULL THEN                                                                                                                                                                                                                                                                  +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             'associate = expected - commission'::TEXT,                                                                                                                                                                                                                                                                                                                                                     +
             v_payment.associate_payment,                                                                                                                                                                                                                                                                                                                                                                   +
             v_payment.expected_amount - v_payment.commission_amount,                                                                                                                                                                                                                                                                                                                                       +
             v_payment.associate_payment - (v_payment.expected_amount - v_payment.commission_amount),                                                                                                                                                                                                                                                                                                       +
             ABS(v_payment.associate_payment - (v_payment.expected_amount - v_payment.commission_amount)) < 0.10;                                                                                                                                                                                                                                                                                           +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                            +
     -- Validar amount_paid <= expected_amount (permitir sobrepago de hasta 100)                                                                                                                                                                                                                                                                                                                            +
     IF v_payment.amount_paid IS NOT NULL AND v_payment.expected_amount IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                    +
         RETURN QUERY SELECT                                                                                                                                                                                                                                                                                                                                                                                +
             'paid <= expected'::TEXT,                                                                                                                                                                                                                                                                                                                                                                      +
             v_payment.amount_paid,                                                                                                                                                                                                                                                                                                                                                                         +
             v_payment.expected_amount,                                                                                                                                                                                                                                                                                                                                                                     +
             v_payment.amount_paid - v_payment.expected_amount,                                                                                                                                                                                                                                                                                                                                             +
             v_payment.amount_paid <= v_payment.expected_amount + 100.00;                                                                                                                                                                                                                                                                                                                                   +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                +
 END;                                                                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                 +
 ;                                                                                                                                                                                                                                                                                                                                                                                                          +
 


-- ============ DATOS DE CAT√ÅLOGOS ============

--
-- PostgreSQL database dump
--

\restrict 3uv63XtWOjwyhK8u9ekZlu7MbruoDONIbZk75ZGh3dVGKalx73dd3stG7mBN8b7

-- Dumped from database version 15.14
-- Dumped by pg_dump version 15.14

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

--
-- Data for Name: associate_levels; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.associate_levels VALUES (1, 'Bronce', 25000.00, 25000.00, NULL, 0, 0.00, '2025-10-31 01:12:22.074569+00', '2025-10-31 01:12:22.074569+00');
INSERT INTO public.associate_levels VALUES (2, 'Plata', 300000.00, 300000.00, NULL, 0, 0.00, '2025-10-31 01:12:22.074569+00', '2025-10-31 01:12:22.074569+00');
INSERT INTO public.associate_levels VALUES (3, 'Oro', 600000.00, 600000.00, NULL, 0, 0.00, '2025-10-31 01:12:22.074569+00', '2025-10-31 01:12:22.074569+00');
INSERT INTO public.associate_levels VALUES (4, 'Platino', 900000.00, 900000.00, NULL, 0, 0.00, '2025-10-31 01:12:22.074569+00', '2025-10-31 01:12:22.074569+00');
INSERT INTO public.associate_levels VALUES (5, 'Diamante', 5000000.00, 5000000.00, NULL, 0, 0.00, '2025-10-31 01:12:22.074569+00', '2025-10-31 01:12:22.074569+00');


--
-- Data for Name: config_types; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.config_types VALUES (1, 'STRING', 'Cadena de texto.', NULL, 'Hola Mundo', '2025-10-31 01:12:22.085589+00', '2025-10-31 01:12:22.085589+00');
INSERT INTO public.config_types VALUES (2, 'NUMBER', 'N√∫mero entero o decimal.', '^-?\d+(\.\d+)?$', '123.45', '2025-10-31 01:12:22.085589+00', '2025-10-31 01:12:22.085589+00');
INSERT INTO public.config_types VALUES (3, 'BOOLEAN', 'Valor booleano.', '^(true|false)$', 'true', '2025-10-31 01:12:22.085589+00', '2025-10-31 01:12:22.085589+00');
INSERT INTO public.config_types VALUES (4, 'JSON', 'Objeto JSON v√°lido.', NULL, '{"key": "value"}', '2025-10-31 01:12:22.085589+00', '2025-10-31 01:12:22.085589+00');
INSERT INTO public.config_types VALUES (5, 'URL', 'URL v√°lida.', '^https?://[^\s]+$', 'https://ejemplo.com', '2025-10-31 01:12:22.085589+00', '2025-10-31 01:12:22.085589+00');
INSERT INTO public.config_types VALUES (6, 'EMAIL', 'Correo electr√≥nico.', '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$', 'user@example.com', '2025-10-31 01:12:22.085589+00', '2025-10-31 01:12:22.085589+00');
INSERT INTO public.config_types VALUES (7, 'DATE', 'Fecha ISO 8601.', '^\d{4}-\d{2}-\d{2}$', '2025-10-30', '2025-10-31 01:12:22.085589+00', '2025-10-31 01:12:22.085589+00');
INSERT INTO public.config_types VALUES (8, 'PERCENTAGE', 'Porcentaje 0-100.', '^(100(\.0+)?|\d{1,2}(\.\d+)?)$', '15.5', '2025-10-31 01:12:22.085589+00', '2025-10-31 01:12:22.085589+00');


--
-- Data for Name: contract_statuses; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.contract_statuses VALUES (1, 'draft', 'Contrato en borrador.', true, false, 1, '2025-10-31 01:12:22.078957+00', '2025-10-31 01:12:22.078957+00');
INSERT INTO public.contract_statuses VALUES (2, 'pending', 'Pendiente de firma del cliente.', true, true, 2, '2025-10-31 01:12:22.078957+00', '2025-10-31 01:12:22.078957+00');
INSERT INTO public.contract_statuses VALUES (3, 'signed', 'Firmado por el cliente.', true, false, 3, '2025-10-31 01:12:22.078957+00', '2025-10-31 01:12:22.078957+00');
INSERT INTO public.contract_statuses VALUES (4, 'active', 'Contrato activo y vigente.', true, false, 4, '2025-10-31 01:12:22.078957+00', '2025-10-31 01:12:22.078957+00');
INSERT INTO public.contract_statuses VALUES (5, 'completed', 'Contrato completado, pr√©stamo liquidado.', true, false, 5, '2025-10-31 01:12:22.078957+00', '2025-10-31 01:12:22.078957+00');
INSERT INTO public.contract_statuses VALUES (6, 'cancelled', 'Contrato cancelado.', true, false, 6, '2025-10-31 01:12:22.078957+00', '2025-10-31 01:12:22.078957+00');


--
-- Data for Name: cut_period_statuses; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.cut_period_statuses VALUES (1, 'PENDING', 'Per√≠odo futuro con pagos pre-asignados de pr√©stamos aprobados.', false, false, 1, '2025-10-31 01:12:22.080292+00', '2025-12-04 08:29:41.841541+00');
INSERT INTO public.cut_period_statuses VALUES (2, 'ACTIVE', 'DEPRECADO - No usar. Per√≠odo actual del calendario.', false, false, 99, '2025-10-31 01:12:22.080292+00', '2025-12-04 08:29:41.841541+00');
INSERT INTO public.cut_period_statuses VALUES (3, 'CUTOFF', 'BORRADOR - Corte autom√°tico ejecutado. Statements en borrador para revisi√≥n del admin.', false, false, 2, '2025-10-31 01:12:22.080292+00', '2025-12-04 08:29:41.841541+00');
INSERT INTO public.cut_period_statuses VALUES (4, 'COLLECTING', 'EN COBRO - Cierre manual ejecutado. Statements finalizados, fase de cobro a asociados.', false, false, 3, '2025-10-31 01:12:22.080292+00', '2025-12-04 08:29:41.841541+00');
INSERT INTO public.cut_period_statuses VALUES (5, 'CLOSED', 'Per√≠odo cerrado y archivado definitivamente. Solo lectura.', true, false, 5, '2025-10-31 01:12:22.080292+00', '2025-12-04 08:29:41.841541+00');
INSERT INTO public.cut_period_statuses VALUES (6, 'SETTLING', 'LIQUIDACI√ìN - Per√≠odo terminado, revisi√≥n de deuda pendiente antes del cierre definitivo.', false, false, 4, '2025-12-04 08:29:41.841541+00', '2025-12-04 08:29:41.841541+00');


--
-- Data for Name: document_statuses; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.document_statuses VALUES (1, 'PENDING', 'Documento cargado, pendiente de revisi√≥n.', 1, '#FFA500', '2025-10-31 01:12:22.083043+00', '2025-10-31 01:12:22.083043+00');
INSERT INTO public.document_statuses VALUES (2, 'UNDER_REVIEW', 'En proceso de revisi√≥n.', 2, '#2196F3', '2025-10-31 01:12:22.083043+00', '2025-10-31 01:12:22.083043+00');
INSERT INTO public.document_statuses VALUES (3, 'APPROVED', 'Documento aprobado.', 3, '#4CAF50', '2025-10-31 01:12:22.083043+00', '2025-10-31 01:12:22.083043+00');
INSERT INTO public.document_statuses VALUES (4, 'REJECTED', 'Documento rechazado.', 4, '#F44336', '2025-10-31 01:12:22.083043+00', '2025-10-31 01:12:22.083043+00');


--
-- Data for Name: document_types; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.document_types VALUES (1, 'Identificaci√≥n Oficial', 'INE, Pasaporte o C√©dula Profesional', true, '2025-10-31 01:12:22.088252+00', '2025-10-31 01:12:22.088252+00');
INSERT INTO public.document_types VALUES (2, 'Comprobante de Domicilio', 'Recibo de luz, agua o predial', true, '2025-10-31 01:12:22.088252+00', '2025-10-31 01:12:22.088252+00');
INSERT INTO public.document_types VALUES (3, 'Comprobante de Ingresos', 'Estado de cuenta o constancia laboral', true, '2025-10-31 01:12:22.088252+00', '2025-10-31 01:12:22.088252+00');
INSERT INTO public.document_types VALUES (4, 'CURP', 'Clave √önica de Registro de Poblaci√≥n', false, '2025-10-31 01:12:22.088252+00', '2025-10-31 01:12:22.088252+00');
INSERT INTO public.document_types VALUES (5, 'Referencia Personal', 'Datos de contacto de referencia', false, '2025-10-31 01:12:22.088252+00', '2025-10-31 01:12:22.088252+00');


--
-- Data for Name: level_change_types; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.level_change_types VALUES (1, 'PROMOTION', 'Promoci√≥n autom√°tica a nivel superior.', true, 1, '2025-10-31 01:12:22.086922+00', '2025-10-31 01:12:22.086922+00');
INSERT INTO public.level_change_types VALUES (2, 'DEMOTION', 'Descenso por incumplimiento.', true, 2, '2025-10-31 01:12:22.086922+00', '2025-10-31 01:12:22.086922+00');
INSERT INTO public.level_change_types VALUES (3, 'MANUAL', 'Cambio manual por admin.', false, 3, '2025-10-31 01:12:22.086922+00', '2025-10-31 01:12:22.086922+00');
INSERT INTO public.level_change_types VALUES (4, 'INITIAL', 'Nivel inicial al registrarse.', false, 4, '2025-10-31 01:12:22.086922+00', '2025-10-31 01:12:22.086922+00');
INSERT INTO public.level_change_types VALUES (5, 'REWARD', 'Promoci√≥n especial por logro.', false, 5, '2025-10-31 01:12:22.086922+00', '2025-10-31 01:12:22.086922+00');
INSERT INTO public.level_change_types VALUES (6, 'PENALTY', 'Descenso por sanci√≥n.', false, 6, '2025-10-31 01:12:22.086922+00', '2025-10-31 01:12:22.086922+00');


--
-- Data for Name: loan_statuses; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.loan_statuses VALUES (1, 'PENDING', 'Pr√©stamo solicitado pero a√∫n no aprobado ni desembolsado.', true, 1, '#FFA500', 'clock', '2025-10-31 01:12:22.075733+00', '2025-10-31 01:12:22.075733+00');
INSERT INTO public.loan_statuses VALUES (2, 'APPROVED', 'Pr√©stamo aprobado, listo para desembolso y generaci√≥n de cronograma.', true, 2, '#4CAF50', 'check-circle', '2025-10-31 01:12:22.075733+00', '2025-10-31 01:12:22.075733+00');
INSERT INTO public.loan_statuses VALUES (3, 'ACTIVE', 'Pr√©stamo desembolsado y activo, con pagos en curso.', true, 3, '#2196F3', 'activity', '2025-10-31 01:12:22.075733+00', '2025-10-31 01:12:22.075733+00');
INSERT INTO public.loan_statuses VALUES (4, 'COMPLETED', 'Pr√©stamo completamente liquidado.', true, 4, '#00C853', 'check-all', '2025-10-31 01:12:22.075733+00', '2025-10-31 01:12:22.075733+00');
INSERT INTO public.loan_statuses VALUES (5, 'PAID', 'Pr√©stamo totalmente pagado (sin√≥nimo de COMPLETED).', true, 5, '#00C853', 'check-all', '2025-10-31 01:12:22.075733+00', '2025-10-31 01:12:22.075733+00');
INSERT INTO public.loan_statuses VALUES (6, 'DEFAULTED', 'Pr√©stamo en mora o incumplimiento.', true, 6, '#F44336', 'alert-triangle', '2025-10-31 01:12:22.075733+00', '2025-10-31 01:12:22.075733+00');
INSERT INTO public.loan_statuses VALUES (7, 'REJECTED', 'Solicitud rechazada por administrador.', true, 7, '#9E9E9E', 'x-circle', '2025-10-31 01:12:22.075733+00', '2025-10-31 01:12:22.075733+00');
INSERT INTO public.loan_statuses VALUES (8, 'CANCELLED', 'Pr√©stamo cancelado antes de completarse.', true, 8, '#757575', 'slash', '2025-10-31 01:12:22.075733+00', '2025-10-31 01:12:22.075733+00');


--
-- Data for Name: payment_methods; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.payment_methods VALUES (1, 'CASH', 'Pago en efectivo.', true, false, 1, 'dollar-sign', '2025-10-31 01:12:22.081669+00', '2025-10-31 01:12:22.081669+00');
INSERT INTO public.payment_methods VALUES (2, 'TRANSFER', 'Transferencia bancaria.', true, true, 2, 'arrow-right-circle', '2025-10-31 01:12:22.081669+00', '2025-10-31 01:12:22.081669+00');
INSERT INTO public.payment_methods VALUES (3, 'CHECK', 'Cheque bancario.', true, true, 3, 'file-text', '2025-10-31 01:12:22.081669+00', '2025-10-31 01:12:22.081669+00');
INSERT INTO public.payment_methods VALUES (4, 'PAYROLL_DEDUCTION', 'Descuento de n√≥mina.', true, false, 4, 'briefcase', '2025-10-31 01:12:22.081669+00', '2025-10-31 01:12:22.081669+00');
INSERT INTO public.payment_methods VALUES (5, 'CARD', 'Tarjeta d√©bito/cr√©dito.', true, true, 5, 'credit-card', '2025-10-31 01:12:22.081669+00', '2025-10-31 01:12:22.081669+00');
INSERT INTO public.payment_methods VALUES (6, 'DEPOSIT', 'Dep√≥sito bancario.', true, true, 6, 'inbox', '2025-10-31 01:12:22.081669+00', '2025-10-31 01:12:22.081669+00');
INSERT INTO public.payment_methods VALUES (7, 'OXXO', 'Pago en OXXO.', true, true, 7, 'shopping-bag', '2025-10-31 01:12:22.081669+00', '2025-10-31 01:12:22.081669+00');


--
-- Data for Name: payment_statuses; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.payment_statuses VALUES (1, 'PENDING', 'Pago programado, a√∫n no vence.', true, 1, '#9E9E9E', 'clock', true, '2025-10-31 01:12:22.077324+00', '2025-10-31 01:12:22.077324+00');
INSERT INTO public.payment_statuses VALUES (2, 'DUE_TODAY', 'Pago vence hoy.', true, 2, '#FF9800', 'calendar', true, '2025-10-31 01:12:22.077324+00', '2025-10-31 01:12:22.077324+00');
INSERT INTO public.payment_statuses VALUES (4, 'OVERDUE', 'Pago vencido, no pagado.', true, 4, '#F44336', 'alert-circle', true, '2025-10-31 01:12:22.077324+00', '2025-10-31 01:12:22.077324+00');
INSERT INTO public.payment_statuses VALUES (5, 'PARTIAL', 'Pago parcial realizado.', true, 5, '#2196F3', 'pie-chart', true, '2025-10-31 01:12:22.077324+00', '2025-10-31 01:12:22.077324+00');
INSERT INTO public.payment_statuses VALUES (6, 'IN_COLLECTION', 'En proceso de cobranza.', true, 6, '#9C27B0', 'phone', true, '2025-10-31 01:12:22.077324+00', '2025-10-31 01:12:22.077324+00');
INSERT INTO public.payment_statuses VALUES (7, 'RESCHEDULED', 'Pago reprogramado.', true, 7, '#03A9F4', 'refresh-cw', true, '2025-10-31 01:12:22.077324+00', '2025-10-31 01:12:22.077324+00');
INSERT INTO public.payment_statuses VALUES (3, 'PAID', 'Pago completado por cliente.', true, 3, '#4CAF50', 'check', true, '2025-10-31 01:12:22.077324+00', '2025-10-31 01:12:22.077324+00');
INSERT INTO public.payment_statuses VALUES (8, 'PAID_PARTIAL', 'Pago parcial aceptado.', true, 8, '#8BC34A', 'check-circle', true, '2025-10-31 01:12:22.077324+00', '2025-10-31 01:12:22.077324+00');
INSERT INTO public.payment_statuses VALUES (9, 'PAID_BY_ASSOCIATE', 'Pagado por asociado (cliente moroso).', true, 9, '#FF5722', 'user-x', false, '2025-10-31 01:12:22.077324+00', '2025-10-31 01:12:22.077324+00');
INSERT INTO public.payment_statuses VALUES (10, 'PAID_NOT_REPORTED', 'Pago no reportado al cierre.', true, 10, '#FFC107', 'alert-triangle', false, '2025-10-31 01:12:22.077324+00', '2025-10-31 01:12:22.077324+00');
INSERT INTO public.payment_statuses VALUES (11, 'FORGIVEN', 'Pago perdonado por administraci√≥n.', true, 11, '#00BCD4', 'heart', false, '2025-10-31 01:12:22.077324+00', '2025-10-31 01:12:22.077324+00');
INSERT INTO public.payment_statuses VALUES (12, 'CANCELLED', 'Pago cancelado.', true, 12, '#607D8B', 'x', false, '2025-10-31 01:12:22.077324+00', '2025-10-31 01:12:22.077324+00');


--
-- Data for Name: rate_profile_reference_table; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.rate_profile_reference_table VALUES (1, 'transition', 3000.00, 6, 612.50, 3675.00, 73.50, 441.00, 539.00, 3234.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (2, 'transition', 4000.00, 6, 816.67, 4900.00, 98.00, 588.00, 718.67, 4312.02, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (3, 'transition', 5000.00, 6, 1020.83, 6125.00, 122.50, 735.00, 898.33, 5389.98, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (4, 'transition', 6000.00, 6, 1225.00, 7350.00, 147.00, 882.00, 1078.00, 6468.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (5, 'transition', 7000.00, 6, 1429.17, 8575.00, 171.50, 1029.00, 1257.67, 7546.02, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (6, 'transition', 8000.00, 6, 1633.33, 9800.00, 196.00, 1176.00, 1437.33, 8623.98, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (7, 'transition', 9000.00, 6, 1837.50, 11025.00, 220.50, 1323.00, 1617.00, 9702.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (8, 'transition', 10000.00, 6, 2041.67, 12250.00, 245.00, 1470.00, 1796.67, 10780.02, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (9, 'transition', 12000.00, 6, 2450.00, 14700.00, 294.00, 1764.00, 2156.00, 12936.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (10, 'transition', 15000.00, 6, 3062.50, 18375.00, 367.50, 2205.00, 2695.00, 16170.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (11, 'transition', 18000.00, 6, 3675.00, 22050.00, 441.00, 2646.00, 3234.00, 19404.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (12, 'transition', 20000.00, 6, 4083.33, 24500.00, 490.00, 2940.00, 3593.33, 21559.98, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (13, 'transition', 25000.00, 6, 5104.17, 30625.00, 612.50, 3675.00, 4491.67, 26950.02, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (14, 'transition', 30000.00, 6, 6125.00, 36750.00, 735.00, 4410.00, 5390.00, 32340.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (15, 'transition', 3000.00, 12, 362.50, 4350.00, 43.50, 522.00, 319.00, 3828.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (16, 'transition', 4000.00, 12, 483.33, 5800.00, 58.00, 696.00, 425.33, 5103.96, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (17, 'transition', 5000.00, 12, 604.17, 7250.00, 72.50, 870.00, 531.67, 6380.04, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (18, 'transition', 6000.00, 12, 725.00, 8700.00, 87.00, 1044.00, 638.00, 7656.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (19, 'transition', 7000.00, 12, 845.83, 10150.00, 101.50, 1218.00, 744.33, 8931.96, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (20, 'transition', 8000.00, 12, 966.67, 11600.00, 116.00, 1392.00, 850.67, 10208.04, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (21, 'transition', 9000.00, 12, 1087.50, 13050.00, 130.50, 1566.00, 957.00, 11484.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (22, 'transition', 10000.00, 12, 1208.33, 14500.00, 145.00, 1740.00, 1063.33, 12759.96, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (23, 'transition', 12000.00, 12, 1450.00, 17400.00, 174.00, 2088.00, 1276.00, 15312.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (24, 'transition', 15000.00, 12, 1812.50, 21750.00, 217.50, 2610.00, 1595.00, 19140.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (25, 'transition', 18000.00, 12, 2175.00, 26100.00, 261.00, 3132.00, 1914.00, 22968.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (26, 'transition', 20000.00, 12, 2416.67, 29000.00, 290.00, 3480.00, 2126.67, 25520.04, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (27, 'transition', 25000.00, 12, 3020.83, 36250.00, 362.50, 4350.00, 2658.33, 31899.96, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (28, 'transition', 30000.00, 12, 3625.00, 43500.00, 435.00, 5220.00, 3190.00, 38280.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (29, 'transition', 3000.00, 18, 279.17, 5025.00, 33.50, 603.00, 245.67, 4422.06, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (30, 'transition', 4000.00, 18, 372.22, 6700.00, 44.67, 804.06, 327.55, 5895.90, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (31, 'transition', 5000.00, 18, 465.28, 8375.00, 55.83, 1004.94, 409.45, 7370.10, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (32, 'transition', 6000.00, 18, 558.33, 10050.00, 67.00, 1206.00, 491.33, 8843.94, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (33, 'transition', 7000.00, 18, 651.39, 11725.00, 78.17, 1407.06, 573.22, 10317.96, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (34, 'transition', 8000.00, 18, 744.44, 13400.00, 89.33, 1607.94, 655.11, 11791.98, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (35, 'transition', 9000.00, 18, 837.50, 15075.00, 100.50, 1809.00, 737.00, 13266.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (36, 'transition', 10000.00, 18, 930.56, 16750.00, 111.67, 2010.06, 818.89, 14740.02, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (37, 'transition', 12000.00, 18, 1116.67, 20100.00, 134.00, 2412.00, 982.67, 17688.06, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (38, 'transition', 15000.00, 18, 1395.83, 25125.00, 167.50, 3015.00, 1228.33, 22109.94, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (39, 'transition', 18000.00, 18, 1675.00, 30150.00, 201.00, 3618.00, 1474.00, 26532.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (40, 'transition', 20000.00, 18, 1861.11, 33500.00, 223.33, 4019.94, 1637.78, 29480.04, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (41, 'transition', 25000.00, 18, 2326.39, 41875.00, 279.17, 5025.06, 2047.22, 36849.96, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (42, 'transition', 30000.00, 18, 2791.67, 50250.00, 335.00, 6030.00, 2456.67, 44220.06, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (43, 'transition', 3000.00, 24, 237.50, 5700.00, 28.50, 684.00, 209.00, 5016.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (44, 'transition', 4000.00, 24, 316.67, 7600.00, 38.00, 912.00, 278.67, 6688.08, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (45, 'transition', 5000.00, 24, 395.83, 9500.00, 47.50, 1140.00, 348.33, 8359.92, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (46, 'transition', 6000.00, 24, 475.00, 11400.00, 57.00, 1368.00, 418.00, 10032.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (47, 'transition', 7000.00, 24, 554.17, 13300.00, 66.50, 1596.00, 487.67, 11704.08, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (48, 'transition', 8000.00, 24, 633.33, 15200.00, 76.00, 1824.00, 557.33, 13375.92, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (49, 'transition', 9000.00, 24, 712.50, 17100.00, 85.50, 2052.00, 627.00, 15048.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (50, 'transition', 10000.00, 24, 791.67, 19000.00, 95.00, 2280.00, 696.67, 16720.08, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (51, 'transition', 12000.00, 24, 950.00, 22800.00, 114.00, 2736.00, 836.00, 20064.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (52, 'transition', 15000.00, 24, 1187.50, 28500.00, 142.50, 3420.00, 1045.00, 25080.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (53, 'transition', 18000.00, 24, 1425.00, 34200.00, 171.00, 4104.00, 1254.00, 30096.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (54, 'transition', 20000.00, 24, 1583.33, 38000.00, 190.00, 4560.00, 1393.33, 33439.92, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (55, 'transition', 25000.00, 24, 1979.17, 47500.00, 237.50, 5700.00, 1741.67, 41800.08, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (56, 'transition', 30000.00, 24, 2375.00, 57000.00, 285.00, 6840.00, 2090.00, 50160.00, 3.750, 12.000, '2025-11-14 06:28:37.101355+00');
INSERT INTO public.rate_profile_reference_table VALUES (57, 'standard', 3000.00, 3, 1127.50, 3382.50, 135.30, 405.90, 992.20, 2976.60, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (58, 'standard', 4000.00, 3, 1503.33, 4510.00, 180.40, 541.20, 1322.93, 3968.79, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (59, 'standard', 5000.00, 3, 1879.17, 5637.50, 225.50, 676.50, 1653.67, 4961.01, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (60, 'standard', 6000.00, 3, 2255.00, 6765.00, 270.60, 811.80, 1984.40, 5953.20, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (61, 'standard', 7000.00, 3, 2630.83, 7892.50, 315.70, 947.10, 2315.13, 6945.39, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (62, 'standard', 8000.00, 3, 3006.67, 9020.00, 360.80, 1082.40, 2645.87, 7937.61, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (63, 'standard', 9000.00, 3, 3382.50, 10147.50, 405.90, 1217.70, 2976.60, 8929.80, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (64, 'standard', 10000.00, 3, 3758.33, 11275.00, 451.00, 1353.00, 3307.33, 9921.99, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (65, 'standard', 12000.00, 3, 4510.00, 13530.00, 541.20, 1623.60, 3968.80, 11906.40, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (66, 'standard', 15000.00, 3, 5637.50, 16912.50, 676.50, 2029.50, 4961.00, 14883.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (67, 'standard', 18000.00, 3, 6765.00, 20295.00, 811.80, 2435.40, 5953.20, 17859.60, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (68, 'standard', 20000.00, 3, 7516.67, 22550.00, 902.00, 2706.00, 6614.67, 19844.01, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (69, 'standard', 25000.00, 3, 9395.83, 28187.50, 1127.50, 3382.50, 8268.33, 24804.99, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (70, 'standard', 30000.00, 3, 11275.00, 33825.00, 1353.00, 4059.00, 9922.00, 29766.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (71, 'standard', 3000.00, 6, 627.50, 3765.00, 75.30, 451.80, 552.20, 3313.20, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (72, 'standard', 4000.00, 6, 836.67, 5020.00, 100.40, 602.40, 736.27, 4417.62, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (73, 'standard', 5000.00, 6, 1045.83, 6275.00, 125.50, 753.00, 920.33, 5521.98, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (74, 'standard', 6000.00, 6, 1255.00, 7530.00, 150.60, 903.60, 1104.40, 6626.40, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (75, 'standard', 7000.00, 6, 1464.17, 8785.00, 175.70, 1054.20, 1288.47, 7730.82, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (76, 'standard', 8000.00, 6, 1673.33, 10040.00, 200.80, 1204.80, 1472.53, 8835.18, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (77, 'standard', 9000.00, 6, 1882.50, 11295.00, 225.90, 1355.40, 1656.60, 9939.60, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (78, 'standard', 10000.00, 6, 2091.67, 12550.00, 251.00, 1506.00, 1840.67, 11044.02, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (79, 'standard', 12000.00, 6, 2510.00, 15060.00, 301.20, 1807.20, 2208.80, 13252.80, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (80, 'standard', 15000.00, 6, 3137.50, 18825.00, 376.50, 2259.00, 2761.00, 16566.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (81, 'standard', 18000.00, 6, 3765.00, 22590.00, 451.80, 2710.80, 3313.20, 19879.20, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (82, 'standard', 20000.00, 6, 4183.33, 25100.00, 502.00, 3012.00, 3681.33, 22087.98, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (83, 'standard', 25000.00, 6, 5229.17, 31375.00, 627.50, 3765.00, 4601.67, 27610.02, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (84, 'standard', 30000.00, 6, 6275.00, 37650.00, 753.00, 4518.00, 5522.00, 33132.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (85, 'standard', 3000.00, 9, 460.83, 4147.50, 55.30, 497.70, 405.53, 3649.77, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (86, 'standard', 4000.00, 9, 614.44, 5530.00, 73.73, 663.57, 540.71, 4866.39, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (87, 'standard', 5000.00, 9, 768.06, 6912.50, 92.17, 829.53, 675.89, 6083.01, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (88, 'standard', 6000.00, 9, 921.67, 8295.00, 110.60, 995.40, 811.07, 7299.63, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (89, 'standard', 7000.00, 9, 1075.28, 9677.50, 129.03, 1161.27, 946.25, 8516.25, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (90, 'standard', 8000.00, 9, 1228.89, 11060.00, 147.47, 1327.23, 1081.42, 9732.78, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (91, 'standard', 9000.00, 9, 1382.50, 12442.50, 165.90, 1493.10, 1216.60, 10949.40, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (92, 'standard', 10000.00, 9, 1536.11, 13825.00, 184.33, 1658.97, 1351.78, 12166.02, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (93, 'standard', 12000.00, 9, 1843.33, 16590.00, 221.20, 1990.80, 1622.13, 14599.17, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (94, 'standard', 15000.00, 9, 2304.17, 20737.50, 276.50, 2488.50, 2027.67, 18249.03, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (95, 'standard', 18000.00, 9, 2765.00, 24885.00, 331.80, 2986.20, 2433.20, 21898.80, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (96, 'standard', 20000.00, 9, 3072.22, 27650.00, 368.67, 3318.03, 2703.55, 24331.95, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (97, 'standard', 25000.00, 9, 3840.28, 34562.50, 460.83, 4147.47, 3379.45, 30415.05, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (98, 'standard', 30000.00, 9, 4608.33, 41475.00, 553.00, 4977.00, 4055.33, 36497.97, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (99, 'standard', 3000.00, 12, 377.50, 4530.00, 45.30, 543.60, 332.20, 3986.40, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (100, 'standard', 4000.00, 12, 503.33, 6040.00, 60.40, 724.80, 442.93, 5315.16, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (101, 'standard', 5000.00, 12, 629.17, 7550.00, 75.50, 906.00, 553.67, 6644.04, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (102, 'standard', 6000.00, 12, 755.00, 9060.00, 90.60, 1087.20, 664.40, 7972.80, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (103, 'standard', 7000.00, 12, 880.83, 10570.00, 105.70, 1268.40, 775.13, 9301.56, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (104, 'standard', 8000.00, 12, 1006.67, 12080.00, 120.80, 1449.60, 885.87, 10630.44, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (105, 'standard', 9000.00, 12, 1132.50, 13590.00, 135.90, 1630.80, 996.60, 11959.20, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (106, 'standard', 10000.00, 12, 1258.33, 15100.00, 151.00, 1812.00, 1107.33, 13287.96, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (107, 'standard', 12000.00, 12, 1510.00, 18120.00, 181.20, 2174.40, 1328.80, 15945.60, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (108, 'standard', 15000.00, 12, 1887.50, 22650.00, 226.50, 2718.00, 1661.00, 19932.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (109, 'standard', 18000.00, 12, 2265.00, 27180.00, 271.80, 3261.60, 1993.20, 23918.40, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (110, 'standard', 20000.00, 12, 2516.67, 30200.00, 302.00, 3624.00, 2214.67, 26576.04, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (111, 'standard', 25000.00, 12, 3145.83, 37750.00, 377.50, 4530.00, 2768.33, 33219.96, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (112, 'standard', 30000.00, 12, 3775.00, 45300.00, 453.00, 5436.00, 3322.00, 39864.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (113, 'standard', 3000.00, 15, 327.50, 4912.50, 39.30, 589.50, 288.20, 4323.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (114, 'standard', 4000.00, 15, 436.67, 6550.00, 52.40, 786.00, 384.27, 5764.05, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (115, 'standard', 5000.00, 15, 545.83, 8187.50, 65.50, 982.50, 480.33, 7204.95, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (116, 'standard', 6000.00, 15, 655.00, 9825.00, 78.60, 1179.00, 576.40, 8646.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (117, 'standard', 7000.00, 15, 764.17, 11462.50, 91.70, 1375.50, 672.47, 10087.05, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (118, 'standard', 8000.00, 15, 873.33, 13100.00, 104.80, 1572.00, 768.53, 11527.95, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (119, 'standard', 9000.00, 15, 982.50, 14737.50, 117.90, 1768.50, 864.60, 12969.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (120, 'standard', 10000.00, 15, 1091.67, 16375.00, 131.00, 1965.00, 960.67, 14410.05, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (121, 'standard', 12000.00, 15, 1310.00, 19650.00, 157.20, 2358.00, 1152.80, 17292.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (122, 'standard', 15000.00, 15, 1637.50, 24562.50, 196.50, 2947.50, 1441.00, 21615.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (123, 'standard', 18000.00, 15, 1965.00, 29475.00, 235.80, 3537.00, 1729.20, 25938.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (124, 'standard', 20000.00, 15, 2183.33, 32750.00, 262.00, 3930.00, 1921.33, 28819.95, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (125, 'standard', 25000.00, 15, 2729.17, 40937.50, 327.50, 4912.50, 2401.67, 36025.05, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (126, 'standard', 30000.00, 15, 3275.00, 49125.00, 393.00, 5895.00, 2882.00, 43230.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (127, 'standard', 3000.00, 18, 294.17, 5295.00, 35.30, 635.40, 258.87, 4659.66, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (128, 'standard', 4000.00, 18, 392.22, 7060.00, 47.07, 847.26, 345.15, 6212.70, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (129, 'standard', 5000.00, 18, 490.28, 8825.00, 58.83, 1058.94, 431.45, 7766.10, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (130, 'standard', 6000.00, 18, 588.33, 10590.00, 70.60, 1270.80, 517.73, 9319.14, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (131, 'standard', 7000.00, 18, 686.39, 12355.00, 82.37, 1482.66, 604.02, 10872.36, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (132, 'standard', 8000.00, 18, 784.44, 14120.00, 94.13, 1694.34, 690.31, 12425.58, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (133, 'standard', 9000.00, 18, 882.50, 15885.00, 105.90, 1906.20, 776.60, 13978.80, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (134, 'standard', 10000.00, 18, 980.56, 17650.00, 117.67, 2118.06, 862.89, 15532.02, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (135, 'standard', 12000.00, 18, 1176.67, 21180.00, 141.20, 2541.60, 1035.47, 18638.46, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (136, 'standard', 15000.00, 18, 1470.83, 26475.00, 176.50, 3177.00, 1294.33, 23297.94, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (137, 'standard', 18000.00, 18, 1765.00, 31770.00, 211.80, 3812.40, 1553.20, 27957.60, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (138, 'standard', 20000.00, 18, 1961.11, 35300.00, 235.33, 4235.94, 1725.78, 31064.04, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (139, 'standard', 25000.00, 18, 2451.39, 44125.00, 294.17, 5295.06, 2157.22, 38829.96, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (140, 'standard', 30000.00, 18, 2941.67, 52950.00, 353.00, 6354.00, 2588.67, 46596.06, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (141, 'standard', 3000.00, 21, 270.36, 5677.50, 32.44, 681.24, 237.92, 4996.32, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (142, 'standard', 4000.00, 21, 360.48, 7570.00, 43.26, 908.46, 317.22, 6661.62, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (143, 'standard', 5000.00, 21, 450.60, 9462.50, 54.07, 1135.47, 396.53, 8327.13, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (144, 'standard', 6000.00, 21, 540.71, 11355.00, 64.89, 1362.69, 475.82, 9992.22, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (145, 'standard', 7000.00, 21, 630.83, 13247.50, 75.70, 1589.70, 555.13, 11657.73, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (146, 'standard', 8000.00, 21, 720.95, 15140.00, 86.51, 1816.71, 634.44, 13323.24, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (147, 'standard', 9000.00, 21, 811.07, 17032.50, 97.33, 2043.93, 713.74, 14988.54, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (148, 'standard', 10000.00, 21, 901.19, 18925.00, 108.14, 2270.94, 793.05, 16654.05, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (149, 'standard', 12000.00, 21, 1081.43, 22710.00, 129.77, 2725.17, 951.66, 19984.86, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (150, 'standard', 15000.00, 21, 1351.79, 28387.50, 162.21, 3406.41, 1189.58, 24981.18, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (151, 'standard', 18000.00, 21, 1622.14, 34065.00, 194.66, 4087.86, 1427.48, 29977.08, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (152, 'standard', 20000.00, 21, 1802.38, 37850.00, 216.29, 4542.09, 1586.09, 33307.89, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (153, 'standard', 25000.00, 21, 2252.98, 47312.50, 270.36, 5677.56, 1982.62, 41635.02, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (154, 'standard', 30000.00, 21, 2703.57, 56775.00, 324.43, 6813.03, 2379.14, 49961.94, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (155, 'standard', 3000.00, 24, 252.50, 6060.00, 30.30, 727.20, 222.20, 5332.80, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (156, 'standard', 4000.00, 24, 336.67, 8080.00, 40.40, 969.60, 296.27, 7110.48, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (157, 'standard', 5000.00, 24, 420.83, 10100.00, 50.50, 1212.00, 370.33, 8887.92, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (158, 'standard', 6000.00, 24, 505.00, 12120.00, 60.60, 1454.40, 444.40, 10665.60, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (159, 'standard', 7000.00, 24, 589.17, 14140.00, 70.70, 1696.80, 518.47, 12443.28, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (160, 'standard', 8000.00, 24, 673.33, 16160.00, 80.80, 1939.20, 592.53, 14220.72, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (161, 'standard', 9000.00, 24, 757.50, 18180.00, 90.90, 2181.60, 666.60, 15998.40, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (162, 'standard', 10000.00, 24, 841.67, 20200.00, 101.00, 2424.00, 740.67, 17776.08, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (163, 'standard', 12000.00, 24, 1010.00, 24240.00, 121.20, 2908.80, 888.80, 21331.20, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (164, 'standard', 15000.00, 24, 1262.50, 30300.00, 151.50, 3636.00, 1111.00, 26664.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (165, 'standard', 18000.00, 24, 1515.00, 36360.00, 181.80, 4363.20, 1333.20, 31996.80, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (166, 'standard', 20000.00, 24, 1683.33, 40400.00, 202.00, 4848.00, 1481.33, 35551.92, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (167, 'standard', 25000.00, 24, 2104.17, 50500.00, 252.50, 6060.00, 1851.67, 44440.08, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (168, 'standard', 30000.00, 24, 2525.00, 60600.00, 303.00, 7272.00, 2222.00, 53328.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (169, 'standard', 3000.00, 30, 227.50, 6825.00, 27.30, 819.00, 200.20, 6006.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (170, 'standard', 4000.00, 30, 303.33, 9100.00, 36.40, 1092.00, 266.93, 8007.90, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (171, 'standard', 5000.00, 30, 379.17, 11375.00, 45.50, 1365.00, 333.67, 10010.10, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (172, 'standard', 6000.00, 30, 455.00, 13650.00, 54.60, 1638.00, 400.40, 12012.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (173, 'standard', 7000.00, 30, 530.83, 15925.00, 63.70, 1911.00, 467.13, 14013.90, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (174, 'standard', 8000.00, 30, 606.67, 18200.00, 72.80, 2184.00, 533.87, 16016.10, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (175, 'standard', 9000.00, 30, 682.50, 20475.00, 81.90, 2457.00, 600.60, 18018.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (176, 'standard', 10000.00, 30, 758.33, 22750.00, 91.00, 2730.00, 667.33, 20019.90, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (177, 'standard', 12000.00, 30, 910.00, 27300.00, 109.20, 3276.00, 800.80, 24024.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (178, 'standard', 15000.00, 30, 1137.50, 34125.00, 136.50, 4095.00, 1001.00, 30030.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (179, 'standard', 18000.00, 30, 1365.00, 40950.00, 163.80, 4914.00, 1201.20, 36036.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (180, 'standard', 20000.00, 30, 1516.67, 45500.00, 182.00, 5460.00, 1334.67, 40040.10, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (181, 'standard', 25000.00, 30, 1895.83, 56875.00, 227.50, 6825.00, 1668.33, 50049.90, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (182, 'standard', 30000.00, 30, 2275.00, 68250.00, 273.00, 8190.00, 2002.00, 60060.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (183, 'standard', 3000.00, 36, 210.83, 7590.00, 25.30, 910.80, 185.53, 6679.08, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (184, 'standard', 4000.00, 36, 281.11, 10120.00, 33.73, 1214.28, 247.38, 8905.68, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (185, 'standard', 5000.00, 36, 351.39, 12650.00, 42.17, 1518.12, 309.22, 11131.92, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (186, 'standard', 6000.00, 36, 421.67, 15180.00, 50.60, 1821.60, 371.07, 13358.52, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (187, 'standard', 7000.00, 36, 491.94, 17710.00, 59.03, 2125.08, 432.91, 15584.76, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (188, 'standard', 8000.00, 36, 562.22, 20240.00, 67.47, 2428.92, 494.75, 17811.00, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (189, 'standard', 9000.00, 36, 632.50, 22770.00, 75.90, 2732.40, 556.60, 20037.60, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (190, 'standard', 10000.00, 36, 702.78, 25300.00, 84.33, 3035.88, 618.45, 22264.20, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (191, 'standard', 12000.00, 36, 843.33, 30360.00, 101.20, 3643.20, 742.13, 26716.68, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (192, 'standard', 15000.00, 36, 1054.17, 37950.00, 126.50, 4554.00, 927.67, 33396.12, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (193, 'standard', 18000.00, 36, 1265.00, 45540.00, 151.80, 5464.80, 1113.20, 40075.20, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (194, 'standard', 20000.00, 36, 1405.56, 50600.00, 168.67, 6072.12, 1236.89, 44528.04, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (195, 'standard', 25000.00, 36, 1756.94, 63250.00, 210.83, 7589.88, 1546.11, 55659.96, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (196, 'standard', 30000.00, 36, 2108.33, 75900.00, 253.00, 9108.00, 1855.33, 66791.88, 4.250, 12.000, '2025-11-14 06:28:43.931117+00');
INSERT INTO public.rate_profile_reference_table VALUES (197, 'premium', 3000.00, 3, 1135.00, 3405.00, 136.20, 408.60, 998.80, 2996.40, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (198, 'premium', 4000.00, 3, 1513.33, 4540.00, 181.60, 544.80, 1331.73, 3995.19, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (199, 'premium', 5000.00, 3, 1891.67, 5675.00, 227.00, 681.00, 1664.67, 4994.01, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (200, 'premium', 6000.00, 3, 2270.00, 6810.00, 272.40, 817.20, 1997.60, 5992.80, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (201, 'premium', 7000.00, 3, 2648.33, 7945.00, 317.80, 953.40, 2330.53, 6991.59, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (202, 'premium', 8000.00, 3, 3026.67, 9080.00, 363.20, 1089.60, 2663.47, 7990.41, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (203, 'premium', 9000.00, 3, 3405.00, 10215.00, 408.60, 1225.80, 2996.40, 8989.20, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (204, 'premium', 10000.00, 3, 3783.33, 11350.00, 454.00, 1362.00, 3329.33, 9987.99, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (205, 'premium', 12000.00, 3, 4540.00, 13620.00, 544.80, 1634.40, 3995.20, 11985.60, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (206, 'premium', 15000.00, 3, 5675.00, 17025.00, 681.00, 2043.00, 4994.00, 14982.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (207, 'premium', 18000.00, 3, 6810.00, 20430.00, 817.20, 2451.60, 5992.80, 17978.40, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (208, 'premium', 20000.00, 3, 7566.67, 22700.00, 908.00, 2724.00, 6658.67, 19976.01, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (209, 'premium', 25000.00, 3, 9458.33, 28375.00, 1135.00, 3405.00, 8323.33, 24969.99, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (210, 'premium', 30000.00, 3, 11350.00, 34050.00, 1362.00, 4086.00, 9988.00, 29964.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (211, 'premium', 3000.00, 6, 635.00, 3810.00, 76.20, 457.20, 558.80, 3352.80, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (212, 'premium', 4000.00, 6, 846.67, 5080.00, 101.60, 609.60, 745.07, 4470.42, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (213, 'premium', 5000.00, 6, 1058.33, 6350.00, 127.00, 762.00, 931.33, 5587.98, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (214, 'premium', 6000.00, 6, 1270.00, 7620.00, 152.40, 914.40, 1117.60, 6705.60, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (215, 'premium', 7000.00, 6, 1481.67, 8890.00, 177.80, 1066.80, 1303.87, 7823.22, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (216, 'premium', 8000.00, 6, 1693.33, 10160.00, 203.20, 1219.20, 1490.13, 8940.78, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (217, 'premium', 9000.00, 6, 1905.00, 11430.00, 228.60, 1371.60, 1676.40, 10058.40, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (218, 'premium', 10000.00, 6, 2116.67, 12700.00, 254.00, 1524.00, 1862.67, 11176.02, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (219, 'premium', 12000.00, 6, 2540.00, 15240.00, 304.80, 1828.80, 2235.20, 13411.20, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (220, 'premium', 15000.00, 6, 3175.00, 19050.00, 381.00, 2286.00, 2794.00, 16764.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (221, 'premium', 18000.00, 6, 3810.00, 22860.00, 457.20, 2743.20, 3352.80, 20116.80, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (222, 'premium', 20000.00, 6, 4233.33, 25400.00, 508.00, 3048.00, 3725.33, 22351.98, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (223, 'premium', 25000.00, 6, 5291.67, 31750.00, 635.00, 3810.00, 4656.67, 27940.02, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (224, 'premium', 30000.00, 6, 6350.00, 38100.00, 762.00, 4572.00, 5588.00, 33528.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (225, 'premium', 3000.00, 9, 468.33, 4215.00, 56.20, 505.80, 412.13, 3709.17, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (226, 'premium', 4000.00, 9, 624.44, 5620.00, 74.93, 674.37, 549.51, 4945.59, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (227, 'premium', 5000.00, 9, 780.56, 7025.00, 93.67, 843.03, 686.89, 6182.01, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (228, 'premium', 6000.00, 9, 936.67, 8430.00, 112.40, 1011.60, 824.27, 7418.43, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (229, 'premium', 7000.00, 9, 1092.78, 9835.00, 131.13, 1180.17, 961.65, 8654.85, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (230, 'premium', 8000.00, 9, 1248.89, 11240.00, 149.87, 1348.83, 1099.02, 9891.18, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (231, 'premium', 9000.00, 9, 1405.00, 12645.00, 168.60, 1517.40, 1236.40, 11127.60, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (232, 'premium', 10000.00, 9, 1561.11, 14050.00, 187.33, 1685.97, 1373.78, 12364.02, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (233, 'premium', 12000.00, 9, 1873.33, 16860.00, 224.80, 2023.20, 1648.53, 14836.77, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (234, 'premium', 15000.00, 9, 2341.67, 21075.00, 281.00, 2529.00, 2060.67, 18546.03, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (235, 'premium', 18000.00, 9, 2810.00, 25290.00, 337.20, 3034.80, 2472.80, 22255.20, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (236, 'premium', 20000.00, 9, 3122.22, 28100.00, 374.67, 3372.03, 2747.55, 24727.95, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (237, 'premium', 25000.00, 9, 3902.78, 35125.00, 468.33, 4214.97, 3434.45, 30910.05, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (238, 'premium', 30000.00, 9, 4683.33, 42150.00, 562.00, 5058.00, 4121.33, 37091.97, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (239, 'premium', 3000.00, 12, 385.00, 4620.00, 46.20, 554.40, 338.80, 4065.60, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (240, 'premium', 4000.00, 12, 513.33, 6160.00, 61.60, 739.20, 451.73, 5420.76, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (241, 'premium', 5000.00, 12, 641.67, 7700.00, 77.00, 924.00, 564.67, 6776.04, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (242, 'premium', 6000.00, 12, 770.00, 9240.00, 92.40, 1108.80, 677.60, 8131.20, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (243, 'premium', 7000.00, 12, 898.33, 10780.00, 107.80, 1293.60, 790.53, 9486.36, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (244, 'premium', 8000.00, 12, 1026.67, 12320.00, 123.20, 1478.40, 903.47, 10841.64, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (245, 'premium', 9000.00, 12, 1155.00, 13860.00, 138.60, 1663.20, 1016.40, 12196.80, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (246, 'premium', 10000.00, 12, 1283.33, 15400.00, 154.00, 1848.00, 1129.33, 13551.96, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (247, 'premium', 12000.00, 12, 1540.00, 18480.00, 184.80, 2217.60, 1355.20, 16262.40, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (248, 'premium', 15000.00, 12, 1925.00, 23100.00, 231.00, 2772.00, 1694.00, 20328.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (249, 'premium', 18000.00, 12, 2310.00, 27720.00, 277.20, 3326.40, 2032.80, 24393.60, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (250, 'premium', 20000.00, 12, 2566.67, 30800.00, 308.00, 3696.00, 2258.67, 27104.04, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (251, 'premium', 25000.00, 12, 3208.33, 38500.00, 385.00, 4620.00, 2823.33, 33879.96, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (252, 'premium', 30000.00, 12, 3850.00, 46200.00, 462.00, 5544.00, 3388.00, 40656.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (253, 'premium', 3000.00, 15, 335.00, 5025.00, 40.20, 603.00, 294.80, 4422.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (254, 'premium', 4000.00, 15, 446.67, 6700.00, 53.60, 804.00, 393.07, 5896.05, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (255, 'premium', 5000.00, 15, 558.33, 8375.00, 67.00, 1005.00, 491.33, 7369.95, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (256, 'premium', 6000.00, 15, 670.00, 10050.00, 80.40, 1206.00, 589.60, 8844.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (257, 'premium', 7000.00, 15, 781.67, 11725.00, 93.80, 1407.00, 687.87, 10318.05, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (258, 'premium', 8000.00, 15, 893.33, 13400.00, 107.20, 1608.00, 786.13, 11791.95, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (259, 'premium', 9000.00, 15, 1005.00, 15075.00, 120.60, 1809.00, 884.40, 13266.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (260, 'premium', 10000.00, 15, 1116.67, 16750.00, 134.00, 2010.00, 982.67, 14740.05, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (261, 'premium', 12000.00, 15, 1340.00, 20100.00, 160.80, 2412.00, 1179.20, 17688.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (262, 'premium', 15000.00, 15, 1675.00, 25125.00, 201.00, 3015.00, 1474.00, 22110.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (263, 'premium', 18000.00, 15, 2010.00, 30150.00, 241.20, 3618.00, 1768.80, 26532.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (264, 'premium', 20000.00, 15, 2233.33, 33500.00, 268.00, 4020.00, 1965.33, 29479.95, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (265, 'premium', 25000.00, 15, 2791.67, 41875.00, 335.00, 5025.00, 2456.67, 36850.05, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (266, 'premium', 30000.00, 15, 3350.00, 50250.00, 402.00, 6030.00, 2948.00, 44220.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (267, 'premium', 3000.00, 18, 301.67, 5430.00, 36.20, 651.60, 265.47, 4778.46, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (268, 'premium', 4000.00, 18, 402.22, 7240.00, 48.27, 868.86, 353.95, 6371.10, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (269, 'premium', 5000.00, 18, 502.78, 9050.00, 60.33, 1085.94, 442.45, 7964.10, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (270, 'premium', 6000.00, 18, 603.33, 10860.00, 72.40, 1303.20, 530.93, 9556.74, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (271, 'premium', 7000.00, 18, 703.89, 12670.00, 84.47, 1520.46, 619.42, 11149.56, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (272, 'premium', 8000.00, 18, 804.44, 14480.00, 96.53, 1737.54, 707.91, 12742.38, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (273, 'premium', 9000.00, 18, 905.00, 16290.00, 108.60, 1954.80, 796.40, 14335.20, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (274, 'premium', 10000.00, 18, 1005.56, 18100.00, 120.67, 2172.06, 884.89, 15928.02, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (275, 'premium', 12000.00, 18, 1206.67, 21720.00, 144.80, 2606.40, 1061.87, 19113.66, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (276, 'premium', 15000.00, 18, 1508.33, 27150.00, 181.00, 3258.00, 1327.33, 23891.94, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (277, 'premium', 18000.00, 18, 1810.00, 32580.00, 217.20, 3909.60, 1592.80, 28670.40, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (278, 'premium', 20000.00, 18, 2011.11, 36200.00, 241.33, 4343.94, 1769.78, 31856.04, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (279, 'premium', 25000.00, 18, 2513.89, 45250.00, 301.67, 5430.06, 2212.22, 39819.96, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (280, 'premium', 30000.00, 18, 3016.67, 54300.00, 362.00, 6516.00, 2654.67, 47784.06, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (281, 'premium', 3000.00, 21, 277.86, 5835.00, 33.34, 700.14, 244.52, 5134.92, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (282, 'premium', 4000.00, 21, 370.48, 7780.00, 44.46, 933.66, 326.02, 6846.42, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (283, 'premium', 5000.00, 21, 463.10, 9725.00, 55.57, 1166.97, 407.53, 8558.13, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (284, 'premium', 6000.00, 21, 555.71, 11670.00, 66.69, 1400.49, 489.02, 10269.42, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (285, 'premium', 7000.00, 21, 648.33, 13615.00, 77.80, 1633.80, 570.53, 11981.13, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (286, 'premium', 8000.00, 21, 740.95, 15560.00, 88.91, 1867.11, 652.04, 13692.84, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (287, 'premium', 9000.00, 21, 833.57, 17505.00, 100.03, 2100.63, 733.54, 15404.34, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (288, 'premium', 10000.00, 21, 926.19, 19450.00, 111.14, 2333.94, 815.05, 17116.05, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (289, 'premium', 12000.00, 21, 1111.43, 23340.00, 133.37, 2800.77, 978.06, 20539.26, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (290, 'premium', 15000.00, 21, 1389.29, 29175.00, 166.71, 3500.91, 1222.58, 25674.18, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (291, 'premium', 18000.00, 21, 1667.14, 35010.00, 200.06, 4201.26, 1467.08, 30808.68, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (292, 'premium', 20000.00, 21, 1852.38, 38900.00, 222.29, 4668.09, 1630.09, 34231.89, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (293, 'premium', 25000.00, 21, 2315.48, 48625.00, 277.86, 5835.06, 2037.62, 42790.02, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (294, 'premium', 30000.00, 21, 2778.57, 58350.00, 333.43, 7002.03, 2445.14, 51347.94, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (295, 'premium', 3000.00, 24, 260.00, 6240.00, 31.20, 748.80, 228.80, 5491.20, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (296, 'premium', 4000.00, 24, 346.67, 8320.00, 41.60, 998.40, 305.07, 7321.68, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (297, 'premium', 5000.00, 24, 433.33, 10400.00, 52.00, 1248.00, 381.33, 9151.92, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (298, 'premium', 6000.00, 24, 520.00, 12480.00, 62.40, 1497.60, 457.60, 10982.40, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (299, 'premium', 7000.00, 24, 606.67, 14560.00, 72.80, 1747.20, 533.87, 12812.88, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (300, 'premium', 8000.00, 24, 693.33, 16640.00, 83.20, 1996.80, 610.13, 14643.12, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (301, 'premium', 9000.00, 24, 780.00, 18720.00, 93.60, 2246.40, 686.40, 16473.60, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (302, 'premium', 10000.00, 24, 866.67, 20800.00, 104.00, 2496.00, 762.67, 18304.08, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (303, 'premium', 12000.00, 24, 1040.00, 24960.00, 124.80, 2995.20, 915.20, 21964.80, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (304, 'premium', 15000.00, 24, 1300.00, 31200.00, 156.00, 3744.00, 1144.00, 27456.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (305, 'premium', 18000.00, 24, 1560.00, 37440.00, 187.20, 4492.80, 1372.80, 32947.20, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (306, 'premium', 20000.00, 24, 1733.33, 41600.00, 208.00, 4992.00, 1525.33, 36607.92, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (307, 'premium', 25000.00, 24, 2166.67, 52000.00, 260.00, 6240.00, 1906.67, 45760.08, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (308, 'premium', 30000.00, 24, 2600.00, 62400.00, 312.00, 7488.00, 2288.00, 54912.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (309, 'premium', 3000.00, 30, 235.00, 7050.00, 28.20, 846.00, 206.80, 6204.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (310, 'premium', 4000.00, 30, 313.33, 9400.00, 37.60, 1128.00, 275.73, 8271.90, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (311, 'premium', 5000.00, 30, 391.67, 11750.00, 47.00, 1410.00, 344.67, 10340.10, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (312, 'premium', 6000.00, 30, 470.00, 14100.00, 56.40, 1692.00, 413.60, 12408.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (313, 'premium', 7000.00, 30, 548.33, 16450.00, 65.80, 1974.00, 482.53, 14475.90, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (314, 'premium', 8000.00, 30, 626.67, 18800.00, 75.20, 2256.00, 551.47, 16544.10, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (315, 'premium', 9000.00, 30, 705.00, 21150.00, 84.60, 2538.00, 620.40, 18612.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (316, 'premium', 10000.00, 30, 783.33, 23500.00, 94.00, 2820.00, 689.33, 20679.90, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (317, 'premium', 12000.00, 30, 940.00, 28200.00, 112.80, 3384.00, 827.20, 24816.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (318, 'premium', 15000.00, 30, 1175.00, 35250.00, 141.00, 4230.00, 1034.00, 31020.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (319, 'premium', 18000.00, 30, 1410.00, 42300.00, 169.20, 5076.00, 1240.80, 37224.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (320, 'premium', 20000.00, 30, 1566.67, 47000.00, 188.00, 5640.00, 1378.67, 41360.10, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (321, 'premium', 25000.00, 30, 1958.33, 58750.00, 235.00, 7050.00, 1723.33, 51699.90, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (322, 'premium', 30000.00, 30, 2350.00, 70500.00, 282.00, 8460.00, 2068.00, 62040.00, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (323, 'premium', 3000.00, 36, 218.33, 7860.00, 26.20, 943.20, 192.13, 6916.68, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (324, 'premium', 4000.00, 36, 291.11, 10480.00, 34.93, 1257.48, 256.18, 9222.48, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (325, 'premium', 5000.00, 36, 363.89, 13100.00, 43.67, 1572.12, 320.22, 11527.92, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (326, 'premium', 6000.00, 36, 436.67, 15720.00, 52.40, 1886.40, 384.27, 13833.72, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (327, 'premium', 7000.00, 36, 509.44, 18340.00, 61.13, 2200.68, 448.31, 16139.16, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (328, 'premium', 8000.00, 36, 582.22, 20960.00, 69.87, 2515.32, 512.35, 18444.60, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (329, 'premium', 9000.00, 36, 655.00, 23580.00, 78.60, 2829.60, 576.40, 20750.40, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (330, 'premium', 10000.00, 36, 727.78, 26200.00, 87.33, 3143.88, 640.45, 23056.20, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (331, 'premium', 12000.00, 36, 873.33, 31440.00, 104.80, 3772.80, 768.53, 27667.08, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (332, 'premium', 15000.00, 36, 1091.67, 39300.00, 131.00, 4716.00, 960.67, 34584.12, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (333, 'premium', 18000.00, 36, 1310.00, 47160.00, 157.20, 5659.20, 1152.80, 41500.80, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (334, 'premium', 20000.00, 36, 1455.56, 52400.00, 174.67, 6288.12, 1280.89, 46112.04, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (335, 'premium', 25000.00, 36, 1819.44, 65500.00, 218.33, 7859.88, 1601.11, 57639.96, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (336, 'premium', 30000.00, 36, 2183.33, 78600.00, 262.00, 9432.00, 1921.33, 69167.88, 4.500, 12.000, '2025-11-14 06:28:50.754992+00');
INSERT INTO public.rate_profile_reference_table VALUES (345, 'standard', 22000.00, 3, 8268.33, 24805.00, 992.20, 2976.60, 7276.13, 21828.39, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (347, 'standard', 27000.00, 3, 10147.50, 30442.50, 1217.70, 3653.10, 8929.80, 26789.40, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (357, 'standard', 22000.00, 6, 4601.67, 27610.00, 552.20, 3313.20, 4049.47, 24296.82, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (359, 'standard', 27000.00, 6, 5647.50, 33885.00, 677.70, 4066.20, 4969.80, 29818.80, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (369, 'standard', 22000.00, 9, 3379.44, 30415.00, 405.53, 3649.77, 2973.91, 26765.19, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (371, 'standard', 27000.00, 9, 4147.50, 37327.50, 497.70, 4479.30, 3649.80, 32848.20, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (381, 'standard', 22000.00, 12, 2768.33, 33220.00, 332.20, 3986.40, 2436.13, 29233.56, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (383, 'standard', 27000.00, 12, 3397.50, 40770.00, 407.70, 4892.40, 2989.80, 35877.60, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (393, 'standard', 22000.00, 15, 2401.67, 36025.00, 288.20, 4323.00, 2113.47, 31702.05, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (395, 'standard', 27000.00, 15, 2947.50, 44212.50, 353.70, 5305.50, 2593.80, 38907.00, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (405, 'standard', 22000.00, 18, 2157.22, 38830.00, 258.87, 4659.66, 1898.35, 34170.30, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (407, 'standard', 27000.00, 18, 2647.50, 47655.00, 317.70, 5718.60, 2329.80, 41936.40, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (417, 'standard', 22000.00, 21, 1982.62, 41635.00, 237.91, 4996.11, 1744.71, 36638.91, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (419, 'standard', 27000.00, 21, 2433.21, 51097.50, 291.99, 6131.79, 2141.22, 44965.62, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (429, 'standard', 22000.00, 24, 1851.67, 44440.00, 222.20, 5332.80, 1629.47, 39107.28, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (431, 'standard', 27000.00, 24, 2272.50, 54540.00, 272.70, 6544.80, 1999.80, 47995.20, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (441, 'standard', 22000.00, 30, 1668.33, 50050.00, 200.20, 6006.00, 1468.13, 44043.90, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (443, 'standard', 27000.00, 30, 2047.50, 61425.00, 245.70, 7371.00, 1801.80, 54054.00, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (453, 'standard', 22000.00, 36, 1546.11, 55660.00, 185.53, 6679.08, 1360.58, 48980.88, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (455, 'standard', 27000.00, 36, 1897.50, 68310.00, 227.70, 8197.20, 1669.80, 60112.80, 4.250, 12.000, '2025-11-14 07:06:09.511403+00');
INSERT INTO public.rate_profile_reference_table VALUES (515, 'legacy', 3000.00, 12, 392.00, 4704.00, 55.00, 660.00, 337.00, 4044.00, 4.733, 14.031, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (516, 'legacy', 4000.00, 12, 510.00, 6120.00, 64.00, 768.00, 446.00, 5352.00, 4.417, 12.549, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (517, 'legacy', 5000.00, 12, 633.00, 7596.00, 80.00, 960.00, 553.00, 6636.00, 4.327, 12.638, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (518, 'legacy', 6000.00, 12, 752.00, 9024.00, 90.00, 1080.00, 662.00, 7944.00, 4.200, 11.968, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (519, 'legacy', 7000.00, 12, 882.00, 10584.00, 112.00, 1344.00, 770.00, 9240.00, 4.267, 12.698, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (520, 'legacy', 8000.00, 12, 1006.00, 12072.00, 128.00, 1536.00, 878.00, 10536.00, 4.242, 12.724, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (521, 'legacy', 9000.00, 12, 1131.00, 13572.00, 144.00, 1728.00, 987.00, 11844.00, 4.233, 12.732, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (522, 'legacy', 10000.00, 12, 1255.00, 15060.00, 160.00, 1920.00, 1095.00, 13140.00, 4.217, 12.749, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (523, 'legacy', 11000.00, 12, 1385.00, 16620.00, 170.00, 2040.00, 1215.00, 14580.00, 4.258, 12.274, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (524, 'legacy', 12000.00, 12, 1504.00, 18048.00, 180.00, 2160.00, 1324.00, 15888.00, 4.200, 11.968, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (525, 'legacy', 13000.00, 12, 1634.00, 19608.00, 202.00, 2424.00, 1432.00, 17184.00, 4.236, 12.362, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (526, 'legacy', 14000.00, 12, 1765.00, 21180.00, 224.00, 2688.00, 1541.00, 18492.00, 4.274, 12.691, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (527, 'legacy', 15000.00, 12, 1888.00, 22656.00, 240.00, 2880.00, 1648.00, 19776.00, 4.253, 12.712, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (528, 'legacy', 16000.00, 12, 2012.00, 24144.00, 256.00, 3072.00, 1756.00, 21072.00, 4.242, 12.724, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (529, 'legacy', 17000.00, 12, 2137.00, 25644.00, 272.00, 3264.00, 1865.00, 22380.00, 4.237, 12.728, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (530, 'legacy', 18000.00, 12, 2262.00, 27144.00, 288.00, 3456.00, 1974.00, 23688.00, 4.233, 12.732, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (531, 'legacy', 19000.00, 12, 2386.00, 28632.00, 304.00, 3648.00, 2082.00, 24984.00, 4.225, 12.741, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (532, 'legacy', 20000.00, 12, 2510.00, 30120.00, 320.00, 3840.00, 2190.00, 26280.00, 4.217, 12.749, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (533, 'legacy', 21000.00, 12, 2640.00, 31680.00, 330.00, 3960.00, 2310.00, 27720.00, 4.238, 12.500, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (534, 'legacy', 22000.00, 12, 2759.00, 33108.00, 340.00, 4080.00, 2419.00, 29028.00, 4.208, 12.323, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (535, 'legacy', 23000.00, 12, 2889.00, 34668.00, 362.00, 4344.00, 2527.00, 30324.00, 4.228, 12.530, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (536, 'legacy', 24000.00, 12, 3020.00, 36240.00, 384.00, 4608.00, 2636.00, 31632.00, 4.250, 12.715, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (537, 'legacy', 25000.00, 12, 3143.00, 37716.00, 400.00, 4800.00, 2743.00, 32916.00, 4.239, 12.727, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (538, 'legacy', 26000.00, 12, 3267.00, 39204.00, 416.00, 4992.00, 2851.00, 34212.00, 4.232, 12.733, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (539, 'legacy', 27000.00, 12, 3392.00, 40704.00, 432.00, 5184.00, 2960.00, 35520.00, 4.230, 12.736, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (540, 'legacy', 28000.00, 12, 3517.00, 42204.00, 448.00, 5376.00, 3069.00, 36828.00, 4.227, 12.738, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (541, 'legacy', 29000.00, 12, 3641.00, 43692.00, 464.00, 5568.00, 3177.00, 38124.00, 4.222, 12.744, '2025-11-19 00:39:21.802725+00');
INSERT INTO public.rate_profile_reference_table VALUES (542, 'legacy', 30000.00, 12, 3765.00, 45180.00, 480.00, 5760.00, 3285.00, 39420.00, 4.217, 12.749, '2025-11-19 00:39:21.802725+00');


--
-- Data for Name: rate_profiles; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.rate_profiles VALUES (1, 'legacy', 'Tabla Hist√≥rica v2.0', 'Sistema actual con montos predefinidos en tabla. Totalmente editable por admin. Permite agregar nuevos montos como $7,500, $12,350, etc.', 'table_lookup', NULL, true, false, 1, NULL, NULL, '{12}', '2025-11-05 00:58:16.105135+00', '2025-11-05 00:58:16.105135+00', NULL, NULL, NULL);
INSERT INTO public.rate_profiles VALUES (3, 'standard', 'Est√°ndar - Recomendado ‚≠ê', 'Balance √≥ptimo entre competitividad y rentabilidad. Tasa ~51% total (12Q), similar al promedio actual. Recomendado para mayor√≠a de casos.', 'formula', 4.250, true, true, 3, NULL, NULL, '{3,6,9,12,15,18,21,24,30,36}', '2025-11-05 00:58:16.105135+00', '2025-11-25 11:34:00.499195+00', NULL, NULL, 1.600);
INSERT INTO public.rate_profiles VALUES (2, 'transition', 'Transici√≥n Suave 3.75%', 'Tasa reducida para facilitar adopci√≥n gradual. Cliente ahorra vs tabla actual. Ideal para primeros 6 meses de migraci√≥n.', 'formula', 3.750, false, false, 2, NULL, NULL, '{6,12,18,24}', '2025-11-05 00:58:16.105135+00', '2025-11-05 00:58:16.105135+00', NULL, NULL, 12.000);
INSERT INTO public.rate_profiles VALUES (4, 'premium', 'Premium 4.5%', 'Tasa objetivo con m√°xima rentabilidad (54% total en 12Q). Mantiene competitividad vs mercado (60-80%). Activar desde mes 7+ de migraci√≥n.', 'formula', 4.500, false, false, 4, NULL, NULL, '{3,6,9,12,15,18,21,24,30,36}', '2025-11-05 00:58:16.105135+00', '2025-11-05 00:58:16.105135+00', NULL, NULL, 12.000);
INSERT INTO public.rate_profiles VALUES (5, 'custom', 'Personalizado', 'Tasa ajustable manualmente para casos especiales. Requiere aprobaci√≥n de gerente/admin. Rango permitido: 2.0% - 6.0% quincenal.', 'formula', 4.250, true, false, 5, NULL, NULL, '{3,6,9,12,15,18,21,24,30,36}', '2025-11-05 00:58:16.105135+00', '2025-11-05 00:58:16.105135+00', NULL, NULL, 1.600);


--
-- Data for Name: relationships; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.relationships VALUES (1, 'Padre', 'Padre del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (2, 'Madre', 'Madre del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (3, 'Hijo', 'Hijo del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (4, 'Hija', 'Hija del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (5, 'Hermano', 'Hermano del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (6, 'Hermana', 'Hermana del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (7, 'Esposo', 'Esposo del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (8, 'Esposa', 'Esposa del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (9, 'Abuelo', 'Abuelo del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (10, 'Abuela', 'Abuela del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (11, 'T√≠o', 'T√≠o del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (12, 'T√≠a', 'T√≠a del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (13, 'Primo', 'Primo del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (14, 'Prima', 'Prima del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (15, 'Sobrino', 'Sobrino del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (16, 'Sobrina', 'Sobrina del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (17, 'Amigo', 'Amigo del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (18, 'Amiga', 'Amiga del titular', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');
INSERT INTO public.relationships VALUES (19, 'Otro', 'Otra relaci√≥n no especificada', true, '2025-11-13 11:08:51.909367+00', '2025-11-13 11:08:51.909367+00');


--
-- Data for Name: roles; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.roles VALUES (1, 'desarrollador', NULL, '2025-10-31 01:12:22.07323+00');
INSERT INTO public.roles VALUES (2, 'administrador', NULL, '2025-10-31 01:12:22.07323+00');
INSERT INTO public.roles VALUES (3, 'auxiliar_administrativo', NULL, '2025-10-31 01:12:22.07323+00');
INSERT INTO public.roles VALUES (4, 'asociado', NULL, '2025-10-31 01:12:22.07323+00');
INSERT INTO public.roles VALUES (5, 'cliente', NULL, '2025-10-31 01:12:22.07323+00');


--
-- Data for Name: statement_statuses; Type: TABLE DATA; Schema: public; Owner: -
--

INSERT INTO public.statement_statuses VALUES (6, 'DRAFT', 'BORRADOR - Vista preliminar editable. Admin puede ajustar antes de cerrar corte.', false, 0, '#FFC107', '2025-11-26 20:11:34.098392+00', '2025-12-04 08:30:19.259578+00');
INSERT INTO public.statement_statuses VALUES (3, 'PAID', 'PAGADO - Asociado pag√≥ completamente a CrediCuenta.', true, 2, '#4CAF50', '2025-10-31 01:12:22.084329+00', '2025-12-04 08:30:19.259578+00');
INSERT INTO public.statement_statuses VALUES (1, 'GENERATED', 'DEPRECADO - Usar FINALIZED en su lugar.', false, 99, '#9E9E9E', '2025-10-31 01:12:22.084329+00', '2025-12-04 08:30:19.259578+00');
INSERT INTO public.statement_statuses VALUES (2, 'SENT', 'DEPRECADO - Usar flag sent_date en statement.', false, 99, '#2196F3', '2025-10-31 01:12:22.084329+00', '2025-12-04 08:30:19.259578+00');
INSERT INTO public.statement_statuses VALUES (7, 'COLLECTING', 'EN COBRO - Statement oficial, esperando pago del asociado a CrediCuenta.', false, 1, '#2196F3', '2025-11-26 20:11:34.098392+00', '2025-12-04 09:17:25.171181+00');
INSERT INTO public.statement_statuses VALUES (9, 'SETTLING', 'EN LIQUIDACI√ìN - Per√≠odo en proceso de cierre, √∫ltimo esfuerzo de cobro.', false, 5, '#9C27B0', '2025-12-18 06:17:27.755561+00', '2025-12-18 06:17:27.755561+00');
INSERT INTO public.statement_statuses VALUES (10, 'CLOSED', 'CERRADO - Per√≠odo cerrado definitivamente.', false, 6, '#455A64', '2025-12-18 06:17:27.755561+00', '2025-12-18 06:17:27.755561+00');
INSERT INTO public.statement_statuses VALUES (8, 'ABSORBED', 'DEPRECADO - ABSORBIDO - Deuda transferida al balance acumulado del asociado.', false, 99, '#607D8B', '2025-12-04 08:30:19.259578+00', '2025-12-18 06:17:27.755561+00');
INSERT INTO public.statement_statuses VALUES (5, 'OVERDUE', 'DEPRECADO - VENCIDO - Per√≠odo termin√≥ sin pago completo del asociado.', false, 99, '#F44336', '2025-10-31 01:12:22.084329+00', '2025-12-18 06:17:27.755561+00');
INSERT INTO public.statement_statuses VALUES (4, 'PARTIAL', 'DEPRECADO - PAGO PARCIAL - Asociado realiz√≥ abono parcial, saldo pendiente.', false, 99, '#FF9800', '2025-10-31 01:12:22.084329+00', '2025-12-18 06:17:27.755561+00');


--
-- Name: associate_levels_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.associate_levels_id_seq', 1, false);


--
-- Name: config_types_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.config_types_id_seq', 8, true);


--
-- Name: contract_statuses_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.contract_statuses_id_seq', 6, true);


--
-- Name: cut_period_statuses_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.cut_period_statuses_id_seq', 6, true);


--
-- Name: document_statuses_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.document_statuses_id_seq', 4, true);


--
-- Name: document_types_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.document_types_id_seq', 1, false);


--
-- Name: level_change_types_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.level_change_types_id_seq', 6, true);


--
-- Name: loan_statuses_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.loan_statuses_id_seq', 8, true);


--
-- Name: payment_methods_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.payment_methods_id_seq', 7, true);


--
-- Name: payment_statuses_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.payment_statuses_id_seq', 1, false);


--
-- Name: rate_profile_reference_table_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.rate_profile_reference_table_id_seq', 542, true);


--
-- Name: rate_profiles_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.rate_profiles_id_seq', 6, true);


--
-- Name: relationships_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.relationships_id_seq', 19, true);


--
-- Name: roles_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.roles_id_seq', 6, false);


--
-- Name: statement_statuses_id_seq; Type: SEQUENCE SET; Schema: public; Owner: -
--

SELECT pg_catalog.setval('public.statement_statuses_id_seq', 6, true);


--
-- PostgreSQL database dump complete
--

\unrestrict 3uv63XtWOjwyhK8u9ekZlu7MbruoDONIbZk75ZGh3dVGKalx73dd3stG7mBN8b7


-- ============ GENERAR PER√çODOS DE CORTE ============
-- Genera per√≠odos para a√±o actual y siguiente

DO $$
DECLARE
    v_year INTEGER;
    v_month INTEGER;
    v_period_num INTEGER := 1;
    v_start_date DATE;
    v_end_date DATE;
    v_cut_code VARCHAR(20);
BEGIN
    FOR v_year IN EXTRACT(YEAR FROM CURRENT_DATE)::INTEGER .. (EXTRACT(YEAR FROM CURRENT_DATE) + 1)::INTEGER LOOP
        FOR v_month IN 1..12 LOOP
            -- Primera quincena (1-7 -> corte 8)
            v_start_date := make_date(v_year, v_month, 1);
            v_end_date := make_date(v_year, v_month, 7);
            v_cut_code := TO_CHAR(v_end_date + 1, 'MonDD-YYYY');
            
            INSERT INTO cut_periods (cut_number, period_start_date, period_end_date, cut_date, cut_code, status_id)
            VALUES (v_period_num, v_start_date, v_end_date, v_end_date + 1, v_cut_code, 
                    CASE WHEN v_end_date < CURRENT_DATE THEN 5 ELSE 1 END)
            ON CONFLICT DO NOTHING;
            v_period_num := v_period_num + 1;
            
            -- Segunda quincena (8-22 -> corte 23)
            v_start_date := make_date(v_year, v_month, 8);
            v_end_date := make_date(v_year, v_month, 22);
            v_cut_code := TO_CHAR(v_end_date + 1, 'MonDD-YYYY');
            
            INSERT INTO cut_periods (cut_number, period_start_date, period_end_date, cut_date, cut_code, status_id)
            VALUES (v_period_num, v_start_date, v_end_date, v_end_date + 1, v_cut_code,
                    CASE WHEN v_end_date < CURRENT_DATE THEN 5 ELSE 1 END)
            ON CONFLICT DO NOTHING;
            v_period_num := v_period_num + 1;
            
            -- Tercera quincena (23-fin de mes)
            v_start_date := make_date(v_year, v_month, 23);
            v_end_date := (make_date(v_year, v_month, 1) + INTERVAL '1 month - 1 day')::DATE;
            
            IF v_month = 12 THEN
                v_cut_code := TO_CHAR(make_date(v_year + 1, 1, 8), 'MonDD-YYYY');
            ELSE
                v_cut_code := TO_CHAR(make_date(v_year, v_month + 1, 8), 'MonDD-YYYY');
            END IF;
            
            INSERT INTO cut_periods (cut_number, period_start_date, period_end_date, cut_date, cut_code, status_id)
            VALUES (v_period_num, v_start_date, v_end_date, v_end_date + 1, v_cut_code,
                    CASE WHEN v_end_date < CURRENT_DATE THEN 5 ELSE 1 END)
            ON CONFLICT DO NOTHING;
            v_period_num := v_period_num + 1;
        END LOOP;
    END LOOP;
    
    RAISE NOTICE 'Per√≠odos generados: %', v_period_num - 1;
END $$;

-- ============ CREAR USUARIO ADMIN POR DEFECTO ============
INSERT INTO users (username, email, password_hash, first_name, last_name, phone, user_type_id, is_active)
VALUES ('admin', 'admin@credinet.com', '$2b$12$LQv3c1yqBWVHxkd0LHAkCOYz6TtxMQJqhN8/X4.SU.f.7Z.X.Z.Z.', 'Administrador', 'Sistema', '0000000000', 1, true)
ON CONFLICT (username) DO NOTHING;

-- Asignar rol admin
INSERT INTO user_roles (user_id, role_id)
SELECT u.id, r.id FROM users u, roles r WHERE u.username = 'admin' AND r.name = 'admin'
ON CONFLICT DO NOTHING;

-- ============ FIN DE RESTAURACI√ìN ============
SELECT 'Restauraci√≥n completada exitosamente' as status;
