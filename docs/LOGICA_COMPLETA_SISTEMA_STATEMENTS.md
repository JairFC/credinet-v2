# ğŸ“‹ LÃ“GICA COMPLETA DEL SISTEMA DE STATEMENTS
**Documento Maestro - DefiniciÃ³n Completa**  
VersiÃ³n: 1.0  
Fecha: 2025-11-11  
Estado: âœ… DEFINICIÃ“N FINAL

---

## ğŸ“‘ TABLA DE CONTENIDOS

1. [Flujo de Pagos Fundamental](#1-flujo-de-pagos-fundamental)
2. [CÃ¡lculo de Mora (30%)](#2-cÃ¡lculo-de-mora-30)
3. [Dos Tipos de Abonos](#3-dos-tipos-de-abonos)
4. [DistribuciÃ³n de Abonos](#4-distribuciÃ³n-de-abonos)
5. [Cierre de PerÃ­odo](#5-cierre-de-perÃ­odo)
6. [Estados de Pagos](#6-estados-de-pagos)
7. [Tracking en Base de Datos](#7-tracking-en-base-de-datos)
8. [Ventanas de Referencias UI](#8-ventanas-de-referencias-ui)

---

## 1. FLUJO DE PAGOS FUNDAMENTAL

### 1.1 Conceptos Clave

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLUJO DE DINERO (por pago)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  CLIENTE â”€â”€â”€â”€â”€â”€â–º expected_amount ($1,250) â”€â”€â”€â”€â”€â”€â–º ASOCIADO          â”‚
â”‚                                                                       â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                  â”‚ Asociado RETIENE comisiÃ³n:  â”‚                     â”‚
â”‚                  â”‚ commission_amount = $62.50  â”‚ â—„â”€â”€ (5%)            â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                       â”‚
â”‚  ASOCIADO â”€â”€â”€â”€â”€â”€â–º associate_payment ($1,187.50) â”€â”€â”€â”€â”€â”€â–º CREDICUENTA â”‚
â”‚                                                                       â”‚
â”‚  VALIDACIÃ“N: $1,250 = $62.50 + $1,187.50 âœ“                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Campos en la Tabla `payments`

```sql
-- Por cada pago individual:
expected_amount       DECIMAL(12,2)  -- Lo que el cliente debe pagar ($1,250)
commission_amount     DECIMAL(10,2)  -- Lo que el asociado gana ($62.50)
associate_payment     DECIMAL(10,2)  -- Lo que el asociado debe pagar a CrediCuenta ($1,187.50)

-- RelaciÃ³n matemÃ¡tica:
-- expected_amount = commission_amount + associate_payment
```

### 1.3 Campos en `associate_payment_statements`

```sql
-- Agregados del perÃ­odo de corte:
total_amount_collected   DECIMAL(12,2)  -- SUM(expected_amount) de todos los pagos
total_commission_owed    DECIMAL(12,2)  -- SUM(commission_amount) de todos los pagos
paid_amount              DECIMAL(12,2)  -- Abonos registrados por el asociado
late_fee_amount          DECIMAL(12,2)  -- Mora del 30% (si aplica)

-- Campo calculado (NO estÃ¡ en DB, se calcula en backend):
associate_payment_total = total_amount_collected - total_commission_owed

-- Ejemplo:
-- total_amount_collected = $18,750 (15 pagos Ã— $1,250)
-- total_commission_owed = $937.50 (15 pagos Ã— $62.50)
-- associate_payment_total = $17,812.50 (lo que debe pagar a CrediCuenta)
```

---

## 2. CÃLCULO DE MORA (30%)

### 2.1 Regla de AplicaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CONDICIONES PARA MORA                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  âŒ SI paid_amount = 0 (CERO ABSOLUTO):                              â”‚
â”‚     â†’ late_fee_amount = total_commission_owed Ã— 0.30                 â”‚
â”‚     â†’ late_fee_applied = true                                        â”‚
â”‚     â†’ Se SUMA a la deuda                                             â”‚
â”‚                                                                       â”‚
â”‚  âœ… SI paid_amount > 0 (CUALQUIER ABONO, incluso $1):                â”‚
â”‚     â†’ late_fee_amount = 0                                            â”‚
â”‚     â†’ late_fee_applied = false                                       â”‚
â”‚     â†’ NO hay mora                                                    â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Ejemplos NumÃ©ricos

**Ejemplo 1: CERO pagos (mora aplica)**
```
total_commission_owed = $937.50
paid_amount = $0

late_fee_amount = $937.50 Ã— 0.30 = $281.25
debt_to_accumulate = $17,812.50 + $281.25 = $18,093.75
```

**Ejemplo 2: Abono parcial de $1 (NO mora)**
```
total_commission_owed = $937.50
paid_amount = $1.00

late_fee_amount = $0
debt_to_accumulate = $17,812.50 - $1.00 = $17,811.50
```

**Ejemplo 3: Abono parcial de $10,000 (NO mora)**
```
total_commission_owed = $937.50
paid_amount = $10,000.00

late_fee_amount = $0
debt_to_accumulate = $17,812.50 - $10,000.00 = $7,812.50
```

---

## 3. DOS TIPOS DE ABONOS

### 3.1 DistinciÃ³n Fundamental

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               SIEMPRE EXISTEN 2 TIPOS DE ABONOS                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  TIPO 1: ABONO AL SALDO ACTUAL (statement del perÃ­odo)               â”‚
â”‚  â”œâ”€ Destino: paid_amount del statement                               â”‚
â”‚  â”œâ”€ Tabla: associate_statement_payments                              â”‚
â”‚  â”œâ”€ Efecto: Reduce saldo pendiente del perÃ­odo                       â”‚
â”‚  â””â”€ Previene: AplicaciÃ³n de mora (si paid_amount > 0)                â”‚
â”‚                                                                       â”‚
â”‚  TIPO 2: ABONO A LA DEUDA ACUMULADA                                  â”‚
â”‚  â”œâ”€ Destino: debt_balance (de associate_profiles)                    â”‚
â”‚  â”œâ”€ Tabla: associate_debt_breakdown (marca is_liquidated)            â”‚
â”‚  â”œâ”€ Efecto: Reduce deuda de perÃ­odos anteriores                      â”‚
â”‚  â””â”€ Estrategia: FIFO (mÃ¡s antiguos primero)                          â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Modal de Registro (UI)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     REGISTRAR ABONO - ASOCIADO                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  Asociado: Juan PÃ©rez (ID: 123)                                      â”‚
â”‚                                                                       â”‚
â”‚  Seleccione destino del abono:                                       â”‚
â”‚                                                                       â”‚
â”‚    (â€¢) Saldo Actual (Quincena 2025-Q04)                              â”‚
â”‚        Pendiente: $17,812.50                                         â”‚
â”‚        ComisiÃ³n: $937.50                                             â”‚
â”‚        âš ï¸ Sin abonos previos - Riesgo de mora (30%)                  â”‚
â”‚                                                                       â”‚
â”‚    ( ) Deuda Acumulada                                               â”‚
â”‚        Saldo: $8,500.00                                              â”‚
â”‚        Origen: 3 perÃ­odos anteriores                                 â”‚
â”‚        ğŸ“Š Ver desglose                                               â”‚
â”‚                                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                       â”‚
â”‚  Monto: [____________]                                               â”‚
â”‚  MÃ©todo de pago: [Transferencia â–¼]                                   â”‚
â”‚  Referencia: [____________]                                          â”‚
â”‚  Notas: [____________]                                               â”‚
â”‚                                                                       â”‚
â”‚          [Cancelar]        [Registrar Abono]                         â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. DISTRIBUCIÃ“N DE ABONOS

### 4.1 DecisiÃ³n de Negocio

**PREGUNTA 3-NUEVA.1: DistribuciÃ³n en pagos individuales**  
**RESPUESTA: B) NO se distribuye** âœ… CONFIRMADO

### 4.2 Implicaciones

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ABONO PARCIAL - NO HAY DISTRIBUCIÃ“N EN PAGOS              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  ANTES del cierre:                                                   â”‚
â”‚  â”œâ”€ 15 pagos individuales con status_id = 4 (PENDING)               â”‚
â”‚  â””â”€ paid_amount en statement = $10,000                               â”‚
â”‚                                                                       â”‚
â”‚  DURANTE el cierre (si paid_amount < associate_payment_total):       â”‚
â”‚  â”œâ”€ NO se marcan pagos individuales como PAID                        â”‚
â”‚  â”œâ”€ TODOS los pagos quedan con status_id = 8 (UNPAID_ACCRUED_DEBT)  â”‚
â”‚  â””â”€ debt_to_accumulate = $17,812.50 - $10,000 = $7,812.50           â”‚
â”‚                                                                       â”‚
â”‚  RazÃ³n: No se puede determinar CUÃLES pagos fueron cubiertos         â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 LÃ³gica de Cierre con Abono Parcial

```sql
-- PseudocÃ³digo del cierre
IF paid_amount = 0 THEN
    late_fee = total_commission_owed Ã— 0.30
    debt_to_accumulate = associate_payment_total + late_fee
    -- Marcar todos los pagos como UNPAID_ACCRUED_DEBT
    UPDATE payments SET status_id = 8 WHERE loan_id IN (...)
    
ELSE IF paid_amount > 0 AND paid_amount < associate_payment_total THEN
    late_fee = 0  -- NO mora porque hubo abono
    debt_to_accumulate = associate_payment_total - paid_amount
    -- Marcar todos los pagos como UNPAID_ACCRUED_DEBT
    -- NO se distribuye, todos quedan pendientes
    UPDATE payments SET status_id = 8 WHERE loan_id IN (...)
    
ELSE IF paid_amount >= associate_payment_total THEN
    late_fee = 0
    debt_to_accumulate = 0
    -- Marcar todos los pagos como PAID_BY_ASSOCIATE
    UPDATE payments SET status_id = 7 WHERE loan_id IN (...)
END IF

-- Acumular deuda
UPDATE associate_profiles
SET debt_balance = debt_balance + debt_to_accumulate
WHERE id = associate_profile_id
```

---

## 5. CIERRE DE PERÃODO

### 5.1 Flujo Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CIERRE DE PERÃODO (MANUAL)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  1. TRIGGER: Admin ejecuta "Cerrar PerÃ­odo"                          â”‚
â”‚                                                                       â”‚
â”‚  2. VALIDACIÃ“N:                                                      â”‚
â”‚     âœ“ PerÃ­odo estÃ¡ ACTIVE                                            â”‚
â”‚     âœ“ Nuevo perÃ­odo ya comenzÃ³ (dÃ­a 8 o dÃ­a 23)                     â”‚
â”‚                                                                       â”‚
â”‚  3. CÃLCULO:                                                         â”‚
â”‚     paid_amount = SUM(associate_statement_payments.payment_amount)   â”‚
â”‚                                                                       â”‚
â”‚  4. DECISIÃ“N MORA:                                                   â”‚
â”‚     IF paid_amount = 0:                                              â”‚
â”‚        late_fee = total_commission_owed Ã— 0.30                       â”‚
â”‚     ELSE:                                                            â”‚
â”‚        late_fee = 0                                                  â”‚
â”‚                                                                       â”‚
â”‚  5. ACUMULACIÃ“N DEUDA:                                               â”‚
â”‚     debt_to_accumulate = (total_amount_collected                     â”‚
â”‚                          - total_commission_owed                     â”‚
â”‚                          - paid_amount                               â”‚
â”‚                          + late_fee)                                 â”‚
â”‚                                                                       â”‚
â”‚  6. ACTUALIZAR ASOCIADO:                                             â”‚
â”‚     UPDATE associate_profiles                                        â”‚
â”‚     SET debt_balance = debt_balance + debt_to_accumulate             â”‚
â”‚                                                                       â”‚
â”‚  7. REGISTRAR BREAKDOWN:                                             â”‚
â”‚     INSERT INTO associate_debt_breakdown (...)                       â”‚
â”‚     -- Crear registros por tipo (UNREPORTED_PAYMENT, LATE_FEE)       â”‚
â”‚                                                                       â”‚
â”‚  8. MARCAR PAGOS:                                                    â”‚
â”‚     IF paid_amount >= associate_payment_total:                       â”‚
â”‚        UPDATE payments SET status_id = 7 (PAID_BY_ASSOCIATE)         â”‚
â”‚     ELSE:                                                            â”‚
â”‚        UPDATE payments SET status_id = 8 (UNPAID_ACCRUED_DEBT)       â”‚
â”‚                                                                       â”‚
â”‚  9. CERRAR STATEMENT:                                                â”‚
â”‚     UPDATE associate_payment_statements                              â”‚
â”‚     SET status_id = 4 (CLOSED), late_fee_amount = late_fee           â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. ESTADOS DE PAGOS

### 6.1 Estados Relevantes (tabla `payment_statuses`)

```sql
-- Estados antes del cierre:
1 - PENDING          -- Pago esperado, aÃºn no vence
2 - OVERDUE          -- Pago vencido, no reportado
3 - PAID             -- Marcado manualmente por admin (cliente pagÃ³)
4 - PAID_NOT_REPORTED -- Marcado manualmente por admin (cliente moroso)

-- Estados despuÃ©s del cierre:
7 - PAID_BY_ASSOCIATE      -- Asociado liquidÃ³ el statement completo
8 - UNPAID_ACCRUED_DEBT    -- Asociado NO liquidÃ³, deuda acumulada
```

### 6.2 Transiciones de Estado

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TRANSICIONES DE ESTADO                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  ANTES DEL CIERRE (Admin puede marcar manualmente):                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                       â”‚
â”‚    PENDING (1) â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â–º PAID (3)                                 â”‚
â”‚                     â”‚                                                 â”‚
â”‚    OVERDUE (2) â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â–º PAID_NOT_REPORTED (4)                    â”‚
â”‚                                                                       â”‚
â”‚                                                                       â”‚
â”‚  AL CIERRE (AutomÃ¡tico segÃºn paid_amount):                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚                                                                       â”‚
â”‚    PENDING/OVERDUE â”€â”€â”€â”€â”¬â”€â”€â”€â”€â–º PAID_BY_ASSOCIATE (7)                  â”‚
â”‚                        â”‚      (si paid_amount >= total)              â”‚
â”‚                        â”‚                                              â”‚
â”‚    PAID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                              â”‚
â”‚                        â”‚                                              â”‚
â”‚    PAID_NOT_REPORTED â”€â”€â”´â”€â”€â”€â”€â–º UNPAID_ACCRUED_DEBT (8)                â”‚
â”‚                              (si paid_amount < total)                â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. TRACKING EN BASE DE DATOS

### 7.1 Tablas Existentes

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TABLAS PARA TRACKING                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  1. associate_statement_payments                                     â”‚
â”‚     â”œâ”€ statement_id (FK â†’ associate_payment_statements)              â”‚
â”‚     â”œâ”€ payment_amount (monto del abono)                              â”‚
â”‚     â”œâ”€ payment_date                                                  â”‚
â”‚     â”œâ”€ payment_method_id                                             â”‚
â”‚     â”œâ”€ payment_reference                                             â”‚
â”‚     â”œâ”€ registered_by (user_id del admin)                             â”‚
â”‚     â””â”€ notes                                                         â”‚
â”‚                                                                       â”‚
â”‚  2. associate_debt_breakdown                                         â”‚
â”‚     â”œâ”€ associate_profile_id                                          â”‚
â”‚     â”œâ”€ cut_period_id (perÃ­odo de origen)                             â”‚
â”‚     â”œâ”€ debt_type (UNREPORTED_PAYMENT, LATE_FEE, DEFAULTED_CLIENT)    â”‚
â”‚     â”œâ”€ loan_id (opcional, rastreo del prÃ©stamo)                      â”‚
â”‚     â”œâ”€ client_user_id (opcional, rastreo del cliente)                â”‚
â”‚     â”œâ”€ amount (monto de la deuda)                                    â”‚
â”‚     â”œâ”€ is_liquidated (boolean)                                       â”‚
â”‚     â”œâ”€ liquidated_at                                                 â”‚
â”‚     â””â”€ liquidation_reference                                         â”‚
â”‚                                                                       â”‚
â”‚  3. associate_profiles                                               â”‚
â”‚     â”œâ”€ debt_balance (suma total de deuda acumulada)                  â”‚
â”‚     â””â”€ (actualizado al cerrar perÃ­odo)                               â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 Estrategia FIFO para Deuda Acumulada

**PREGUNTA 4-NUEVA.1: FIFO en deuda acumulada**  
**RESPUESTA: A) Automatic FIFO (oldest first)** âœ… CONFIRMADO

```sql
-- LÃ³gica de liquidaciÃ³n FIFO (ya existe en trigger)
-- Archivo: 06_functions_business.sql lÃ­nea ~680

-- Al registrar abono a deuda acumulada:
FOR debt_item IN (
    SELECT id, amount
    FROM associate_debt_breakdown
    WHERE associate_profile_id = p_associate_profile_id
      AND is_liquidated = false
    ORDER BY created_at ASC, id ASC  -- â­ FIFO: mÃ¡s antiguos primero
)
LOOP
    IF remaining_amount >= debt_item.amount THEN
        -- Liquidar completamente este item
        UPDATE associate_debt_breakdown
        SET is_liquidated = true,
            liquidated_at = CURRENT_TIMESTAMP,
            liquidation_reference = p_payment_reference
        WHERE id = debt_item.id;
        
        remaining_amount := remaining_amount - debt_item.amount;
    ELSE
        -- Liquidar parcialmente este item
        -- (Split en 2: liquidado + pendiente)
        EXIT;
    END IF;
END LOOP;
```

### 7.3 VisualizaciÃ³n de Deuda (ASCII)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            DESGLOSE DE DEUDA ACUMULADA - Juan PÃ©rez                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  Total Deuda: $8,500.00                                              â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ PERÃODO      TIPO                    MONTO      ESTADO       â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ 2025-Q01     UNREPORTED_PAYMENT      $3,200.00  ğŸ”´ Pendienteâ”‚ â†1 â”‚
â”‚  â”‚ 2025-Q01     LATE_FEE                $  960.00  ğŸ”´ Pendienteâ”‚ â†2 â”‚
â”‚  â”‚ 2025-Q02     UNREPORTED_PAYMENT      $2,840.00  ğŸ”´ Pendienteâ”‚ â†3 â”‚
â”‚  â”‚ 2025-Q03     LATE_FEE                $  500.00  ğŸ”´ Pendienteâ”‚ â†4 â”‚
â”‚  â”‚ 2025-Q03     DEFAULTED_CLIENT        $1,000.00  ğŸ”´ Pendienteâ”‚ â†5 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                       â”‚
â”‚  ORDEN DE LIQUIDACIÃ“N (FIFO):                                        â”‚
â”‚  1Âº â†’ Item #1 ($3,200) del perÃ­odo 2025-Q01                          â”‚
â”‚  2Âº â†’ Item #2 ($960) del perÃ­odo 2025-Q01                            â”‚
â”‚  3Âº â†’ Item #3 ($2,840) del perÃ­odo 2025-Q02                          â”‚
â”‚  4Âº â†’ Item #4 ($500) del perÃ­odo 2025-Q03                            â”‚
â”‚  5Âº â†’ Item #5 ($1,000) del perÃ­odo 2025-Q03                          â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. VENTANAS DE REFERENCIAS UI

### 8.1 Vista Principal: Statements

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ESTADOS DE CUENTA - ASOCIADOS                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  PerÃ­odo: [2025-Q04 (23 Oct - 7 Nov) â–¼]   [ğŸ” Buscar asociado...]   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ASOCIADO           COBRADO    COMISIÃ“N   A PAGAR   ESTADO   â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ Juan PÃ©rez         $18,750    $937.50    $17,813   ğŸŸ¡ Parcialâ”‚â—„â”€â”â”‚
â”‚  â”‚ MarÃ­a LÃ³pez        $25,000    $1,250     $23,750   ğŸ”´ Pendiente â”‚â”‚
â”‚  â”‚ Carlos Ruiz        $15,000    $750       $14,250   ğŸŸ¢ Pagado    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          DETALLE - Juan PÃ©rez (Quincena 2025-Q04)             â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  ğŸ“Š RESUMEN FINANCIERO                                         â”‚  â”‚
â”‚  â”‚  â”œâ”€ Total Cobrado:        $18,750.00  (15 pagos Ã— $1,250)     â”‚  â”‚
â”‚  â”‚  â”œâ”€ ComisiÃ³n Ganada:      $   937.50  (5%)                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ A Pagar CrediCuenta:  $17,812.50                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ Abonos Realizados:    $10,000.00  (1 abono)               â”‚  â”‚
â”‚  â”‚  â”œâ”€ Saldo Pendiente:      $ 7,812.50                          â”‚  â”‚
â”‚  â”‚  â””â”€ Mora Aplicada:        $     0.00  (hubo abono)            â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  ğŸ’³ ABONOS REGISTRADOS                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ FECHA      MONTO       MÃ‰TODO       REFERENCIA         â”‚   â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  â”‚
â”‚  â”‚  â”‚ 01/11/25   $10,000.00  Transferencia  SPEI-123456      â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  ğŸ“‹ DESGLOSE DE PAGOS (15 pagos)                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ #   CLIENTE    ESPERADO   COMISIÃ“N   A PAGAR  ESTADO   â”‚   â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚  â”‚
â”‚  â”‚  â”‚ 1   Ana G.     $1,250     $62.50     $1,187.50  PAID   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ 2   Luis M.    $1,250     $62.50     $1,187.50  PAID   â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ 3   Pedro S.   $1,250     $62.50     $1,187.50  PENDINGâ”‚   â”‚  â”‚
â”‚  â”‚  â”‚ ... (12 mÃ¡s)                                            â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  ğŸ¦ DEUDA ACUMULADA                                            â”‚  â”‚
â”‚  â”‚  Saldo de perÃ­odos anteriores: $8,500.00 [Ver Desglose â–¼]    â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚  [ğŸ“ Registrar Abono]  [ğŸ“‹ Ver Historial]  [ğŸ”’ Cerrar PerÃ­odo]â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Modal: Registrar Abono (Detallado)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     REGISTRAR ABONO - Juan PÃ©rez                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  PASO 1: Seleccione destino del abono                                â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ (â€¢) SALDO ACTUAL (Quincena 2025-Q04)                         â”‚    â”‚
â”‚  â”‚                                                               â”‚    â”‚
â”‚  â”‚     Total a Pagar:       $17,812.50                          â”‚    â”‚
â”‚  â”‚     Abonos Previos:      $10,000.00                          â”‚    â”‚
â”‚  â”‚     Saldo Pendiente:     $ 7,812.50                          â”‚    â”‚
â”‚  â”‚                                                               â”‚    â”‚
â”‚  â”‚     âš ï¸ IMPORTANTE:                                            â”‚    â”‚
â”‚  â”‚     â€¢ Cualquier abono evita mora del 30% ($281.25)           â”‚    â”‚
â”‚  â”‚     â€¢ PerÃ­odo cierra el 07/Nov/2025                          â”‚    â”‚
â”‚  â”‚                                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ( ) DEUDA ACUMULADA                                          â”‚    â”‚
â”‚  â”‚                                                               â”‚    â”‚
â”‚  â”‚     Saldo Total:         $8,500.00                           â”‚    â”‚
â”‚  â”‚     PerÃ­odos:            3 (2025-Q01, Q02, Q03)              â”‚    â”‚
â”‚  â”‚     LiquidaciÃ³n:         FIFO (mÃ¡s antiguos primero)         â”‚    â”‚
â”‚  â”‚                                                               â”‚    â”‚
â”‚  â”‚     ğŸ“Š Desglose:                                             â”‚    â”‚
â”‚  â”‚     â€¢ 2025-Q01: $4,160.00 (pago + mora)                      â”‚    â”‚
â”‚  â”‚     â€¢ 2025-Q02: $2,840.00 (pago no reportado)                â”‚    â”‚
â”‚  â”‚     â€¢ 2025-Q03: $1,500.00 (cliente moroso + mora)            â”‚    â”‚
â”‚  â”‚                                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                       â”‚
â”‚  PASO 2: InformaciÃ³n del pago                                        â”‚
â”‚                                                                       â”‚
â”‚  Monto:          [________________]                                  â”‚
â”‚                                                                       â”‚
â”‚  MÃ©todo de pago: [Transferencia Bancaria        â–¼]                   â”‚
â”‚                                                                       â”‚
â”‚  Referencia:     [________________]                                  â”‚
â”‚                  (Ej: SPEI-123456, Recibo #789)                      â”‚
â”‚                                                                       â”‚
â”‚  Fecha de pago:  [11/11/2025                    ğŸ“…]                  â”‚
â”‚                                                                       â”‚
â”‚  Notas:          [___________________________________]               â”‚
â”‚                  [___________________________________]               â”‚
â”‚                                                                       â”‚
â”‚                                                                       â”‚
â”‚                  [Cancelar]        [Registrar Abono]                 â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 Tabla de Desglose de Pagos (Expandida)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          DESGLOSE DE PAGOS - Juan PÃ©rez (2025-Q04)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  [â–¼ Filtrar por estado: Todos â–¼] [ğŸ” Buscar cliente...]              â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ #  CLIENTE     ESPERADO  COMISIÃ“N  A PAGAR   ESTADO  ACCIONESâ”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚ 1  Ana GarcÃ­a  $1,250.00  $62.50   $1,187.50  âœ… PAID     â”‚ ğŸ‘ â”‚â”‚
â”‚  â”‚ 2  Luis Mtz    $1,250.00  $62.50   $1,187.50  âœ… PAID     â”‚ ğŸ‘ â”‚â”‚
â”‚  â”‚ 3  Pedro S.    $1,250.00  $62.50   $1,187.50  ğŸŸ¡ PENDING  â”‚ ğŸ‘ â”‚â”‚
â”‚  â”‚ 4  Carmen L.   $1,250.00  $62.50   $1,187.50  ğŸŸ¡ PENDING  â”‚ ğŸ‘ â”‚â”‚
â”‚  â”‚ 5  Jorge R.    $1,250.00  $62.50   $1,187.50  ğŸŸ¡ PENDING  â”‚ ğŸ‘ â”‚â”‚
â”‚  â”‚ 6  SofÃ­a P.    $1,250.00  $62.50   $1,187.50  â±ï¸ OVERDUE  â”‚ ğŸ‘ â”‚â”‚
â”‚  â”‚ 7  Miguel A.   $1,250.00  $62.50   $1,187.50  â±ï¸ OVERDUE  â”‚ ğŸ‘ â”‚â”‚
â”‚  â”‚ 8  Laura V.    $1,250.00  $62.50   $1,187.50  ğŸ”´ MOROSO   â”‚ ğŸ‘ â”‚â”‚
â”‚  â”‚ ... (7 mÃ¡s)                                                 â”‚    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                       â”‚
â”‚  LEYENDA:                                                            â”‚
â”‚  âœ… PAID = Marcado manualmente (cliente pagÃ³)                        â”‚
â”‚  ğŸ”´ MOROSO = Cliente moroso (pago no reportado)                      â”‚
â”‚  ğŸŸ¡ PENDING = Esperando cobro                                        â”‚
â”‚  â±ï¸ OVERDUE = Vencido, no reportado                                  â”‚
â”‚                                                                       â”‚
â”‚  TOTALES:                                                            â”‚
â”‚  â€¢ Esperado Total:    $18,750.00 (15 pagos)                          â”‚
â”‚  â€¢ ComisiÃ³n Total:    $   937.50                                     â”‚
â”‚  â€¢ A Pagar Total:     $17,812.50                                     â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. RESUMEN DE DECISIONES

### 9.1 Decisiones Confirmadas

| ID | PREGUNTA | RESPUESTA | IMPLICACIÃ“N |
|----|----------|-----------|-------------|
| 1.1 | Â¿QuiÃ©n marca morosidad? | Solo ADMIN | No hay auto-detecciÃ³n |
| 1.2 | Â¿QuÃ© se marca? | Pago individual O cliente completo | Admin selecciona |
| 2.1 | Â¿Mora se suma o resta? | SE SUMA a la deuda | Incrementa monto |
| 2.2 | Â¿Cierre automÃ¡tico? | MANUAL (Admin ejecuta) | Control total |
| 3.1 | Â¿DistribuciÃ³n en pagos? | **NO se distribuye** | Todos quedan pendientes |
| 4.1 | Â¿FIFO en deuda? | **AutomÃ¡tico FIFO** | MÃ¡s antiguos primero |

### 9.2 Campos Clave en Base de Datos

```sql
-- payments (por pago individual)
expected_amount       -- Lo que cliente paga
commission_amount     -- Lo que asociado gana (5%)
associate_payment     -- Lo que asociado paga a CrediCuenta
status_id             -- Estado del pago (1-8)

-- associate_payment_statements (agregado del perÃ­odo)
total_amount_collected   -- SUM(expected_amount)
total_commission_owed    -- SUM(commission_amount)
paid_amount              -- Abonos del asociado (de associate_statement_payments)
late_fee_amount          -- Mora 30% (si paid_amount = 0)

-- associate_statement_payments (abonos al saldo actual)
statement_id          -- FK al statement
payment_amount        -- Monto del abono
payment_date
payment_reference

-- associate_debt_breakdown (desglose de deuda acumulada)
associate_profile_id
debt_type             -- UNREPORTED_PAYMENT, LATE_FEE, DEFAULTED_CLIENT
amount                -- Monto de la deuda
is_liquidated         -- Boolean (FIFO)
created_at            -- Para ordenar FIFO

-- associate_profiles (perfil del asociado)
debt_balance          -- Suma total de deuda acumulada
```

---

## 10. PRÃ“XIMOS PASOS

### 10.1 Backend

1. **DTOs a crear:**
   - `StatementDetailDTO` (incluir total_amount_collected, debt_balance)
   - `PaymentBreakdownDTO` (desglose de pagos individuales)
   - `DebtBreakdownDTO` (desglose de deuda acumulada)
   - `StatementPaymentDTO` (abonos al statement)

2. **Endpoints a implementar:**
   - `GET /api/statements/:id/payments` - Desglose de pagos
   - `POST /api/statements/:id/payments` - Registrar abono a saldo actual
   - `GET /api/associates/:id/debt-breakdown` - Desglose de deuda
   - `POST /api/associates/:id/debt-payments` - Registrar abono a deuda
   - `POST /api/statements/:id/close` - Cerrar perÃ­odo (manual)

3. **Funciones SQL a crear/actualizar:**
   - `close_cut_period_statement()` - Implementar lÃ³gica de cierre
   - `apply_payment_to_debt_fifo()` - Ya existe, validar

### 10.2 Frontend

1. **Componentes a crear:**
   - `ModalRegistrarAbono.jsx` (con selector de destino)
   - `TablaDesglosePagos.jsx` (tabla expandida)
   - `DetalleStatement.jsx` (panel de detalle completo)
   - `DesgloseDeuda.jsx` (desglose FIFO de deuda acumulada)

2. **Servicios a actualizar:**
   - `statementsService.js` - Agregar mÃ©todos de abono
   - `associatesService.js` - MÃ©todos de deuda

3. **PÃ¡ginas a crear:**
   - `StatementsPage.jsx` - Vista principal (ya existe, mejorar)
   - `StatementDetailPage.jsx` - Detalle individual

---

## ğŸ“Œ NOTAS IMPORTANTES

1. **NO hay distribuciÃ³n proporcional** - Si el abono es parcial, TODOS los pagos quedan como UNPAID_ACCRUED_DEBT
2. **Mora solo si paid_amount = 0** - Cualquier abono (incluso $1) evita la mora
3. **FIFO automÃ¡tico en deuda** - Se liquidan primero las deudas mÃ¡s antiguas
4. **Cierre manual** - Admin decide cuÃ¡ndo cerrar el perÃ­odo
5. **Dos tipos de abonos SIEMPRE** - UI debe ofrecer ambas opciones en modal

---

**FIN DEL DOCUMENTO**  
Ãšltima actualizaciÃ³n: 2025-11-11 por GitHub Copilot
